* UUID support in Springsteenlyrics
** initial

Given the following types of URLs

https://www.springsteenlyrics.com/bootlegs.php?cmd=edit&item=<itemID>&category=<category>
for example
https://www.springsteenlyrics.com/bootlegs.php?cmd=edit&item=5013&category=aud_live1980

please parse the source code of the example URL and create a Tampermonkey userscripts
which checks for a valid Universally Unique Identifier (UUID) (but only lowercase letters, should be allowed)
when pasting it in the following textfield (in the following example it's already prefilled with "0761d7ea-a5d8-4499-9ab9-d0dcc161fcaa"):

#+begin_example
// ==UserScript==
// @name         MusicBrainz UUID Validator (Lowercase Hex)
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  Ensures the MusicBrainz ID field accepts only valid, lowercase UUIDs on the bootlegs editing page.
// @author       Gemini
// @match        https://www.springsteenlyrics.com/bootlegs.php?cmd=edit*
// @grant        none
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    // The UUID format regex:
    // ^      - Start of string
    // [0-9a-f]{8} - 8 lowercase hex digits
    // -      - Hyphen
    // [0-9a-f]{4} - 4 lowercase hex digits
    // ...
    // [0-9a-f]{12}$ - 12 lowercase hex digits, end of string
    const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;

    const inputField = document.getElementById('db_musicbrainz');

    if (inputField) {
        // Find the parent label/section to apply styling and messages
        const parentLabel = inputField.closest('.input');
        const parentRow = inputField.closest('.row');

        if (!parentLabel || !parentRow) {
            console.error("Tampermonkey Script: Could not find required parent elements for styling.");
            return;
        }

        // --- Helper Function to Handle Feedback ---
        function setValidationFeedback(isValid) {
            if (isValid) {
                // Remove error state
                parentLabel.style.border = '1px solid #ccc';
                let existingError = parentRow.querySelector('.validation-error-message');
                if (existingError) {
                    existingError.remove();
                }
            } else {
                // Apply error state
                parentLabel.style.border = '2px solid red';

                // Check for existing message to avoid duplicates
                let existingError = parentRow.querySelector('.validation-error-message');
                if (!existingError) {
                    const errorMessage = document.createElement('p');
                    errorMessage.className = 'validation-error-message';
                    errorMessage.style.color = 'red';
                    errorMessage.style.fontSize = '12px';
                    errorMessage.style.marginTop = '5px';
                    errorMessage.textContent = 'Invalid MusicBrainz ID format. Must be a valid UUID (8-4-4-4-12) using only lowercase hex characters (0-9, a-f).';
                    parentRow.appendChild(errorMessage);
                }
            }
        }

        // 1. Validate on Paste (to prevent invalid data from entering)
        inputField.addEventListener('paste', function(e) {
            // Get the pasted text
            const pastedText = (e.clipboardData || window.clipboardData).getData('text');

            if (pastedText && !UUID_REGEX.test(pastedText)) {
                // If the pasted text is not a valid UUID, prevent the paste action
                e.preventDefault();
                setValidationFeedback(false);

                // Optionally, inform the user why the paste was blocked (using the same visual feedback)
                inputField.value = "PASTE BLOCKED: Invalid format.";
                // Clear the message after a short delay
                setTimeout(() => {
                    if (inputField.value === "PASTE BLOCKED: Invalid format.") {
                        inputField.value = '';
                    }
                }, 1500);
            }
        });


        // 2. Validate on Input (for real-time typing/editing feedback)
        inputField.addEventListener('input', function() {
            const currentValue = inputField.value;

            if (currentValue === "") {
                // If field is empty, clear feedback
                setValidationFeedback(true);
            } else if (UUID_REGEX.test(currentValue)) {
                // Valid UUID
                setValidationFeedback(true);
            } else {
                // Invalid UUID
                setValidationFeedback(false);
            }
        });

        // Initial validation check if the field is pre-filled
        if (inputField.value.length > 0) {
            setValidationFeedback(UUID_REGEX.test(inputField.value));
        }
    }
})();
#+end_example

** extend pasting support

In the uploaded userscript, please extend the functionality so that when pasting, in addition to plain UUIDs also
complete URLs of the following forms should be supported, where the UUID part should be extracted from:

https://musicbrainz.org/release/<UUID>/<optional virtual path>

<UUID> is a supported UUID
<optional virtual path> is an arbitrary query string like "edit"

** add button on main page

Given URLS of type https://www.springsteenlyrics.com/bootlegs.php?item=<id>&category=<category>

for example: https://www.springsteenlyrics.com/bootlegs.php?item=6214&category=aud_live1975

create a user script which places a button with text "Add MusicBrainz MBID" after the "edit item" text (see following HTML snippet)

#+begin_example
 <i class="bi bi-pencil-square">
		  </i>
		  <a href="bootlegs.php?cmd=edit&amp;item=6214&amp;category=aud_live1975">edit item
		  </a>
#+end_example

inside the the complete HTML structure:

#+begin_example
<div class="blog-post">
	<div class="row">
		<div class="col-md-2 margin20">
		  <a href="bootlegs.php?item=6214&amp;category=aud_live1975">
		    <img src="bootlegs/aud_live1975/6214.jpg" class="img-responsive" alt="The Lost New Year's Eve (31 Dec 1975)" title="The Lost New Year's Eve (31 Dec 1975)">
		  </a>
		</div>
		<div class="col-md-10 margin20">
		  <b>6214
		  </b>
		  <span class="text-primary">
		    <i class="glyphicon glyphicon-option-vertical">
		    </i>
		  </span>
		  <a href="bootlegs.php?item=6214&amp;category=aud_live1975">
		    <b>The Lost New Year's Eve
		    </b>
		  </a>
			
		  <span class="text-primary">
		    <i class="glyphicon glyphicon-option-vertical">
		    </i>
		  </span>
		  <b>Vintage Masters
		  </b>
		  <br>
		  <span class="text-primary">
		    <em>Date:
		    </em>
		  </span> 31 Dec 1975
		  <br>
		  <span class="text-primary">
		    <em>Location:
		    </em>
		  </span> Tower Theater, Upper Darby, PA
		  <br>
		  <span class="text-primary">
		    <em>Format:
		    </em>
		  </span> FLAC
		  <br>
		  <span class="text-primary">
		    <em>Duration:
		    </em>
		  </span> 60:26.70
		  <br>
		  <i class="bi bi-image">
		  </i> artwork available |
		  <i class="glyphicon glyphicon-file">
		  </i> original info file available
		  <br>
		  <i class="bi bi-pencil-square">
		  </i>
		  <a href="bootlegs.php?cmd=edit&amp;item=6214&amp;category=aud_live1975">edit item
		  </a>
		</div>
	</div>
</div>
#+end_example

When the button is pressed a click on the hyperlink '<a href="bootlegs.php?cmd=edit&amp;item=6214&amp;category=aud_live1975">' of the "edit item" text should be generated

** 1

#+begin_example
// ==UserScript==
// @name         SpringsteenLyrics - Add MusicBrainz MBID Button
// @namespace    http://tampermonkey.net/
// @version      1.1
// @description  Adds a button specifically after the "edit item" link in the blog-post section
// @author       Gemini
// @match        https://www.springsteenlyrics.com/bootlegs.php?item=*&category=*
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    // 1. Target all links, then filter for the one that specifically says "edit item"
    // and is located within the blog-post content area.
    const links = document.querySelectorAll('.blog-post a[href*="cmd=edit"]');
    let editItemLink = null;

    links.forEach(link => {
        if (link.textContent.toLowerCase().includes('edit item')) {
            editItemLink = link;
        }
    });

    if (editItemLink) {
        // 2. Create the button
        const mbidButton = document.createElement('button');
        mbidButton.innerText = 'Add MusicBrainz MBID';
        mbidButton.type = 'button';

        // Styling to match the context
        mbidButton.style.marginLeft = '5px';
        mbidButton.style.padding = '2px 5px';
        mbidButton.style.fontSize = '12px';
        mbidButton.style.cursor = 'pointer';
        // Applying Bootstrap classes for better integration
        mbidButton.className = 'btn btn-xs btn-outline-primary';

        // 3. Add click event logic
        mbidButton.addEventListener('click', function(e) {
            e.preventDefault();
            editItemLink.click();
        });

        // 4. Insert after the "edit item" link
        editItemLink.parentNode.insertBefore(mbidButton, editItemLink.nextSibling);
    }
})();
#+end_example

** 2

#+begin_example
// ==UserScript==
// @name         SpringsteenLyrics - MBID Helper Integrated
// @namespace    https://github.com/vzell/mb-userscripts
// @version      2.1
// @description  Adds "Add MusicBrainz MBID" button and validates UUID/URLs on the edit page
// @author       vzell & Gemini
// @match        https://www.springsteenlyrics.com/bootlegs.php?item=*&category=*
// @match        https://www.springsteenlyrics.com/bootlegs.php?cmd=edit*
// @icon         https://volkerzell.de/favicons/springsteenlyrics.ico
// @grant        none
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const currentUrl = window.location.href;

    // --- LOGIC FOR BOOTLEG VIEW PAGE ---
    if (currentUrl.includes('item=') && !currentUrl.includes('cmd=edit')) {
        const links = document.querySelectorAll('.blog-post a[href*="cmd=edit"]');
        let editItemLink = null;

        links.forEach(link => {
            if (link.textContent.toLowerCase().includes('edit item')) {
                editItemLink = link;
            }
        });

        if (editItemLink) {
            const mbidButton = document.createElement('button');
            mbidButton.innerText = 'Add MusicBrainz MBID';
            mbidButton.type = 'button';
            mbidButton.className = 'btn btn-xs btn-outline-primary'; 
            mbidButton.style.marginLeft = '5px';
            mbidButton.style.cursor = 'pointer';

            mbidButton.addEventListener('click', function(e) {
                e.preventDefault();
                editItemLink.click();
            });

            editItemLink.parentNode.insertBefore(mbidButton, editItemLink.nextSibling);
        }
    }

    // --- LOGIC FOR EDIT PAGE (MusicBrainz UUID Paster) ---
    if (currentUrl.includes('cmd=edit')) {
        const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;
        const MB_URL_REGEX = /^https:\/\/musicbrainz\.org\/release\/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})(\/.*)?$/i;

        const inputField = document.getElementById('db_musicbrainz');

        if (inputField) {
            const parentLabel = inputField.closest('.input');
            const parentRow = inputField.closest('.row');

            if (!parentLabel || !parentRow) return;

            const setValidationFeedback = (isValid) => {
                if (isValid) {
                    parentLabel.style.border = '1px solid #ccc';
                    let existingError = parentRow.querySelector('.validation-error-message');
                    if (existingError) existingError.remove();
                } else {
                    parentLabel.style.border = '2px solid red';
                    let existingError = parentRow.querySelector('.validation-error-message');
                    if (!existingError) {
                        const errorMessage = document.createElement('p');
                        errorMessage.className = 'validation-error-message';
                        errorMessage.style.color = 'red';
                        errorMessage.style.fontSize = '12px';
                        errorMessage.style.marginTop = '5px';
                        errorMessage.textContent = 'Invalid MusicBrainz ID format. Must be a valid UUID or a musicbrainz.org/release URL.';
                        parentRow.appendChild(errorMessage);
                    }
                }
            };

            inputField.addEventListener('paste', function(e) {
                let pastedText = (e.clipboardData || window.clipboardData).getData('text').trim();
                const urlMatch = pastedText.match(MB_URL_REGEX);

                if (urlMatch) {
                    e.preventDefault();
                    const extractedUuid = urlMatch[1].toLowerCase();
                    inputField.value = extractedUuid;
                    setValidationFeedback(true);
                } else if (pastedText && !UUID_REGEX.test(pastedText)) {
                    e.preventDefault();
                    setValidationFeedback(false);
                    inputField.value = "PASTE BLOCKED: Invalid format.";
                    setTimeout(() => {
                        if (inputField.value === "PASTE BLOCKED: Invalid format.") {
                            inputField.value = '';
                        }
                    }, 1500);
                }
            });

            inputField.addEventListener('input', function() {
                const currentValue = inputField.value.trim();
                setValidationFeedback(currentValue === "" || UUID_REGEX.test(currentValue));
            });

            if (inputField.value.length > 0) {
                setValidationFeedback(UUID_REGEX.test(inputField.value));
            }
        }
    }
})();
#+end_example

** 3

#+begin_example
// ==UserScript==
// @name         SpringsteenLyrics - MBID Helper Integrated
// @namespace    https://github.com/vzell/mb-userscripts
// @version      2.3
// @description  Adds button and automated clipboard paster for MusicBrainz IDs
// @author       vzell & Gemini
// @match        https://www.springsteenlyrics.com/bootlegs.php?item=*&category=*
// @match        https://www.springsteenlyrics.com/bootlegs.php?cmd=edit*
// @icon         https://volkerzell.de/favicons/springsteenlyrics.ico
// @grant        none
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const currentUrl = window.location.href;
    const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;
    const MB_URL_REGEX = /^https:\/\/musicbrainz\.org\/release\/([0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12})(\/.*)?$/i;

    // --- HELPER: Process text (Logic from your original script) ---
    function processMbidText(text, inputField, feedbackFn) {
        const cleanText = text.trim();
        const urlMatch = cleanText.match(MB_URL_REGEX);

        if (urlMatch) {
            inputField.value = urlMatch[1].toLowerCase();
            feedbackFn(true);
            return true;
        } else if (UUID_REGEX.test(cleanText)) {
            inputField.value = cleanText.toLowerCase();
            feedbackFn(true);
            return true;
        } else {
            inputField.value = "INVALID FORMAT";
            feedbackFn(false);
            setTimeout(() => { if (inputField.value === "INVALID FORMAT") inputField.value = ''; }, 1500);
            return false;
        }
    }

    // --- LOGIC FOR BOOTLEG VIEW PAGE ---
    if (currentUrl.includes('item=') && !currentUrl.includes('cmd=edit')) {
        const editLink = document.querySelector('.blog-post a[href*="cmd=edit"]');
        if (editLink && editLink.textContent.toLowerCase().includes('edit item')) {
            const btn = document.createElement('button');
            btn.innerText = 'Add MusicBrainz MBID';
            btn.type = 'button';
            btn.className = 'btn btn-xs btn-outline-primary';
            btn.style.marginLeft = '5px';
            btn.onclick = (e) => {
                e.preventDefault();
                sessionStorage.setItem('autoPasteMBID', 'true');
                editLink.click();
            };
            editLink.parentNode.insertBefore(btn, editLink.nextSibling);
        }
    }

    // --- LOGIC FOR EDIT PAGE ---
    if (currentUrl.includes('cmd=edit')) {
        const inputField = document.getElementById('db_musicbrainz');
        if (!inputField) return;

        const parentLabel = inputField.closest('.input');
        const parentRow = inputField.closest('.row');

        const setValidationFeedback = (isValid) => {
            if (!parentRow) return;
            if (parentLabel) parentLabel.style.border = isValid ? '1px solid #ccc' : '2px solid red';
            let msg = parentRow.querySelector('.validation-error-message');
            if (!isValid && !msg) {
                msg = document.createElement('p');
                msg.className = 'validation-error-message';
                msg.style.color = 'red';
                msg.style.fontSize = '12px';
                msg.textContent = 'Invalid MusicBrainz ID format.';
                parentRow.appendChild(msg);
            } else if (isValid && msg) {
                msg.remove();
            }
        };

        // Create a "Paste" helper button on the edit page
        const pasteBtn = document.createElement('button');
        pasteBtn.innerText = 'üìã Paste from Clipboard';
        pasteBtn.type = 'button';
        pasteBtn.style.cssText = 'margin-top: 5px; display: block; cursor: pointer; padding: 4px 8px; background: #e7f3ff; border: 1px solid #b2d7ff; border-radius: 4px; font-size: 11px;';

        pasteBtn.onclick = async () => {
            try {
                const text = await navigator.clipboard.readText();
                processMbidText(text, inputField, setValidationFeedback);
            } catch (err) {
                alert("Permission to read clipboard was denied. Please paste manually (Ctrl+V).");
            }
        };

        inputField.parentNode.appendChild(pasteBtn);

        // Auto-focus logic
        if (sessionStorage.getItem('autoPasteMBID') === 'true') {
            sessionStorage.removeItem('autoPasteMBID');
            inputField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            inputField.focus();
            pasteBtn.style.backgroundColor = '#fff9c4'; // Highlight the button to guide the user
            pasteBtn.innerText = 'üìã Click here to Paste MBID';
        }

        // Keep your original Manual Paste listener
        inputField.addEventListener('paste', (e) => {
            let pastedText = (e.clipboardData || window.clipboardData).getData('text');
            e.preventDefault();
            processMbidText(pastedText, inputField, setValidationFeedback);
        });

        inputField.addEventListener('input', () => {
            setValidationFeedback(inputField.value.trim() === "" || UUID_REGEX.test(inputField.value.trim()));
        });
    }
})();
#+end_example

** emulate login

Analyze the following URL: https://www.springsteenlyrics.com/bootlegs.php?item=3062&category=aud_live1980

Part of the URLs page functionality needs authentication. The uploaded user script expects a hyperlink, see

#+begin_example
document.querySelector('.blog-post a[href*="cmd=edit"]
#+end_example

in the code block after the comment line "// --- LOGIC FOR BOOTLEG VIEW PAGE ---"

which is not there as long as the end user hasn't authenticated yet. Please adjust the uploaded user script to emulate
pressing the authentication icon which can be found in the code at '<li class="dropdown">.

The HTML code in the non-authenticated case looks like the following

#+begin_example
<li class="dropdown">
<a href="#" class=" dropdown-toggle" data-toggle="dropdown"><i class="bi bi-lock"></i></a>
 <div class="dropdown-menu dropdown-menu-right dropdown-login-box animated fadeInUp">
 	<form action="/bootlegs.php?item=3062&amp;category=aud_live1980" method="post" name="login_form">
 		<h4>Log in</h4>
 		<div class="form-group">
 			<div class="input-group">
 				<span class="input-group-addon"><i class="bi bi-person"></i></span>
 				<input type="text" name="hTxtUsername" id="hTxtUsername" class="form-control" placeholder="Username">
 			</div>
 			<br>
 			<div class="input-group">
 				<span class="input-group-addon"><i class="bi bi-lock"></i></span>
 				<input type="password" name="hTxtPassword" id="hTxtPassword" class="form-control" placeholder="Password">
 			</div>
 			<div class="checkbox pull-left">
 				<label>
 					<!--<input type="checkbox"> Remember me-->
 				</label>
 			</div>
 			<button type="submit" value="Login" name="hBtnLogin" class="btn btn-theme-bg pull-right">Log In</button>
 			<div class="clearfix"></div>
 		</div>
 	</form>
 </div>
</li>
#+end_example

and when the rendered icon (probably represented by the <li class="dropdown"> code) is pressed, the 
HTML code looks like the following:

#+begin_example
<li class="dropdown open">
<a href="#" class=" dropdown-toggle" data-toggle="dropdown" aria-expanded="true"><i class="bi bi-lock"></i></a>
 <div class="dropdown-menu dropdown-menu-right dropdown-login-box animated fadeInUp">
 	<form action="/bootlegs.php?item=3062&amp;category=aud_live1980" method="post" name="login_form">
 		<h4>Log in</h4>
 		<div class="form-group">
 			<div class="input-group">
 				<span class="input-group-addon"><i class="bi bi-person"></i></span>
 				<input type="text" name="hTxtUsername" id="hTxtUsername" class="form-control" placeholder="Username">
 			</div>
 			<br>
 			<div class="input-group">
 				<span class="input-group-addon"><i class="bi bi-lock"></i></span>
 				<input type="password" name="hTxtPassword" id="hTxtPassword" class="form-control" placeholder="Password">
 			</div>
 			<div class="checkbox pull-left">
 				<label>
 					<!--<input type="checkbox"> Remember me-->
 				</label>
 			</div>
 			<button type="submit" value="Login" name="hBtnLogin" class="btn btn-theme-bg pull-right">Log In</button>
 			<div class="clearfix"></div>
 		</div>
 	</form>
 </div>
</li>
#+end_example

Also adjust the userscript code to then press the Submit button represented as

#+begin_example
<button type="submit" value="Login" name="hBtnLogin" class="btn btn-theme-bg pull-right">Log In</button>
#+end_example

(The browser already fills in username and password, as they are stored in it's security store)

** 1

Actually an auto-login should happen when the user is not authenticated yet. There shouldn't be an additional button,
otherwise the user could just login the natural via by clicking the lock icon directly and pressing submit afterwards

** 2

Actually the logic seems right. At least the login dialog quickly pops up, and then vanishes again (as if the submit
button has been clicked), BUT the username and password are not filled in yet. Also the helper button is not present
yet, as wea re not authenticated yet.

And afterwards the script execution cannot be triggered again. Instead I have to copy the URL in a completely new tab in
the browser, but with the same effects

** 3

I can see the username and passwords get filled in now, but the authentication still does not happen.

** 4

Yes, I can see it focusing at least the password field, but I can't see the actual Submit button press. It also doesn't happen, Same result as before.

** auto submit

In the uploaded user script add the following functionality:

After pasting of the MBID in the "Musicbrain ID" text field automatically advance to the "Submit" button of the page and emulate a click on the button. This is the HTML code where the button is located:

#+begin_example
<footer>
  <input type="hidden" value="edit" name="previouscmd">
  <button type="submit" class="btn border-black btn-lg">Submit</button>
  <button type="reset" class="btn border-black btn-lg">Reset</button>
  <a href="bootlegs.php?item=6212&amp;category=aud_live1975" class="btn border-black btn-lg">Cancel</a>
  <a href="javascript:confirm_delete('bootlegs.php?cmd=delete&amp;item=6212&amp;category=aud_live1975')" class="btn border-black btn-lg">Delete</a>
</footer>
#+end_example

** alternate button text

In the uploaded user script add the following functionality:

The button text should be

 - "Add MusicBrainz MBID" if the "Musicbrain ID" text field is empty
 - "Edit MusicBrainz MBID" if the "Musicbrain ID" text field already has a value

For example if the following HTML code is present

#+begin_example
<a href="https://musicbrainz.org/release/4ee36309-5877-449b-a53f-f532a7d96fc3" target="_blank"><img src="img/collection_musicbrainz.png" alt="MusicBrainz link"></a>
#+end_example

** preselect

In the uploaded user script add the following functionality:

In the Auto-focus logic also preselect the MBID in the "MusicBrainz MBID" text field if already present

#+begin_example
        // Auto-focus logic
        if (sessionStorage.getItem('autoPasteMBID') === 'true') {
            sessionStorage.removeItem('autoPasteMBID');
            inputField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            inputField.focus();
            pasteBtn.style.backgroundColor = '#fff9c4'; // Highlight the button to guide the user
            pasteBtn.innerText = 'üìã Click here to Paste MBID';
        }
#+end_example

** button text and color

In the uploaded user script, why are the button texts in all UPPER case. Please change this to the actual text provided
in the script. Also change the button appearance so that it can better be distinguished (its grey right now) from the
grey backgound of the part of the web page where it's located. Pleas also add visual feedback when hovering over and
pressing the button.

** autsubmit also when pressing buttonn

In the uploaded user scripts, add the auto-submit functionality (allow the paste and then submit) also when the 'üìã
Paste from Clipboard' button is pressed.


* Add external link to release
** Gemini
*** question

Write a Tampermonkey userscript when adding a new release to MusicBrainz on the URL

https://musicbrainz.org/release/add

with the following functionality:

When pasting a URL which starts with either

    - https://www.springsteenlyrics.com/bootlegs.php?item=<Item-ID>&category=<category> - <=== cut off everything after <Item-ID> before insertion
    - https://www.jungleland.it/html/<filename>.htm

into the text field 'placeholder="Add link"' which looks in HTML like this

#+begin_example
<fieldset class="information">
    <legend>External links</legend>
      <div id="external-links-editor-container"><table class="row-form" id="external-links-editor"><tbody><tr class="external-link-item" id="external-link-0"><td></td><td class="link-actions"></td><td><input class="value with-button" data-index="0" placeholder="Add link" type="url" value=""></td></tr></tbody></table></div>
  </fieldset>
#+end_example

then the React based Musicbrainz UI adds a new piece of HTML code

#+begin_example
<fieldset class="information">
    <legend>External links</legend>
      <div id="external-links-editor-container"><table class="row-form" id="external-links-editor"><tbody><tr class="external-link-item" id="external-link-0"><td><span class="favicon no-favicon"></span></td><td class="link-actions"><button class="nobutton icon remove-item" data-index="0" title="Remove link" type="button"></button><button class="icon edit-item" title="Edit URL" aria-haspopup="dialog" type="button"></button></td><td><a class="url " href="https://www.springsteenlyrics.com/bootlegs.php?item=5013" rel="noreferrer" target="_blank" style="overflow-wrap: anywhere;">https://www.springsteenlyrics.com/bootlegs.php?item=5013</a></td></tr><tr class="relationship-item"><td></td><td class="link-actions"><button class="icon edit-item" title="Edit attributes" aria-haspopup="dialog" type="button"></button></td><td><div class="relationship-content "><label>Type:</label><label class="relationship-name"><select class="link-type"><option value="">&nbsp;</option>
      <option value="288">discography entry</option>
      <option value="301">license</option>
      <option disabled="" value="73">get the music</option>
      <option value="79">&nbsp;&nbsp;purchase for mail-order</option>
      <option value="74">&nbsp;&nbsp;purchase for download</option>
      <option value="75">&nbsp;&nbsp;download for free</option>
      <option value="85">&nbsp;&nbsp;stream for free</option>
      <option value="980">&nbsp;&nbsp;streaming page</option>
      <option value="906">crowdfunding page</option>
      <option value="729">show notes</option>
      <option value="78">cover art</option>
      </select></label></div><div class="error field-error" data-visible="1">Please select a link type for the URL you‚Äôve entered.</div></td></tr><tr class="add-relationship"><td></td><td></td><td class="add-item"><button class="add-item with-label" type="button">Add another relationship</button></td></tr><tr class="external-link-item" id="external-link-1"><td></td><td class="link-actions"></td><td><input class="value with-button" data-index="1" placeholder="Add another link" type="url" value=""></td></tr></tbody></table></div>
  </fieldset>
#+end_example

and populates a "Type" list where the following entry should be selected

#+begin_example
<option value="288">discography entry</option>
#+end_example

*** 1

The URL trimming for SpringsteenLyrics URLs and the insertion in the text box actually works, but nothing is selected
from the "Type" pull-down list, especially the "discography entry" option.

Here is the complete HTML code of the generated area when I select the entry manually:

#+begin_src bash
<fieldset class="information">
    <legend>External links</legend>
      <div id="external-links-editor-container"><table class="row-form" id="external-links-editor"><tbody><tr class="external-link-item" id="external-link-0"><td><span class="favicon no-favicon"></span></td><td class="link-actions"><button class="nobutton icon remove-item" data-index="0" title="Remove link" type="button"></button><button class="icon edit-item" title="Edit URL" aria-haspopup="dialog" type="button"></button></td><td><a class="url " href="https://www.springsteenlyrics.com/bootlegs.php?item=5013" rel="noreferrer" target="_blank" style="overflow-wrap: anywhere;">https://www.springsteenlyrics.com/bootlegs.php?item=5013</a></td></tr><tr class="relationship-item"><td></td><td class="link-actions"><button class="icon edit-item" title="Edit attributes" aria-haspopup="dialog" type="button"></button></td><td><div class="relationship-content "><label>Type:</label><label class="relationship-name"><select class="link-type"><option value="">&nbsp;</option><option value="288">discography entry</option><option value="301">license</option><option disabled="" value="73">get the music</option><option value="79">&nbsp;&nbsp;purchase for mail-order</option><option value="74">&nbsp;&nbsp;purchase for download</option><option value="75">&nbsp;&nbsp;download for free</option><option value="85">&nbsp;&nbsp;stream for free</option><option value="980">&nbsp;&nbsp;streaming page</option><option value="906">crowdfunding page</option><option value="729">show notes</option><option value="78">cover art</option></select><span class="tooltip-wrapper"><span class="img icon help" style="display: inline-block; margin-left: 10px; vertical-align: text-top;"></span><span class="tooltip-container"><span class="tooltip-triangle"></span><span class="tooltip-content"><div style="text-align: left;">This link points to a page for a particular release within a discography for an artist or label. (<a href="/relationship/823656dd-0309-4247-b282-b92d287d59c5" target="_blank">more documentation</a>)</div></span></span></span></label></div></td></tr><tr class="add-relationship"><td></td><td></td><td class="add-item"><button class="add-item with-label" type="button">Add another relationship</button></td></tr><tr class="external-link-item" id="external-link-1"><td></td><td class="link-actions"></td><td><input class="value with-button" data-index="1" placeholder="Add another link" type="url" value=""></td></tr></tbody></table></div>
  </fieldset>
#+end_src

Please add debug logging to the script and fix

*** 2

Still nothing selected. Here console loutout

#+begin_example
MusicBrainz Quick Tools Debug: Initializing MutationObserver on the #recordings element's attributes.
userscript.html?name=MusicBrainz%253A-Auto-Select-Discography-Link-Type.user.js&id=d3b2b758-fc84-4cd6-9a84-c415fde438ca:21 [MB-Discography-AutoSelect] Container found, starting observer.
userscript.html?name=MusicBrainz%253A-Auto-Select-Discography-Link-Type.user.js&id=d3b2b758-fc84-4cd6-9a84-c415fde438ca:21 [MB-Discography-AutoSelect] Cleaned URL on paste: https://www.springsteenlyrics.com/bootlegs.php?item=5013
userscript.html?name=MusicBrainz%253A-Auto-Select-Discography-Link-Type.user.js&id=d3b2b758-fc84-4cd6-9a84-c415fde438ca:21 [MB-Discography-AutoSelect] Found select element: <select class=‚Äã"link-type">‚Äã<option value>‚Äã&nbsp;‚Äã</option>‚Äãslot<option value=‚Äã"288">‚Äãdiscography entry‚Äã</option>‚Äãslot<option value=‚Äã"301">‚Äãlicense‚Äã</option>‚Äãslot<option disabled value=‚Äã"73">‚Äãget the music‚Äã</option>‚Äãslot<option value=‚Äã"79">‚Äã&nbsp;&nbsp;purchase for mail-order‚Äã</option>‚Äãslot<option value=‚Äã"74">‚Äã&nbsp;&nbsp;purchase for download‚Äã</option>‚Äãslot<option value=‚Äã"75">‚Äã&nbsp;&nbsp;download for free‚Äã</option>‚Äãslot<option value=‚Äã"85">‚Äã&nbsp;&nbsp;stream for free‚Äã</option>‚Äãslot<option value=‚Äã"980">‚Äã&nbsp;&nbsp;streaming page‚Äã</option>‚Äãslot<option value=‚Äã"906">‚Äãcrowdfunding page‚Äã</option>‚Äãslot<option value=‚Äã"729">‚Äãshow notes‚Äã</option>‚Äãslot<option value=‚Äã"78">‚Äãcover art‚Äã</option>‚Äãslot</select>
userscript.html?name=MusicBrainz%253A-Auto-Select-Discography-Link-Type.user.js&id=d3b2b758-fc84-4cd6-9a84-c415fde438ca:21 [MB-Discography-AutoSelect] Could not find a.url in previous sibling row <tr class=‚Äã"external-link-item" id=‚Äã"external-link-0">‚Äã<td>‚Äã<span class=‚Äã"favicon no-favicon">‚Äã</span>‚Äã</td>‚Äã<td class=‚Äã"link-actions">‚Äã‚Ä¶‚Äã</td>‚Äã<button class=‚Äã"nobutton icon remove-item" data-index=‚Äã"0" title=‚Äã"Remove link" type=‚Äã"button">‚Äã</button>‚Äã<button class=‚Äã"icon edit-item" title=‚Äã"Edit URL" aria-haspopup=‚Äã"dialog" type=‚Äã"button">‚Äã</button>‚Äã</td>‚Äã<td>‚Äã<a class=‚Äã"url " href=‚Äã"https:‚Äã/‚Äã/‚Äãwww.springsteenlyrics.com/‚Äãbootlegs.php?item=5013" rel=‚Äã"noreferrer" target=‚Äã"_blank" style=‚Äã"overflow-wrap:‚Äã anywhere;‚Äã">‚Äãhttps://www.springsteenlyrics.com/bootlegs.php?item=5013‚Äã</a>‚Äã</td>‚Äã</tr>
#+end_example

*** 3

#+begin_example
[MB-Discography-AutoSelect] Container found, starting observer.
userscript.html?name=MusicBrainz%253A-Auto-Select-Discography-Link-Type.user.js&id=d3b2b758-fc84-4cd6-9a84-c415fde438ca:21 [MB-Discography-AutoSelect] Cleaned URL on paste: https://www.springsteenlyrics.com/bootlegs.php?item=5013
userscript.html?name=MusicBrainz%253A-Auto-Select-Discography-Link-Type.user.js&id=d3b2b758-fc84-4cd6-9a84-c415fde438ca:21 [MB-Discography-AutoSelect] Found select element: <select class=‚Äã"link-type">‚Äã<option value>‚Äã&nbsp;‚Äã</option>‚Äãslot<option value=‚Äã"288">‚Äãdiscography entry‚Äã</option>‚Äãslot<option value=‚Äã"301">‚Äãlicense‚Äã</option>‚Äãslot<option disabled value=‚Äã"73">‚Äãget the music‚Äã</option>‚Äãslot<option value=‚Äã"79">‚Äã&nbsp;&nbsp;purchase for mail-order‚Äã</option>‚Äãslot<option value=‚Äã"74">‚Äã&nbsp;&nbsp;purchase for download‚Äã</option>‚Äãslot<option value=‚Äã"75">‚Äã&nbsp;&nbsp;download for free‚Äã</option>‚Äãslot<option value=‚Äã"85">‚Äã&nbsp;&nbsp;stream for free‚Äã</option>‚Äãslot<option value=‚Äã"980">‚Äã&nbsp;&nbsp;streaming page‚Äã</option>‚Äãslot<option value=‚Äã"906">‚Äãcrowdfunding page‚Äã</option>‚Äãslot<option value=‚Äã"729">‚Äãshow notes‚Äã</option>‚Äãslot<option value=‚Äã"78">‚Äãcover art‚Äã</option>‚Äãslot</select>
userscript.html?name=MusicBrainz%253A-Auto-Select-Discography-Link-Type.user.js&id=d3b2b758-fc84-4cd6-9a84-c415fde438ca:21 [MB-Discography-AutoSelect] Could not find a.url or a[href] in previous sibling row <tr class=‚Äã"external-link-item" id=‚Äã"external-link-0">‚Äã<td>‚Äã<span class=‚Äã"favicon no-favicon">‚Äã</span>‚Äã</td>‚Äã<td class=‚Äã"link-actions">‚Äã<button class=‚Äã"nobutton icon remove-item" data-index=‚Äã"0" title=‚Äã"Remove link" type=‚Äã"button">‚Äã</button>‚Äã<button class=‚Äã"icon edit-item" title=‚Äã"Edit URL" aria-haspopup=‚Äã"dialog" type=‚Äã"button">‚Äã</button>‚Äã</td>‚Äã<td>‚Äã<a class=‚Äã"url " href=‚Äã"https:‚Äã/‚Äã/‚Äãwww.springsteenlyrics.com/‚Äãbootlegs.php?item=5013" rel=‚Äã"noreferrer" target=‚Äã"_blank" style=‚Äã"overflow-wrap:‚Äã anywhere;‚Äã">‚Äãhttps://www.springsteenlyrics.com/bootlegs.php?item=5013‚Äã</a>‚Äã</td>‚Äã</tr>
#+end_example

*** 4

No nothing. This should actually be trivial to implement. As soon as a complete valid URL is entered, the React UI pop-ups
after the URL input area the following pull-down list, with the following HTML code

#+begin_example
<td><div class="relationship-content "><label>Type:</label><label class="relationship-name"><select class="link-type"><option value="">&nbsp;</option><option value="288">discography entry</option><option value="301">license</option><option disabled="" value="73">get the music</option><option value="79">&nbsp;&nbsp;purchase for mail-order</option><option value="74">&nbsp;&nbsp;purchase for download</option><option value="75">&nbsp;&nbsp;download for free</option><option value="85">&nbsp;&nbsp;stream for free</option><option value="980">&nbsp;&nbsp;streaming page</option><option value="906">crowdfunding page</option><option value="729">show notes</option><option value="78">cover art</option></select></label></div><div class="error field-error" data-visible="1">Please select a link type for the URL you‚Äôve entered.</div></td>
#+end_example

*** 5

Still nothing

#+begin_example
[MB-Discography-AutoSelect] Container found, starting observer.
userscript.html?name=MusicBrainz%253A-Auto-Select-Discography-Link-Type.user.js&id=d3b2b758-fc84-4cd6-9a84-c415fde438ca:23 [MB-Discography-AutoSelect] Found select element: <select class=‚Äã"link-type">‚Äã‚Ä¶‚Äã</select>
userscript.html?name=MusicBrainz%253A-Auto-Select-Discography-Link-Type.user.js&id=d3b2b758-fc84-4cd6-9a84-c415fde438ca:23 [MB-Discography-AutoSelect] [Polling failed] Could not find anchor tag (a[href]) after 50 attempts. external-link-0
#+end_example

Try implementing the following. After pasting the URL (eventually stripped), emulate two times "Tab", to reach the Pull-down list, and then select the very first element which is "discography entry"

*** 6

This finally works.
Emulate switching out of the current URL input field and move to the next one which gets generated after the current one

*** 7

Yes, thanx, this finally works.

Now please add support for pasting URLs of the following type (when they start with)

 - https://nugs.net/

then choose the option after switching to the pull-downlist which says:

#+begin_example
      <option value="74">&nbsp;&nbsp;purchase for download</option>
#+end_example

*** 8

Please add a new button right after the '<legend>External links</legend>' in the following part of the page

#+begin_example
<fieldset class="information">
    <legend>External links</legend>
      <div id="external-links-editor-container"><table class="row-form" id="external-links-editor"><tbody><tr class="external-link-item" id="external-link-0"><td><span class="favicon no-favicon"></span></td><td class="link-actions"><button class="nobutton icon remove-item" data-index="0" title="Remove link" type="button"></button><button class="icon edit-item" title="Edit URL" aria-haspopup="dialog" type="button"></button></td><td><a class="url " href="https://www.jungleland.it/html/19810123_2.htm" rel="noreferrer" target="_blank" style="overflow-wrap: anywhere;">https://www.jungleland.it/html/19810123_2.htm</a></td></tr><tr class="relationship-item"><td></td><td class="link-actions"><button class="icon edit-item" title="Edit attributes" aria-haspopup="dialog" type="button"></button></td><td><div class="relationship-content "><label>Type:</label><label class="relationship-name"><select class="link-type"><option value="">&nbsp;</option><option value="288">discography entry</option><option value="301">license</option><option disabled="" value="73">get the music</option><option value="79">&nbsp;&nbsp;purchase for mail-order</option><option value="74">&nbsp;&nbsp;purchase for download</option><option value="75">&nbsp;&nbsp;download for free</option><option value="85">&nbsp;&nbsp;stream for free</option><option value="980">&nbsp;&nbsp;streaming page</option><option value="906">crowdfunding page</option><option value="729">show notes</option><option value="78">cover art</option></select><span class="tooltip-wrapper"><span class="img icon help" style="display: inline-block; margin-left: 10px; vertical-align: text-top;"></span><span class="tooltip-container"><span class="tooltip-triangle"></span><span class="tooltip-content"><div style="text-align: left;">This link points to a page for a particular release within a discography for an artist or label. (<a href="/relationship/823656dd-0309-4247-b282-b92d287d59c5">more documentation</a>)</div></span></span></span></label></div></td></tr><tr class="add-relationship"><td></td><td></td><td class="add-item"><button class="add-item with-label" type="button">Add another relationship</button></td></tr><tr class="external-link-item" id="external-link-1"><td><span class="favicon no-favicon"></span></td><td class="link-actions"><button class="nobutton icon remove-item" data-index="1" title="Remove link" type="button"></button><button class="icon edit-item" title="Edit URL" aria-haspopup="dialog" type="button"></button></td><td><a class="url " href="https://www.springsteenlyrics.com/bootlegs.php?item=5013" rel="noreferrer" target="_blank" style="overflow-wrap: anywhere;">https://www.springsteenlyrics.com/bootlegs.php?item=5013</a></td></tr><tr class="relationship-item"><td></td><td class="link-actions"><button class="icon edit-item" title="Edit attributes" aria-haspopup="dialog" type="button"></button></td><td><div class="relationship-content "><label>Type:</label><label class="relationship-name"><select class="link-type"><option value="">&nbsp;</option><option value="288">discography entry</option><option value="301">license</option><option disabled="" value="73">get the music</option><option value="79">&nbsp;&nbsp;purchase for mail-order</option><option value="74">&nbsp;&nbsp;purchase for download</option><option value="75">&nbsp;&nbsp;download for free</option><option value="85">&nbsp;&nbsp;stream for free</option><option value="980">&nbsp;&nbsp;streaming page</option><option value="906">crowdfunding page</option><option value="729">show notes</option><option value="78">cover art</option></select><span class="tooltip-wrapper"><span class="img icon help" style="display: inline-block; margin-left: 10px; vertical-align: text-top;"></span><span class="tooltip-container"><span class="tooltip-triangle"></span><span class="tooltip-content"><div style="text-align: left;">This link points to a page for a particular release within a discography for an artist or label. (<a href="/relationship/823656dd-0309-4247-b282-b92d287d59c5">more documentation</a>)</div></span></span></span></label></div></td></tr><tr class="add-relationship"><td></td><td></td><td class="add-item"><button class="add-item with-label" type="button">Add another relationship</button></td></tr><tr class="external-link-item" id="external-link-2"><td><span class="favicon no-favicon"></span></td><td class="link-actions"><button class="nobutton icon remove-item" data-index="2" title="Remove link" type="button"></button><button class="icon edit-item" title="Edit URL" aria-haspopup="dialog" type="button"></button></td><td><a class="url " href="https://nugs.net/" rel="noreferrer" target="_blank" style="overflow-wrap: anywhere;">https://nugs.net/</a></td></tr><tr class="relationship-item"><td></td><td class="link-actions"><button class="icon edit-item" title="Edit attributes" aria-haspopup="dialog" type="button"></button></td><td><div class="relationship-content "><label>Type:</label><label class="relationship-name"><select class="link-type"><option value="">&nbsp;</option><option value="288">discography entry</option><option value="301">license</option><option disabled="" value="73">get the music</option><option value="79">&nbsp;&nbsp;purchase for mail-order</option><option value="74">&nbsp;&nbsp;purchase for download</option><option value="75">&nbsp;&nbsp;download for free</option><option value="85">&nbsp;&nbsp;stream for free</option><option value="980">&nbsp;&nbsp;streaming page</option><option value="906">crowdfunding page</option><option value="729">show notes</option><option value="78">cover art</option></select><span class="tooltip-wrapper"><span class="img icon help" style="display: inline-block; margin-left: 10px; vertical-align: text-top;"></span><span class="tooltip-container"><span class="tooltip-triangle"></span><span class="tooltip-content"><div style="text-align: left;">This is used to link to a page where the release can be purchased for download. (<a href="/relationship/98e08c20-8402-4163-8970-53504bb6a1e4">more documentation</a>)</div></span></span></span></label></div></td></tr><tr class="add-relationship"><td></td><td></td><td class="add-item"><button class="add-item with-label" type="button">Add another relationship</button></td></tr><tr class="external-link-item" id="external-link-3"><td><span class="favicon no-favicon"></span></td><td class="link-actions"><button class="nobutton icon remove-item" data-index="3" title="Remove link" type="button"></button><button class="icon edit-item" title="Edit URL" aria-haspopup="dialog" type="button"></button></td><td><a class="url " href="https://volkerzell.de/" rel="noreferrer" target="_blank" style="overflow-wrap: anywhere;">https://volkerzell.de/</a></td></tr><tr class="relationship-item"><td></td><td class="link-actions"><button class="icon edit-item" title="Edit attributes" aria-haspopup="dialog" type="button"></button></td><td><div class="relationship-content "><label>Type:</label><label class="relationship-name"><select class="link-type"><option value="">&nbsp;</option><option value="288">discography entry</option><option value="301">license</option><option disabled="" value="73">get the music</option><option value="79">&nbsp;&nbsp;purchase for mail-order</option><option value="74">&nbsp;&nbsp;purchase for download</option><option value="75">&nbsp;&nbsp;download for free</option><option value="85">&nbsp;&nbsp;stream for free</option><option value="980">&nbsp;&nbsp;streaming page</option><option value="906">crowdfunding page</option><option value="729">show notes</option><option value="78">cover art</option></select></label></div><div class="error field-error" data-visible="1">Please select a link type for the URL you‚Äôve entered.</div></td></tr><tr class="add-relationship"><td></td><td></td><td class="add-item"><button class="add-item with-label" type="button">Add another relationship</button></td></tr><tr class="external-link-item" id="external-link-4"><td></td><td class="link-actions"></td><td><input class="value with-button" data-index="4" placeholder="Add another link" type="url" value=""></td></tr></tbody></table></div>
  </fieldset>
#+end_example

with the button text "‚öôÔ∏è Configure external\nlink mappings".

When pressed present an UI which which it should be possible to configure the currently hardcoded variables

#+begin_example
    const REGEX_SPRINGSTEEN = /^(https?:\/\/www\.springsteenlyrics\.com\/bootlegs\.php\?item=\d+)(&.*)?$/i;
    const REGEX_JUNGLELAND = /^https?:\/\/www\.jungleland\.it\/html\/.*\.htm$/i;
    const REGEX_NUGS = /^https?:\/\/nugs\.net\//i; // New regex for Nugs.net
#+end_example

in kind of like an association table "URL ==> Type, like the following

#+begin_example
/^(https?:\/\/www\.springsteenlyrics\.com\/bootlegs\.php\?item=\d+)(&.*)?$/i ==> "discography entry"
/^https?:\/\/www\.jungleland\.it\/html\/.*\.htm$/i ==> "discography entry"
/^https?:\/\/nugs\.net\//i; "&nbsp;&nbsp;purchase for download"
#+end_example

Initially this new associaten variable should consist of the above 3 entries.
But it should be possible to add new and remove existing entries from the structure and persist the resulting data to
browser storage, so that different kind of users (which use different mappings) are supported.

When adding a new entry (or editing an already existing entry) the "Type" choices should only be from the following list options

#+begin_example
      <option value="288">discography entry</option>
      <option value="301">license</option>
      <option disabled="" value="73">get the music</option>
      <option value="79">&nbsp;&nbsp;purchase for mail-order</option>
      <option value="74">&nbsp;&nbsp;purchase for download</option>
      <option value="75">&nbsp;&nbsp;download for free</option>
      <option value="85">&nbsp;&nbsp;stream for free</option>
      <option value="980">&nbsp;&nbsp;streaming page</option>
      <option value="906">crowdfunding page</option>
      <option value="729">show notes</option>
      <option value="78">cover art</option>
#+end_example

*** 2

First of all a couple of observations:

1.) The "‚öôÔ∏è Configure external\nlink mappings" button is there, but under a different container, called "Additional Information" which is a container above our "External Links" container
2.) The button is not really a button , but a clickable text (except the icon is there): it should be a butten with an icon and text, and the mouse curser should change to a finger when hovering over it
3.) The resulting dialog which pops-up when pressing the "‚öôÔ∏è Configure external\nlink mappings" button has the same problem with the "Add New Mapping" button which is clickable but only a text only button
    It gives an error when clicking. Here the console output:

#+begin_example
[MB-Discography-AutoSelect] Container found, starting observer.
userscript.html?name=MusicBrainz%253A-Auto-Select-Discography-Link-Type.user.js&id=d3b2b758-fc84-4cd6-9a84-c415fde438ca:328 Uncaught TypeError: Cannot set properties of null (setting 'onclick')
    at openEditModal (userscript.html?name=MusicBrainz%253A-Auto-Select-Discography-Link-Type.user.js&id=d3b2b758-fc84-4cd6-9a84-c415fde438ca:328:59)
    at addButton.onclick (userscript.html?name=MusicBrainz%253A-Auto-Select-Discography-Link-Type.user.js&id=d3b2b758-fc84-4cd6-9a84-c415fde438ca:269:35)
#+end_example

4.) The already existing three mappings are NOT completely editable, you onyl can delet one by one by clicking the red (x) button under the Actions column

Please fix..

*** 3

Yes this works now.

A couple more things are left:

1.) The text based button "Add New Mapping" in the "MusicBrainz Auto-Select Configuration" dialog should also be a real button with text on it, like the "Close" button in the same dialog
2.) We should be able to also edit the already existing entries, not just "Remove" them by clicking the red "x" under the actions column

*** 4

The "Add New Mapping" button is now OK.

But it's still NOT possible to edit existing entries, undly the "(x)"-Remove is present under the actions column

*** 5

Still nothing. Onyl the "Delete" button present, the "Edit" button is somehow NOT rendered.

This is the actual HTML which gets generated

#+begin_example
<div style="background: white; padding: 20px; border-radius: 5px; box-shadow: rgba(0, 0, 0, 0.5) 0px 5px 15px; width: 80%; max-width: 1000px; margin-top: 50px; max-height: 80vh; overflow-y: auto;">
            <h1 style="border-bottom: 1px solid #ccc; padding-bottom: 10px;">MusicBrainz Auto-Select Configuration</h1>
            <p>Define custom Regular Expressions to automatically select a link type when a matching URL is pasted.</p>
            <div id="mb-autosel-modal-content"><table class="tbl" style="width: 100%;">
            <thead>
                <tr>
                    <th>URL Regex Pattern</th>
                    <th style="width: 150px;">Maps To (Type ID)</th>
                    <th style="width: 250px;">Description (Optional)</th>
                    <th style="width: 100px;">Actions</th>
                </tr>
            </thead>
            <tbody><tr>
                <td style="font-family: monospace; font-size: 0.9em; max-width: 300px; word-break: break-all; vertical-align: top; padding-right: 10px;">^(https?://www\.springsteenlyrics\.com/bootlegs\.php\?item=\d+)(&amp;.*)?$</td>
                <td style="vertical-align: top;">discography entry (288)</td>
                <td style="vertical-align: top;">SpringsteenLyrics bootleg entry (cleaned)</td>
                <td style="vertical-align: top;">
                    <button class="nobutton icon edit-item" type="button" data-index="0" title="Edit"></button>
                    <button class="nobutton icon remove-item" type="button" data-index="0" title="Delete"></button>
                </td>
            </tr><tr>
                <td style="font-family: monospace; font-size: 0.9em; max-width: 300px; word-break: break-all; vertical-align: top; padding-right: 10px;">^https?://www\.jungleland\.it/html/.*\.htm$</td>
                <td style="vertical-align: top;">discography entry (288)</td>
                <td style="vertical-align: top;">Jungleland discography page</td>
                <td style="vertical-align: top;">
                    <button class="nobutton icon edit-item" type="button" data-index="1" title="Edit"></button>
                    <button class="nobutton icon remove-item" type="button" data-index="1" title="Delete"></button>
                </td>
            </tr><tr>
                <td style="font-family: monospace; font-size: 0.9em; max-width: 300px; word-break: break-all; vertical-align: top; padding-right: 10px;">^https?://nugs\.net/</td>
                <td style="vertical-align: top;">purchase for download (74)</td>
                <td style="vertical-align: top;">Nugs.net primary URL</td>
                <td style="vertical-align: top;">
                    <button class="nobutton icon edit-item" type="button" data-index="2" title="Edit"></button>
                    <button class="nobutton icon remove-item" type="button" data-index="2" title="Delete"></button>
                </td>
            </tr><tr>
                <td style="font-family: monospace; font-size: 0.9em; max-width: 300px; word-break: break-all; vertical-align: top; padding-right: 10px;">https://volkerzell.de/</td>
                <td style="vertical-align: top;">cover art (78)</td>
                <td style="vertical-align: top;">my homepage</td>
                <td style="vertical-align: top;">
                    <button class="nobutton icon edit-item" type="button" data-index="3" title="Edit"></button>
                    <button class="nobutton icon remove-item" type="button" data-index="3" title="Delete"></button>
                </td>
            </tr></tbody>
        </table><button class="submit" type="button" style="margin-top: 15px;">Add New Mapping</button></div>
            <div style="padding-top: 20px; text-align: right;">
                <button id="closeModalButton" class="submit" type="button">Close</button>
            </div>
        </div>
#+end_example

*** 6

Yes, thx it finally works, the buttons are there.

Please add now the latest bit:

When pressing the "Esc" key in the UI dialogs, the dialogs should just close (if nothing has changed), otherwise ask for confirmation.

*** 7

One last glich. When the "Add New Mapping" dialog is opend from the first dialog "MusicBrainz Auto-Select
Configuration", pressing "Esc" closes both dialogs, but instead only the "Add New Mapping" dialog should be closed.

*** rewrite regexp

Rewrite the following regexp in userscripts

^(https://www\\.springsteenlyrics\\.com/bootlegs\\.php\\?item=\\d+)(&.*)?$

that the follwing to types of URLs should be matched

https://www.springsteenlyrics.com/bootlegs.php?item=3578&category=aud_live1995
https://www.springsteenlyrics.com/collection.php?item=9834&category=album

** ChatGPT
*** question

Write a Tampermonkey userscript when adding a new release to MusicBrainz on the URL

https://musicbrainz.org/release/add

with the following functionality:

When pasting a URL which starts with either

    - https://www.springsteenlyrics.com/bootlegs.php?item=<Item-ID>&category=<category> - <=== cut off everything after <Item-ID> before insertion
    - https://www.jungleland.it/html/<filename>.htm

into the text field 'placeholder="Add link"' which looks in HTML like this

#+begin_example
<fieldset class="information">
    <legend>External links</legend>
      <div id="external-links-editor-container"><table class="row-form" id="external-links-editor"><tbody><tr class="external-link-item" id="external-link-0"><td></td><td class="link-actions"></td><td><input class="value with-button" data-index="0" placeholder="Add link" type="url" value=""></td></tr></tbody></table></div>
  </fieldset>
#+end_example

then the React based Musicbrainz UI adds a new piece of HTML code

#+begin_example
<fieldset class="information">
    <legend>External links</legend>
      <div id="external-links-editor-container"><table class="row-form" id="external-links-editor"><tbody><tr class="external-link-item" id="external-link-0"><td><span class="favicon no-favicon"></span></td><td class="link-actions"><button class="nobutton icon remove-item" data-index="0" title="Remove link" type="button"></button><button class="icon edit-item" title="Edit URL" aria-haspopup="dialog" type="button"></button></td><td><a class="url " href="https://www.springsteenlyrics.com/bootlegs.php?item=5013" rel="noreferrer" target="_blank" style="overflow-wrap: anywhere;">https://www.springsteenlyrics.com/bootlegs.php?item=5013</a></td></tr><tr class="relationship-item"><td></td><td class="link-actions"><button class="icon edit-item" title="Edit attributes" aria-haspopup="dialog" type="button"></button></td><td><div class="relationship-content "><label>Type:</label><label class="relationship-name"><select class="link-type"><option value="">&nbsp;</option><option value="288">discography entry</option><option value="301">license</option><option disabled="" value="73">get the music</option><option value="79">&nbsp;&nbsp;purchase for mail-order</option><option value="74">&nbsp;&nbsp;purchase for download</option><option value="75">&nbsp;&nbsp;download for free</option><option value="85">&nbsp;&nbsp;stream for free</option><option value="980">&nbsp;&nbsp;streaming page</option><option value="906">crowdfunding page</option><option value="729">show notes</option><option value="78">cover art</option></select></label></div><div class="error field-error" data-visible="1">Please select a link type for the URL you‚Äôve entered.</div></td></tr><tr class="add-relationship"><td></td><td></td><td class="add-item"><button class="add-item with-label" type="button">Add another relationship</button></td></tr><tr class="external-link-item" id="external-link-1"><td></td><td class="link-actions"></td><td><input class="value with-button" data-index="1" placeholder="Add another link" type="url" value=""></td></tr></tbody></table></div>
  </fieldset>
#+end_example

and populates a "Type" list where the following entry should be selected

#+begin_example
<option value="288">discography entry</option>
#+end_example

**** solution

#+begin_example
// ==UserScript==
// @name         MB: Auto-select Discography Entry for Springsteen/Jungleland Links
// @namespace    https://musicbrainz.org/
// @version      1.0
// @description  Automatically selects "discography entry" (288) when adding SpringsteenLyrics or Jungleland links on add-release page.
// @match        https://musicbrainz.org/release/add*
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    // URL prefixes we care about
    const PREFIXES = [
        "https://www.springsteenlyrics.com/bootlegs.php?item=",
        "https://www.jungleland.it/html/"
    ];

    /** Determine whether URL matches our pattern */
    function matchesSource(url) {
        return PREFIXES.some(prefix => url.startsWith(prefix));
    }

    /** Find the "relationship-item" row following an accepted link row */
    function findRelationshipRow(linkURL) {
        const rows = document.querySelectorAll("#external-links-editor .external-link-item a.url");
        for (let a of rows) {
            if (a.href === linkURL) {
                const tr = a.closest("tr");
                if (tr && tr.nextElementSibling && tr.nextElementSibling.classList.contains("relationship-item")) {
                    return tr.nextElementSibling;
                }
            }
        }
        return null;
    }

    /** Try to set the dropdown to "discography entry" (value 288) */
    function setDiscographyEntry(relationshipRow) {
        const select = relationshipRow.querySelector("select.link-type");
        if (select) {
            select.value = "288";                  // Set selection
            select.dispatchEvent(new Event("change", { bubbles: true }));
        }
    }

    /** Handle URL paste into the input fields */
    function handlePaste(e) {
        const pasted = (e.clipboardData || window.clipboardData).getData("text").trim();
        if (!matchesSource(pasted)) return;       // Not our URL ‚Üí ignore

        // React will create the new rows shortly after paste
        // We retry every 150ms until the relationship row appears
        let attempts = 0;
        const MAX_ATTEMPTS = 40;

        const interval = setInterval(() => {
            attempts++;
            const row = findRelationshipRow(pasted);
            if (row) {
                clearInterval(interval);
                setDiscographyEntry(row);
            }
            if (attempts > MAX_ATTEMPTS) clearInterval(interval);
        }, 150);
    }

    /** Listen for paste on all dynamic link fields */
    function attachPasteListeners() {
        const container = document.querySelector("#external-links-editor");
        if (!container) return;

        container.addEventListener("paste", function (e) {
            if (e.target && e.target.matches("input[type='url']")) {
                handlePaste(e);
            }
        });
    }

    // Wait until the external-links table exists
    function waitForEditor() {
        if (document.querySelector("#external-links-editor")) {
            attachPasteListeners();
        } else {
            setTimeout(waitForEditor, 300);
        }
    }
    waitForEditor();
})();
#+end_example

Automatically remove trailing parameters from URLs
‚≠ê Auto-set additional relationship attributes
‚≠ê Support for more sites (e.g., setlist.fm, discogs bootlegs, etc.)
‚≠ê Visual highlight when auto-filled
‚≠ê Error logging overlay for debugging
   Retry loops for slow React rendering

**** 1

Nothing happens. Please include console logging information.

**** 2

Yes now it works.

Please add thus additional functionality

When pasting links of type

#+begin_example
https://www.springsteenlyrics.com/bootlegs.php?item=<Item-ID>&category=<category>
#+end_example

cut off everything after <Item-ID>

**** 3

Still not working, it somehow doubles the URL input "value=‚Äã"https:‚Äã/‚Äã/‚Äãwww.springsteenlyrics.com/‚Äãbootlegs.php?item=5013https:‚Äã/‚Äã/‚Äãwww.springsteenlyrics.com/‚Äãbootlegs.php?item=5013&category=aud_live1980"

#+begin_example
MusicBrainz Quick Tools Debug: Initializing MutationObserver on the #recordings element's attributes.
userscript.html?name=MB%253A-Auto-select-Discography-Entry-%252B-URL-Cleanup-robust.user.js&id=96295f6f-8c71-4e8f-b98d-c0a124c89bdf:221 [MB-AutoLinkType] Detected #external-links-editor via MutationObserver.
userscript.html?name=MB%253A-Auto-select-Discography-Entry-%252B-URL-Cleanup-robust.user.js&id=96295f6f-8c71-4e8f-b98d-c0a124c89bdf:197 [MB-AutoLinkType] Attaching delegated paste listener.
userscript.html?name=MB%253A-Auto-select-Discography-Entry-%252B-URL-Cleanup-robust.user.js&id=96295f6f-8c71-4e8f-b98d-c0a124c89bdf:234 [MB-AutoLinkType] Detected #external-links-editor via fallback poll.
userscript.html?name=MB%253A-Auto-select-Discography-Entry-%252B-URL-Cleanup-robust.user.js&id=96295f6f-8c71-4e8f-b98d-c0a124c89bdf:204 [MB-AutoLinkType] paste event received on input: <input class=‚Äã"value with-button" data-index=‚Äã"0" placeholder type=‚Äã"url" value=‚Äã"https:‚Äã/‚Äã/‚Äãwww.springsteenlyrics.com/‚Äãbootlegs.php?item=5013https:‚Äã/‚Äã/‚Äãwww.springsteenlyrics.com/‚Äãbootlegs.php?item=5013&category=aud_live1980">
userscript.html?name=MB%253A-Auto-select-Discography-Entry-%252B-URL-Cleanup-robust.user.js&id=96295f6f-8c71-4e8f-b98d-c0a124c89bdf:33 [MB-AutoLinkType] Normalized SpringsteenLyrics URL: https://www.springsteenlyrics.com/bootlegs.php?item=5013
userscript.html?name=MB%253A-Auto-select-Discography-Entry-%252B-URL-Cleanup-robust.user.js&id=96295f6f-8c71-4e8f-b98d-c0a124c89bdf:137 [MB-AutoLinkType] Target URL pasted (normalized): https://www.springsteenlyrics.com/bootlegs.php?item=5013
userscript.html?name=MB%253A-Auto-select-Discography-Entry-%252B-URL-Cleanup-robust.user.js&id=96295f6f-8c71-4e8f-b98d-c0a124c89bdf:147 [MB-AutoLinkType] Wrote normalized URL back into input.
userscript.html?name=MB%253A-Auto-select-Discography-Entry-%252B-URL-Cleanup-robust.user.js&id=96295f6f-8c71-4e8f-b98d-c0a124c89bdf:161 [MB-AutoLinkType] Waiting for relationship row (polling up to 24s).
userscript.html?name=MB%253A-Auto-select-Discography-Entry-%252B-URL-Cleanup-robust.user.js&id=96295f6f-8c71-4e8f-b98d-c0a124c89bdf:176 [MB-AutoLinkType] Timeout waiting for relationship row for URL: https://www.springsteenlyrics.com/bootlegs.php?item=5013
(anonymous) @ console.js:36
(anonymous) @ userscript.html?name=MB%253A-Auto-select-Discography-Entry-%252B-URL-Cleanup-robust.user.js&id=96295f6f-8c71-4e8f-b98d-c0a124c89bdf:176
r @ helpers.js:97
setInterval
(anonymous) @ trycatch.js:106
handlePasteEvent @ userscript.html?name=MB%253A-Auto-select-Discography-Entry-%252B-URL-Cleanup-robust.user.js&id=96295f6f-8c71-4e8f-b98d-c0a124c89bdf:163
container.addEventListener.capture @ userscript.html?name=MB%253A-Auto-select-Discography-Entry-%252B-URL-Cleanup-robust.user.js&id=96295f6f-8c71-4e8f-b98d-c0a124c89bdf:205
r @ helpers.js:97
#+end_example


* Customizable multi select
** Gemini

The old uploaded userscripts for refactoring had an implementation with a function like

#+begin_example
    function showSettingsDialog(type, availableOptions, selectedOptions) {
        // Create and style the dialog
        const dialog = document.createElement('div');
        dialog.style.position = 'fixed';
        dialog.style.top = '50%';
        dialog.style.left = '50%';
        dialog.style.transform = 'translate(-50%, -50%)';
        dialog.style.zIndex = '10000';
        dialog.style.backgroundColor = 'white';
        dialog.style.padding = '20px';
        dialog.style.borderRadius = '8px';
        dialog.style.boxShadow = '0 4px 8px rgba(0,0,0,0.2)';
        dialog.style.width = '400px';
        dialog.style.maxHeight = '80vh';
        dialog.style.overflowY = 'auto';

        // Create a header
        const header = document.createElement('h3');
        header.textContent = 'Customize Packaging Button';
        header.style.marginTop = '0';
        header.style.marginBottom = '15px';
        dialog.appendChild(header);

        // Create description
        const description = document.createElement('p');
        description.textContent = `Select which ${type} you want to appear as quick buttons:`;
        dialog.appendChild(description);

        // Create the options list
        const optionsContainer = document.createElement('div');
        optionsContainer.style.maxHeight = '300px';
        optionsContainer.style.overflowY = 'auto';
        optionsContainer.style.border = '1px solid #eee';
        optionsContainer.style.padding = '10px';
        optionsContainer.style.marginBottom = '15px';

        // Sort options alphabetically
        availableOptions.sort();

        // Create checkboxes for all available options
        availableOptions.forEach(option => {
            const optionLabel = document.createElement('label');
            optionLabel.style.display = 'block';
            optionLabel.style.marginBottom = '5px';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.value = option;
            checkbox.checked = selectedOptions.includes(option);
            checkbox.style.marginRight = '5px';

            optionLabel.appendChild(checkbox);
            optionLabel.appendChild(document.createTextNode(option));
            optionsContainer.appendChild(optionLabel);
        });

        dialog.appendChild(optionsContainer);

        // Create buttons
        const buttonContainer = document.createElement('div');
        buttonContainer.style.display = 'flex';
        buttonContainer.style.justifyContent = 'space-between';

        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'Cancel';
        cancelButton.style.padding = '6px 12px';
        cancelButton.style.border = '1px solid #ccc';
        cancelButton.style.borderRadius = '4px';
        cancelButton.style.backgroundColor = '#f8f8f8';
        cancelButton.style.cursor = 'pointer';

        const saveButton = document.createElement('button');
        saveButton.textContent = 'Save';
        saveButton.style.padding = '6px 12px';
        saveButton.style.border = '1px solid #4CAF50';
        saveButton.style.borderRadius = '4px';
        saveButton.style.backgroundColor = '#4CAF50';
        saveButton.style.color = 'white';
        saveButton.style.cursor = 'pointer';

        buttonContainer.appendChild(cancelButton);
        buttonContainer.appendChild(saveButton);
        dialog.appendChild(buttonContainer);

        // Create overlay
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0,0,0,0.5)';
        overlay.style.zIndex = '9999';

        // Add to document
        document.body.appendChild(overlay);
        document.body.appendChild(dialog);

        // Handle cancel
        cancelButton.addEventListener('click', function() {
            document.body.removeChild(overlay);
            document.body.removeChild(dialog);
        });

        // Handle save
        saveButton.addEventListener('click', function() {
            const newSelection = [];
            const checkboxes = optionsContainer.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    newSelection.push(checkbox.value);
                }
            });

            preferredPackaging = newSelection;
            GM_setValue('mbPackaging', newSelection);

            document.body.removeChild(overlay);
            document.body.removeChild(dialog);

            // Reload the page to apply changes
            location.reload();
        });
    }
#+end_example

Please reinstantiate this behaviour

** 2

Please analyze the uploaded script to include it's functionality in our script

** 3

Make sure the script also works on

#+begin_src bash
https://musicbrainz.org/work/create
#+end_src

Where the element where "languages" can be selected is called "Lyrics languages" instead of just "Language" on the
https://musicbrainz.org/release/create pages

** 4

It's not yet working on "work" pages.

Here is the HTML code for the "https://musicbrainz.org/work/create" page

#+begin_example
<fieldset>
      <legend>Work details</legend>      <div class="row">

    <label class="required" for="id-edit-work.name" id="label-id-edit-work.name">Name:</label>
    <input class="with-guesscase" id="id-edit-work.name" name="edit-work.name" required="required" type="text" value="" style="">
    <button type="button" class="guesscase-title icon" title="Guess case"></button>    <button type="button" class="guesscase-options icon" title="Guess case options"></button>


    </div>
        <div class="row">

      <label for="id-edit-work.comment" id="label-id-edit-work.comment">Disambiguation:</label>
      <input class="with-guesscase" id="id-edit-work.comment" name="edit-work.comment" size="47" type="text" value="">


     <button class="icon guess-punctuation" type="button" title="Guess punctuation"></button></div>
        <div class="row">

      <label class="" for="id-edit-work.type_id" id="label-id-edit-work.type_id">Type:</label>
      <select class="" id="id-edit-work.type_id" name="edit-work.type_id"><option selected="selected">&nbsp;</option><option value="17">Song</option><option value="1">Aria</option><option value="25">Audio drama</option><option value="2">Ballet</option><option value="26">Beijing opera</option><option value="3">Cantata</option><option value="4">Concerto</option><option value="20">√âtude</option><option value="30">Incidental music</option><option value="7">Madrigal</option><option value="8">Mass</option><option value="9">Motet</option><option value="29">Musical</option><option value="10">Opera</option><option value="24">Operetta</option><option value="11">Oratorio</option><option value="12">Overture</option><option value="13">Partita</option><option value="28">Play</option><option value="21">Poem</option><option value="23">Prose</option><option value="14">Quartet</option><option value="5">Sonata</option><option value="15">Song-cycle</option><option value="22">Soundtrack</option><option value="6">Suite</option><option value="18">Symphonic poem</option><option value="16">Symphony</option><option value="19">Zarzuela</option></select>

    </div>      <div id="work-languages-editor"><div class="row"><label>Lyrics languages:</label><div style="margin: 10px 0px; display: flex; align-items: center; flex-wrap: wrap; gap: 6px;"><strong>Quick add:</strong><button type="button" style="margin-right: 8px; padding: 4px 10px; background-color: rgb(238, 238, 238); border: 1px solid rgb(204, 204, 204); border-radius: 4px; cursor: pointer; font-size: 12px;">English</button><button type="button" style="margin-right: 8px; padding: 4px 10px; background-color: rgb(238, 238, 238); border: 1px solid rgb(204, 204, 204); border-radius: 4px; cursor: pointer; font-size: 12px;">‚öôÔ∏è</button></div><div class="form-row-select-list"><div class="select-list-row"><select class="with-button" id="id-edit-work.languages.0" name="edit-work.languages.0"><option value="">&nbsp;</option><optgroup label="Frequently used"><option value="284">[Multiple languages]</option><option value="486">[No lyrics]</option><option value="18">Arabic</option><option value="76">Chinese</option><option value="113">Dutch</option><option value="120">English</option><option value="131">Finnish</option><option value="134">French</option><option value="145">German</option><option value="167">Hebrew</option><option value="171">Hindi</option><option value="195">Italian</option><option value="198">Japanese</option><option value="224">Korean</option><option value="309">Norwegian</option><option value="338">Polish</option><option value="340">Portuguese</option><option value="353">Russian</option><option value="393">Spanish</option><option value="403">Swedish</option><option value="433">Turkish</option></optgroup><optgroup label="Other"><option value="24">[Artificial (Other)]</option><option value="2">Abkhazian</option><option value="3">Achinese</option><option value="4">Acoli</option><option value="5">Adangme</option><option value="6">Adyghe</option><option value="1">Afar</option><option value="8">Afrihili</option><option value="9">Afrikaans</option><option value="473">Ainu</option><option value="10">Akan</option><option value="11">Akkadian</option><option value="12">Albanian</option><option value="13">Aleut</option><option value="709">Algonquin</option><option value="15">Amharic</option><option value="475">Angika</option><option value="20">Aragonese</option><option value="23">Arapaho</option><option value="25">Arawak</option><option value="5403">ArdhamƒÅgadhƒ´ PrƒÅkrit</option><option value="21">Armenian</option><option value="479">Aromanian</option><option value="26">Assamese</option><option value="27">Asturian</option><option value="866">Atikamekw</option><option value="30">Avaric</option><option value="31">Avestan</option><option value="32">Awadhi</option><option value="33">Aymara</option><option value="34">Azerbaijani</option><option value="1470">Baeggu</option><option value="40">Balinese</option><option value="38">Baluchi</option><option value="39">Bambara</option><option value="42">Basa</option><option value="37">Bashkir</option><option value="41">Basque</option><option value="982">Bavarian</option><option value="44">Beja</option><option value="45">Belarusian</option><option value="46">Bemba</option><option value="47">Bengali</option><option value="49">Bhojpuri</option><option value="51">Bikol</option><option value="52">Bini</option><option value="53">Bislama</option><option value="64">Blin</option><option value="1394">Bodo (India)</option><option value="56">Bosnian</option><option value="57">Braj</option><option value="58">Breton</option><option value="1322">Buamu</option><option value="61">Buginese</option><option value="62">Bulgarian</option><option value="60">Buriat</option><option value="63">Burmese</option><option value="1406">Burushaski</option><option value="65">Caddo</option><option value="2311">Cajun French</option><option value="68">Catalan</option><option value="70">Cebuano</option><option value="7217">Celtiberian</option><option value="5809">Central Okinawan</option><option value="2243">Central Yupik</option><option value="75">Chagatai</option><option value="72">Chamorro</option><option value="74">Chechen</option><option value="82">Cherokee</option><option value="85">Cheyenne</option><option value="73">Chibcha</option><option value="313">Chichewa</option><option value="79">Chinook jargon</option><option value="81">Chipewyan</option><option value="80">Choctaw</option><option value="83">Church Slavic</option><option value="77">Chuukese</option><option value="84">Chuvash</option><option value="87">Coptic</option><option value="88">Cornish</option><option value="89">Corsican</option><option value="93">Cree</option><option value="286">Creek</option><option value="94">Crimean Tatar</option><option value="366">Croatian</option><option value="7303">Cuneiform Luwian</option><option value="98">Czech</option><option value="99">Dakota</option><option value="100">Danish</option><option value="101">Dargwa</option><option value="103">Delaware</option><option value="106">Dinka</option><option value="107">Divehi</option><option value="108">Dogri</option><option value="105">Dogrib</option><option value="111">Duala</option><option value="112">Dutch, Middle (ca.1050-1350)</option><option value="114">Dyula</option><option value="115">Dzongkha</option><option value="584">Eastern Arrernte</option><option value="116">Efik</option><option value="117">Egyptian (Ancient)</option><option value="118">Ekajuk</option><option value="119">Elamite</option><option value="121">English, Middle (1100-1500)</option><option value="16">English, Old (ca.450-1100)</option><option value="290">Erzya</option><option value="122">Esperanto</option><option value="123">Estonian</option><option value="124">Ewe</option><option value="125">Ewondo</option><option value="126">Fang</option><option value="128">Fanti</option><option value="127">Faroese</option><option value="129">Fijian</option><option value="130">Filipino</option><option value="133">Fon</option><option value="136">French, Old (842-ca.1400)</option><option value="485">Frisian, Eastern</option><option value="484">Frisian, Northern</option><option value="137">Frisian, Western</option><option value="139">Friulian</option><option value="138">Fulah</option><option value="140">Ga</option><option value="67">Galibi Carib</option><option value="150">Galician</option><option value="249">Ganda</option><option value="1591">Garifuna</option><option value="141">Gayo</option><option value="142">Gbaya</option><option value="146">Geez</option><option value="144">Georgian</option><option value="299">German, Low</option><option value="152">German, Middle High (ca.1050-1500)</option><option value="153">German, Old High (ca.750-1050)</option><option value="476">German, Swiss</option><option value="147">Gilbertese</option><option value="154">Gondi</option><option value="155">Gorontalo</option><option value="156">Gothic</option><option value="157">Grebo</option><option value="159">Greek</option><option value="158">Greek, Ancient</option><option value="204">Greenlandic</option><option value="2534">Gronings</option><option value="2386">Guadeloupean Creole French</option><option value="160">Guarani</option><option value="161">Gujarati</option><option value="2511">Gumatj</option><option value="2581">Gupapuyngu</option><option value="2638">Guyanese Creole English</option><option value="162">Gwich'in</option><option value="163">Haida</option><option value="164">Haitian Creole</option><option value="165">Hausa</option><option value="166">Hawaiian</option><option value="168">Herero</option><option value="169">Hiligaynon</option><option value="174">Hiri Motu</option><option value="173">Hmong</option><option value="176">Hungarian</option><option value="177">Hupa</option><option value="178">Iban</option><option value="180">Icelandic</option><option value="181">Ido</option><option value="179">Igbo</option><option value="186">Iloko</option><option value="189">Indonesian</option><option value="2967">Ingrian</option><option value="191">Ingush</option><option value="4369">Innu</option><option value="187">Interlingua</option><option value="185">Interlingue</option><option value="184">Inuktitut</option><option value="192">Inupiaq</option><option value="149">Irish</option><option value="2980">Jamaican Creole English</option><option value="196">Javanese</option><option value="6526">Jewish Babylonian Aramaic (ca. 200-1200 CE)</option><option value="200">Judeo-Arabic</option><option value="199">Judeo-Persian</option><option value="212">Kabardian</option><option value="3185">Kabuverdianu</option><option value="202">Kabyle</option><option value="203">Kachin</option><option value="459">Kalmyk</option><option value="205">Kamba</option><option value="206">Kannada</option><option value="209">Kanuri</option><option value="201">Kara-Kalpak</option><option value="227">Karachay-Balkar</option><option value="477">Karelian</option><option value="208">Kashmiri</option><option value="96">Kashubian</option><option value="211">Kazakh</option><option value="3137">Khanty</option><option value="213">Khasi</option><option value="215">Khmer, Central</option><option value="217">Kikuyu</option><option value="220">Kimbundu</option><option value="218">Kinyarwanda</option><option value="219">Kirghiz</option><option value="4291">Kituba (Congo)</option><option value="3568">Kituba (Democratic Republic of Congo)</option><option value="421">Klingon</option><option value="3529">K√∂lsch</option><option value="222">Komi</option><option value="223">Kongo</option><option value="221">Konkani</option><option value="225">Kosraean</option><option value="226">Kpelle</option><option value="3525">Kuanua</option><option value="230">Kuanyama</option><option value="231">Kumyk</option><option value="7421">Kunigami</option><option value="232">Kurdish</option><option value="229">Kurukh</option><option value="233">Kutenai</option><option value="3885">Ladin</option><option value="234">Ladino</option><option value="235">Lahnda</option><option value="3880">Lakota</option><option value="236">Lamba</option><option value="237">Lao</option><option value="238">Latin</option><option value="239">Latvian</option><option value="4039">Laz</option><option value="240">Lezghian</option><option value="241">Limburgish</option><option value="242">Lingala</option><option value="243">Lithuanian</option><option value="3858">Liv</option><option value="197">Lojban</option><option value="3958">Louisiana Creole French</option><option value="245">Lozi</option><option value="248">Luba-Katanga</option><option value="247">Luba-Lulua</option><option value="250">Luiseno</option><option value="251">Lunda</option><option value="252">Luo</option><option value="253">Lushai</option><option value="246">Luxembourgish</option><option value="4018">Luyia</option><option value="254">Macedonian</option><option value="255">Madurese</option><option value="256">Magahi</option><option value="258">Maithili</option><option value="259">Makasar</option><option value="275">Malagasy</option><option value="266">Malay</option><option value="260">Malayalam</option><option value="276">Maltese</option><option value="277">Manchu</option><option value="268">Mandar</option><option value="1739">Mandarin Chinese</option><option value="261">Mandingo</option><option value="278">Manipuri</option><option value="4358">Mansi</option><option value="151">Manx</option><option value="262">Maori</option><option value="22">Mapudungun</option><option value="264">Marathi</option><option value="78">Mari</option><option value="257">Marshallese</option><option value="288">Marwari</option><option value="265">Masai</option><option value="269">Mende</option><option value="271">Mi'kmaq</option><option value="4663">Min Nan Chinese</option><option value="2735">Mina (Cameroon)</option><option value="272">Minangkabau</option><option value="287">Mirandese</option><option value="4538">Miyako</option><option value="280">Mohawk</option><option value="267">Moksha</option><option value="244">Mongo</option><option value="282">Mongolian</option><option value="283">Mossi</option><option value="478">N'Ko</option><option value="294">Nauru</option><option value="295">Navajo</option><option value="297">Ndebele, North</option><option value="296">Ndebele, South</option><option value="298">Ndonga</option><option value="293">Neapolitan</option><option value="301">Nepal Bhasa</option><option value="300">Nepali</option><option value="7618">Nhengatu</option><option value="302">Nias</option><option value="304">Niuean</option><option value="307">Nogai</option><option value="4991">Norn</option><option value="308">Norse, Old</option><option value="306">Norwegian Bokm√•l</option><option value="305">Norwegian Nynorsk</option><option value="314">Nyamwezi</option><option value="315">Nyankole</option><option value="316">Nyoro</option><option value="317">Nzima</option><option value="318">Occitan</option><option value="319">Ojibwa</option><option value="320">Oriya</option><option value="321">Oromo</option><option value="322">Osage</option><option value="323">Ossetian</option><option value="328">Pahlavi</option><option value="332">Palauan</option><option value="337">Pali</option><option value="329">Pampanga</option><option value="327">Pangasinan</option><option value="331">Papiamento</option><option value="334">Persian</option><option value="5402">Pitjantjatjara</option><option value="339">Pohnpeian</option><option value="342">Proven√ßal, Old (to 1500)</option><option value="5521">Prussian</option><option value="2321">Pulaar</option><option value="330">Punjabi</option><option value="343">Pushto</option><option value="5603">Puyuma</option><option value="344">Quechua</option><option value="5662">Quenya</option><option value="345">Rajasthani</option><option value="346">Rapanui</option><option value="347">Rarotongan</option><option value="5690">R√©union Creole French</option><option value="351">Romanian</option><option value="349">Romansh</option><option value="350">Romany</option><option value="352">Rundi</option><option value="5790">Rusyn</option><option value="359">Samaritan Aramaic</option><option value="383">Sami, Inari</option><option value="382">Sami, Lule</option><option value="380">Sami, Northern</option><option value="385">Sami, Skolt</option><option value="379">Sami, Southern</option><option value="384">Samoan</option><option value="354">Sandawe</option><option value="355">Sango</option><option value="360">Sanskrit</option><option value="362">Santali</option><option value="394">Sardinian</option><option value="361">Sasak</option><option value="365">Scots</option><option value="148">Scottish Gaelic</option><option value="2586">Sea Island Creole English</option><option value="367">Selkup</option><option value="5888">Semai</option><option value="363">Serbian</option><option value="2670">Serbo-Croatian</option><option value="395">Serer</option><option value="371">Shan</option><option value="386">Shona</option><option value="182">Sichuan Yi</option><option value="364">Sicilian</option><option value="372">Sidamo</option><option value="54">Siksika</option><option value="5989">Sindarin</option><option value="387">Sindhi</option><option value="373">Sinhala</option><option value="104">Slave (Athapascan)</option><option value="377">Slovak</option><option value="378">Slovenian</option><option value="390">Somali</option><option value="388">Soninke</option><option value="110">Sorbian, Lower</option><option value="175">Sorbian, Upper</option><option value="310">Sotho, Northern</option><option value="392">Sotho, Southern</option><option value="474">Southern Altai</option><option value="3309">Southern Kiwai</option><option value="480">Sranan Tongo</option><option value="398">Sukuma</option><option value="399">Sundanese</option><option value="400">Susu</option><option value="6216">Svan</option><option value="402">Swahili</option><option value="397">Swati</option><option value="404">Syriac</option><option value="5943">Tachelhit</option><option value="414">Tagalog</option><option value="405">Tahitian</option><option value="413">Tajik</option><option value="423">Tamashek</option><option value="407">Tamil</option><option value="408">Tatar</option><option value="409">Telugu</option><option value="411">Tereno</option><option value="412">Tetum</option><option value="415">Thai</option><option value="416">Tibetan</option><option value="417">Tigre</option><option value="418">Tigrinya</option><option value="410">Timne</option><option value="419">Tiv</option><option value="422">Tlingit</option><option value="426">Tok Pisin</option><option value="420">Tokelau</option><option value="7845">Toki Pona</option><option value="424">Tonga (Nyasa)</option><option value="425">Tonga (Tonga Islands)</option><option value="427">Tsimshian</option><option value="429">Tsonga</option><option value="428">Tswana</option><option value="431">Tumbuka</option><option value="324">Turkish, Ottoman</option><option value="430">Turkmen</option><option value="435">Tuvalu</option><option value="437">Tuvinian</option><option value="436">Twi</option><option value="438">Udmurt</option><option value="440">Uighur</option><option value="441">Ukrainian</option><option value="442">Umbundu</option><option value="5995">Ume Sami</option><option value="444">Urdu</option><option value="445">Uzbek</option><option value="446">Vai</option><option value="447">Venda</option><option value="6913">Veps</option><option value="448">Vietnamese</option><option value="449">Volap√ºk</option><option value="6966">V√µro</option><option value="450">Votic</option><option value="457">Walloon</option><option value="6981">Walser</option><option value="453">Waray</option><option value="7009">Warlpiri</option><option value="454">Washo</option><option value="455">Welsh</option><option value="820">Western Arrarnta</option><option value="452">Wolaitta</option><option value="458">Wolof</option><option value="7181">Wyandot</option><option value="460">Xhosa</option><option value="5808">Yaeyama</option><option value="356">Yakut</option><option value="461">Yao</option><option value="462">Yapese</option><option value="463">Yiddish</option><option value="7602">Yoron</option><option value="464">Yoruba</option><option value="7636">Yucateco</option><option value="7640">Yue Chinese</option><option value="466">Zapotec</option><option value="2009">Zarma</option><option value="483">Zaza</option><option value="467">Zenaga</option><option value="468">Zhuang</option><option value="470">Zulu</option><option value="471">Zuni</option></optgroup></select> <button class="nobutton icon remove-item remove-language" title="Remove language" type="button"></button></div><div class="form-row-add"><button class="add-item with-label" id="add-language" type="button">Add language</button></div></div></div></div>
      <script type="application/json">{"removeButtonLabel":"Remove ISWC","addButtonLabel":"Add ISWC","initialState":{"currentTextValues":"","repeatable":{"errors":[],"type":"repeatable_field","id":1,"field":[{"has_errors":false,"id":2,"type":"field","html_name":"edit-work.iswcs.0","errors":[],"field":{"removed":{"errors":[],"type":"field","id":4,"html_name":"edit-work.iswcs.0.removed","value":false,"has_errors":false},"value":{"errors":[],"type":"field","id":3,"html_name":"edit-work.iswcs.0.value","value":"","has_errors":false}}}],"html_name":"edit-work.iswcs","last_index":0,"has_errors":false}},"label":"ISWCs:","addButtonId":"add-iswc"}</script><div class="row form-row-text-list-container"><label class="">ISWCs:</label><div class="form-row-text-list"><div class="text-list-row"><input class="value with-button" name="edit-work.iswcs.0" type="text" value=""><button class="nobutton icon remove-item" title="Remove ISWC" type="button"></button></div><div class="form-row-add"><button class="add-item with-label" id="add-iswc" type="button">Add ISWC</button></div></div></div>
    </fieldset>
#+end_example

** 5

Yes "language" and "script" are workig now everywhere but the "primary type" "status" and "packaging" not anymore

** 6

Now, what I meant was, that in our combined script the functionaliy for "primary type" "status" and "packaging" is not working anymore. There are not buttons for them

** 7

Nothing on the work page.

Here's the HTML code on that page

#+begin_example
<fieldset>
      <legend>Work details</legend>      <div class="row">

    <label class="required" for="id-edit-work.name" id="label-id-edit-work.name">Name:</label>
    <input class="with-guesscase" id="id-edit-work.name" name="edit-work.name" required="required" type="text" value="" style="">
    <button type="button" class="guesscase-title icon" title="Guess case"></button>    <button type="button" class="guesscase-options icon" title="Guess case options"></button>


    </div>
        <div class="row">

      <label for="id-edit-work.comment" id="label-id-edit-work.comment">Disambiguation:</label>
      <input class="with-guesscase" id="id-edit-work.comment" name="edit-work.comment" size="47" type="text" value="">


     <button class="icon guess-punctuation" type="button" title="Guess punctuation"></button></div>
        <div class="row">

      <label class="" for="id-edit-work.type_id" id="label-id-edit-work.type_id">Type:</label>
      <select class="" id="id-edit-work.type_id" name="edit-work.type_id"><option selected="selected">&nbsp;</option><option value="17">Song</option><option value="1">Aria</option><option value="25">Audio drama</option><option value="2">Ballet</option><option value="26">Beijing opera</option><option value="3">Cantata</option><option value="4">Concerto</option><option value="20">√âtude</option><option value="30">Incidental music</option><option value="7">Madrigal</option><option value="8">Mass</option><option value="9">Motet</option><option value="29">Musical</option><option value="10">Opera</option><option value="24">Operetta</option><option value="11">Oratorio</option><option value="12">Overture</option><option value="13">Partita</option><option value="28">Play</option><option value="21">Poem</option><option value="23">Prose</option><option value="14">Quartet</option><option value="5">Sonata</option><option value="15">Song-cycle</option><option value="22">Soundtrack</option><option value="6">Suite</option><option value="18">Symphonic poem</option><option value="16">Symphony</option><option value="19">Zarzuela</option></select>

    </div>      <div id="work-languages-editor"><div class="row"><label>Lyrics languages:</label><div class="form-row-select-list"><div class="select-list-row"><select class="with-button" id="id-edit-work.languages.0" name="edit-work.languages.0"><option value="">&nbsp;</option><optgroup label="Frequently used"><option value="284">[Multiple languages]</option><option value="486">[No lyrics]</option><option value="18">Arabic</option><option value="76">Chinese</option><option value="113">Dutch</option><option value="120">English</option><option value="131">Finnish</option><option value="134">French</option><option value="145">German</option><option value="167">Hebrew</option><option value="171">Hindi</option><option value="195">Italian</option><option value="198">Japanese</option><option value="224">Korean</option><option value="309">Norwegian</option><option value="338">Polish</option><option value="340">Portuguese</option><option value="353">Russian</option><option value="393">Spanish</option><option value="403">Swedish</option><option value="433">Turkish</option></optgroup><optgroup label="Other"><option value="24">[Artificial (Other)]</option><option value="2">Abkhazian</option><option value="3">Achinese</option><option value="4">Acoli</option><option value="5">Adangme</option><option value="6">Adyghe</option><option value="1">Afar</option><option value="8">Afrihili</option><option value="9">Afrikaans</option><option value="473">Ainu</option><option value="10">Akan</option><option value="11">Akkadian</option><option value="12">Albanian</option><option value="13">Aleut</option><option value="709">Algonquin</option><option value="15">Amharic</option><option value="475">Angika</option><option value="20">Aragonese</option><option value="23">Arapaho</option><option value="25">Arawak</option><option value="5403">ArdhamƒÅgadhƒ´ PrƒÅkrit</option><option value="21">Armenian</option><option value="479">Aromanian</option><option value="26">Assamese</option><option value="27">Asturian</option><option value="866">Atikamekw</option><option value="30">Avaric</option><option value="31">Avestan</option><option value="32">Awadhi</option><option value="33">Aymara</option><option value="34">Azerbaijani</option><option value="1470">Baeggu</option><option value="40">Balinese</option><option value="38">Baluchi</option><option value="39">Bambara</option><option value="42">Basa</option><option value="37">Bashkir</option><option value="41">Basque</option><option value="982">Bavarian</option><option value="44">Beja</option><option value="45">Belarusian</option><option value="46">Bemba</option><option value="47">Bengali</option><option value="49">Bhojpuri</option><option value="51">Bikol</option><option value="52">Bini</option><option value="53">Bislama</option><option value="64">Blin</option><option value="1394">Bodo (India)</option><option value="56">Bosnian</option><option value="57">Braj</option><option value="58">Breton</option><option value="1322">Buamu</option><option value="61">Buginese</option><option value="62">Bulgarian</option><option value="60">Buriat</option><option value="63">Burmese</option><option value="1406">Burushaski</option><option value="65">Caddo</option><option value="2311">Cajun French</option><option value="68">Catalan</option><option value="70">Cebuano</option><option value="7217">Celtiberian</option><option value="5809">Central Okinawan</option><option value="2243">Central Yupik</option><option value="75">Chagatai</option><option value="72">Chamorro</option><option value="74">Chechen</option><option value="82">Cherokee</option><option value="85">Cheyenne</option><option value="73">Chibcha</option><option value="313">Chichewa</option><option value="79">Chinook jargon</option><option value="81">Chipewyan</option><option value="80">Choctaw</option><option value="83">Church Slavic</option><option value="77">Chuukese</option><option value="84">Chuvash</option><option value="87">Coptic</option><option value="88">Cornish</option><option value="89">Corsican</option><option value="93">Cree</option><option value="286">Creek</option><option value="94">Crimean Tatar</option><option value="366">Croatian</option><option value="7303">Cuneiform Luwian</option><option value="98">Czech</option><option value="99">Dakota</option><option value="100">Danish</option><option value="101">Dargwa</option><option value="103">Delaware</option><option value="106">Dinka</option><option value="107">Divehi</option><option value="108">Dogri</option><option value="105">Dogrib</option><option value="111">Duala</option><option value="112">Dutch, Middle (ca.1050-1350)</option><option value="114">Dyula</option><option value="115">Dzongkha</option><option value="584">Eastern Arrernte</option><option value="116">Efik</option><option value="117">Egyptian (Ancient)</option><option value="118">Ekajuk</option><option value="119">Elamite</option><option value="121">English, Middle (1100-1500)</option><option value="16">English, Old (ca.450-1100)</option><option value="290">Erzya</option><option value="122">Esperanto</option><option value="123">Estonian</option><option value="124">Ewe</option><option value="125">Ewondo</option><option value="126">Fang</option><option value="128">Fanti</option><option value="127">Faroese</option><option value="129">Fijian</option><option value="130">Filipino</option><option value="133">Fon</option><option value="136">French, Old (842-ca.1400)</option><option value="485">Frisian, Eastern</option><option value="484">Frisian, Northern</option><option value="137">Frisian, Western</option><option value="139">Friulian</option><option value="138">Fulah</option><option value="140">Ga</option><option value="67">Galibi Carib</option><option value="150">Galician</option><option value="249">Ganda</option><option value="1591">Garifuna</option><option value="141">Gayo</option><option value="142">Gbaya</option><option value="146">Geez</option><option value="144">Georgian</option><option value="299">German, Low</option><option value="152">German, Middle High (ca.1050-1500)</option><option value="153">German, Old High (ca.750-1050)</option><option value="476">German, Swiss</option><option value="147">Gilbertese</option><option value="154">Gondi</option><option value="155">Gorontalo</option><option value="156">Gothic</option><option value="157">Grebo</option><option value="159">Greek</option><option value="158">Greek, Ancient</option><option value="204">Greenlandic</option><option value="2534">Gronings</option><option value="2386">Guadeloupean Creole French</option><option value="160">Guarani</option><option value="161">Gujarati</option><option value="2511">Gumatj</option><option value="2581">Gupapuyngu</option><option value="2638">Guyanese Creole English</option><option value="162">Gwich'in</option><option value="163">Haida</option><option value="164">Haitian Creole</option><option value="165">Hausa</option><option value="166">Hawaiian</option><option value="168">Herero</option><option value="169">Hiligaynon</option><option value="174">Hiri Motu</option><option value="173">Hmong</option><option value="176">Hungarian</option><option value="177">Hupa</option><option value="178">Iban</option><option value="180">Icelandic</option><option value="181">Ido</option><option value="179">Igbo</option><option value="186">Iloko</option><option value="189">Indonesian</option><option value="2967">Ingrian</option><option value="191">Ingush</option><option value="4369">Innu</option><option value="187">Interlingua</option><option value="185">Interlingue</option><option value="184">Inuktitut</option><option value="192">Inupiaq</option><option value="149">Irish</option><option value="2980">Jamaican Creole English</option><option value="196">Javanese</option><option value="6526">Jewish Babylonian Aramaic (ca. 200-1200 CE)</option><option value="200">Judeo-Arabic</option><option value="199">Judeo-Persian</option><option value="212">Kabardian</option><option value="3185">Kabuverdianu</option><option value="202">Kabyle</option><option value="203">Kachin</option><option value="459">Kalmyk</option><option value="205">Kamba</option><option value="206">Kannada</option><option value="209">Kanuri</option><option value="201">Kara-Kalpak</option><option value="227">Karachay-Balkar</option><option value="477">Karelian</option><option value="208">Kashmiri</option><option value="96">Kashubian</option><option value="211">Kazakh</option><option value="3137">Khanty</option><option value="213">Khasi</option><option value="215">Khmer, Central</option><option value="217">Kikuyu</option><option value="220">Kimbundu</option><option value="218">Kinyarwanda</option><option value="219">Kirghiz</option><option value="4291">Kituba (Congo)</option><option value="3568">Kituba (Democratic Republic of Congo)</option><option value="421">Klingon</option><option value="3529">K√∂lsch</option><option value="222">Komi</option><option value="223">Kongo</option><option value="221">Konkani</option><option value="225">Kosraean</option><option value="226">Kpelle</option><option value="3525">Kuanua</option><option value="230">Kuanyama</option><option value="231">Kumyk</option><option value="7421">Kunigami</option><option value="232">Kurdish</option><option value="229">Kurukh</option><option value="233">Kutenai</option><option value="3885">Ladin</option><option value="234">Ladino</option><option value="235">Lahnda</option><option value="3880">Lakota</option><option value="236">Lamba</option><option value="237">Lao</option><option value="238">Latin</option><option value="239">Latvian</option><option value="4039">Laz</option><option value="240">Lezghian</option><option value="241">Limburgish</option><option value="242">Lingala</option><option value="243">Lithuanian</option><option value="3858">Liv</option><option value="197">Lojban</option><option value="3958">Louisiana Creole French</option><option value="245">Lozi</option><option value="248">Luba-Katanga</option><option value="247">Luba-Lulua</option><option value="250">Luiseno</option><option value="251">Lunda</option><option value="252">Luo</option><option value="253">Lushai</option><option value="246">Luxembourgish</option><option value="4018">Luyia</option><option value="254">Macedonian</option><option value="255">Madurese</option><option value="256">Magahi</option><option value="258">Maithili</option><option value="259">Makasar</option><option value="275">Malagasy</option><option value="266">Malay</option><option value="260">Malayalam</option><option value="276">Maltese</option><option value="277">Manchu</option><option value="268">Mandar</option><option value="1739">Mandarin Chinese</option><option value="261">Mandingo</option><option value="278">Manipuri</option><option value="4358">Mansi</option><option value="151">Manx</option><option value="262">Maori</option><option value="22">Mapudungun</option><option value="264">Marathi</option><option value="78">Mari</option><option value="257">Marshallese</option><option value="288">Marwari</option><option value="265">Masai</option><option value="269">Mende</option><option value="271">Mi'kmaq</option><option value="4663">Min Nan Chinese</option><option value="2735">Mina (Cameroon)</option><option value="272">Minangkabau</option><option value="287">Mirandese</option><option value="4538">Miyako</option><option value="280">Mohawk</option><option value="267">Moksha</option><option value="244">Mongo</option><option value="282">Mongolian</option><option value="283">Mossi</option><option value="478">N'Ko</option><option value="294">Nauru</option><option value="295">Navajo</option><option value="297">Ndebele, North</option><option value="296">Ndebele, South</option><option value="298">Ndonga</option><option value="293">Neapolitan</option><option value="301">Nepal Bhasa</option><option value="300">Nepali</option><option value="7618">Nhengatu</option><option value="302">Nias</option><option value="304">Niuean</option><option value="307">Nogai</option><option value="4991">Norn</option><option value="308">Norse, Old</option><option value="306">Norwegian Bokm√•l</option><option value="305">Norwegian Nynorsk</option><option value="314">Nyamwezi</option><option value="315">Nyankole</option><option value="316">Nyoro</option><option value="317">Nzima</option><option value="318">Occitan</option><option value="319">Ojibwa</option><option value="320">Oriya</option><option value="321">Oromo</option><option value="322">Osage</option><option value="323">Ossetian</option><option value="328">Pahlavi</option><option value="332">Palauan</option><option value="337">Pali</option><option value="329">Pampanga</option><option value="327">Pangasinan</option><option value="331">Papiamento</option><option value="334">Persian</option><option value="5402">Pitjantjatjara</option><option value="339">Pohnpeian</option><option value="342">Proven√ßal, Old (to 1500)</option><option value="5521">Prussian</option><option value="2321">Pulaar</option><option value="330">Punjabi</option><option value="343">Pushto</option><option value="5603">Puyuma</option><option value="344">Quechua</option><option value="5662">Quenya</option><option value="345">Rajasthani</option><option value="346">Rapanui</option><option value="347">Rarotongan</option><option value="5690">R√©union Creole French</option><option value="351">Romanian</option><option value="349">Romansh</option><option value="350">Romany</option><option value="352">Rundi</option><option value="5790">Rusyn</option><option value="359">Samaritan Aramaic</option><option value="383">Sami, Inari</option><option value="382">Sami, Lule</option><option value="380">Sami, Northern</option><option value="385">Sami, Skolt</option><option value="379">Sami, Southern</option><option value="384">Samoan</option><option value="354">Sandawe</option><option value="355">Sango</option><option value="360">Sanskrit</option><option value="362">Santali</option><option value="394">Sardinian</option><option value="361">Sasak</option><option value="365">Scots</option><option value="148">Scottish Gaelic</option><option value="2586">Sea Island Creole English</option><option value="367">Selkup</option><option value="5888">Semai</option><option value="363">Serbian</option><option value="2670">Serbo-Croatian</option><option value="395">Serer</option><option value="371">Shan</option><option value="386">Shona</option><option value="182">Sichuan Yi</option><option value="364">Sicilian</option><option value="372">Sidamo</option><option value="54">Siksika</option><option value="5989">Sindarin</option><option value="387">Sindhi</option><option value="373">Sinhala</option><option value="104">Slave (Athapascan)</option><option value="377">Slovak</option><option value="378">Slovenian</option><option value="390">Somali</option><option value="388">Soninke</option><option value="110">Sorbian, Lower</option><option value="175">Sorbian, Upper</option><option value="310">Sotho, Northern</option><option value="392">Sotho, Southern</option><option value="474">Southern Altai</option><option value="3309">Southern Kiwai</option><option value="480">Sranan Tongo</option><option value="398">Sukuma</option><option value="399">Sundanese</option><option value="400">Susu</option><option value="6216">Svan</option><option value="402">Swahili</option><option value="397">Swati</option><option value="404">Syriac</option><option value="5943">Tachelhit</option><option value="414">Tagalog</option><option value="405">Tahitian</option><option value="413">Tajik</option><option value="423">Tamashek</option><option value="407">Tamil</option><option value="408">Tatar</option><option value="409">Telugu</option><option value="411">Tereno</option><option value="412">Tetum</option><option value="415">Thai</option><option value="416">Tibetan</option><option value="417">Tigre</option><option value="418">Tigrinya</option><option value="410">Timne</option><option value="419">Tiv</option><option value="422">Tlingit</option><option value="426">Tok Pisin</option><option value="420">Tokelau</option><option value="7845">Toki Pona</option><option value="424">Tonga (Nyasa)</option><option value="425">Tonga (Tonga Islands)</option><option value="427">Tsimshian</option><option value="429">Tsonga</option><option value="428">Tswana</option><option value="431">Tumbuka</option><option value="324">Turkish, Ottoman</option><option value="430">Turkmen</option><option value="435">Tuvalu</option><option value="437">Tuvinian</option><option value="436">Twi</option><option value="438">Udmurt</option><option value="440">Uighur</option><option value="441">Ukrainian</option><option value="442">Umbundu</option><option value="5995">Ume Sami</option><option value="444">Urdu</option><option value="445">Uzbek</option><option value="446">Vai</option><option value="447">Venda</option><option value="6913">Veps</option><option value="448">Vietnamese</option><option value="449">Volap√ºk</option><option value="6966">V√µro</option><option value="450">Votic</option><option value="457">Walloon</option><option value="6981">Walser</option><option value="453">Waray</option><option value="7009">Warlpiri</option><option value="454">Washo</option><option value="455">Welsh</option><option value="820">Western Arrarnta</option><option value="452">Wolaitta</option><option value="458">Wolof</option><option value="7181">Wyandot</option><option value="460">Xhosa</option><option value="5808">Yaeyama</option><option value="356">Yakut</option><option value="461">Yao</option><option value="462">Yapese</option><option value="463">Yiddish</option><option value="7602">Yoron</option><option value="464">Yoruba</option><option value="7636">Yucateco</option><option value="7640">Yue Chinese</option><option value="466">Zapotec</option><option value="2009">Zarma</option><option value="483">Zaza</option><option value="467">Zenaga</option><option value="468">Zhuang</option><option value="470">Zulu</option><option value="471">Zuni</option></optgroup></select> <button class="nobutton icon remove-item remove-language" title="Remove language" type="button"></button></div><div class="form-row-add"><button class="add-item with-label" id="add-language" type="button">Add language</button></div></div></div></div>
      <script type="application/json">{"label":"ISWCs:","addButtonId":"add-iswc","removeButtonLabel":"Remove ISWC","addButtonLabel":"Add ISWC","initialState":{"repeatable":{"field":[{"id":2,"field":{"value":{"type":"field","html_name":"edit-work.iswcs.0.value","id":3,"value":"","errors":[],"has_errors":false},"removed":{"has_errors":false,"errors":[],"value":false,"html_name":"edit-work.iswcs.0.removed","type":"field","id":4}},"html_name":"edit-work.iswcs.0","type":"field","has_errors":false,"errors":[]}],"type":"repeatable_field","html_name":"edit-work.iswcs","id":1,"has_errors":false,"last_index":0,"errors":[]},"currentTextValues":""}}</script><div class="row form-row-text-list-container"><label class="">ISWCs:</label><div class="form-row-text-list"><div class="text-list-row"><input class="value with-button" name="edit-work.iswcs.0" type="text" value=""><button class="nobutton icon remove-item" title="Remove ISWC" type="button"></button></div><div class="form-row-add"><button class="add-item with-label" id="add-iswc" type="button">Add ISWC</button></div></div></div>
    </fieldset>
#+end_example



* Customizable Language select
** Gemini

Please investigate the uploaded Userscript "CustomizableMultiSelector.user.js" and adjust the button appearances on the
other one, the "CustomizableLanguageSelector.user.js" so that it matches the same style. Very important, do not touch
the code logic at all and the comments, as everything it's working. Only adjust the button styling stuff.

1.) Remove the bold text "Quick add:" in front of the "‚öôÔ∏è" button in the "CustomizableLanguageSelector.user.js"
2.) Align the "‚öôÔ∏è" button to the right side of the generated configured buttons inside the container

** 1

In the URLS which have "alias" in their virtual path, please add the bold String "Quick locale:" in front of the
generated buttons and align the description "Quick locale:" with the rest of the description in the same container, like "Alias name:" or " Sort name".


* Batch-add a relationship to recordings
** ChatGPT
*** initial question

Write a userscript that runs on the following url: https://musicbrainz.org/release/c679a438-d704-4b34-97d4-09aeb7064bf8/edit-relationships

Create a button with text "Add instrument" after the text "Track relationships" that executes the following actions when
clicked: Emulate a click on the text "Batch-add a relationship to recordings" located in the following part of the page:

<td><span class="tooltip-wrapper"><button class=
              "add-item with-label batch-add-recording-relationship"
              aria-haspopup="dialog" type="button">Batch-add a relationship to recordings</button></span></td>

Ok, after pressing the button there pops up a dynamically generated dialog (probably react based) with the following content:

#+begin_example
<div class="form">
  <div class="dialog-titlebar">
    <h1>Add relationship
    </h1>
    <div class="buttons-right">
      <span style="font-weight: normal;">(
	<a href="#">help
	</a>)
      </span>
    </div>
  </div>
  <p>This will add a relationship to all checked recordings.
  </p>
  <table class="relationship-details">
    <tbody>
      <tr>
	<td class="required section">Recording
	</td>
	<td class="fields">(31 recordings selected)
	</td>
      </tr>
      <tr>
	<td class="required section">Related type
	</td>
	<td class="fields">
	  <select class="entity-type">
	    <option value="area">Area
	    </option>
	    <option value="artist">Artist
	    </option>
	    <option value="event">Event
	    </option>
	    <option value="label">Label
	    </option>
	    <option value="place">Place
	    </option>
	    <option value="recording">Recording
	    </option>
	    <option value="release">Release
	    </option>
	    <option value="series">Series
	    </option>
	    <option value="work">Work
	    </option>
	  </select>
	</td>
      </tr>
    </tbody>
  </table>
  <h2>
    <div class="heading-line">
    </div>
    <span class="heading-text">Relationship
    </span>
  </h2>
  <table class="relationship-details">
    <tbody>
      <tr>
	<td class="required section">Relationship type
	</td>
	<td class="fields">
	  <label class="autocomplete2-label required" for="relationship-type-artist-recording--915" id="relationship-type-artist-recording--915-label">Type or click to search:
	  </label>
	  <div class="autocomplete2 relationship-type">
	    <div aria-expanded="false" aria-haspopup="listbox" aria-owns="relationship-type-artist-recording--915-menu" class="required" role="combobox">
	      <input aria-autocomplete="list" aria-controls="relationship-type-artist-recording--915-menu" aria-labelledby="relationship-type-artist-recording--915-label" aria-required="true" autocomplete="off" class="relationship-type required" id="relationship-type-artist-recording--915" placeholder="Type or click to search" type="text" value="">
	      <button aria-controls="relationship-type-artist-recording--915-menu" aria-haspopup="true" aria-label="Search" class="search" data-toggle="true" role="button" tabindex="-1" title="Search" type="button">
	      </button>
	    </div>
	    <ul aria-controls="relationship-type-artist-recording--915-status" aria-labelledby="relationship-type-artist-recording--915-label" id="relationship-type-artist-recording--915-menu" role="listbox" tabindex="-1">
	      <li aria-disabled="true" aria-selected="false" class="disabled header-item " id="relationship-type-artist-recording--915-item-recent-items-header" role="option">Recent items
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-type-artist-recording--915-item-148-recent" role="option">instruments
		<br>
		<span class="autocomplete-comment">Indicates an artist that performed one or more instruments on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-type-artist-recording--915-item-156-recent" role="option">performed / performer
		<br>
		<span class="autocomplete-comment">Indicates an artist that performed on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-type-artist-recording--915-item-149-recent" role="option">vocals
		<br>
		<span class="autocomplete-comment">Indicates an artist that performed vocals on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="action-item " id="relationship-type-artist-recording--915-item-clear-recent-items" role="option">Clear recent items
	      </li>
	      <li aria-disabled="true" aria-selected="false" class="disabled separator option-item " id="relationship-type-artist-recording--915-item-122" role="option">performance
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-156" role="option">performed / performer
		<br>
		<span class="autocomplete-comment">Indicates an artist that performed on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level2 option-item " id="relationship-type-artist-recording--915-item-148" role="option">instruments
		<br>
		<span class="autocomplete-comment">Indicates an artist that performed one or more instruments on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level2 option-item " id="relationship-type-artist-recording--915-item-149" role="option">vocals
		<br>
		<span class="autocomplete-comment">Indicates an artist that performed vocals on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-150" role="option">orchestra
		<br>
		<span class="autocomplete-comment">Indicates an orchestra that performed on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-151" role="option">conducted / conductor
		<br>
		<span class="autocomplete-comment">This indicates an artist who conducted an orchestra, band or choir on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-152" role="option">chorus master
		<br>
		<span class="autocomplete-comment">This indicates the chorus master of a choir which performed on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-760" role="option">concertmaster for / concertmaster
		<br>
		<span class="autocomplete-comment">This indicates an artist who was the concertmaster/leader for an orchestra or band on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-1186" role="option">audio director for / audio director
		<br>
		<span class="autocomplete-comment">This indicates the artist was an audio director for this recording. This is the artist responsible for the creative realization of an audio project (such as an audio drama or audiobook), which is usually based on a written template and involves the performance of voice actors.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-type-artist-recording--915-item-297" role="option">arranged / arranger
		<br>
		<span class="autocomplete-comment">This indicates the artist who arranged a tune into a form suitable for performance. ‚ÄúArrangement‚Äù is used as a catch-all term for all processes that turn a composition into a form that can be played by a specific type of ensemble.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-158" role="option">instruments arranged / instruments arranger
		<br>
		<span class="autocomplete-comment">This indicates the artist who arranged a tune into a form suitable for performance. ‚ÄúArrangement‚Äù is used as a catch-all term for all processes that turn a composition into a form that can be played by a specific type of ensemble.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level2 option-item " id="relationship-type-artist-recording--915-item-300" role="option">orchestrated / orchestrator
		<br>
		<span class="autocomplete-comment">This indicates the person who orchestrated the recording. Orchestration is a special type of arrangement. It means the adaptation of a composition for an orchestra, done in a way that the musical substance remains essentially unchanged. The orchestrator is also responsible for writing scores for an orchestra, band, choral group, individual instrumentalist(s) or vocalist(s). In practical terms it consists of deciding which instruments should play which notes in a piece of music.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-298" role="option">vocals arranged / vocals arranger
		<br>
		<span class="autocomplete-comment">This indicates the artist who arranged a tune into a form suitable for performance. ‚ÄúArrangement‚Äù is used as a catch-all term for all processes that turn a composition into a form that can be played by a specific type of ensemble.
		</span>
	      </li>
	      <li aria-disabled="true" aria-selected="false" class="disabled option-item " id="relationship-type-artist-recording--915-item-157" role="option">remixes and compilations
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-147" role="option">compiled / compiler
		<br>
		<span class="autocomplete-comment">This indicates the person who selected the tracks and the sequence for a compilation. This applies to one long recording which contains multiple songs, one after the other. If the tracks are pitched or blended into each other, it is more appropriate to credit this person as a DJ-mixer.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-155" role="option">DJ-mixed / DJ-mixer
		<br>
		<span class="autocomplete-comment">This links a DJ-mix to the artist who mixed it.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-153" role="option">remixed / remixer
		<br>
		<span class="autocomplete-comment">This links a recording to the person who remixed it by taking one or more other tracks, substantially altering them and mixing them together with other material. Note that this includes the artist who created a mash-up or used samples as well.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-154" role="option">produced material that was sampled in / contains samples by
		<br>
		<span class="autocomplete-comment">Indicates that the recording contains samples from material by the indicated artist. Use this only if you really cannot figure out the particular recording that has been sampled.
		</span>
	      </li>
	      <li aria-disabled="true" aria-selected="false" class="disabled option-item " id="relationship-type-artist-recording--915-item-961" role="option">video
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-858" role="option">appears on video / visual appearances
		<br>
		<span class="autocomplete-comment">This indicates that an artist appears on a music video, but doesn't actually perform on the audio track.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-962" role="option">video director for / video director
		<br>
		<span class="autocomplete-comment">This indicates the artist was the director of this video recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-1243" role="option">animation
		<br>
		<span class="autocomplete-comment">This credits a person or agency who worked on animation for a video recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-1241" role="option">artwork
		<br>
		<span class="autocomplete-comment">This indicates an artist who provided artwork for a video recording when no more specific information is available.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level2 option-item " id="relationship-type-artist-recording--915-item-1242" role="option">design
		<br>
		<span class="autocomplete-comment">This indicates an artist who did design for a video recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level3 option-item " id="relationship-type-artist-recording--915-item-125" role="option">graphic design
		<br>
		<span class="autocomplete-comment">This credits the people or agency who did the graphic design / layout for a video recording, arranging pieces of content into a coherent and aesthetically-pleasing whole.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="separator action-item " id="relationship-type-artist-recording--915-item-show-more" role="option">Show more...
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="separator action-item " id="relationship-type-artist-recording--915-item-toggle-descriptions" role="option">Hide descriptions
	      </li>
	    </ul>
	    <div aria-live="assertive" aria-relevant="additions text" id="relationship-type-artist-recording--915-status" role="status">
	    </div>
	  </div>
	  <div aria-atomic="true" class="error" role="alert">
	  </div>
	</td>
      </tr>
      <tr>
	<td class="required section">Artist
	</td>
	<td class="fields">
	  <label class="autocomplete2-label required" for="relationship-target--915" id="relationship-target--915-label">Search for an artist:
	  </label>
	  <div class="autocomplete2 relationship-target">
	    <div aria-expanded="false" aria-haspopup="listbox" aria-owns="relationship-target--915-menu" class="required" role="combobox">
	      <input aria-autocomplete="list" aria-controls="relationship-target--915-menu" aria-labelledby="relationship-target--915-label" aria-required="true" autocomplete="off" class="relationship-target required" id="relationship-target--915" placeholder="Type to search, or paste an MBID" type="text" value="">
	      <button aria-controls="relationship-target--915-menu" aria-haspopup="true" aria-label="Search" class="search" data-toggle="true" role="button" tabindex="-1" title="Search" type="button">
	      </button>
	    </div>
	    <ul aria-controls="relationship-target--915-status" aria-labelledby="relationship-target--915-label" id="relationship-target--915-menu" role="listbox" tabindex="-1">
	      <li aria-disabled="true" aria-selected="false" class="disabled header-item " id="relationship-target--915-item-recent-items-header" role="option">Recent items
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-339449-recent" role="option">Max Weinberg
		<br>
		<span class="autocomplete-comment">Person, 1951-04-13 ‚Äì
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-813-recent" role="option">Bruce Springsteen
		<br>
		<span class="autocomplete-comment">Person, 1949-09-23 ‚Äì
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-47784-recent" role="option">J.D. Souther
		<br>
		<span class="autocomplete-comment">Person, 1945-11-02 ‚Äì 2024-09-17
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-1086-recent" role="option">Jackson Browne
		<span class="autocomplete-comment">(American singer-songwriter)
		</span>
		<br>
		<span class="autocomplete-comment">Person, 1948-10-09 ‚Äì
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-11058-recent" role="option">Crosby, Stills, Nash &amp; Young
		<br>
		<span class="autocomplete-comment">Group, 1969 ‚Äì 2015
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-964-recent" role="option">Neil Young
		<span class="autocomplete-comment">(Canadian singer, songwriter &amp; musician)
		</span>
		<br>
		<span class="autocomplete-comment">Person, 1945-11-12 ‚Äì
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-1240195-recent" role="option">The E Street Band
		<br>
		<span class="autocomplete-comment">Group, 1972-10 ‚Äì
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-131161-recent" role="option">Eddie Vedder
		<br>
		<span class="autocomplete-comment">Person, 1964-12-23 ‚Äì
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-713674-recent" role="option">Garry Tallent
		<br>
		<span class="autocomplete-comment">Person, 1949-10-27 ‚Äì
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="action-item " id="relationship-target--915-item-clear-recent-items" role="option">Clear recent items
	      </li>
	    </ul>
	    <div aria-live="assertive" aria-relevant="additions text" id="relationship-target--915-status" role="status">
	    </div>
	  </div>
	  <div class="error">
	  </div>
	</td>
      </tr>
    </tbody>
  </table>
  <h2>
    <div class="heading-line">
    </div>
    <span class="heading-text">Preview
    </span>
  </h2>
  <p class="required-fields-note">Please fill out all required fields.
  </p>
  <div class="buttons" style="margin-top: 1em;">
    <button class="negative" type="button">Cancel
    </button>
    <div class="buttons-right">
      <button class="positive" disabled="" type="button">Done
      </button>
    </div>
  </div>
</div>
#+end_example

replace the text "Type or click to search:" next to the heading "Relationship type" by entering the text
"instruments". The field in reality (when a human would fill it in) is actually dynamically populated using completion
when typing, possible completing against the musicbrainz database when typing.

#+begin_example
	    <div aria-expanded="false" aria-haspopup="listbox" aria-owns="relationship-type-artist-recording--915-menu" class="required" role="combobox">
	      <input aria-autocomplete="list" aria-controls="relationship-type-artist-recording--915-menu" aria-labelledby="relationship-type-artist-recording--915-label" aria-required="true" autocomplete="off" class="relationship-type required" id="relationship-type-artist-recording--915" placeholder="Type or click to search" type="text" value="">
	      <button aria-controls="relationship-type-artist-recording--915-menu" aria-haspopup="true" aria-label="Search" class="search" data-toggle="true" role="button" tabindex="-1" title="Search" type="button">
	      </button>
	    </div>
#+end_example

then press the button '<button aria-controls="relationship-type-artist-recording--931-menu" aria-haspopup="true"
aria-label="Search" class="search" data-toggle="true" role="button" tabindex="-1" title="Search" type="button">'


#+begin_example
<li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-type-artist-recording--931-item-148-recent" role="option">instruments
<br>
<span class="autocomplete-comment">Indicates an artist that performed one or more instruments on this recording.
</span>
</li>
#+end_example

then press the button '<button aria-controls="relationship-type-artist-recording--931-menu" aria-haspopup="true"
aria-label="Search" class="search" data-toggle="true" role="button" tabindex="-1" title="Search" type="button">'


Yes it works now.

Now please emulate typing "Max Weinberg" to the "Artist" field, which says "Type to search, or paste an MBID"
and again at the end choose "Max Weinberg" from the popup suggestion list.

Afterwards emulate typing "drums (drum set)" to the "Instrument" field, which says "instrument"
and again at the end choose "drums (drum set)" from the popup suggestion list.

Afterwards emulate a "Tab" to reach the text field which says "Credited as" and type in "drums". Note that this last
field seems to be a normal text field without autocompletion, at least its suggested when a human types in (nothing gets
validated, so you could enter whatever string you want).



Next add "Nils Lofgren" to the "Artist" field (<label class="autocomplete2-label required"
for="relationship-target--945" id="relationship-target--945-label">Search for an artist:</label>) and again emulate
Enter

Finally add "electric guitar" in the "Instrument" field

#+begin_example
// ==UserScript==
// @name         MusicBrainz React Release Batch Instrument Adder
// @namespace    https://musicbrainz.org/
// @version      1.0
// @description  Batch-add the same Artist + Instrument to all recordings on MusicBrainz release edit-relationships (React editor). Test on a non-production edit first.
// @author       ChatGPT (GPT-5 Thinking mini)
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @run-at       document-idle
// ==/UserScript==

(async function () {
  'use strict';

  // -------- CONFIG --------
  const ARTIST_NAME = 'Nils Lofgren';    // change to your artist
  const INSTRUMENT_NAME = 'electric guitar'; // change to your instrument
  const DEBUG = true;

  // time constants (ms)
  const POLL = 200;
  const SHORT = 200;
  const MED = 450;
  const LONG = 1000;
  const RETRIES = 30;

  function log(...args) { if (DEBUG) console.log('[MB-batch]', ...args); }
  function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

  // Robust text matcher (normalize whitespace + lowercase)
  function textContains(node, text) {
    if (!node) return false;
    const s = (node.textContent || '').replace(/\s+/g, ' ').trim().toLowerCase();
    return s.includes((text || '').toLowerCase());
  }

  // find element by tag with visible text includes
  function findByText(tag, text, root = document) {
    const nodes = Array.from(root.querySelectorAll(tag));
    return nodes.find(n => textContains(n, text));
  }

  // wait until predicate true or timeout attempts exhausted
  async function waitFor(predicate, attempts = RETRIES, interval = POLL) {
    for (let i = 0; i < attempts; i++) {
      try {
        const v = predicate();
        if (v) return v;
      } catch (e) { /* ignore */ }
      await sleep(interval);
    }
    return null;
  }

  // simulate user events for inputs
  function setInputValue(el, value) {
    if (!el) return false;
    el.focus();
    // prefer native value set + events
    try {
      const prev = el.value;
      el.value = value;
      el.dispatchEvent(new Event('input', { bubbles: true }));
      el.dispatchEvent(new Event('change', { bubbles: true }));
      // some React typeaheads need key events
      el.dispatchEvent(new KeyboardEvent('keydown', { key: 'a', bubbles: true }));
      el.dispatchEvent(new KeyboardEvent('keyup', { key: 'a', bubbles: true }));
      el.blur();
      return true;
    } catch (e) {
      try { el.value = value; return true; } catch (e2) { return false; }
    }
  }

  // click element robustly
  function robustClick(el) {
    if (!el) return false;
    try {
      el.scrollIntoView({ block: 'center' });
    } catch (e) {}
    try {
      el.click();
      // try dispatching MouseEvents too
      el.dispatchEvent(new MouseEvent('mousedown', { bubbles: true }));
      el.dispatchEvent(new MouseEvent('mouseup', { bubbles: true }));
      el.dispatchEvent(new MouseEvent('click', { bubbles: true }));
      return true;
    } catch (e) {
      return false;
    }
  }

  // Heuristic: find the header "select all" checkbox in the recordings column
  async function selectAllRecordings() {
    log('Selecting all recording checkboxes...');
    // try the visible header checkbox (often in table header)
    const headerCheckbox = await waitFor(() => {
      // checkbox input inside a header cell in the left (recordings) column
      const inputs = Array.from(document.querySelectorAll('input[type="checkbox"]'));
      // prefer one that has an aria-label like 'Select all' or is above many track rows
      for (const i of inputs) {
        const label = i.getAttribute('aria-label') || '';
        if (/select all/i.test(label) || /all recordings/i.test(label) || /select all recordings/i.test(label)) return i;
      }
      // fallback: choose a checkbox that is in a header row (closest ancestor th)
      for (const i of inputs) {
        if (i.closest('th')) return i;
      }
      return null;
    }, 8, POLL);

    if (headerCheckbox) {
      robustClick(headerCheckbox);
      await sleep(SHORT);
      log('Header checkbox clicked.');
      return true;
    }

    // fallback: check every visible recording checkbox
    const recCheckboxes = Array.from(document.querySelectorAll('.recording input[type="checkbox"], input.recording-checkbox, input[name^="recording"]'))
      .filter(cb => cb.offsetParent !== null);

    if (recCheckboxes.length) {
      recCheckboxes.forEach(cb => { if (!cb.checked) cb.click(); });
      log(`Checked ${recCheckboxes.length} recording checkboxes (fallback).`);
      return true;
    }

    log('No recording checkboxes found to select.');
    return false;
  }

  // Find & click the Batch-add relationships for recordings button (Tools)
  async function clickBatchAddButton() {
    log('Locating batch-add button...');
    // heuristics: look for buttons/links that contain "Batch-add" and "record" or "recordings"
    const nodes = Array.from(document.querySelectorAll('button, a, [role="button"]'));
    const candidate = nodes.find(n => {
      const t = (n.textContent || '').toLowerCase();
      return t.includes('batch') && (t.includes('record') || t.includes('recording') || t.includes('recordings'));
    });
    if (candidate) {
      robustClick(candidate);
      log('Clicked batch-add button (found by text).');
      return true;
    }

    // Another heuristic: Tools area often contains "Batch-add a relationship to recordings"
    const tools = Array.from(document.querySelectorAll('[data-testid], .tools, .editor-tools, .relationships-tools, .tools-panel')).flat();
    for (const r of tools) {
      const btn = findByText('button, a, [role="button"]', 'Batch-add', r);
      if (btn && (btn.textContent || '').toLowerCase().includes('record')) {
        robustClick(btn);
        log('Clicked batch-add button (found in tools container).');
        return true;
      }
    }

    log('Batch-add button not found.');
    return false;
  }

  // Wait for modal dialog to appear and return it
  async function waitForModalDialog() {
    log('Waiting for modal/dialog...');
    const dlg = await waitFor(() => {
      // any visible element with role dialog / aria-modal / class modal-dialog
      const candidate = Array.from(document.querySelectorAll('[role="dialog"], .modal, .modal-dialog, .dialog')).find(el => el.offsetParent !== null);
      return candidate || null;
    }, RETRIES, POLL);
    if (dlg) log('Modal found.');
    return dlg;
  }

  // choose relationship type = instrument in modal
  async function setRelationshipType(modal) {
    log('Selecting relationship type "instrument"...');

    // Strategy:
    // 1) Find label "Relationship type" or "Type" and then the select/button next to it.
    // 2) If native select element exists, pick matching option.
    // 3) Otherwise open dropdown and select item that contains "instrument".

    const label = Array.from(modal.querySelectorAll('label, .label, span'))
      .find(n => textContains(n, 'relationship type') || textContains(n, 'relationship') && textContains(n, 'type'));

    // attempt to find select near label
    let select = null;
    if (label) {
      // nextElementSibling, parent query
      select = label.parentElement.querySelector('select, [role="combobox"], input, button');
    }

    // fallback: any select in modal whose options include 'instrument'
    if (!select) {
      const selects = Array.from(modal.querySelectorAll('select, [role="combobox"], input, button'));
      for (const s of selects) {
        const text = (s.textContent || '') + ' ' + (s.getAttribute('aria-label') || '') + ' ' + (s.placeholder || '');
        if (text.toLowerCase().includes('relationship') || text.toLowerCase().includes('type')) { select = s; break; }
      }
    }

    // If it's a native <select>
    if (select && select.tagName && select.tagName.toLowerCase() === 'select') {
      // try to match option
      const opt = Array.from(select.options).find(o => (o.text || '').toLowerCase().includes('instrument'));
      if (opt) {
        select.value = opt.value;
        select.dispatchEvent(new Event('change', { bubbles: true }));
        await sleep(MED);
        log('Relationship type set via native select.');
        return true;
      }
    }

    // If it's a combo/button, try clicking to open and pick list item
    if (select) {
      robustClick(select);
      await sleep(MED);
      // find listbox option
      const option = Array.from(document.querySelectorAll('[role="option"], li, button')).find(o => textContains(o, 'instrument'));
      if (option) { robustClick(option); await sleep(MED); log('Relationship type selected via dropdown.'); return true; }
    }

    // fallback: find any option element that includes 'instrument' in modal
    const generalOpt = Array.from(modal.querySelectorAll('*')).find(n => textContains(n, 'instrument') && (n.matches('li') || n.matches('button') || n.matches('[role="option"]')));
    if (generalOpt) { robustClick(generalOpt); await sleep(MED); log('Picked relationship type via general option fallback.'); return true; }

    log('Could not explicitly set relationship type to "instrument". The modal UI may differ.');
    return false;
  }

  // set entity type to Artist
  async function setEntityTypeToArtist(modal) {
    log('Setting entity/target type to Artist...');
    // look for a label like 'Entity type' / 'Target type' / 'Entity'
    const label = Array.from(modal.querySelectorAll('label, .label, span')).find(n => textContains(n, 'entity') || textContains(n, 'target') || textContains(n, 'related to') || textContains(n, 'entity type'));
    let selector = null;
    if (label) selector = label.parentElement.querySelector('select, [role="combobox"], button, input');
    if (!selector) selector = modal.querySelector('select, [role="combobox"], input, button');

    if (selector && selector.tagName && selector.tagName.toLowerCase() === 'select') {
      const opt = Array.from(selector.options).find(o => (o.text || '').toLowerCase().includes('artist'));
      if (opt) { selector.value = opt.value; selector.dispatchEvent(new Event('change', { bubbles: true })); await sleep(MED); log('Entity type set via native select.'); return true; }
    }

    if (selector) {
      robustClick(selector);
      await sleep(MED);
      const opt = Array.from(document.querySelectorAll('[role="option"], li, button')).find(o => textContains(o, 'artist'));
      if (opt) { robustClick(opt); await sleep(MED); log('Entity type selected via dropdown.'); return true; }
    }

    // fallback: find any option with text artist
    const anyArtist = Array.from(modal.querySelectorAll('*')).find(n => (textContains(n, 'artist') && (n.matches('li') || n.matches('button') || n.matches('[role="option"]'))));
    if (anyArtist) { robustClick(anyArtist); await sleep(MED); log('Entity type chosen by fallback.'); return true; }

    log('Could not set entity type to Artist explicitly.');
    return false;
  }

  // type target artist and choose suggestion
  async function setTargetArtist(modal, artist) {
    log('Typing artist name:', artist);
    // find input or combobox for the target
    const inputs = Array.from(modal.querySelectorAll('input, [role="combobox"]')).filter(i => i.offsetParent !== null);
    // heuristics: placeholder or aria-label containing 'artist' or 'target' or 'search'
    let targetInput = inputs.find(i => ((i.placeholder || '') + ' ' + (i.getAttribute('aria-label') || '')).toLowerCase().includes('artist') ||
                                                (i.name || '').toLowerCase().includes('artist') || textContains(i.parentElement, 'artist'));
    if (!targetInput) targetInput = inputs[0];

    if (!targetInput) { log('No target input found'); return false; }

    setInputValue(targetInput, artist);
    await sleep(MED + 200);

    // try to pick first suggestion from a listbox
    const suggestion = Array.from(document.querySelectorAll('[role="listbox"] [role="option"], ul[role="listbox"] li, .autocomplete li, .typeahead li')).find(n => textContains(n, artist) || n.textContent.trim().length > 0);
    if (suggestion) {
      robustClick(suggestion);
      await sleep(MED);
      log('Picked artist suggestion.');
      return true;
    }

    // fallback: press Enter in the input to accept top result
    try {
      targetInput.focus();
      targetInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', bubbles: true }));
      await sleep(MED);
      log('Sent Enter to accept artist (fallback).');
      return true;
    } catch (e) {
      log('Could not pick artist suggestion.');
      return false;
    }
  }

  // set instrument attribute (if present)
  async function setInstrumentAttribute(modal, instrument) {
    log('Setting instrument attribute:', instrument);
    // find label 'Attribute' / 'Instrument' / 'Relationship attribute'
    const label = Array.from(modal.querySelectorAll('label, span')).find(n => textContains(n, 'attribute') || textContains(n, 'instrument') || textContains(n, 'attribute (instrument)'));
    let attrInput = null;
    if (label) attrInput = label.parentElement.querySelector('input, [role="combobox"], textarea, select');
    if (!attrInput) {
      // fallback: find any input with name or placeholder that looks like attribute/instrument
      attrInput = Array.from(modal.querySelectorAll('input, [role="combobox"], textarea, select')).find(i => ((i.name || '') + ' ' + (i.placeholder || '') + ' ' + (i.getAttribute('aria-label') || '')).toLowerCase().includes('instrument') || ((i.name || '').toLowerCase().includes('attribute')));
    }
    if (!attrInput) {
      log('No instrument attribute input found ‚Äî maybe relationship attributes are handled differently. Skipping this step.');
      return false;
    }

    setInputValue(attrInput, instrument);
    await sleep(MED);

    // try to choose suggestion
    const suggestion = Array.from(document.querySelectorAll('[role="listbox"] [role="option"], .typeahead li, ul[role="listbox"] li')).find(n => textContains(n, instrument));
    if (suggestion) {
      robustClick(suggestion);
      await sleep(MED);
      log('Picked instrument attribute suggestion.');
      return true;
    }

    // fallback: press Enter to accept
    try {
      attrInput.focus();
      attrInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', bubbles: true }));
      await sleep(MED);
      log('Pressed Enter to accept instrument attribute (fallback).');
      return true;
    } catch (e) {
      log('Could not set instrument attribute.');
      return false;
    }
  }

  // finally click the modal Add/Apply button
  async function clickModalApply(modal) {
    log('Trying to confirm/apply the batch-add in modal...');
    // common labels: "Add relationships", "Add", "Apply"
    const btnTexts = ['add relationships', 'add', 'apply', 'save', 'ok'];
    for (const t of btnTexts) {
      const btn = Array.from(modal.querySelectorAll('button, [role="button"]')).find(b => textContains(b, t));
      if (btn) {
        robustClick(btn);
        await sleep(LONG);
        log('Clicked modal button:', t);
        return true;
      }
    }
    log('Could not find an Apply/Add button in modal.');
    return false;
  }

  // Top-level runner
  async function run() {
    log('=== MB Batch Instrument Adder starting ===');
    // 1) select all recordings
    await selectAllRecordings();

    // 2) click Batch-add a relationship to recordings
    const clicked = await clickBatchAddButton();
    if (!clicked) { console.error('[MB-batch] Could not click batch-add button.'); return; }

    // 3) wait for modal
    const modal = await waitForModalDialog();
    if (!modal) { console.error('[MB-batch] Modal did not appear.'); return; }

    // small pause for React rendering
    await sleep(MED);

    // 4) set relationship type to instrument
    await setRelationshipType(modal);

    // 5) set entity type to Artist
    await setEntityTypeToArtist(modal);

    // 6) type & choose artist
    const okArtist = await setTargetArtist(modal, ARTIST_NAME);
    if (!okArtist) log('[MB-batch] Warning: artist selection may have failed.');

    // 7) set instrument attribute (if possible)
    await setInstrumentAttribute(modal, INSTRUMENT_NAME);

    // 8) click Apply/Add
    const okApply = await clickModalApply(modal);
    if (!okApply) console.error('[MB-batch] Could not find/press Apply button. Inspect modal manually.');

    log('=== MB Batch Instrument Adder finished ===');
  }

  // insert a small control button for the user to run the script manually
  function injectControl() {
    if (document.getElementById('mb-batch-instrument-button')) return;
    const heading = Array.from(document.querySelectorAll('h2, h3, h4, .header, .panel-heading')).find(h => textContains(h, 'Track relationships') || textContains(h, 'Relationships') || textContains(h, 'Recording'));
    const container = heading ? heading.parentElement : document.body;
    const btn = document.createElement('button');
    btn.id = 'mb-batch-instrument-button';
    btn.textContent = 'Batch-add Artist+Instrument to all tracks';
    btn.style.cssText = 'margin-left:10px;padding:6px 10px;background:#2b6cb0;color:white;border-radius:4px;border:0;cursor:pointer';
    btn.addEventListener('click', async (e) => {
      btn.disabled = true;
      try {
        await run();
      } catch (err) {
        console.error('[MB-batch] Unexpected error:', err);
      } finally {
        btn.disabled = false;
      }
    });
    if (heading) heading.parentElement.appendChild(btn);
    else document.body.prepend(btn);
  }

  // wait until page ready enough and inject the control button
  await waitFor(() => document.readyState === 'complete' || document.readyState === 'interactive', 20, 200);
  injectControl();
  log('Script loaded. Control button injected (or available).');

})();
#+end_example

#+begin_example
// ==UserScript==
// @name         MusicBrainz React: Batch-add same Instrument to all recordings
// @namespace    https://musicbrainz.org/
// @version      1.0
// @description  On the React release relationship editor page, open the "Batch-add relationships" modal and fill Relationship=Instrument, Target=Artist, Attribute=Instrument then apply to all recordings. Use responsibly; test on a draft/edit you can revert.
// @match        https://musicbrainz.org/release/*/edit-relationships
// @grant        none
// @run-at       document-idle
// ==/UserScript==

/* Notes:
 * - The React editor DOM changes from time to time; this script uses robust text-based matching,
 *   role attributes (combobox/listbox), and retries to cope with dynamic rendering.
 * - If MusicBrainz changes labels (i.e., localized), the button-text matching might need adjusting.
 */

(function () {
  'use strict';

  /* ---------- Configuration ---------- */
  const CONFIG = {
    retryAttempts: 40,
    retryInterval: 200,        // ms between polls
    afterTypeDelay: 450,       // wait after typing into combobox before searching listbox
    verbose: true
  };

  function log(...args) { if (CONFIG.verbose) console.log('[MB-batchA]', ...args); }
  function sleep(ms) { return new Promise((res) => setTimeout(res, ms)); }

  /* ---------- Utilities ---------- */

  // Wait until a function returns a truthy value, or timeout
  async function waitFor(fn, attempts = CONFIG.retryAttempts, interval = CONFIG.retryInterval) {
    for (let i = 0; i < attempts; i++) {
      try {
        const res = fn();
        if (res) return res;
      } catch (e) {
        // ignore errors from fn while DOM is not ready
      }
      await sleep(interval);
    }
    return null;
  }

  // Case-insensitive text matcher for elements
  function elementTextIncludes(el, text) {
    if (!el) return false;
    return (el.textContent || '').toLowerCase().includes(text.toLowerCase());
  }

  // Find a button or element by visible text (partial match). Returns first match.
  function findByText(tagList, text, root = document) {
    const tags = Array.isArray(tagList) ? tagList : [tagList];
    for (const tag of tags) {
      const nodes = Array.from(root.querySelectorAll(tag));
      const found = nodes.find((n) => elementTextIncludes(n, text));
      if (found) return found;
    }
    return null;
  }

  // Emulate robust clicks: focus, mouse events, native click
  function robustClick(el) {
    if (!el) return false;
    try {
      el.focus && el.focus();
      // mouse events
      ['mousedown', 'mouseup', 'click'].forEach((t) => el.dispatchEvent(new MouseEvent(t, { bubbles: true, cancelable: true, view: window })));
      // DOM click
      if (typeof el.click === 'function') el.click();
      return true;
    } catch (e) {
      console.warn('[MB-batchA] robustClick error', e);
      return false;
    }
  }

  // Set value on a combobox-like input and emit events to trigger React typeahead
  function setComboboxInputValue(inputEl, value) {
    if (!inputEl) throw new Error('No input element provided');
    inputEl.focus && inputEl.focus();
    // set value (works for React controlled inputs in many cases if we also dispatch input)
    const prev = inputEl.value;
    inputEl.value = value;
    // create and dispatch events
    const evInput = new Event('input', { bubbles: true });
    inputEl.dispatchEvent(evInput);
    const evChange = new Event('change', { bubbles: true });
    inputEl.dispatchEvent(evChange);
    // small blur/focus sequence sometimes helps
    try { inputEl.blur && inputEl.blur(); } catch {}
    try { inputEl.focus && inputEl.focus(); } catch {}
    // restore previous if empty string requested? we set to desired value already
    return prev;
  }

  // Given a combobox input element, try to pick a listbox option whose text contains 'wantText'
  // Returns true if picked.
  async function pickFromListbox(wantText, root = document, attempts = CONFIG.retryAttempts) {
    for (let i = 0; i < attempts; i++) {
      // listbox: role="listbox" commonly used by react typeaheads; fallback to ul[role=listbox] li
      const listboxes = Array.from(root.querySelectorAll('[role="listbox"], ul, div[role="presentation"]')).filter(Boolean);
      for (const box of listboxes) {
        // options are often role="option" or li/div items
        const opts = Array.from(box.querySelectorAll('[role="option"], li, div')).filter(Boolean);
        if (!opts.length) continue;
        // find best match
        const match = opts.find((o) => elementTextIncludes(o, wantText));
        const opt = match || opts[0];
        if (opt) {
          // try clicking
          robustClick(opt);
          return true;
        }
      }
      await sleep(CONFIG.retryInterval);
    }
    return false;
  }

  /* ---------- UI Panel (small) ---------- */

  function injectPanel() {
    if (document.getElementById('mb-batch-adder-panel')) return;
    const panel = document.createElement('div');
    panel.id = 'mb-batch-adder-panel';
    Object.assign(panel.style, {
      position: 'fixed',
      top: '110px',
      right: '14px',
      width: '320px',
      zIndex: 999999,
      background: '#fff',
      border: '1px solid #bbb',
      padding: '10px',
      borderRadius: '8px',
      boxShadow: '0 6px 18px rgba(0,0,0,0.12)',
      fontFamily: 'Arial, sans-serif',
      fontSize: '13px'
    });

    panel.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <strong>MB Batch Instrument (A)</strong>
        <button id="mb-batch-close" title="Close" style="border:none;background:transparent;cursor:pointer;font-size:14px">‚úï</button>
      </div>
      <label style="font-size:12px">Artist (target):</label>
      <input id="mb-batch-artist" placeholder="e.g. Nils Lofgren" style="width:100%;margin-bottom:6px;padding:6px;box-sizing:border-box" />
      <label style="font-size:12px">Instrument (attribute):</label>
      <input id="mb-batch-instrument" placeholder="e.g. electric guitar" style="width:100%;margin-bottom:8px;padding:6px;box-sizing:border-box" />
      <div style="display:flex;gap:6px">
        <button id="mb-batch-run" style="flex:1;padding:8px;border-radius:6px;border:1px solid #333;cursor:pointer;background:#2b6cb0;color:white">Run</button>
        <button id="mb-batch-help" style="padding:8px;border-radius:6px;border:1px solid #777;cursor:pointer">Help</button>
      </div>
      <div id="mb-batch-status" style="margin-top:8px;font-size:12px;color:#333">Idle</div>
    `;
    document.body.appendChild(panel);

    document.getElementById('mb-batch-close').addEventListener('click', () => panel.remove());
    document.getElementById('mb-batch-help').addEventListener('click', showHelp);
    document.getElementById('mb-batch-run').addEventListener('click', runBatchFromUI);
  }

  function showHelp() {
    alert('This script will open MusicBrainz\'s "Batch-add relationships" modal and fill:\n\n- Relationship type: Instrument\n- Target: Artist (the name you entered)\n- Attribute (instrument): Instrument (the name you entered)\n\nAfter running, verify the modal and click the final Apply/Done button yourself to avoid accidental mass edits.\n\nIf something doesn\'t work, open the browser console to see logs.');
  }

  /* ---------- Core automation flow for Option A ---------- */

  async function runBatchFromUI() {
    const artist = (document.getElementById('mb-batch-artist').value || '').trim();
    const instr = (document.getElementById('mb-batch-instrument').value || '').trim();
    const statusEl = document.getElementById('mb-batch-status');

    if (!artist || !instr) {
      alert('Please enter both Artist and Instrument.');
      return;
    }

    statusEl.textContent = 'Starting: attempting to open Batch-add modal...';
    log('Requested batch add for artist=', artist, 'instrument=', instr);

    // 1) Find and click the existing "Batch-add relationships" button (text match).
    // Try multiple text variants to be robust.
    const batchBtnTextCandidates = [
      'Batch-add relationships',
      'Batch add relationships',
      'Batch-add a relationship to recordings',
      'Batch-add a relationship'
    ];

    let batchBtn = null;
    for (const txt of batchBtnTextCandidates) {
      batchBtn = findByText(['button', 'a', 'div'], txt);
      if (batchBtn) break;
    }

    if (!batchBtn) {
      // fallback: try heading "Track relationships" and find sibling button
      const heading = findByText(['h2','h3','h4','legend'], 'Track relationships') || findByText(['h2','h3','h4','legend'], 'Relationships');
      if (heading) {
        // look for a button near heading
        const nearbyBtn = heading.parentElement ? heading.parentElement.querySelector('button, a') : null;
        if (nearbyBtn) batchBtn = nearbyBtn;
      }
    }

    if (!batchBtn) {
      statusEl.textContent = 'ERROR: Could not find Batch-add button on page. See console.';
      console.error('[MB-batchA] Could not locate Batch-add relationships button.');
      return;
    }

    // click to open modal
    robustClick(batchBtn);
    statusEl.textContent = 'Batch modal opened (or clicked). Waiting for modal...';
    log('Clicked batch button, waiting for modal...');

    // 2) Wait for modal to appear. We look for role="dialog" or an element with text "Batch" and "Relationship".
    const modal = await waitFor(() => {
      // typical React modal has role dialog
      const m1 = document.querySelector('[role="dialog"]');
      if (m1 && elementTextIncludes(m1, 'Batch')) return m1;
      // fallback: modal container with "Batch" text
      const nodes = Array.from(document.querySelectorAll('div')).filter(n => elementTextIncludes(n, 'Batch') && n.querySelector('input, [role="combobox"]'));
      if (nodes.length) return nodes[0];
      return null;
    }, CONFIG.retryAttempts, CONFIG.retryInterval);

    if (!modal) {
      statusEl.textContent = 'ERROR: Batch modal did not appear. See console.';
      console.error('[MB-batchA] Batch modal not found.');
      return;
    }
    log('Modal found:', modal);
    statusEl.textContent = 'Modal detected. Filling relationship type...';

    // 3) Relationship Type: find the combobox/select that sets type and set to 'instrument' (or variant)
    // Look for labels nearby that say "Relationship type", or find combobox with placeholder "Search" etc.
    const typeCandidates = Array.from(modal.querySelectorAll('input[role="combobox"], input[type="text"], select')).filter(Boolean);
    let typeInput = null;
    // Heuristics: label text, aria-label, placeholder
    for (const el of typeCandidates) {
      const lab = (el.getAttribute('aria-label') || '') + ' ' + (el.placeholder || '') + ' ' + ((el.labels && el.labels[0] && el.labels[0].textContent) || '');
      if (lab.toLowerCase().includes('relationship') || lab.toLowerCase().includes('type')) {
        typeInput = el;
        break;
      }
    }
    // fallback: first combobox in modal
    if (!typeInput) typeInput = typeCandidates.find(e => e.getAttribute('role') === 'combobox') || typeCandidates[0];

    if (!typeInput) {
      statusEl.textContent = 'ERROR: Could not find Relationship Type input. See console.';
      console.error('[MB-batchA] Relationship Type input not found in modal.', modal);
      return;
    }

    // Set relationship type to "instrument" (try plural/singular)
    setComboboxInputValue(typeInput, 'instrument');
    await sleep(CONFIG.afterTypeDelay);

    // pick from listbox
    const pickedType = await pickFromListbox('instrument', modal);
    log('Picked relationship type:', pickedType);
    if (!pickedType) {
      console.warn('[MB-batchA] Could not pick "instrument" option automatically; leaving typed text and continuing.');
    }
    statusEl.textContent = 'Relationship type set. Filling artist (Target)...';

    // 4) Target (Artist) combobox: find the next combobox after the type input or labeled 'Target' or 'Artist'
    // We'll search inputs in modal and prefer those with aria-label/placeholder mentioning 'target'/'artist'/'entity'.
    const inputs = Array.from(modal.querySelectorAll('input[role="combobox"], input[type="text"], textarea')).filter(Boolean);
    let artistInput = null;
    for (const el of inputs) {
      const meta = ((el.getAttribute('aria-label') || '') + ' ' + (el.placeholder || '') + ' ' + (el.getAttribute('name') || '') + ' ' + ((el.labels && el.labels[0] && el.labels[0].textContent) || '')).toLowerCase();
      if (meta.includes('target') || meta.includes('artist') || meta.includes('entity') || meta.includes('artist/target')) { artistInput = el; break; }
    }
    // fallback: the input after typeInput in DOM order
    if (!artistInput && typeInput) {
      const idx = inputs.indexOf(typeInput);
      if (idx >= 0 && inputs[idx + 1]) artistInput = inputs[idx + 1];
    }
    // final fallback: first combobox different from typeInput
    if (!artistInput) artistInput = inputs.find(i => i !== typeInput);

    if (!artistInput) {
      statusEl.textContent = 'ERROR: Could not find Target/Artist input. See console.';
      console.error('[MB-batchA] Artist/target input not found in modal.', modal);
      return;
    }

    // set artist
    setComboboxInputValue(artistInput, artist);
    await sleep(CONFIG.afterTypeDelay);
    const pickedArtist = await pickFromListbox(artist, modal);
    log('Picked artist option:', pickedArtist);
    if (!pickedArtist) console.warn('[MB-batchA] Artist option not picked automatically; please pick manually in modal.');

    statusEl.textContent = 'Artist set. Filling instrument attribute...';

    // 5) Attribute / Instrument input: many editors place attributes in a separate "attribute" input field.
    // Find an input whose label/aria mentions 'instrument' or 'attribute'
    let attrInput = null;
    for (const el of inputs) {
      const meta = ((el.getAttribute('aria-label') || '') + ' ' + (el.placeholder || '') + ' ' + ((el.labels && el.labels[0] && el.labels[0].textContent) || '')).toLowerCase();
      if (meta.includes('instrument') || meta.includes('attribute') || meta.includes('role')) { attrInput = el; break; }
    }
    // If not found, search for any input inside modal that seems like "attribute" area using nearby label text in DOM
    if (!attrInput) {
      const labels = Array.from(modal.querySelectorAll('label')).filter(Boolean);
      const instrumentLabel = labels.find(l => elementTextIncludes(l, 'Instrument') || elementTextIncludes(l, 'attribute'));
      if (instrumentLabel && instrumentLabel.htmlFor) {
        attrInput = modal.querySelector('#' + CSS.escape(instrumentLabel.htmlFor));
      }
    }
    // final fallback: try to find a small text input near the bottom of modal
    if (!attrInput) {
      const smallInputs = inputs.filter(i => (i.offsetWidth || 0) < 600);
      if (smallInputs.length) attrInput = smallInputs[smallInputs.length - 1];
    }

    if (!attrInput) {
      // Attribute field may be rendered only after selecting target/type. Warn but continue.
      console.warn('[MB-batchA] Attribute input not detected automatically. The modal may present attribute fields inline or as a separate component. You may need to fill instrument manually.');
      statusEl.textContent = 'Attribute input not found automatically ‚Äî please fill Instrument manually in modal.';
      return;
    }

    // Fill attribute (instrument)
    setComboboxInputValue(attrInput, instr);
    await sleep(CONFIG.afterTypeDelay);
    const pickedAttr = await pickFromListbox(instr, modal);
    log('Picked attribute option:', pickedAttr);
    if (!pickedAttr) console.warn('[MB-batchA] Could not pick attribute option automatically; please pick it manually.');

    statusEl.textContent = 'Fields filled. Please review the modal and click the final "Add relationships" / "Apply" / "Done" button to complete the edit.';

    // Attempt to click modal "Add relationships" or "Apply" automatically as a convenience,
    // but DO NOT force final submit if you prefer to inspect.
    const finishBtnCandidates = ['Add relationships', 'Apply', 'Apply to selected recordings', 'Add relationship', 'Save', 'Done'];
    for (const txt of finishBtnCandidates) {
      const btn = findByText(['button', 'a', 'div'], txt, modal);
      if (btn) {
        log('Attempting to click finish button:', txt, btn);
        robustClick(btn);
        statusEl.textContent = `Clicked "${txt}". If nothing happened, please click it manually.`;
        break;
      }
    }

    log('runBatchFromUI finished; user should verify modal and finalise.');
  }

  /* ---------- Init ---------- */
  function init() {
    injectPanel();
    log('MB batch-instrument (Option A) script initialised. Panel injected.');
  }

  // Wait for page to be interactive and inject panel
  window.addEventListener('load', () => {
    setTimeout(init, 700);
  });

  // also try immediate init if DOM already loaded
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
    setTimeout(init, 500);
  }

})();
#+end_example

*** new logic - 1

#+begin_example
// ==UserScript==
// @name         AA - Minimal Add Instrument Button (react release editor)
// @namespace    https://musicbrainz.org/
// @version      1.1
// @description  Adds a button after ‚ÄúTrack relationships‚Äù header and triggers batch-add button. Includes fallback DOM logging.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument-btn]', ...args);
    }

    /** Wait until fn() returns non-null, or timeout. */
    async function waitFor(fn, attempts = 30, interval = 300) {
        for (let i = 0; i < attempts; i++) {
            try {
                const v = fn();
                if (v) return v;
            } catch (e) {}
            await new Promise(r => setTimeout(r, interval));
        }
        return null;
    }

    /** Creates a detailed log of every <button> and <a> on the page. */
    function logAllButtonsAndLinks() {
        const elements = Array.from(document.querySelectorAll('button, a'));

        console.group('[AA] Fallback: listing all buttons and links (' + elements.length + ')');
        elements.forEach((el, idx) => {
            console.group('Element #' + idx);
            console.log('Text:', el.textContent.trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('Aria:', {
                label: el.getAttribute('aria-label'),
                haspopup: el.getAttribute('aria-haspopup'),
                pressed: el.getAttribute('aria-pressed'),
            });
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();

        alert(
            "AA Script: could NOT find the batch-add button.\n\n" +
            "I logged ALL <button> and <a> elements in console.\n" +
            "Open the browser console and search for the real button."
        );
    }

    /** Insert our ‚ÄúAdd instrument‚Äù button */
    async function insertButton() {
        const heading = Array.from(document.querySelectorAll('h1, h2, h3, h4, .section-header, .header'))
            .find(el => (el.textContent || '').toLowerCase().includes('track relationships'));

        if (!heading) {
            log('Heading ‚ÄúTrack relationships‚Äù not found yet ‚Äî retrying‚Ä¶');
            return false;
        }

        // avoid double insertion
        if (document.getElementById('aa-add-instrument-btn')) return true;

        const btn = document.createElement('button');
        btn.id = 'aa-add-instrument-btn';
        btn.textContent = 'Add instrument';
        btn.style.marginLeft = '10px';
        btn.style.padding = '4px 8px';
        btn.style.border = '1px solid #444';
        btn.style.borderRadius = '4px';
        btn.style.background = '#0066cc';
        btn.style.color = 'white';
        btn.style.cursor = 'pointer';

        btn.addEventListener('click', () => {
            log('Custom button clicked ‚Äî trying to trigger batch-add button‚Ä¶');

            // First attempt: exact selector you provided
            const exact = document.querySelector(
                'button.add-item.with-label.batch-add-recording-relationship'
            );
            if (exact) {
                log('Found batch-add button by exact class ‚Äî clicking.');
                exact.click();
                return;
            }

            // Second attempt: text-based search
            const candidates = Array.from(document.querySelectorAll('button, a'));
            const match = candidates.find(el => {
                const t = (el.textContent || '').toLowerCase();
                return t.includes('batch-add') && (t.includes('record') || t.includes('recording'));
            });

            if (match) {
                log('Found batch-add button by text fallback ‚Äî clicking:', match);
                match.click();
                return;
            }

            // If all failed ‚Üí log everything
            console.error('[AA] Could NOT find the batch-add button!');
            logAllButtonsAndLinks();
        });

        // Add our button after the heading
        heading.insertAdjacentElement('afterend', btn);
        log('Injected custom ‚ÄúAdd instrument‚Äù button.');
        return true;
    }


    // Start trying to insert button (React may delay rendering)
    (async () => {
        const ok = await waitFor(insertButton, 40, 500);
        if (!ok) console.warn('[AA] Could not insert Add instrument button ‚Äî giving up.');
    })();

})();
#+end_example

#+begin_example
// ==UserScript==
// @name         AA - Add Instrument Button (React Release Editor)
// @namespace    https://musicbrainz.org/
// @version      1.3
// @description  Insert ‚ÄúAdd instrument (React)‚Äù button after Track relationships and trigger batch-add button. Includes fallback logging.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    function logAllButtonsAndLinks() {
        const elems = $('button, a');
        console.group('[AA] Fallback: Dumping all buttons/links (' + elems.length + ')');
        elems.each((i, el) => {
            console.group('Element #' + i);
            console.log('Text:', $(el).text().trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();

        alert("AA Script: Could NOT find the batch-add button.\n\nAll button/link elements have been logged in the console.");
    }

    function createCustomButton() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButton, 500);
            return;
        }

        if ($('#aa-add-instrument').length) return;

        const $button = $('<button/>', {
            id: 'aa-add-instrument',
            text: "Add instrument (React)",
            style: `
                margin-left: 10px;
                background-color: #38a169;
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
            `
        });

        $heading.wrap('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.parent().append($button);

        log("AA: Button injected next to 'Track relationships'.");

        $button.on('click', () => {
            log("Custom button clicked ‚Üí searching for batch-add button‚Ä¶");

            const $batch = $("button.add-item.with-label.batch-add-recording-relationship");

            if ($batch.length) {
                log("Found batch-add button by exact match ‚Üí clicking.");
                $batch[0].click();
                return;
            }

            log("Exact match failed ‚Üí trying text-based fallback‚Ä¶");

            const $fallback = $("button, a").filter((i, el) => {
                const t = $(el).text().toLowerCase();
                return t.includes("batch-add") && (t.includes("record") || t.includes("recording"));
            });

            if ($fallback.length) {
                log("Found batch-add button by text fallback ‚Üí clicking.");
                $fallback[0].click();
                return;
            }

            log("Batch-add button NOT found ‚Üí dumping all buttons for inspection.");
            logAllButtonsAndLinks();
        });
    }

    $(document).ready(createCustomButton);

})();
#+end_example

*** with working "instruments"

Please extend the following working userscript:

#+begin_example
// ==UserScript==
// @name         AA - Add Instrument Button (React Release Editor)
// @namespace    https://musicbrainz.org/
// @version      1.4
// @description  Insert ‚ÄúAdd instrument (React)‚Äù button, open batch-add dialog, auto-fill relationship type = "instruments".
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    /** Dumps all buttons & links in case selectors fail */
    function logAllButtonsAndLinks() {
        const elems = $('button, a');
        console.group('[AA] Fallback: Dumping all buttons/links (' + elems.length + ')');
        elems.each((i, el) => {
            console.group('Element #' + i);
            console.log('Text:', $(el).text().trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();

        alert("AA Script: Could NOT find the batch-add button.\n\nAll button/link elements have been logged in the console.");
    }

    /** Simulate real typing so React autocomplete updates correctly */
function typeIntoAutocomplete($input, text) {
    const el = $input[0];
    el.focus();

    let idx = 0;

    function reactInput(el, newValue) {
        const last = el.value;
        el.value = newValue;

        const e = new InputEvent("input", {
            bubbles: true,
            cancelable: true,
            inputType: "insertText",
            data: newValue.replace(last, "")
        });

        el.dispatchEvent(e);
    }

    function clickInstrumentsOption() {
        // Find the dropdown item labeled "instruments" (case-insensitive)
        const $opt = $("li[role='option']").filter((i, el) =>
            $(el).text().trim().toLowerCase().startsWith("instruments")
        );

        if ($opt.length) {
            log("Clicking dropdown option: instruments");
            $opt[0].click();
        } else {
            log("Dropdown list not ready yet ‚Üí retrying‚Ä¶");
            setTimeout(clickInstrumentsOption, 100);
        }
    }

    function typeNext() {
        if (idx >= text.length) {
            // After typing, give React time to populate the dropdown
            setTimeout(clickInstrumentsOption, 150);
            return;
        }

        const ch = text[idx];
        const newValue = el.value + ch;
        reactInput(el, newValue);

        idx++;
        setTimeout(typeNext, 50);
    }

    typeNext();
}

    /** After the dialog appears, fill in the 'Relationship type' field with "instruments" */
    function fillRelationshipType() {
        log("Checking for Relationship Type input‚Ä¶");

        const $input = $('input.relationship-type:visible');

        if ($input.length === 0) {
            log("Relationship type field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(fillRelationshipType, 250);
            return;
        }

        log("Found Relationship type field ‚Üí typing 'instruments'");
        typeIntoAutocomplete($input, "instruments");
    }

    /** MAIN: Create the custom button next to "Track relationships" */
    function createCustomButton() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButton, 500);
            return;
        }

        if ($('#aa-add-instrument').length) return;

        const $button = $('<button/>', {
            id: 'aa-add-instrument',
            text: "Add instrument (React)",
            style: `
                margin-left: 10px;
                background-color: #38a169;
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
            `
        });

        // Insert next to heading
        $heading.wrap('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.parent().append($button);

        log("AA: Injected custom button next to 'Track relationships'.");

        // Button click = open dialog
        $button.on('click', () => {
            log("Custom button clicked ‚Üí searching for batch-add button‚Ä¶");

            const tryBatchClick = () => {
                const $batch = $("button.add-item.with-label.batch-add-recording-relationship");
                if ($batch.length) {
                    log("Found batch-add button (exact class) ‚Üí clicking.");
                    $batch[0].click();
                    setTimeout(fillRelationshipType, 300);
                    return true;
                }
                return false;
            };

            if (!tryBatchClick()) {
                log("Exact match failed ‚Äî trying fallback text search‚Ä¶");

                const $fallback = $("button, a").filter((i, el) => {
                    const t = $(el).text().toLowerCase();
                    return t.includes("batch-add") && t.includes("record");
                });

                if ($fallback.length) {
                    log("Fallback batch-add button found ‚Üí clicking.");
                    $fallback[0].click();
                    setTimeout(fillRelationshipType, 300);
                } else {
                    log("Batch-add button not found ‚Üí logging all buttons/links.");
                    logAllButtonsAndLinks();
                }
            }
        });
    }

    $(document).ready(createCustomButton);

})();
#+end_example

with the following functionality.

After filling in the "instruments" into the "Relationship type" field...

Please emulate typing "Max Weinberg" to the "Artist" field, which says "Type to search, or paste an MBID"
and again at the end choose "Max Weinberg" from the popup suggestion list.

Afterwards emulate typing "drums (drum set)" to the "Instrument" field, which says "instrument"
and again at the end choose "drums (drum set)" from the popup suggestion list.

Afterwards emulate a "Tab" to reach the text field which says "Credited as" and type in "drums". Note that this last
field seems to be a normal text field without autocompletion, at least its suggested when a human types in (nothing gets
validated, so you could enter whatever string you want).

#+begin_example
// ==UserScript==
// @name         AA - Add Instrument Button (React Release Editor) Extended
// @namespace    https://musicbrainz.org/
// @version      1.5
// @description  Insert ‚ÄúAdd instrument (React)‚Äù button, open batch-add dialog, auto-fill relationship type = "instruments", then Artist, Instrument, and Credited as fields.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    function logAllButtonsAndLinks() {
        const elems = $('button, a');
        console.group('[AA] Fallback: Dumping all buttons/links (' + elems.length + ')');
        elems.each((i, el) => {
            console.group('Element #' + i);
            console.log('Text:', $(el).text().trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();
        alert("AA Script: Could NOT find the batch-add button.\n\nAll button/link elements have been logged in the console.");
    }

    function typeIntoAutocomplete($input, text, callback) {
        const el = $input[0];
        el.focus();

        let idx = 0;

        function reactInput(el, newValue) {
            const last = el.value;
            el.value = newValue;

            const e = new InputEvent("input", {
                bubbles: true,
                cancelable: true,
                inputType: "insertText",
                data: newValue.replace(last, "")
            });

            el.dispatchEvent(e);
        }

        function clickOptionMatching(prefix) {
            const $opt = $("li[role='option']").filter((i, el) =>
                $(el).text().trim().toLowerCase().startsWith(prefix.toLowerCase())
            );

            if ($opt.length) {
                log(`Clicking dropdown option: ${prefix}`);
                $opt[0].click();
                if (callback) callback();
            } else {
                log(`Dropdown option "${prefix}" not ready yet ‚Üí retrying‚Ä¶`);
                setTimeout(() => clickOptionMatching(prefix), 100);
            }
        }

        function typeNext() {
            if (idx >= text.length) {
                setTimeout(() => clickOptionMatching(text), 150);
                return;
            }

            const ch = text[idx];
            const newValue = el.value + ch;
            reactInput(el, newValue);

            idx++;
            setTimeout(typeNext, 50);
        }

        typeNext();
    }

    function fillRelationshipType() {
        log("Checking for Relationship Type input‚Ä¶");

        const $input = $('input.relationship-type:visible');

        if ($input.length === 0) {
            log("Relationship type field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(fillRelationshipType, 250);
            return;
        }

        log("Found Relationship type field ‚Üí typing 'instruments'");
        typeIntoAutocomplete($input, "instruments", fillArtistField);
    }

    // --- New sequence: Artist ‚Üí Instrument ‚Üí Credited as ---

    function fillArtistField() {
        log("Filling Artist field‚Ä¶");
        const $artist = $('input[placeholder="Type to search, or paste an MBID"]:visible');

        if ($artist.length === 0) {
            log("Artist field not ready ‚Äî retrying‚Ä¶");
            setTimeout(fillArtistField, 250);
            return;
        }

        typeIntoAutocomplete($artist, "Max Weinberg", fillInstrumentField);
    }

    function fillInstrumentField() {
        log("Filling Instrument field‚Ä¶");
        const $instr = $('input[placeholder="instrument"]:visible');

        if ($instr.length === 0) {
            log("Instrument field not ready ‚Äî retrying‚Ä¶");
            setTimeout(fillInstrumentField, 250);
            return;
        }

        typeIntoAutocomplete($instr, "drums (drum set)", fillCreditedAsField);
    }

    function
#+end_example

Everything works up to filling in "drums (drum set)", but the tabbing in the next empty field (which holds the text "Credited as" as a hint) doesn't work.
Instead the console output shows

#+begin_example
[AA-add-instrument] Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] AA: Injected custom button next to 'Track relationships'.
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Custom button clicked ‚Üí searching for batch-add button‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Found batch-add button (exact class) ‚Üí clicking.
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Checking for Relationship Type input‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Found Relationship type field ‚Üí typing 'instruments'
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: instruments
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling Artist field‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: Max Weinberg
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling Instrument field‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: drums (drum set)
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling 'Credited as' field‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] 'Credited as' field filled.
edit-relationships:1 Blocked aria-hidden on an element because its descendant retained focus. The focus must not be hidden from assistive technology users. Avoid using aria-hidden on a focused element or its ancestor. Consider using the inert attribute instead, which will also prevent focus. For more details, see the aria-hidden section of the WAI-ARIA specification at https://w3c.github.io/aria/#aria-hidden.
Element with focus: <input#headerid-query>
Ancestor with aria-hidden: <div.header> <div class=‚Äã"header" data-floating-ui-inert aria-hidden=‚Äã"true">‚Äã‚Ä¶‚Äã</div>
#+end_example

I now get

#+begin_example
[AA-add-instrument] Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] AA: Injected custom button next to 'Track relationships'.
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Custom button clicked ‚Üí searching for batch-add button‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Found batch-add button (exact class) ‚Üí clicking.
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Checking for Relationship Type input‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Found Relationship type field ‚Üí typing 'instruments'
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: instruments
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling Artist field‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: Max Weinberg
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling Instrument field‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: drums (drum set)
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling 'Credited as' field‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] 'Credited as' field filled successfully.
edit-relationships:1 Blocked aria-hidden on an element because its descendant retained focus. The focus must not be hidden from assistive technology users. Avoid using aria-hidden on a focused element or its ancestor. Consider using the inert attribute instead, which will also prevent focus. For more details, see the aria-hidden section of the WAI-ARIA specification at https://w3c.github.io/aria/#aria-hidden.
Element with focus: <input#headerid-query>
Ancestor with aria-hidden: <div.header> <div class=‚Äã"header" data-floating-ui-inert aria-hidden=‚Äã"true">‚Äã‚Ä¶‚Äã</div>‚ÄãUnderstand this warning
#+end_example


It's still not working. Here is the complete generated HTML code up to the point when the text "drums" should be inserted

#+begin_example
<div class="form">
  <div class="dialog-titlebar">
    <h1>Add relationship
    </h1>
    <div class="buttons-right">
      <span style="font-weight: normal;">(
	<a href="#">help
	</a>)
      </span>
    </div>
  </div>
  <p>This will add a relationship to all checked recordings.
  </p>
  <table class="relationship-details">
    <tbody>
      <tr>
	<td class="required section">Recording
	</td>
	<td class="fields">(31 recordings selected)
	</td>
      </tr>
      <tr>
	<td class="required section">Related type
	</td>
	<td class="fields">
	  <select class="entity-type">
	    <option value="area">Area
	    </option>
	    <option value="artist">Artist
	    </option>
	    <option value="event">Event
	    </option>
	    <option value="label">Label
	    </option>
	    <option value="place">Place
	    </option>
	    <option value="recording">Recording
	    </option>
	    <option value="release">Release
	    </option>
	    <option value="series">Series
	    </option>
	    <option value="work">Work
	    </option>
	  </select>
	</td>
      </tr>
    </tbody>
  </table>
  <h2>
    <div class="heading-line">
    </div>
    <span class="heading-text">Relationship
    </span>
  </h2>
  <table class="relationship-details">
    <tbody>
      <tr>
	<td class="required section">Relationship type
	</td>
	<td class="fields">
	  <label class="autocomplete2-label required" for="relationship-type-artist-recording--915" id="relationship-type-artist-recording--915-label">Type or click to search:
	  </label>
	  <div class="autocomplete2 relationship-type">
	    <div aria-expanded="false" aria-haspopup="listbox" aria-owns="relationship-type-artist-recording--915-menu" class="required" role="combobox">
	      <input aria-autocomplete="list" aria-controls="relationship-type-artist-recording--915-menu" aria-labelledby="relationship-type-artist-recording--915-label" aria-required="true" autocomplete="off" class="relationship-type lookup-performed" id="relationship-type-artist-recording--915" placeholder="Type or click to search" type="text" value="instruments">
	      <button aria-controls="relationship-type-artist-recording--915-menu" aria-haspopup="true" aria-label="Search" class="search" data-toggle="true" role="button" tabindex="-1" title="Search" type="button">
	      </button>
	    </div>
	    <ul aria-controls="relationship-type-artist-recording--915-status" aria-labelledby="relationship-type-artist-recording--915-label" id="relationship-type-artist-recording--915-menu" role="listbox" tabindex="-1">
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-type-artist-recording--915-item-148" role="option">instruments
		<br>
		<span class="autocomplete-comment">Indicates an artist that performed one or more instruments on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-type-artist-recording--915-item-158" role="option">instruments arranged / instruments arranger
		<br>
		<span class="autocomplete-comment">This indicates the artist who arranged a tune into a form suitable for performance. ‚ÄúArrangement‚Äù is used as a catch-all term for all processes that turn a composition into a form that can be played by a specific type of ensemble.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-type-artist-recording--915-item-986" role="option">instruments technician for / instruments technician
		<br>
		<span class="autocomplete-comment">Indicates the instrument technician for this recording. Use also for "piano tuner" credits and other similar ones.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="separator action-item " id="relationship-type-artist-recording--915-item-toggle-descriptions" role="option">Hide descriptions
	      </li>
	    </ul>
	    <div aria-live="assertive" aria-relevant="additions text" id="relationship-type-artist-recording--915-status" role="status">instruments
	    </div>
	  </div>
	  <div aria-atomic="true" class="error" role="alert">
	  </div>
	</td>
      </tr>
      <tr>
	<td class="required section">Artist
	</td>
	<td class="fields">
	  <label class="autocomplete2-label required" for="relationship-target--915" id="relationship-target--915-label">Search for an artist:
	  </label>
	  <div class="autocomplete2 relationship-target">
	    <div aria-expanded="false" aria-haspopup="listbox" aria-owns="relationship-target--915-menu" class="required" role="combobox">
	      <input aria-autocomplete="list" aria-controls="relationship-target--915-menu" aria-labelledby="relationship-target--915-label" aria-required="true" autocomplete="off" class="relationship-target lookup-performed" id="relationship-target--915" placeholder="Type to search, or paste an MBID" type="text" value="Max Weinberg">
	      <button aria-controls="relationship-target--915-menu" aria-haspopup="true" aria-label="Search" class="search" data-toggle="true" role="button" tabindex="-1" title="Search" type="button">
	      </button>
	    </div>
	    <ul aria-controls="relationship-target--915-status" aria-labelledby="relationship-target--915-label" id="relationship-target--915-menu" role="listbox" tabindex="-1">
	    </ul>
	    <div aria-live="assertive" aria-relevant="additions text" id="relationship-target--915-status" role="status">Max Weinberg
	    </div>
	  </div>
	  <div class="error">
	  </div>
	  <div class="target-entity-credit">
	    <input aria-description="A credited name is optional. You can leave this field blank to keep the current name." aria-label="Credited as" class="entity-credit" id=":rr1:" placeholder="Credited as" type="text" value="">
	    <span class="tooltip-wrapper">
	      <span class="img icon help" style="display: inline-block; margin-left: 10px; vertical-align: text-top;">
	      </span>
	      <span class="tooltip-container">
		<span class="tooltip-triangle">
		</span>
		<span class="tooltip-content">A credited name is optional. You can leave this field blank to keep the current name.
		</span>
	      </span>
	    </span>
	  </div>
	</td>
      </tr>
    </tbody>
  </table>
  <h2>
    <div class="heading-line">
    </div>
    <span class="heading-text">Attributes
    </span>
  </h2>
  <table class="relationship-details">
    <tbody>
      <tr>
	<td class="section">
	</td>
	<td class="fields">
	  <div class="attribute-container checkbox additional">
	    <label>
	      <input class="boolean" id="additional-checkbox" type="checkbox"> additional
	    </label>
	  </div>
	</td>
      </tr>
      <tr>
	<td class="section">
	</td>
	<td class="fields">
	  <div class="attribute-container checkbox guest">
	    <label>
	      <input class="boolean" id="guest-checkbox" type="checkbox"> guest
	    </label>
	  </div>
	</td>
      </tr>
      <tr>
	<td class="section">
	</td>
	<td class="fields">
	  <div class="attribute-container checkbox solo">
	    <label>
	      <input class="boolean" id="solo-checkbox" type="checkbox"> solo
	    </label>
	  </div>
	</td>
      </tr>
      <tr>
	<td class="section">Instrument
	</td>
	<td class="fields">
	  <div class="attribute-container multiselect instrument">
	    <div class="multiselect-value">
	      <label class="autocomplete2-label" for="attribute-924" id="attribute-924-label">instrument:
	      </label>
	      <div class="autocomplete2">
		<div aria-expanded="false" aria-haspopup="listbox" aria-owns="attribute-924-menu" role="combobox">
		  <input aria-autocomplete="list" aria-controls="attribute-924-menu" aria-labelledby="attribute-924-label" aria-required="false" autocomplete="off" class="lookup-performed" id="attribute-924" placeholder="instrument" type="text" value="drums (drum set)">
		  <button aria-controls="attribute-924-menu" aria-haspopup="true" aria-label="Search" class="search" data-toggle="true" role="button" tabindex="-1" title="Search" type="button">
		  </button>
		</div>
		<ul aria-controls="attribute-924-status" aria-labelledby="attribute-924-label" id="attribute-924-menu" role="listbox" tabindex="-1">
		  <li aria-disabled="false" aria-selected="false" class="option-item " id="attribute-924-item-126" role="option">drums (drum set)
		    <span class="autocomplete-comment">(Set of drums in modern music, Percussion instrument)
		    </span>
		    <br>
		    <span class="autocomplete-comment">Set of drums developed from the 1930's onward, it is used in Jazz, Swing, Rock and Pop music. It consists of snare drum, tom-toms, hi-hats, cymbals and bass drum.
		    </span>
		  </li>
		  <li aria-disabled="false" aria-selected="false" class="separator action-item " id="attribute-924-item-toggle-descriptions" role="option">Hide descriptions
		  </li>
		</ul>
		<div aria-live="assertive" aria-relevant="additions text" id="attribute-924-status" role="status">drums (drum set)
		</div>
	      </div>
	      <input aria-label="Credited as" class="attribute-credit" placeholder="Credited as" type="text" value="">
	      <button aria-disabled="false" class="remove-item icon" title="Remove" type="button">
	      </button>
	    </div>
	    <button class="add-item with-label" type="button"> Add instrument
	    </button>
	  </div>
	</td>
      </tr>
      <tr>
	<td class="section">
	  <label for="id-period.begin_date.year">Begin date
	  </label>
	</td>
	<td class="fields">
	  <span class="partial-date">
	    <input class="partial-date-year" id="id-period.begin_date.year" maxlength="4" name="period.begin_date.year" placeholder="YYYY" size="4" type="text" value="">-
	    <input class="partial-date-month" id="id-period.begin_date.month" maxlength="2" name="period.begin_date.month" placeholder="MM" size="2" type="text" value="">-
	    <input class="partial-date-day" id="id-period.begin_date.day" maxlength="2" name="period.begin_date.day" placeholder="DD" size="2" type="text" value="">
	  </span>
	  <button class="icon copy-date" title="Copy to end date" type="button">
	  </button>
	</td>
      </tr>
      <tr>
	<td class="section">
	  <label for="id-period.end_date.year">End date
	  </label>
	</td>
	<td class="fields end-date">
	  <span class="partial-date">
	    <input class="partial-date-year" id="id-period.end_date.year" maxlength="4" name="period.end_date.year" placeholder="YYYY" size="4" type="text" value="">-
	    <input class="partial-date-month" id="id-period.end_date.month" maxlength="2" name="period.end_date.month" placeholder="MM" size="2" type="text" value="">-
	    <input class="partial-date-day" id="id-period.end_date.day" maxlength="2" name="period.end_date.day" placeholder="DD" size="2" type="text" value="">
	  </span>
	  <br>
	  <div class="row">
	    <label class="inline">
	      <input id="id-period.ended" name="period.ended" type="checkbox" value="1"> This relationship has ended.
	    </label>
	  </div>
	</td>
      </tr>
    </tbody>
  </table>
  <h2>
    <div class="heading-line">
    </div>
    <span class="heading-text">Preview
    </span>
  </h2>
  <table class="preview details add-relationship">
    <tbody>
      <tr>
	<th>Relationship:
	</th>
	<td>
	  <a class="wrap-anywhere" target="_blank" href="/artist/2566ca73-1dfd-49e7-ab20-dfa5697b360e" title="Weinberg, Max">
	    <bdi>Max Weinberg
	    </bdi>
	  </a> performed
	  <a href="/instrument/12092505-6ee1-46af-a15a-b5b468b6b155">drums (drum set)
	  </a> on
	  <span class="tooltip" title="(31 recordings selected)">
	    <bdi>[selected recording]
	    </bdi>
	  </span>
	</td>
      </tr>
    </tbody>
  </table>
  <div class="buttons" style="margin-top: 1em;">
    <button class="negative" type="button">Cancel
    </button>
    <div class="buttons-right">
      <button class="positive" type="button">Done
      </button>
    </div>
  </div>
</div>
#+end_example

and here is the relevant part where it says "Credited as"

#+begin_example
	      <input aria-label="Credited as" class="attribute-credit" placeholder="Credited as" type="text" value="">
	      <button aria-disabled="false" class="remove-item icon" title="Remove" type="button">
#+end_example

The console output is

#+begin_example
[AA-add-instrument] Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] AA: Injected custom button next to 'Track relationships'.
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Custom button clicked ‚Üí searching for batch-add button‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Found batch-add button (exact class) ‚Üí clicking.
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Checking for Relationship Type input‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Found Relationship type field ‚Üí typing 'instruments'
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: instruments
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling Artist field‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: Max Weinberg
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling Instrument field‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: drums (drum set)
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling 'Credited as' field‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] 'Credited as' field filled successfully.
#+end_example

but still NOTHING gets inserted

#+begin_example
// ==UserScript==
// @name         AA - Add Instrument Button (React Release Editor) Extended
// @namespace    https://musicbrainz.org/
// @version      1.5
// @description  Insert ‚ÄúAdd instrument (React)‚Äù button, open batch-add dialog, auto-fill relationship type = "instruments", then Artist, Instrument, and Credited as fields.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    function logAllButtonsAndLinks() {
        const elems = $('button, a');
        console.group('[AA] Fallback: Dumping all buttons/links (' + elems.length + ')');
        elems.each((i, el) => {
            console.group('Element #' + i);
            console.log('Text:', $(el).text().trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();
        alert("AA Script: Could NOT find the batch-add button.\n\nAll button/link elements have been logged in the console.");
    }

    function typeIntoAutocomplete($input, text, callback) {
        const el = $input[0];
        el.focus();

        let idx = 0;

        function reactInput(el, newValue) {
            const last = el.value;
            el.value = newValue;

            const e = new InputEvent("input", {
                bubbles: true,
                cancelable: true,
                inputType: "insertText",
                data: newValue.replace(last, "")
            });

            el.dispatchEvent(e);
        }

        function clickOptionMatching(prefix) {
            const $opt = $("li[role='option']").filter((i, el) =>
                $(el).text().trim().toLowerCase().startsWith(prefix.toLowerCase())
            );

            if ($opt.length) {
                log(`Clicking dropdown option: ${prefix}`);
                $opt[0].click();
                if (callback) callback();
            } else {
                log(`Dropdown option "${prefix}" not ready yet ‚Üí retrying‚Ä¶`);
                setTimeout(() => clickOptionMatching(prefix), 100);
            }
        }

        function typeNext() {
            if (idx >= text.length) {
                setTimeout(() => clickOptionMatching(text), 150);
                return;
            }

            const ch = text[idx];
            const newValue = el.value + ch;
            reactInput(el, newValue);

            idx++;
            setTimeout(typeNext, 50);
        }

        typeNext();
    }

    function fillRelationshipType() {
        log("Checking for Relationship Type input‚Ä¶");

        const $input = $('input.relationship-type:visible');

        if ($input.length === 0) {
            log("Relationship type field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(fillRelationshipType, 250);
            return;
        }

        log("Found Relationship type field ‚Üí typing 'instruments'");
        typeIntoAutocomplete($input, "instruments", fillArtistField);
    }

    // --- New sequence: Artist ‚Üí Instrument ‚Üí Credited as ---

    function fillArtistField() {
        log("Filling Artist field‚Ä¶");
        const $artist = $('input[placeholder="Type to search, or paste an MBID"]:visible');

        if ($artist.length === 0) {
            log("Artist field not ready ‚Äî retrying‚Ä¶");
            setTimeout(fillArtistField, 250);
            return;
        }

        typeIntoAutocomplete($artist, "Max Weinberg", fillInstrumentField);
    }

    function fillInstrumentField() {
        log("Filling Instrument field‚Ä¶");
        const $instr = $('input[placeholder="instrument"]:visible');

        if ($instr.length === 0) {
            log("Instrument field not ready ‚Äî retrying‚Ä¶");
            setTimeout(fillInstrumentField, 250);
            return;
        }

        typeIntoAutocomplete($instr, "drums (drum set)", fillCreditedAsField);
    }

function fillCreditedAsField() {
    log("Filling 'Credited as' field‚Ä¶");

    // Find the last instrument multiselect container (the one we just filled)
    const $instrumentContainer = $('.multiselect.instrument').last();

    if ($instrumentContainer.length === 0) {
        log("Instrument container not found ‚Äî retrying‚Ä¶");
        setTimeout(fillCreditedAsField, 250);
        return;
    }

    const $creditedInput = $instrumentContainer.find('input.attribute-credit');

    if ($creditedInput.length === 0) {
        log("'Credited as' input not found ‚Äî retrying‚Ä¶");
        setTimeout(fillCreditedAsField, 250);
        return;
    }

    const el = $creditedInput[0];
    const value = "drums";

    // Clear first
    el.value = "";

    // Type character by character
    for (let i = 0; i < value.length; i++) {
        el.value += value[i];
        el.dispatchEvent(new Event('input', { bubbles: true }));
    }

    // Final change event to ensure React picks it up
    el.dispatchEvent(new Event('change', { bubbles: true }));

    log("'Credited as' field filled successfully.");
}

    function createCustomButton() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButton, 500);
            return;
        }

        if ($('#aa-add-instrument').length) return;

        const $button = $('<button/>', {
            id: 'aa-add-instrument',
            text: "Add instrument (React)",
            style: `
                margin-left: 10px;
                background-color: #38a169;
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
            `
        });

        $heading.wrap('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.parent().append($button);

        log("AA: Injected custom button next to 'Track relationships'.");

        $button.on('click', () => {
            log("Custom button clicked ‚Üí searching for batch-add button‚Ä¶");

            const tryBatchClick = () => {
                const $batch = $("button.add-item.with-label.batch-add-recording-relationship");
                if ($batch.length) {
                    log("Found batch-add button (exact class) ‚Üí clicking.");
                    $batch[0].click();
                    setTimeout(fillRelationshipType, 300);
                    return true;
                }
                return false;
            };

            if (!tryBatchClick()) {
                log("Exact match failed ‚Äî trying fallback text search‚Ä¶");

                const $fallback = $("button, a").filter((i, el) => {
                    const t = $(el).text().toLowerCase();
                    return t.includes("batch-add") && t.includes("record");
                });

                if ($fallback.length) {
                    log("Fallback batch-add button found ‚Üí clicking.");
                    $fallback[0].click();
                    setTimeout(fillRelationshipType, 300);
                } else {
                    log("Batch-add button not found ‚Üí logging all buttons/links.");
                    logAllButtonsAndLinks();
                }
            }
        });
    }

    $(document).ready(createCustomButton);

})();
#+end_example


#+begin_example
function typeIntoReactInput(el, text, callback) {
    el.focus({ preventScroll: true });
    let idx = 0;

    function typeNext() {
        if (idx >= text.length) {
            if (callback) callback();
            return;
        }

        const ch = text[idx];
        const newValue = el.value + ch;
        el.value = newValue;

        const inputEvent = new InputEvent("input", {
            bubbles: true,
            cancelable: true,
            inputType: "insertText",
            data: ch,
        });
        el.dispatchEvent(inputEvent);

        idx++;
        setTimeout(typeNext, 50);
    }

    typeNext();
}
#+end_example

#+begin_example
function fillCreditedAsField() {
    log("Filling 'Credited as' field‚Ä¶");

    const $instrumentContainer = $('.multiselect.instrument').last();
    if (!$instrumentContainer.length) {
        log("Instrument container not found ‚Äî retrying‚Ä¶");
        setTimeout(fillCreditedAsField, 250);
        return;
    }

    const $creditedInput = $instrumentContainer.find('input.attribute-credit');
    if (!$creditedInput.length) {
        log("'Credited as' input not found ‚Äî retrying‚Ä¶");
        setTimeout(fillCreditedAsField, 250);
        return;
    }

    const el = $creditedInput[0];
    typeIntoReactInput(el, "drums", () => {
        log("'Credited as' field filled successfully.");
    });
}
#+end_example

#+begin_example
// ==UserScript==
// @name         AA - Add Instrument Button (React Release Editor) Extended
// @namespace    https://musicbrainz.org/
// @version      1.5
// @description  Insert ‚ÄúAdd instrument (React)‚Äù button, open batch-add dialog, auto-fill relationship type = "instruments", then Artist, Instrument, and Credited as fields.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    function logAllButtonsAndLinks() {
        const elems = $('button, a');
        console.group('[AA] Fallback: Dumping all buttons/links (' + elems.length + ')');
        elems.each((i, el) => {
            console.group('Element #' + i);
            console.log('Text:', $(el).text().trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();
        alert("AA Script: Could NOT find the batch-add button.\n\nAll button/link elements have been logged in the console.");
    }

    function typeIntoAutocomplete($input, text, callback) {
        const el = $input[0];
        el.focus();

        let idx = 0;

        function reactInput(el, newValue) {
            const last = el.value;
            el.value = newValue;

            const e = new InputEvent("input", {
                bubbles: true,
                cancelable: true,
                inputType: "insertText",
                data: newValue.replace(last, "")
            });

            el.dispatchEvent(e);
        }

        function clickOptionMatching(prefix) {
            const $opt = $("li[role='option']").filter((i, el) =>
                $(el).text().trim().toLowerCase().startsWith(prefix.toLowerCase())
            );

            if ($opt.length) {
                log(`Clicking dropdown option: ${prefix}`);
                $opt[0].click();
                if (callback) callback();
            } else {
                log(`Dropdown option "${prefix}" not ready yet ‚Üí retrying‚Ä¶`);
                setTimeout(() => clickOptionMatching(prefix), 100);
            }
        }

        function typeNext() {
            if (idx >= text.length) {
                setTimeout(() => clickOptionMatching(text), 150);
                return;
            }

            const ch = text[idx];
            const newValue = el.value + ch;
            reactInput(el, newValue);

            idx++;
            setTimeout(typeNext, 50);
        }

        typeNext();
    }

    function fillRelationshipType() {
        log("Checking for Relationship Type input‚Ä¶");

        const $input = $('input.relationship-type:visible');

        if ($input.length === 0) {
            log("Relationship type field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(fillRelationshipType, 250);
            return;
        }

        log("Found Relationship type field ‚Üí typing 'instruments'");
        typeIntoAutocomplete($input, "instruments", fillArtistField);
    }

    // --- New sequence: Artist ‚Üí Instrument ‚Üí Credited as ---

    function fillArtistField() {
        log("Filling Artist field‚Ä¶");
        const $artist = $('input[placeholder="Type to search, or paste an MBID"]:visible');

        if ($artist.length === 0) {
            log("Artist field not ready ‚Äî retrying‚Ä¶");
            setTimeout(fillArtistField, 250);
            return;
        }

        typeIntoAutocomplete($artist, "Max Weinberg", fillInstrumentField);
    }

    function fillInstrumentField() {
        log("Filling Instrument field‚Ä¶");
        const $instr = $('input[placeholder="instrument"]:visible');

        if ($instr.length === 0) {
            log("Instrument field not ready ‚Äî retrying‚Ä¶");
            setTimeout(fillInstrumentField, 250);
            return;
        }

        typeIntoAutocomplete($instr, "drums (drum set)", fillCreditedAsField);
    }

function typeIntoReactInput(el, text, callback) {
    el.focus({ preventScroll: true });
    let idx = 0;

    function typeNext() {
        if (idx >= text.length) {
            if (callback) callback();
            return;
        }

        const ch = text[idx];
        const newValue = el.value + ch;
        el.value = newValue;

        const inputEvent = new InputEvent("input", {
            bubbles: true,
            cancelable: true,
            inputType: "insertText",
            data: ch,
        });
        el.dispatchEvent(inputEvent);

        idx++;
        setTimeout(typeNext, 50);
    }

    typeNext();
}

function fillCreditedAsField() {
    log("Filling 'Credited as' field‚Ä¶");

    const $instrumentContainer = $('.multiselect.instrument').last();
    if (!$instrumentContainer.length) {
        log("Instrument container not found ‚Äî retrying‚Ä¶");
        setTimeout(fillCreditedAsField, 250);
        return;
    }

    const $creditedInput = $instrumentContainer.find('input.attribute-credit');
    if (!$creditedInput.length) {
        log("'Credited as' input not found ‚Äî retrying‚Ä¶");
        setTimeout(fillCreditedAsField, 250);
        return;
    }

    const el = $creditedInput[0];
    typeIntoReactInput(el, "drums", () => {
        log("'Credited as' field filled successfully.");
    });
}

    function createCustomButton() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButton, 500);
            return;
        }

        if ($('#aa-add-instrument').length) return;

        const $button = $('<button/>', {
            id: 'aa-add-instrument',
            text: "Add instrument (React)",
            style: `
                margin-left: 10px;
                background-color: #38a169;
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
            `
        });

        $heading.wrap('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.parent().append($button);

        log("AA: Injected custom button next to 'Track relationships'.");

        $button.on('click', () => {
            log("Custom button clicked ‚Üí searching for batch-add button‚Ä¶");

            const tryBatchClick = () => {
                const $batch = $("button.add-item.with-label.batch-add-recording-relationship");
                if ($batch.length) {
                    log("Found batch-add button (exact class) ‚Üí clicking.");
                    $batch[0].click();
                    setTimeout(fillRelationshipType, 300);
                    return true;
                }
                return false;
            };

            if (!tryBatchClick()) {
                log("Exact match failed ‚Äî trying fallback text search‚Ä¶");

                const $fallback = $("button, a").filter((i, el) => {
                    const t = $(el).text().toLowerCase();
                    return t.includes("batch-add") && t.includes("record");
                });

                if ($fallback.length) {
                    log("Fallback batch-add button found ‚Üí clicking.");
                    $fallback[0].click();
                    setTimeout(fillRelationshipType, 300);
                } else {
                    log("Batch-add button not found ‚Üí logging all buttons/links.");
                    logAllButtonsAndLinks();
                }
            }
        });
    }

    $(document).ready(createCustomButton);

})();
#+end_example

Now it works, but it only inserts "rums", instead of "drums".

#+begin_example
function typeIntoReactInput(el, text, callback) {
    el.focus({ preventScroll: true });
    let idx = 0;

    function typeNext() {
        if (idx >= text.length) {
            if (callback) callback();
            return;
        }

        const ch = text[idx];

        // Create InputEvent without modifying el.value directly
        const inputEvent = new InputEvent("input", {
            bubbles: true,
            cancelable: true,
            inputType: "insertText",
            data: ch,
        });

        el.dispatchEvent(inputEvent);

        idx++;
        setTimeout(typeNext, 50);
    }

    typeNext();
}
#+end_example


#+begin_example
const $creditedInput = $('.multiselect.instrument').last().find('input.attribute-credit');
typeIntoReactInput($creditedInput[0], "drums", () => {
    console.log("'Credited as' field filled successfully.");
});
#+end_example

*** this is the good version and should be replae with the two code examples from above

#+begin_example
// ==UserScript==
// @name         AA - Add Instrument Button (React Release Editor) Extended
// @namespace    https://musicbrainz.org/
// @version      1.5
// @description  Insert ‚ÄúAdd instrument (React)‚Äù button, open batch-add dialog, auto-fill relationship type = "instruments", then Artist, Instrument, and Credited as fields.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    function logAllButtonsAndLinks() {
        const elems = $('button, a');
        console.group('[AA] Fallback: Dumping all buttons/links (' + elems.length + ')');
        elems.each((i, el) => {
            console.group('Element #' + i);
            console.log('Text:', $(el).text().trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();
        alert("AA Script: Could NOT find the batch-add button.\n\nAll button/link elements have been logged in the console.");
    }

    function typeIntoAutocomplete($input, text, callback) {
        const el = $input[0];
        el.focus();

        let idx = 0;

        function reactInput(el, newValue) {
            const last = el.value;
            el.value = newValue;

            const e = new InputEvent("input", {
                bubbles: true,
                cancelable: true,
                inputType: "insertText",
                data: newValue.replace(last, "")
            });

            el.dispatchEvent(e);
        }

        function clickOptionMatching(prefix) {
            const $opt = $("li[role='option']").filter((i, el) =>
                $(el).text().trim().toLowerCase().startsWith(prefix.toLowerCase())
            );

            if ($opt.length) {
                log(`Clicking dropdown option: ${prefix}`);
                $opt[0].click();
                if (callback) callback();
            } else {
                log(`Dropdown option "${prefix}" not ready yet ‚Üí retrying‚Ä¶`);
                setTimeout(() => clickOptionMatching(prefix), 100);
            }
        }

        function typeNext() {
            if (idx >= text.length) {
                setTimeout(() => clickOptionMatching(text), 150);
                return;
            }

            const ch = text[idx];
            const newValue = el.value + ch;
            reactInput(el, newValue);

            idx++;
            setTimeout(typeNext, 50);
        }

        typeNext();
    }

    function fillRelationshipType() {
        log("Checking for Relationship Type input‚Ä¶");

        const $input = $('input.relationship-type:visible');

        if ($input.length === 0) {
            log("Relationship type field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(fillRelationshipType, 250);
            return;
        }

        log("Found Relationship type field ‚Üí typing 'instruments'");
        typeIntoAutocomplete($input, "instruments", fillArtistField);
    }

    // --- New sequence: Artist ‚Üí Instrument ‚Üí Credited as ---

    function fillArtistField() {
        log("Filling Artist field‚Ä¶");
        const $artist = $('input[placeholder="Type to search, or paste an MBID"]:visible');

        if ($artist.length === 0) {
            log("Artist field not ready ‚Äî retrying‚Ä¶");
            setTimeout(fillArtistField, 250);
            return;
        }

        typeIntoAutocomplete($artist, "Max Weinberg", fillInstrumentField);
    }

    function fillInstrumentField() {
        log("Filling Instrument field‚Ä¶");
        const $instr = $('input[placeholder="instrument"]:visible');

        if ($instr.length === 0) {
            log("Instrument field not ready ‚Äî retrying‚Ä¶");
            setTimeout(fillInstrumentField, 250);
            return;
        }

        typeIntoAutocomplete($instr, "drums (drum set)", fillCreditedAsField);
    }

function typeIntoReactInput(el, text, callback) {
    el.focus({ preventScroll: true });
    let idx = 0;

    function typeNext() {
        if (idx >= text.length) {
            if (callback) callback();
            return;
        }

        const ch = text[idx];

        // Create InputEvent without modifying el.value directly
        const inputEvent = new InputEvent("input", {
            bubbles: true,
            cancelable: true,
            inputType: "insertText",
            data: ch,
        });

        el.dispatchEvent(inputEvent);

        idx++;
        setTimeout(typeNext, 50);
    }

    typeNext();
}

function fillCreditedAsField() {
    log("Filling 'Credited as' field‚Ä¶");

    const $instrumentContainer = $('.multiselect.instrument').last();
    if (!$instrumentContainer.length) {
        log("Instrument container not found ‚Äî retrying‚Ä¶");
        setTimeout(fillCreditedAsField, 250);
        return;
    }

    const $creditedInput = $instrumentContainer.find('input.attribute-credit');
    if (!$creditedInput.length) {
        log("'Credited as' input not found ‚Äî retrying‚Ä¶");
        setTimeout(fillCreditedAsField, 250);
        return;
    }

    const el = $creditedInput[0];
    typeIntoReactInput(el, "drums", () => {
        log("'Credited as' field filled successfully.");
    });
}

    function createCustomButton() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButton, 500);
            return;
        }

        if ($('#aa-add-instrument').length) return;

        const $button = $('<button/>', {
            id: 'aa-add-instrument',
            text: "Add instrument (React)",
            style: `
                margin-left: 10px;
                background-color: #38a169;
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
            `
        });

        $heading.wrap('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.parent().append($button);

        log("AA: Injected custom button next to 'Track relationships'.");

        $button.on('click', () => {
            log("Custom button clicked ‚Üí searching for batch-add button‚Ä¶");

            const tryBatchClick = () => {
                const $batch = $("button.add-item.with-label.batch-add-recording-relationship");
                if ($batch.length) {
                    log("Found batch-add button (exact class) ‚Üí clicking.");
                    $batch[0].click();
                    setTimeout(fillRelationshipType, 300);
                    return true;
                }
                return false;
            };

            if (!tryBatchClick()) {
                log("Exact match failed ‚Äî trying fallback text search‚Ä¶");

                const $fallback = $("button, a").filter((i, el) => {
                    const t = $(el).text().toLowerCase();
                    return t.includes("batch-add") && t.includes("record");
                });

                if ($fallback.length) {
                    log("Fallback batch-add button found ‚Üí clicking.");
                    $fallback[0].click();
                    setTimeout(fillRelationshipType, 300);
                } else {
                    log("Batch-add button not found ‚Üí logging all buttons/links.");
                    logAllButtonsAndLinks();
                }
            }
        });
    }

    $(document).ready(createCustomButton);

})();
#+end_example

*** latest version

#+begin_example
// ==UserScript==
// @name         AA - Add Instrument Button (React Release Editor) Extended
// @namespace    https://musicbrainz.org/
// @version      1.5
// @description  Insert ‚ÄúAdd instrument (React)‚Äù button, open batch-add dialog, auto-fill relationship type, artist, instrument, and credited-as.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    /** Dumps all buttons & links in case selectors fail */
    function logAllButtonsAndLinks() {
        const elems = $('button, a');
        console.group('[AA] Fallback: Dumping all buttons/links (' + elems.length + ')');
        elems.each((i, el) => {
            console.group('Element #' + i);
            console.log('Text:', $(el).text().trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();
        alert("AA Script: Could NOT find the batch-add button.\n\nAll button/link elements have been logged in the console.");
    }

    /** Typing helper compatible with React inputs */
    function typeIntoReactInput(el, text, callback) {
        el.focus({ preventScroll: true });
        let idx = 0;

        function typeNext() {
            if (idx >= text.length) {
                if (callback) callback();
                return;
            }

            const ch = text[idx];

            const inputEvent = new InputEvent("input", {
                bubbles: true,
                cancelable: true,
                inputType: "insertText",
                data: ch,
            });

            el.dispatchEvent(inputEvent);

            idx++;
            setTimeout(typeNext, 50);
        }

        typeNext();
    }

    /** Fill Relationship type field with "instruments" */
    function fillRelationshipType() {
        log("Checking for Relationship Type input‚Ä¶");

        const $input = $('input.relationship-type:visible');

        if ($input.length === 0) {
            log("Relationship type field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(fillRelationshipType, 250);
            return;
        }

        log("Found Relationship type field ‚Üí typing 'instruments'");
        typeIntoReactInput($input[0], "instruments", fillArtistField);
    }

    /** Fill Artist field with "Max Weinberg" */
    function fillArtistField() {
        log("Filling Artist field‚Ä¶");

        const $input = $('input.relationship-target:visible');

        if ($input.length === 0) {
            log("Artist field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(fillArtistField, 250);
            return;
        }

        typeIntoReactInput($input[0], "Max Weinberg", () => {
            // After typing, choose first dropdown option
            const $opt = $("li[role='option']").filter((i, el) =>
                $(el).text().trim().toLowerCase() === "max weinberg"
            );
            if ($opt.length) {
                log("Clicking dropdown option: Max Weinberg");
                $opt[0].click();
            }
            setTimeout(fillInstrumentField, 150);
        });
    }

    /** Fill Instrument field with "drums (drum set)" */
    function fillInstrumentField() {
        log("Filling Instrument field‚Ä¶");

        const $input = $('.multiselect.instrument input.lookup-performed:visible').last();

        if ($input.length === 0) {
            log("Instrument field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(fillInstrumentField, 250);
            return;
        }

        typeIntoReactInput($input[0], "drums (drum set)", () => {
            // After typing, click dropdown option
            const $opt = $("li[role='option']").filter((i, el) =>
                $(el).text().trim().toLowerCase() === "drums (drum set)"
            );
            if ($opt.length) {
                log("Clicking dropdown option: drums (drum set)");
                $opt[0].click();
            }
            setTimeout(fillCreditedAsField, 150);
        });
    }

    /** Fill Credited as field with "drums" */
    function fillCreditedAsField() {
        log("Filling 'Credited as' field‚Ä¶");

        const $container = $('.multiselect.instrument').last();
        if (!$container.length) {
            log("Instrument container not found ‚Äî retrying‚Ä¶");
            setTimeout(fillCreditedAsField, 250);
            return;
        }

        const $input = $container.find('input.attribute-credit:visible');
        if (!$input.length) {
            log("'Credited as' input not found ‚Äî retrying‚Ä¶");
            setTimeout(fillCreditedAsField, 250);
            return;
        }

        typeIntoReactInput($input[0], "drums", () => {
            log("'Credited as' field filled successfully.");
        });
    }

    /** MAIN: Create the custom button next to "Track relationships" */
    function createCustomButton() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButton, 500);
            return;
        }

        if ($('#aa-add-instrument').length) return;

        const $button = $('<button/>', {
            id: 'aa-add-instrument',
            text: "Add instrument (React)",
            style: `
                margin-left: 10px;
                background-color: #38a169;
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
            `
        });

        // Insert next to heading
        $heading.wrap('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.parent().append($button);

        log("AA: Injected custom button next to 'Track relationships'.");

        // Button click = open dialog
        $button.on('click', () => {
            log("Custom button clicked ‚Üí searching for batch-add button‚Ä¶");

            const tryBatchClick = () => {
                const $batch = $("button.add-item.with-label.batch-add-recording-relationship");
                if ($batch.length) {
                    log("Found batch-add button (exact class) ‚Üí clicking.");
                    $batch[0].click();
                    setTimeout(fillRelationshipType, 300);
                    return true;
                }
                return false;
            };

            if (!tryBatchClick()) {
                log("Exact match failed ‚Äî trying fallback text search‚Ä¶");

                const $fallback = $("button, a").filter((i, el) => {
                    const t = $(el).text().toLowerCase();
                    return t.includes("batch-add") && t.includes("record");
                });

                if ($fallback.length) {
                    log("Fallback batch-add button found ‚Üí clicking.");
                    $fallback[0].click();
                    setTimeout(fillRelationshipType, 300);
                } else {
                    log("Batch-add button not found ‚Üí logging all buttons/links.");
                    logAllButtonsAndLinks();
                }
            }
        });
    }

    $(document).ready(createCustomButton);

})();
#+end_example

#+begin_example
/** Fill the "Credited as" field */
function fillCreditedAsField() {
    log("Filling 'Credited as' field‚Ä¶");

    // The input is a normal text field
    const $input = $('input.attribute-credit:visible').last();
    if ($input.length) {
        const el = $input[0];
        el.focus();
        el.value = "drums"; // directly set value

        // trigger simple input event to notify any listeners
        const event = new Event('input', { bubbles: true, cancelable: true });
        el.dispatchEvent(event);

        log("'Credited as' field filled successfully.");
    } else {
        log("'Credited as' field not found yet ‚Äî retrying‚Ä¶");
        setTimeout(fillCreditedAsField, 200);
    }
}
#+end_example

*** lets start from here again

OK, lets start from here again. The following code works except filling in the "'Credited as' field:

#+begin_example
// ==UserScript==
// @name         AA - Add Instrument Button (React Release Editor) Extended
// @namespace    https://musicbrainz.org/
// @version      1.5
// @description  Insert ‚ÄúAdd instrument (React)‚Äù button, open batch-add dialog, auto-fill relationship type = "instruments", then Artist, Instrument, and Credited as fields.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    function logAllButtonsAndLinks() {
        const elems = $('button, a');
        console.group('[AA] Fallback: Dumping all buttons/links (' + elems.length + ')');
        elems.each((i, el) => {
            console.group('Element #' + i);
            console.log('Text:', $(el).text().trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();
        alert("AA Script: Could NOT find the batch-add button.\n\nAll button/link elements have been logged in the console.");
    }

    function typeIntoAutocomplete($input, text, callback) {
        const el = $input[0];
        el.focus();

        let idx = 0;

        function reactInput(el, newValue) {
            const last = el.value;
            el.value = newValue;

            const e = new InputEvent("input", {
                bubbles: true,
                cancelable: true,
                inputType: "insertText",
                data: newValue.replace(last, "")
            });

            el.dispatchEvent(e);
        }

        function clickOptionMatching(prefix) {
            const $opt = $("li[role='option']").filter((i, el) =>
                $(el).text().trim().toLowerCase().startsWith(prefix.toLowerCase())
            );

            if ($opt.length) {
                log(`Clicking dropdown option: ${prefix}`);
                $opt[0].click();
                if (callback) callback();
            } else {
                log(`Dropdown option "${prefix}" not ready yet ‚Üí retrying‚Ä¶`);
                setTimeout(() => clickOptionMatching(prefix), 100);
            }
        }

        function typeNext() {
            if (idx >= text.length) {
                setTimeout(() => clickOptionMatching(text), 150);
                return;
            }

            const ch = text[idx];
            const newValue = el.value + ch;
            reactInput(el, newValue);

            idx++;
            setTimeout(typeNext, 50);
        }

        typeNext();
    }

    function fillRelationshipType() {
        log("Checking for Relationship Type input‚Ä¶");

        const $input = $('input.relationship-type:visible');

        if ($input.length === 0) {
            log("Relationship type field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(fillRelationshipType, 250);
            return;
        }

        log("Found Relationship type field ‚Üí typing 'instruments'");
        typeIntoAutocomplete($input, "instruments", fillArtistField);
    }

    // --- New sequence: Artist ‚Üí Instrument ‚Üí Credited as ---

    function fillArtistField() {
        log("Filling Artist field‚Ä¶");
        const $artist = $('input[placeholder="Type to search, or paste an MBID"]:visible');

        if ($artist.length === 0) {
            log("Artist field not ready ‚Äî retrying‚Ä¶");
            setTimeout(fillArtistField, 250);
            return;
        }

        typeIntoAutocomplete($artist, "Max Weinberg", fillInstrumentField);
    }

    function fillInstrumentField() {
        log("Filling Instrument field‚Ä¶");
        const $instr = $('input[placeholder="instrument"]:visible');

        if ($instr.length === 0) {
            log("Instrument field not ready ‚Äî retrying‚Ä¶");
            setTimeout(fillInstrumentField, 250);
            return;
        }

        typeIntoAutocomplete($instr, "drums (drum set)", fillCreditedAsField);
    }

function typeIntoReactInput(el, text, callback) {
    el.focus({ preventScroll: true });
    let idx = 0;

    function typeNext() {
        if (idx >= text.length) {
            if (callback) callback();
            return;
        }

        const ch = text[idx];

        // Create InputEvent without modifying el.value directly
        const inputEvent = new InputEvent("input", {
            bubbles: true,
            cancelable: true,
            inputType: "insertText",
            data: ch,
        });

        el.dispatchEvent(inputEvent);

        idx++;
        setTimeout(typeNext, 50);
    }

    typeNext();
}

function fillCreditedAsField() {
    log("Filling 'Credited as' field‚Ä¶");

    const $instrumentContainer = $('.multiselect.instrument').last();
    if (!$instrumentContainer.length) {
        log("Instrument container not found ‚Äî retrying‚Ä¶");
        setTimeout(fillCreditedAsField, 250);
        return;
    }

const $creditedInput = $('.multiselect.instrument').last().find('input.attribute-credit');
typeIntoReactInput($creditedInput[0], "drums", () => {
    console.log("'Credited as' field filled successfully.");
});
}

    function createCustomButton() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButton, 500);
            return;
        }

        if ($('#aa-add-instrument').length) return;

        const $button = $('<button/>', {
            id: 'aa-add-instrument',
            text: "Add instrument (React)",
            style: `
                margin-left: 10px;
                background-color: #38a169;
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
            `
        });

        $heading.wrap('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.parent().append($button);

        log("AA: Injected custom button next to 'Track relationships'.");

        $button.on('click', () => {
            log("Custom button clicked ‚Üí searching for batch-add button‚Ä¶");

            const tryBatchClick = () => {
                const $batch = $("button.add-item.with-label.batch-add-recording-relationship");
                if ($batch.length) {
                    log("Found batch-add button (exact class) ‚Üí clicking.");
                    $batch[0].click();
                    setTimeout(fillRelationshipType, 300);
                    return true;
                }
                return false;
            };

            if (!tryBatchClick()) {
                log("Exact match failed ‚Äî trying fallback text search‚Ä¶");

                const $fallback = $("button, a").filter((i, el) => {
                    const t = $(el).text().toLowerCase();
                    return t.includes("batch-add") && t.includes("record");
                });

                if ($fallback.length) {
                    log("Fallback batch-add button found ‚Üí clicking.");
                    $fallback[0].click();
                    setTimeout(fillRelationshipType, 300);
                } else {
                    log("Batch-add button not found ‚Üí logging all buttons/links.");
                    logAllButtonsAndLinks();
                }
            }
        });
    }

    $(document).ready(createCustomButton);

})();
#+end_example

with the following console output

#+begin_example
[AA-add-instrument] Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] AA: Injected custom button next to 'Track relationships'.
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Custom button clicked ‚Üí searching for batch-add button‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Found batch-add button (exact class) ‚Üí clicking.
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Checking for Relationship Type input‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Found Relationship type field ‚Üí typing 'instruments'
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: instruments
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling Artist field‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: Max Weinberg
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling Instrument field‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: drums (drum set)
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling 'Credited as' field‚Ä¶
userscript.html?name=AA-Add-Instrument-Button-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:176 'Credited as' field filled successfully.
#+end_example

*** completely working version

#+begin_example
// ==UserScript==
// @name         AA - Add Instrument Button (React Release Editor) Extended
// @namespace    https://musicbrainz.org/
// @version      1.5
// @description  Insert ‚ÄúAdd instrument (React)‚Äù button, open batch-add dialog, auto-fill relationship type = "instruments", then Artist, Instrument, and Credited as fields.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    function logAllButtonsAndLinks() {
        const elems = $('button, a');
        console.group('[AA] Fallback: Dumping all buttons/links (' + elems.length + ')');
        elems.each((i, el) => {
            console.group('Element #' + i);
            console.log('Text:', $(el).text().trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();
        alert("AA Script: Could NOT find the batch-add button.\n\nAll button/link elements have been logged in the console.");
    }

    function typeIntoAutocomplete($input, text, callback) {
        const el = $input[0];
        el.focus();

        let idx = 0;

        function reactInput(el, newValue) {
            const last = el.value;
            el.value = newValue;

            const e = new InputEvent("input", {
                bubbles: true,
                cancelable: true,
                inputType: "insertText",
                data: newValue.replace(last, "")
            });

            el.dispatchEvent(e);
        }

        function clickOptionMatching(prefix) {
            const $opt = $("li[role='option']").filter((i, el) =>
                $(el).text().trim().toLowerCase().startsWith(prefix.toLowerCase())
            );

            if ($opt.length) {
                log(`Clicking dropdown option: ${prefix}`);
                $opt[0].click();
                if (callback) callback();
            } else {
                log(`Dropdown option "${prefix}" not ready yet ‚Üí retrying‚Ä¶`);
                setTimeout(() => clickOptionMatching(prefix), 100);
            }
        }

        function typeNext() {
            if (idx >= text.length) {
                setTimeout(() => clickOptionMatching(text), 150);
                return;
            }

            const ch = text[idx];
            const newValue = el.value + ch;
            reactInput(el, newValue);

            idx++;
            setTimeout(typeNext, 50);
        }

        typeNext();
    }

    function fillRelationshipType() {
        log("Checking for Relationship Type input‚Ä¶");

        const $input = $('input.relationship-type:visible');

        if ($input.length === 0) {
            log("Relationship type field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(fillRelationshipType, 250);
            return;
        }

        log("Found Relationship type field ‚Üí typing 'instruments'");
        typeIntoAutocomplete($input, "instruments", fillArtistField);
    }

    // --- New sequence: Artist ‚Üí Instrument ‚Üí Credited as ---

    function fillArtistField() {
        log("Filling Artist field‚Ä¶");
        const $artist = $('input[placeholder="Type to search, or paste an MBID"]:visible');

        if ($artist.length === 0) {
            log("Artist field not ready ‚Äî retrying‚Ä¶");
            setTimeout(fillArtistField, 250);
            return;
        }

        typeIntoAutocomplete($artist, "Max Weinberg", fillInstrumentField);
    }

    function fillInstrumentField() {
        log("Filling Instrument field‚Ä¶");
        const $instr = $('input[placeholder="instrument"]:visible');

        if ($instr.length === 0) {
            log("Instrument field not ready ‚Äî retrying‚Ä¶");
            setTimeout(fillInstrumentField, 250);
            return;
        }

        typeIntoAutocomplete($instr, "drums (drum set)", fillCreditedAsField);
    }

function typeIntoReactInput(el, text, callback) {
    el.focus({ preventScroll: true });
    let idx = 0;

    function typeNext() {
        if (idx >= text.length) {
            if (callback) callback();
            return;
        }

        const ch = text[idx];

        // Create InputEvent without modifying el.value directly
        const inputEvent = new InputEvent("input", {
            bubbles: true,
            cancelable: true,
            inputType: "insertText",
            data: ch,
        });

        el.dispatchEvent(inputEvent);

        idx++;
        setTimeout(typeNext, 50);
    }

    typeNext();
}

function fillCreditedAsField() {
    log("Filling 'Credited as' field‚Ä¶");

    const $instrumentContainer = $('.multiselect.instrument').last();
    if (!$instrumentContainer.length) {
        log("Instrument container not found ‚Äî retrying‚Ä¶");
        setTimeout(fillCreditedAsField, 250);
        return;
    }

    const $creditedInput = $instrumentContainer.find('input.attribute-credit');
    if (!$creditedInput.length) {
        log("Credited-as input not found ‚Äî retrying‚Ä¶");
        setTimeout(fillCreditedAsField, 250);
        return;
    }

    const el = $creditedInput[0];
    const text = "drums";

    // React-compliant setter
    const nativeInputValueSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
    if (nativeInputValueSetter) nativeInputValueSetter.call(el, text);

    // Dispatch events to notify React
    el.dispatchEvent(new Event('input', { bubbles: true }));
    el.dispatchEvent(new Event('change', { bubbles: true }));

    log("'Credited as' field filled successfully.");
}

    function createCustomButton() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButton, 500);
            return;
        }

        if ($('#aa-add-instrument').length) return;

        const $button = $('<button/>', {
            id: 'aa-add-instrument',
            text: "Add instrument (React)",
            style: `
                margin-left: 10px;
                background-color: #38a169;
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
            `
        });

        $heading.wrap('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.parent().append($button);

        log("AA: Injected custom button next to 'Track relationships'.");

        $button.on('click', () => {
            log("Custom button clicked ‚Üí searching for batch-add button‚Ä¶");

            const tryBatchClick = () => {
                const $batch = $("button.add-item.with-label.batch-add-recording-relationship");
                if ($batch.length) {
                    log("Found batch-add button (exact class) ‚Üí clicking.");
                    $batch[0].click();
                    setTimeout(fillRelationshipType, 300);
                    return true;
                }
                return false;
            };

            if (!tryBatchClick()) {
                log("Exact match failed ‚Äî trying fallback text search‚Ä¶");

                const $fallback = $("button, a").filter((i, el) => {
                    const t = $(el).text().toLowerCase();
                    return t.includes("batch-add") && t.includes("record");
                });

                if ($fallback.length) {
                    log("Fallback batch-add button found ‚Üí clicking.");
                    $fallback[0].click();
                    setTimeout(fillRelationshipType, 300);
                } else {
                    log("Batch-add button not found ‚Üí logging all buttons/links.");
                    logAllButtonsAndLinks();
                }
            }
        });
    }

    $(document).ready(createCustomButton);

})();
#+end_example

Yes its working now. Can you now also emulate the final button press on the "Done" button

It's in the HTML code here

#+begin_example
  <div class="buttons" style="margin-top: 1em;">
    <button class="negative" type="button">Cancel
    </button>
    <div class="buttons-right">
      <button class="positive" type="button">Done
      </button>
    </div>
  </div>
#+end_example

#+begin_example
function fillCreditedAsField() {
    log("Filling 'Credited as' field‚Ä¶");

    const $instrumentContainer = $('.multiselect.instrument').last();
    if (!$instrumentContainer.length) {
        log("Instrument container not found ‚Äî retrying‚Ä¶");
        setTimeout(fillCreditedAsField, 250);
        return;
    }

    const $creditedInput = $instrumentContainer.find('input.attribute-credit');
    if (!$creditedInput.length) {
        log("Credited-as input not found ‚Äî retrying‚Ä¶");
        setTimeout(fillCreditedAsField, 250);
        return;
    }

    const el = $creditedInput[0];
    const text = "drums";

    // React-compliant setter
    const nativeInputValueSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
    if (nativeInputValueSetter) nativeInputValueSetter.call(el, text);

    // Dispatch events to notify React
    el.dispatchEvent(new Event('input', { bubbles: true }));
    el.dispatchEvent(new Event('change', { bubbles: true }));

    log("'Credited as' field filled successfully.");

    // Now click the Done button
    const $doneButton = $('button.positive:visible').filter((i, btn) => $(btn).text().trim() === "Done");
    if ($doneButton.length) {
        log("Clicking Done button‚Ä¶");
        $doneButton[0].click();
    } else {
        log("Done button not found ‚Äî retrying‚Ä¶");
        setTimeout(fillCreditedAsField, 250);
    }
}
#+end_example

*** enhance

Now please rename the first button to "Max Weinberg" and add a second button named "Garry Tallent".
Refactor the code that in the case of the "Max Weinberg" button the following will be filled in (actually the same as before):

#+begin_example
"Max Weinberg" button:

Relationship type: "instruments"
Artist: "Max Weinberg"
Instrument: "drums (drum set)" Credited as: "drums"
#+end_example

and in the case of the "Garry Tallent" button the following (here the "Credited as" is really the empty string)

#+begin_example
"Garry Tallent" button:

Relationship type: "instruments"
Artist: "Garry Tallent"
Instrument: "electric bass guitar" Credited as: ""
#+end_example

Also prepare for future expansions to even more "Artist" buttons with the 'Relationship type: "instruments"'

#+begin_example
// ==UserScript==
// @name         AA - Add Instrument Buttons (React Release Editor) Extended
// @namespace    https://musicbrainz.org/
// @version      1.7
// @description  Insert multiple Artist buttons, open batch-add dialog, auto-fill relationship type = "instruments", then Artist, Instrument, Credited as fields, and click Done.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    // --- Configuration for multiple Artist buttons ---
    const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        }
        // Add more artist buttons here easily
    ];

    function logAllButtonsAndLinks() {
        const elems = $('button, a');
        console.group('[AA] Fallback: Dumping all buttons/links (' + elems.length + ')');
        elems.each((i, el) => {
            console.group('Element #' + i);
            console.log('Text:', $(el).text().trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();
        alert("AA Script: Could NOT find the batch-add button.\n\nAll button/link elements have been logged in the console.");
    }

    function typeIntoAutocomplete($input, text, callback) {
        const el = $input[0];
        el.focus();

        let idx = 0;

        function reactInput(el, newValue) {
            const last = el.value;
            el.value = newValue;

            const e = new InputEvent("input", {
                bubbles: true,
                cancelable: true,
                inputType: "insertText",
                data: newValue.replace(last, "")
            });

            el.dispatchEvent(e);
        }

        function clickOptionMatching(prefix) {
            const $opt = $("li[role='option']").filter((i, el) =>
                $(el).text().trim().toLowerCase().startsWith(prefix.toLowerCase())
            );

            if ($opt.length) {
                log(`Clicking dropdown option: ${prefix}`);
                $opt[0].click();
                if (callback) callback();
            } else {
                log(`Dropdown option "${prefix}" not ready yet ‚Üí retrying‚Ä¶`);
                setTimeout(() => clickOptionMatching(prefix), 100);
            }
        }

        function typeNext() {
            if (idx >= text.length) {
                setTimeout(() => clickOptionMatching(text), 150);
                return;
            }

            const ch = text[idx];
            const newValue = el.value + ch;
            reactInput(el, newValue);

            idx++;
            setTimeout(typeNext, 50);
        }

        typeNext();
    }

    // --- Main filling sequence ---
    function fillFields(config) {
        fillRelationshipType(config);
    }

    function fillRelationshipType(config) {
        log("Checking for Relationship Type input‚Ä¶");

        const $input = $('input.relationship-type:visible');

        if ($input.length === 0) {
            log("Relationship type field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(() => fillRelationshipType(config), 250);
            return;
        }

        log(`Found Relationship type field ‚Üí typing '${config.relationshipType}'`);
        typeIntoAutocomplete($input, config.relationshipType, () => fillArtistField(config));
    }

    function fillArtistField(config) {
        log("Filling Artist field‚Ä¶");
        const $artist = $('input[placeholder="Type to search, or paste an MBID"]:visible');

        if ($artist.length === 0) {
            log("Artist field not ready ‚Äî retrying‚Ä¶");
            setTimeout(() => fillArtistField(config), 250);
            return;
        }

        typeIntoAutocomplete($artist, config.artist, () => fillInstrumentField(config));
    }

    function fillInstrumentField(config) {
        log("Filling Instrument field‚Ä¶");
        const $instr = $('input[placeholder="instrument"]:visible');

        if ($instr.length === 0) {
            log("Instrument field not ready ‚Äî retrying‚Ä¶");
            setTimeout(() => fillInstrumentField(config), 250);
            return;
        }

        typeIntoAutocomplete($instr, config.instrument, () => fillCreditedAsField(config));
    }

    function fillCreditedAsField(config) {
        log("Filling 'Credited as' field‚Ä¶");

        const $instrumentContainer = $('.multiselect.instrument').last();
        if (!$instrumentContainer.length) {
            log("Instrument container not found ‚Äî retrying‚Ä¶");
            setTimeout(() => fillCreditedAsField(config), 250);
            return;
        }

        const $creditedInput = $instrumentContainer.find('input.attribute-credit');
        if ($creditedInput.length) {
            const el = $creditedInput[0];
            const text = config.creditedAs;

            // React-compliant setter
            const nativeInputValueSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
            if (nativeInputValueSetter) nativeInputValueSetter.call(el, text);

            // Dispatch events to notify React
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }

        log("'Credited as' field filled successfully.");

        // Click the Done button
        const $doneButton = $('button.positive:visible').filter((i, btn) => $(btn).text().trim() === "Done");
        if ($doneButton.length) {
            log("Clicking Done button‚Ä¶");
            $doneButton[0].click();
        } else {
            log("Done button not found ‚Äî retrying‚Ä¶");
            setTimeout(() => fillCreditedAsField(config), 250);
        }
    }

    // --- Button creation ---
    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        const $container = $('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.wrap($container);

        ARTIST_BUTTONS.forEach(config => {
            const $button = $('<button/>', {
                text: config.label,
                style: `
                    margin-left: 10px;
                    background-color: #38a169;
                    color: white;
                    padding: 5px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                `
            });

            $heading.parent().append($button);

            $button.on('click', () => {
                log(`"${config.label}" button clicked ‚Üí searching for batch-add button‚Ä¶`);

                const tryBatchClick = () => {
                    const $batch = $("button.add-item.with-label.batch-add-recording-relationship");
                    if ($batch.length) {
                        log("Found batch-add button (exact class) ‚Üí clicking.");
                        $batch[0].click();
                        setTimeout(() => fillFields(config), 300);
                        return true;
                    }
                    return false;
                };

                if (!tryBatchClick()) {
                    log("Exact match failed ‚Äî trying fallback text search‚Ä¶");

                    const $fallback = $("button, a").filter((i, el) => {
                        const t = $(el).text().toLowerCase();
                        return t.includes("batch-add") && t.includes("record");
                    });

                    if ($fallback.length) {
                        log("Fallback batch-add button found ‚Üí clicking.");
                        $fallback[0].click();
                        setTimeout(() => fillFields(config), 300);
                    } else {
                        log("Batch-add button not found ‚Üí logging all buttons/links.");
                        logAllButtonsAndLinks();
                    }
                }
            });
        });

        log("AA: Injected custom artist buttons next to 'Track relationships'.");
    }

    $(document).ready(createCustomButtons);

})();
#+end_example


Well the two buttons show up, but there is an endless loop:

#+begin_example
[AA-add-instrument] Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] AA: Injected custom artist buttons next to 'Track relationships'.
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] "Max Weinberg" button clicked ‚Üí searching for batch-add button‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Found batch-add button (exact class) ‚Üí clicking.
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Checking for Relationship Type input‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Relationship type field not found yet ‚Äî retrying‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Checking for Relationship Type input‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Relationship type field not found yet ‚Äî retrying‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Checking for Relationship Type input‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Relationship type field not found yet ‚Äî retrying‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22
#+end_example

*** multi instruments working code

#+begin_example
// ==UserScript==
// @name         AA - Add Instrument Buttons (React Release Editor) Extended
// @namespace    https://musicbrainz.org/
// @version      1.7
// @description  Insert multiple Artist buttons, open batch-add dialog, auto-fill relationship type = "instruments", then Artist, Instrument, Credited as fields, and click Done.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    // --- Configuration for multiple Artist buttons ---
    const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        }
        // Add more artist buttons here easily
    ];

    function logAllButtonsAndLinks() {
        const elems = $('button, a');
        console.group('[AA] Fallback: Dumping all buttons/links (' + elems.length + ')');
        elems.each((i, el) => {
            console.group('Element #' + i);
            console.log('Text:', $(el).text().trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();
        alert("AA Script: Could NOT find the batch-add button.\n\nAll button/link elements have been logged in the console.");
    }

    function typeIntoAutocomplete($input, text, callback) {
        const el = $input[0];
        el.focus();

        let idx = 0;

        function reactInput(el, newValue) {
            const last = el.value;
            el.value = newValue;

            const e = new InputEvent("input", {
                bubbles: true,
                cancelable: true,
                inputType: "insertText",
                data: newValue.replace(last, "")
            });

            el.dispatchEvent(e);
        }

        function clickOptionMatching(prefix) {
            const $opt = $("li[role='option']").filter((i, el) =>
                $(el).text().trim().toLowerCase().startsWith(prefix.toLowerCase())
            );

            if ($opt.length) {
                log(`Clicking dropdown option: ${prefix}`);
                $opt[0].click();
                if (callback) callback();
            } else {
                log(`Dropdown option "${prefix}" not ready yet ‚Üí retrying‚Ä¶`);
                setTimeout(() => clickOptionMatching(prefix), 100);
            }
        }

        function typeNext() {
            if (idx >= text.length) {
                setTimeout(() => clickOptionMatching(text), 150);
                return;
            }

            const ch = text[idx];
            const newValue = el.value + ch;
            reactInput(el, newValue);

            idx++;
            setTimeout(typeNext, 50);
        }

        typeNext();
    }

    // --- Main filling sequence ---
    function fillFields(config) {
        fillRelationshipType(config);
    }

    function fillRelationshipType(config) {
        log("Checking for Relationship Type input‚Ä¶");

        const $input = $('input.relationship-type:visible');

        if ($input.length === 0) {
            log("Relationship type field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(() => fillRelationshipType(config), 250);
            return;
        }

        log(`Found Relationship type field ‚Üí typing '${config.relationshipType}'`);
        typeIntoAutocomplete($input, config.relationshipType, () => fillArtistField(config));
    }

    function fillArtistField(config) {
        log("Filling Artist field‚Ä¶");
        const $artist = $('input[placeholder="Type to search, or paste an MBID"]:visible');

        if ($artist.length === 0) {
            log("Artist field not ready ‚Äî retrying‚Ä¶");
            setTimeout(() => fillArtistField(config), 250);
            return;
        }

        typeIntoAutocomplete($artist, config.artist, () => fillInstrumentField(config));
    }

    function fillInstrumentField(config) {
        log("Filling Instrument field‚Ä¶");
        const $instr = $('input[placeholder="instrument"]:visible');

        if ($instr.length === 0) {
            log("Instrument field not ready ‚Äî retrying‚Ä¶");
            setTimeout(() => fillInstrumentField(config), 250);
            return;
        }

        typeIntoAutocomplete($instr, config.instrument, () => fillCreditedAsField(config));
    }

    function fillCreditedAsField(config) {
        log("Filling 'Credited as' field‚Ä¶");

        const $instrumentContainer = $('.multiselect.instrument').last();
        if (!$instrumentContainer.length) {
            log("Instrument container not found ‚Äî retrying‚Ä¶");
            setTimeout(() => fillCreditedAsField(config), 250);
            return;
        }

        const $creditedInput = $instrumentContainer.find('input.attribute-credit');
        if ($creditedInput.length) {
            const el = $creditedInput[0];
            const text = config.creditedAs;

            // React-compliant setter
            const nativeInputValueSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
            if (nativeInputValueSetter) nativeInputValueSetter.call(el, text);

            // Dispatch events to notify React
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }

        log("'Credited as' field filled successfully.");

        // Click the Done button
        const $doneButton = $('button.positive:visible').filter((i, btn) => $(btn).text().trim() === "Done");
        if ($doneButton.length) {
            log("Clicking Done button‚Ä¶");
            $doneButton[0].click();
        } else {
            log("Done button not found ‚Äî retrying‚Ä¶");
            setTimeout(() => fillCreditedAsField(config), 250);
        }
    }

    // --- Button creation ---
    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        const $container = $('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.wrap($container);

        ARTIST_BUTTONS.forEach(config => {
            const $button = $('<button/>', {
                text: config.label,
                style: `
                    margin-left: 10px;
                    background-color: #38a169;
                    color: white;
                    padding: 5px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                `
            });

            $heading.parent().append($button);

$button.on('click', () => {
    log(`"${config.label}" button clicked ‚Üí searching for batch-add button‚Ä¶`);

    const tryBatchClick = () => {
        const $batch = $("button.add-item.with-label.batch-add-recording-relationship");
        if ($batch.length) {
            log("Found batch-add button (exact class) ‚Üí clicking.");
            $batch[0].click();

            // Wait a bit for the dialog to appear before filling fields
            setTimeout(() => fillFields(config), 500);
            return true;
        }
        return false;
    };

    if (!tryBatchClick()) {
        log("Exact match failed ‚Äî trying fallback text search‚Ä¶");

        const $fallback = $("button, a").filter((i, el) => {
            const t = $(el).text().toLowerCase();
            return t.includes("batch-add") && t.includes("record");
        });

        if ($fallback.length) {
            log("Fallback batch-add button found ‚Üí clicking.");
            $fallback[0].click();
            setTimeout(() => fillFields(config), 500);
        } else {
            log("Batch-add button not found ‚Üí logging all buttons/links.");
            logAllButtonsAndLinks();
        }
    }
});
        });

        log("AA: Injected custom artist buttons next to 'Track relationships'.");
    }

    $(document).ready(createCustomButtons);

})();
#+end_example

adding loggig of "Credited as

#+begin_example
function fillCreditedAsField(config) {
    log("Filling 'Credited as' field‚Ä¶");

    const $instrumentContainer = $('.multiselect.instrument').last();
    if (!$instrumentContainer.length) {
        log("Instrument container not found ‚Äî retrying‚Ä¶");
        setTimeout(() => fillCreditedAsField(config), 250);
        return;
    }

    const $creditedInput = $instrumentContainer.find('input.attribute-credit');

    typeIntoReactInput($creditedInput[0], config.creditedAs || "", () => {
        log(`'Credited as' field filled successfully ‚Üí "${config.creditedAs || ""}"`);

        // Optional: click Done button automatically
        const $done = $("button.positive:visible").last();
        if ($done.length) {
            log("Clicking Done button‚Ä¶");
            $done[0].click();
        }
    });
}
#+end_example

*** latest working version for multiple instruments

OK, lets start from here

#+begin_example
// ==UserScript==
// @name         AA - Add Instrument Buttons (React Release Editor) Extended
// @namespace    https://musicbrainz.org/
// @version      1.7
// @description  Insert multiple Artist buttons, open batch-add dialog, auto-fill relationship type = "instruments", then Artist, Instrument, Credited as fields, and click Done.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    // --- Configuration for multiple Artist buttons ---
    const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        }
        // Add more artist buttons here easily
    ];

    function logAllButtonsAndLinks() {
        const elems = $('button, a');
        console.group('[AA] Fallback: Dumping all buttons/links (' + elems.length + ')');
        elems.each((i, el) => {
            console.group('Element #' + i);
            console.log('Text:', $(el).text().trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();
        alert("AA Script: Could NOT find the batch-add button.\n\nAll button/link elements have been logged in the console.");
    }

    function typeIntoAutocomplete($input, text, callback) {
        const el = $input[0];
        el.focus();

        let idx = 0;

        function reactInput(el, newValue) {
            const last = el.value;
            el.value = newValue;

            const e = new InputEvent("input", {
                bubbles: true,
                cancelable: true,
                inputType: "insertText",
                data: newValue.replace(last, "")
            });

            el.dispatchEvent(e);
        }

        function clickOptionMatching(prefix) {
            const $opt = $("li[role='option']").filter((i, el) =>
                $(el).text().trim().toLowerCase().startsWith(prefix.toLowerCase())
            );

            if ($opt.length) {
                log(`Clicking dropdown option: ${prefix}`);
                $opt[0].click();
                if (callback) callback();
            } else {
                log(`Dropdown option "${prefix}" not ready yet ‚Üí retrying‚Ä¶`);
                setTimeout(() => clickOptionMatching(prefix), 100);
            }
        }

        function typeNext() {
            if (idx >= text.length) {
                setTimeout(() => clickOptionMatching(text), 150);
                return;
            }

            const ch = text[idx];
            const newValue = el.value + ch;
            reactInput(el, newValue);

            idx++;
            setTimeout(typeNext, 50);
        }

        typeNext();
    }

    // --- Main filling sequence ---
    function fillFields(config) {
        fillRelationshipType(config);
    }

    function fillRelationshipType(config) {
        log("Checking for Relationship Type input‚Ä¶");

        const $input = $('input.relationship-type:visible');

        if ($input.length === 0) {
            log("Relationship type field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(() => fillRelationshipType(config), 250);
            return;
        }

        log(`Found Relationship type field ‚Üí typing '${config.relationshipType}'`);
        typeIntoAutocomplete($input, config.relationshipType, () => fillArtistField(config));
    }

    function fillArtistField(config) {
        log("Filling Artist field‚Ä¶");
        const $artist = $('input[placeholder="Type to search, or paste an MBID"]:visible');

        if ($artist.length === 0) {
            log("Artist field not ready ‚Äî retrying‚Ä¶");
            setTimeout(() => fillArtistField(config), 250);
            return;
        }

        typeIntoAutocomplete($artist, config.artist, () => fillInstrumentField(config));
    }

    function fillInstrumentField(config) {
        log("Filling Instrument field‚Ä¶");
        const $instr = $('input[placeholder="instrument"]:visible');

        if ($instr.length === 0) {
            log("Instrument field not ready ‚Äî retrying‚Ä¶");
            setTimeout(() => fillInstrumentField(config), 250);
            return;
        }

        typeIntoAutocomplete($instr, config.instrument, () => fillCreditedAsField(config));
    }

    function fillCreditedAsField(config) {
        log("Filling 'Credited as' field‚Ä¶");

        const $instrumentContainer = $('.multiselect.instrument').last();
        if (!$instrumentContainer.length) {
            log("Instrument container not found ‚Äî retrying‚Ä¶");
            setTimeout(() => fillCreditedAsField(config), 250);
            return;
        }

        const $creditedInput = $instrumentContainer.find('input.attribute-credit');
        if ($creditedInput.length) {
            const el = $creditedInput[0];
            const text = config.creditedAs;

            // React-compliant setter
            const nativeInputValueSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
            if (nativeInputValueSetter) nativeInputValueSetter.call(el, text);

            // Dispatch events to notify React
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }

        log(`'Credited as' field filled successfully with ${config.creditedAs}`);

        // Click the Done button
        const $doneButton = $('button.positive:visible').filter((i, btn) => $(btn).text().trim() === "Done");
        if ($doneButton.length) {
            log("Clicking Done button‚Ä¶");
            $doneButton[0].click();
        } else {
            log("Done button not found ‚Äî retrying‚Ä¶");
            setTimeout(() => fillCreditedAsField(config), 250);
        }
    }

    // --- Button creation ---
    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        const $container = $('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.wrap($container);

        ARTIST_BUTTONS.forEach(config => {
            const $button = $('<button/>', {
                text: config.label,
                style: `
                    margin-left: 10px;
                    background-color: #38a169;
                    color: white;
                    padding: 5px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                `
            });

            $heading.parent().append($button);

$button.on('click', () => {
    log(`"${config.label}" button clicked ‚Üí searching for batch-add button‚Ä¶`);

    const tryBatchClick = () => {
        const $batch = $("button.add-item.with-label.batch-add-recording-relationship");
        if ($batch.length) {
            log("Found batch-add button (exact class) ‚Üí clicking.");
            $batch[0].click();

            // Wait a bit for the dialog to appear before filling fields
            setTimeout(() => fillFields(config), 500);
            return true;
        }
        return false;
    };

    if (!tryBatchClick()) {
        log("Exact match failed ‚Äî trying fallback text search‚Ä¶");

        const $fallback = $("button, a").filter((i, el) => {
            const t = $(el).text().toLowerCase();
            return t.includes("batch-add") && t.includes("record");
        });

        if ($fallback.length) {
            log("Fallback batch-add button found ‚Üí clicking.");
            $fallback[0].click();
            setTimeout(() => fillFields(config), 500);
        } else {
            log("Batch-add button not found ‚Üí logging all buttons/links.");
            logAllButtonsAndLinks();
        }
    }
});
        });

        log("AA: Injected custom artist buttons next to 'Track relationships'.");
    }

    $(document).ready(createCustomButtons);

})();
#+end_example

and make it more fool proof against timeouts, when pressing the buttons. Sometimes the data in the suggestion popup boxes is net yet there and we already emulated the "Return" button.
For example, it happend that "Garry Tallent" was entered as playing just instruments but not a specific one as the actual "electric bass guitar".


OK, lets start from here

#+begin_example
// ==UserScript==
// @name         AA - Add Instrument Buttons (React Release Editor) Extended
// @namespace    https://musicbrainz.org/
// @version      1.7
// @description  Insert multiple Artist buttons, open batch-add dialog, auto-fill relationship type = "instruments", then Artist, Instrument, Credited as fields, and click Done.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    // --- Configuration for multiple Artist buttons ---
    const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        }
        // Add more artist buttons here easily
    ];

    function logAllButtonsAndLinks() {
        const elems = $('button, a');
        console.group('[AA] Fallback: Dumping all buttons/links (' + elems.length + ')');
        elems.each((i, el) => {
            console.group('Element #' + i);
            console.log('Text:', $(el).text().trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();
        alert("AA Script: Could NOT find the batch-add button.\n\nAll button/link elements have been logged in the console.");
    }

    function typeIntoAutocomplete($input, text, callback) {
        const el = $input[0];
        el.focus();

        let idx = 0;

        function reactInput(el, newValue) {
            const last = el.value;
            el.value = newValue;

            const e = new InputEvent("input", {
                bubbles: true,
                cancelable: true,
                inputType: "insertText",
                data: newValue.replace(last, "")
            });

            el.dispatchEvent(e);
        }

        function clickOptionMatching(prefix) {
            const $opt = $("li[role='option']").filter((i, el) =>
                $(el).text().trim().toLowerCase().startsWith(prefix.toLowerCase())
            );

            if ($opt.length) {
                log(`Clicking dropdown option: ${prefix}`);
                $opt[0].click();
                if (callback) callback();
            } else {
                log(`Dropdown option "${prefix}" not ready yet ‚Üí retrying‚Ä¶`);
                setTimeout(() => clickOptionMatching(prefix), 100);
            }
        }

        function typeNext() {
            if (idx >= text.length) {
                setTimeout(() => clickOptionMatching(text), 150);
                return;
            }

            const ch = text[idx];
            const newValue = el.value + ch;
            reactInput(el, newValue);

            idx++;
            setTimeout(typeNext, 50);
        }

        typeNext();
    }

    // --- Main filling sequence ---
    function fillFields(config) {
        fillRelationshipType(config);
    }

    function fillRelationshipType(config) {
        log("Checking for Relationship Type input‚Ä¶");

        const $input = $('input.relationship-type:visible');

        if ($input.length === 0) {
            log("Relationship type field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(() => fillRelationshipType(config), 250);
            return;
        }

        log(`Found Relationship type field ‚Üí typing '${config.relationshipType}'`);
        typeIntoAutocomplete($input, config.relationshipType, () => fillArtistField(config));
    }

    function fillArtistField(config) {
        log("Filling Artist field‚Ä¶");
        const $artist = $('input[placeholder="Type to search, or paste an MBID"]:visible');

        if ($artist.length === 0) {
            log("Artist field not ready ‚Äî retrying‚Ä¶");
            setTimeout(() => fillArtistField(config), 250);
            return;
        }

        typeIntoAutocomplete($artist, config.artist, () => fillInstrumentField(config));
    }

    function fillInstrumentField(config) {
        log("Filling Instrument field‚Ä¶");
        const $instr = $('input[placeholder="instrument"]:visible');

        if ($instr.length === 0) {
            log("Instrument field not ready ‚Äî retrying‚Ä¶");
            setTimeout(() => fillInstrumentField(config), 250);
            return;
        }

        typeIntoAutocomplete($instr, config.instrument, () => fillCreditedAsField(config));
    }

    function fillCreditedAsField(config) {
        log("Filling 'Credited as' field‚Ä¶");

        const $instrumentContainer = $('.multiselect.instrument').last();
        if (!$instrumentContainer.length) {
            log("Instrument container not found ‚Äî retrying‚Ä¶");
            setTimeout(() => fillCreditedAsField(config), 250);
            return;
        }

        const $creditedInput = $instrumentContainer.find('input.attribute-credit');
        if ($creditedInput.length) {
            const el = $creditedInput[0];
            const text = config.creditedAs;

            // React-compliant setter
            const nativeInputValueSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
            if (nativeInputValueSetter) nativeInputValueSetter.call(el, text);

            // Dispatch events to notify React
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }

        log(`'Credited as' field filled successfully with ${config.creditedAs}`);

        // Click the Done button
        const $doneButton = $('button.positive:visible').filter((i, btn) => $(btn).text().trim() === "Done");
        if ($doneButton.length) {
            log("Clicking Done button‚Ä¶");
            $doneButton[0].click();
        } else {
            log("Done button not found ‚Äî retrying‚Ä¶");
            setTimeout(() => fillCreditedAsField(config), 250);
        }
    }

    // --- Button creation ---
    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        const $container = $('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.wrap($container);

        ARTIST_BUTTONS.forEach(config => {
            const $button = $('<button/>', {
                text: config.label,
                style: `
                    margin-left: 10px;
                    background-color: #38a169;
                    color: white;
                    padding: 5px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                `
            });

            $heading.parent().append($button);

$button.on('click', () => {
    log(`"${config.label}" button clicked ‚Üí searching for batch-add button‚Ä¶`);

    const tryBatchClick = () => {
        const $batch = $("button.add-item.with-label.batch-add-recording-relationship");
        if ($batch.length) {
            log("Found batch-add button (exact class) ‚Üí clicking.");
            $batch[0].click();

            // Wait a bit for the dialog to appear before filling fields
            setTimeout(() => fillFields(config), 500);
            return true;
        }
        return false;
    };

    if (!tryBatchClick()) {
        log("Exact match failed ‚Äî trying fallback text search‚Ä¶");

        const $fallback = $("button, a").filter((i, el) => {
            const t = $(el).text().toLowerCase();
            return t.includes("batch-add") && t.includes("record");
        });

        if ($fallback.length) {
            log("Fallback batch-add button found ‚Üí clicking.");
            $fallback[0].click();
            setTimeout(() => fillFields(config), 500);
        } else {
            log("Batch-add button not found ‚Üí logging all buttons/links.");
            logAllButtonsAndLinks();
        }
    }
});
        });

        log("AA: Injected custom artist buttons next to 'Track relationships'.");
    }

    $(document).ready(createCustomButtons);

})();
#+end_example

and further refactor it to also add the "Relationship type" as "vocals" (instead of "instruments").

In the "vocals" case the "Instrument" field (where we before entered things like "drums (drum set)" or "electric bass
guitar") is instead now called "Vocal" and can have values like "lead vocals" or "spoken vocals" but also supports the
"Credited as" field.

The     'const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        }
        // Add more artist buttons here easily
    ];'


structure should also support now the 'relationshipType: "vocal"' and for example 'vocal: "lead vocals"' like this

    // --- Configuration for multiple Artist buttons ---
    const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg (i)",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent (i)",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        }
        {
            label: "Bruce Springsteen (v)",
            relationshipType: "vocal",
            artist: "Bruce Springsteen",
            vocal: "lead vocals",
            creditedAs: ""
        }
        // Add more artist buttons here easily
    ];

The Button text should have an "(i)" appended to the actual artist if his/here relationshipType is "instruments" and
"(v)" if it's "vocal"


#+begin_example
// ==UserScript==
// @name         AA - Add Instrument and Vocal Buttons (React Release Editor) Extended
// @namespace    https://musicbrainz.org/
// @version      1.7
// @description  Insert multiple Artist buttons, open batch-add dialog, auto-fill relationship type = "instruments" or "vocals", then Artist, Instrument/Vocal, Credited as fields, and click Done.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument-vocal]', ...args);
    }

    // --- Configuration for multiple Artist buttons ---
    const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg (i)",  // (i) for instrument
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent (i)",  // (i) for instrument
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        },
        {
            label: "Bruce Springsteen (v)",  // (v) for vocals
            relationshipType: "vocal",
            artist: "Bruce Springsteen",
            vocal: "lead vocals",
            creditedAs: ""
        }
        // Add more artist buttons here easily
    ];

    function logAllButtonsAndLinks() {
        const elems = $('button, a');
        console.group('[AA] Fallback: Dumping all buttons/links (' + elems.length + ')');
        elems.each((i, el) => {
            console.group('Element #' + i);
            console.log('Text:', $(el).text().trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();
        alert("AA Script: Could NOT find the batch-add button.\n\nAll button/link elements have been logged in the console.");
    }

    function typeIntoAutocomplete($input, text, callback) {
        const el = $input[0];
        el.focus();

        let idx = 0;

        function reactInput(el, newValue) {
            const last = el.value;
            el.value = newValue;

            const e = new InputEvent("input", {
                bubbles: true,
                cancelable: true,
                inputType: "insertText",
                data: newValue.replace(last, "")
            });

            el.dispatchEvent(e);
        }

        function clickOptionMatching(prefix) {
            const $opt = $("li[role='option']").filter((i, el) =>
                $(el).text().trim().toLowerCase().startsWith(prefix.toLowerCase())
            );

            if ($opt.length) {
                log(`Clicking dropdown option: ${prefix}`);
                $opt[0].click();
                if (callback) callback();
            } else {
                log(`Dropdown option "${prefix}" not ready yet ‚Üí retrying‚Ä¶`);
                setTimeout(() => clickOptionMatching(prefix), 100);
            }
        }

        function typeNext() {
            if (idx >= text.length) {
                setTimeout(() => clickOptionMatching(text), 150);
                return;
            }

            const ch = text[idx];
            const newValue = el.value + ch;
            reactInput(el, newValue);

            idx++;
            setTimeout(typeNext, 50);
        }

        typeNext();
    }

    // --- Main filling sequence ---
    function fillFields(config) {
        fillRelationshipType(config);
    }

    function fillRelationshipType(config) {
        log("Checking for Relationship Type input‚Ä¶");

        const $input = $('input.relationship-type:visible');

        if ($input.length === 0) {
            log("Relationship type field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(() => fillRelationshipType(config), 250);
            return;
        }

        log(`Found Relationship type field ‚Üí typing '${config.relationshipType}'`);
        typeIntoAutocomplete($input, config.relationshipType, () => fillArtistField(config));
    }

    function fillArtistField(config) {
        log("Filling Artist field‚Ä¶");
        const $artist = $('input[placeholder="Type to search, or paste an MBID"]:visible');

        if ($artist.length === 0) {
            log("Artist field not ready ‚Äî retrying‚Ä¶");
            setTimeout(() => fillArtistField(config), 250);
            return;
        }

        typeIntoAutocomplete($artist, config.artist, () => {
            if (config.relationshipType === "instruments") {
                fillInstrumentField(config);
            } else if (config.relationshipType === "vocal") {
                fillVocalField(config);
            }
        });
    }

    function fillInstrumentField(config) {
        log("Filling Instrument field‚Ä¶");
        const $instr = $('input[placeholder="instrument"]:visible');

        if ($instr.length === 0) {
            log("Instrument field not ready ‚Äî retrying‚Ä¶");
            setTimeout(() => fillInstrumentField(config), 250);
            return;
        }

        typeIntoAutocomplete($instr, config.instrument, () => fillCreditedAsField(config));
    }

    function fillVocalField(config) {
        log("Filling Vocal field‚Ä¶");
        const $vocal = $('input[placeholder="vocal"]:visible');

        if ($vocal.length === 0) {
            log("Vocal field not ready ‚Äî retrying‚Ä¶");
            setTimeout(() => fillVocalField(config), 250);
            return;
        }

        typeIntoAutocomplete($vocal, config.vocal, () => fillCreditedAsField(config));
    }

    function fillCreditedAsField(config) {
        log("Filling 'Credited as' field‚Ä¶");

        const $instrumentContainer = $('.multiselect.instrument').last();
        const $vocalContainer = $('.multiselect.vocal').last();
        const $container = config.relationshipType === "instruments" ? $instrumentContainer : $vocalContainer;

        if (!$container.length) {
            log("Instrument/Vocal container not found ‚Äî retrying‚Ä¶");
            setTimeout(() => fillCreditedAsField(config), 250);
            return;
        }

        const $creditedInput = $container.find('input.attribute-credit');
        if ($creditedInput.length) {
            const el = $creditedInput[0];
            const text = config.creditedAs;

            // React-compliant setter
            const nativeInputValueSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
            if (nativeInputValueSetter) nativeInputValueSetter.call(el, text);

            // Dispatch events to notify React
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }

        log(`'Credited as' field filled successfully with ${config.creditedAs}`);

        // Click the Done button
        const $doneButton = $('button.positive:visible').filter((i, btn) => $(btn).text().trim() === "Done");
        if ($doneButton.length) {
            log("Clicking Done button‚Ä¶");
            $doneButton[0].click();
        } else {
            log("Done button not found ‚Äî retrying‚Ä¶");
            setTimeout(() => fillCreditedAsField(config), 250);
        }
    }

    // --- Button creation ---
    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        const $container = $('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.wrap($container);

        ARTIST_BUTTONS.forEach(config => {
            const $button = $('<button/>', {
                text: config.label,
                style: `
                    margin-left: 10px;
                    background-color: #38a169;
                    color: white;
                    padding: 5px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                `
            });

            $heading.parent().append($button);

            $button.on('click', () => {
                log(`"${config.label}" button clicked ‚Üí searching for batch-add button‚Ä¶`);

                const tryBatchClick = ()
#+end_example

*** working version for vocals and instruments with DONE button click

When using the following working userscript (the pressing the "DONE" button logic commented out), the scripts works
perfect.  But when including the "DONE" button click, the results are not OK. Especially the "Garry Tallent" button
doesn't fill in "electric bass guitar", or when pressing the "Bruce Springsteen" button, the "lead vocals" isn't filled
in.  It looks like a timing/timeout problem when accessing the value from the suggestion list.  Also when pressing all
the buttons right after each other, it looks like when the data for each butten gets entered in the "Instrument" or
"Vocal" field, the previously entered data is still present and the newly entered text is inserted somewhere in between.


#+begin_example
// ==UserScript==
// @name         AA - Add Instrument Buttons (React Release Editor) Extended
// @namespace    https://musicbrainz.org/
// @version      1.8
// @description  Insert multiple Artist buttons, open batch-add dialog, auto-fill relationship type = "instruments" or "vocals", then Artist, Instrument/Vocal, Credited as fields, and click Done.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    // --- Configuration for multiple Artist buttons ---
    const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        },
        {
            label: "Bruce Springsteen",
            relationshipType: "vocal",
            artist: "Bruce Springsteen",
            vocal: "lead vocals",
            creditedAs: ""
        }
        // Add more artist buttons here easily
    ];

    function logAllButtonsAndLinks() {
        const elems = $('button, a');
        console.group('[AA] Fallback: Dumping all buttons/links (' + elems.length + ')');
        elems.each((i, el) => {
            console.group('Element #' + i);
            console.log('Text:', $(el).text().trim());
            console.log('Classes:', el.className);
            console.log('ID:', el.id);
            console.log('OuterHTML:', el.outerHTML);
            console.groupEnd();
        });
        console.groupEnd();
        alert("AA Script: Could NOT find the batch-add button.\n\nAll button/link elements have been logged in the console.");
    }

    function typeIntoAutocomplete($input, text, callback) {
        const el = $input[0];
        el.focus();

        let idx = 0;

        function reactInput(el, newValue) {
            const last = el.value;
            el.value = newValue;

            const e = new InputEvent("input", {
                bubbles: true,
                cancelable: true,
                inputType: "insertText",
                data: newValue.replace(last, "")
            });

            el.dispatchEvent(e);
        }

        function clickOptionMatching(prefix) {
            const $opt = $("li[role='option']").filter((i, el) =>
                $(el).text().trim().toLowerCase().startsWith(prefix.toLowerCase())
            );

            if ($opt.length) {
                log(`Clicking dropdown option: ${prefix}`);
                $opt[0].click();
                if (callback) callback();
            } else {
                log(`Dropdown option "${prefix}" not ready yet ‚Üí retrying‚Ä¶`);
                setTimeout(() => clickOptionMatching(prefix), 100);
            }
        }

        function typeNext() {
            if (idx >= text.length) {
                setTimeout(() => clickOptionMatching(text), 150);
                return;
            }

            const ch = text[idx];
            const newValue = el.value + ch;
            reactInput(el, newValue);

            idx++;
            setTimeout(typeNext, 50);
        }

        typeNext();
    }

    // --- Main filling sequence ---
    function fillFields(config) {
        fillRelationshipType(config);
    }

    function fillRelationshipType(config) {
        log("Checking for Relationship Type input‚Ä¶");

        const $input = $('input.relationship-type:visible');

        if ($input.length === 0) {
            log("Relationship type field not found yet ‚Äî retrying‚Ä¶");
            setTimeout(() => fillRelationshipType(config), 250);
            return;
        }

        log(`Found Relationship type field ‚Üí typing '${config.relationshipType}'`);
        typeIntoAutocomplete($input, config.relationshipType, () => fillArtistField(config));
    }

    function fillArtistField(config) {
        log("Filling Artist field‚Ä¶");
        const $artist = $('input[placeholder="Type to search, or paste an MBID"]:visible');

        if ($artist.length === 0) {
            log("Artist field not ready ‚Äî retrying‚Ä¶");
            setTimeout(() => fillArtistField(config), 250);
            return;
        }

        typeIntoAutocomplete($artist, config.artist, () => fillInstrumentOrVocalField(config));
    }

    function fillInstrumentOrVocalField(config) {
        log(config.relationshipType === "instruments" ? "Filling Instrument field‚Ä¶" : "Filling Vocal field‚Ä¶");

        const $inputField = $('input[placeholder="' + (config.relationshipType === "instruments" ? "instrument" : "vocal") + '"]:visible');

        if ($inputField.length === 0) {
            log(`${config.relationshipType === "instruments" ? "Instrument" : "Vocal"} field not ready ‚Äî retrying‚Ä¶`);
            setTimeout(() => fillInstrumentOrVocalField(config), 250);
            return;
        }

        const valueToEnter = config.relationshipType === "instruments" ? config.instrument : config.vocal;
        typeIntoAutocomplete($inputField, valueToEnter, () => fillCreditedAsField(config));
    }

function fillCreditedAsField(config) {
    log("Filling 'Credited as' field‚Ä¶");

    // Check if the relationship is for vocals or instruments and target the appropriate container
    let $container;
    if (config.relationshipType === "instruments") {
        $container = $('.multiselect.instrument').last(); // For instruments
    } else if (config.relationshipType === "vocal") {
        $container = $('.multiselect.vocal').last(); // For vocals (new selector)
    }

    if (!$container.length) {
        log(`${config.relationshipType === "instruments" ? "Instrument" : "Vocal"} container not found ‚Äî retrying‚Ä¶`);
        setTimeout(() => fillCreditedAsField(config), 250);
        return;
    }

    const $creditedInput = $container.find('input.attribute-credit');
    if ($creditedInput.length) {
        const el = $creditedInput[0];
        const text = config.creditedAs;

        // React-compliant setter
        const nativeInputValueSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
        if (nativeInputValueSetter) nativeInputValueSetter.call(el, text);

        // Dispatch events to notify React
        el.dispatchEvent(new Event('input', { bubbles: true }));
        el.dispatchEvent(new Event('change', { bubbles: true }));
    }

    log(`'Credited as' field filled successfully with ${config.creditedAs}`);

    // Click the Done button
    // const $doneButton = $('button.positive:visible').filter((i, btn) => $(btn).text().trim() === "Done");
    // if ($doneButton.length) {
    //     log("Clicking Done button‚Ä¶");
    //     $doneButton[0].click();
    // } else {
    //     log("Done button not found ‚Äî retrying‚Ä¶");
    //     setTimeout(() => fillCreditedAsField(config), 250);
    // }
}

    // --- Button creation ---
    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        const $container = $('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.wrap($container);

        ARTIST_BUTTONS.forEach(config => {
            const buttonText = config.relationshipType === "instruments" ? `${config.label} (i)` : `${config.label} (v)`;

            const $button = $('<button/>', {
                text: buttonText,
                style: `
                    margin-left: 10px;
                    background-color: #38a169;
                    color: white;
                    padding: 5px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                `
            });

            $heading.parent().append($button);

            $button.on('click', () => {
                log(`"${config.label}" button clicked ‚Üí searching for batch-add button‚Ä¶`);

                const tryBatchClick = () => {
                    const $batch = $("button.add-item.with-label.batch-add-recording-relationship");
                    if ($batch.length) {
                        log("Found batch-add button (exact class) ‚Üí clicking.");
                        $batch[0].click();

                        // Wait a bit for the dialog to appear before filling fields
                        setTimeout(() => fillFields(config), 500);
                        return true;
                    }
                    return false;
                };

                if (!tryBatchClick()) {
                    log("Exact match failed ‚Äî trying fallback text search‚Ä¶");

                    const $fallback = $("button, a").filter((i, el) => {
                        const t = $(el).text().toLowerCase();
                        return t.includes("batch-add") && t.includes("record");
                    });

                    if ($fallback.length) {
                        log("Fallback batch-add button found ‚Üí clicking.");
                        $fallback[0].click();
                        setTimeout(() => fillFields(config), 500);
                    } else {
                        log("Batch-add button not found ‚Üí logging all buttons/links.");
                        logAllButtonsAndLinks();
                    }
                }
            });
        });

        log("AA: Injected custom buttons.");
    }

    // Wait for the page to load, then create the custom buttons
    setTimeout(createCustomButtons, 1000);
})();
#+end_example


#+begin_example
[AA-add-instrument] AA: Injected custom buttons.
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] "Max Weinberg" button clicked ‚Üí searching for batch-add button‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Found batch-add button (exact class) ‚Üí clicking.
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Checking for Relationship Type input‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Found Relationship type field ‚Üí typing 'instruments'
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: instruments
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling Artist field‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: Max Weinberg
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling Instrument field‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: drums (drum set)
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling 'Credited as' field‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] 'Credited as' field filled successfully with drums
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] "Garry Tallent" button clicked ‚Üí searching for batch-add button‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Found batch-add button (exact class) ‚Üí clicking.
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Checking for Relationship Type input‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Found Relationship type field ‚Üí typing 'instruments'
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: instruments
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling Artist field‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: Garry Tallent
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling Instrument field‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: electric bass guitar
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling 'Credited as' field‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] 'Credited as' field filled successfully with
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] "Bruce Springsteen" button clicked ‚Üí searching for batch-add button‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Found batch-add button (exact class) ‚Üí clicking.
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Checking for Relationship Type input‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Found Relationship type field ‚Üí typing 'vocal'
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: vocal
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling Artist field‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: Bruce Springsteen
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling Vocal field‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Clicking dropdown option: lead vocals
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] Filling 'Credited as' field‚Ä¶
userscript.html?name=AA-Add-Instrument-Buttons-React-Release-Editor-Extended.user.js&id=685ef80c-cb44-4a9c-a75b-1a985d1501c8:22 [AA-add-instrument] 'Credited as' field filled successfully with
#+end_example


#+begin_example
// ==UserScript==
// @name         AA - Add Instrument/Vocal Buttons (React Release Editor) Robust
// @namespace    https://musicbrainz.org/
// @version      1.9
// @description  Robust: Insert artist buttons, open batch-add dialog, reliably fill relationship type (instruments|vocal), artist, instrument/vocal, credited-as, click Done ‚Äî sequential queue + dialog lifecycle awareness.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    // --- Configuration for multiple Artist buttons ---
    const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        },
        {
            label: "Bruce Springsteen",
            relationshipType: "vocal",
            artist: "Bruce Springsteen",
            vocal: "lead vocals",
            creditedAs: ""
        }
        // Add/remove entries as needed
    ];

    // ----------------- Utilities -----------------
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    // Wait for an element matching selector that is visible
    async function waitVisible(selector, opts = {}) {
        const timeout = opts.timeout ?? 5000;
        const interval = opts.interval ?? 100;
        const start = Date.now();
        while (Date.now() - start < timeout) {
            const $el = $(selector).filter(':visible');
            if ($el.length) return $el;
            await sleep(interval);
        }
        return null;
    }

    // Wait until no visible dialog exists (used to ensure previous dialog fully closed)
    async function waitDialogClosed(timeout = 3000) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            // adjust selector if your dialog uses a specific class; generic attempt:
            const $visibleDialogs = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
            if ($visibleDialogs.length === 0) {
                // small extra breathing room so React finishes unmount
                await sleep(200);
                return true;
            }
            await sleep(100);
        }
        return false;
    }

    // Wait until a particular condition returns truthy or times out
    async function waitForCondition(conditionFn, {timeout = 3000, interval = 100} = {}) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            try {
                if (await conditionFn()) return true;
            } catch (e) { /* ignore */ }
            await sleep(interval);
        }
        return false;
    }

    // Set value for React-controlled input and dispatch events
    function setReactValueAndDispatch(el, value) {
        try {
            const nativeSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
            if (nativeSetter) nativeSetter.call(el, value);
            else el.value = value;

            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
            // some react versions also respond to these:
            el.dispatchEvent(new InputEvent('input', { bubbles: true }));
        } catch (e) {
            // fallback
            el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }

    // Clear an input cleanly (React-aware)
    function clearInput(el) {
        setReactValueAndDispatch(el, '');
    }

    // Type into autocomplete input character by character and select matching option when available.
    // This function is defensive: it waits for suggestion list, waits for an option starting with prefix (case-insensitive),
    // clicks it, then waits until some sign of selection appears (or a small delay).
    async function typeAndSelect($input, text, {charDelay = 40, postSelectWait = 300, optionSelector = "li[role='option']"} = {}) {
        const el = $input[0];
        if (!el) throw new Error('Input element missing');

        el.focus();

        // Ensure input is empty first (React-friendly)
        clearInput(el);
        await sleep(50);

        // Type characters slowly
        for (let i = 0; i < text.length; i++) {
            const ch = text[i];
            const newValue = el.value + ch;
            setReactValueAndDispatch(el, newValue);
            await sleep(charDelay);
        }

        // At end, give suggestions a moment
        await sleep(120);

        // Wait for a suggestion that startsWith text
        const found = await waitForCondition(() => {
            const $opts = $(optionSelector).filter(':visible');
            if (!$opts.length) return false;
            // prefer exact startsWith (case-insensitive)
            const match = $opts.toArray().find(o => $(o).text().trim().toLowerCase().startsWith(text.toLowerCase()));
            if (match) {
                match.click();
                return true;
            }
            // fallback: any option that includes the text
            const match2 = $opts.toArray().find(o => $(o).text().trim().toLowerCase().includes(text.toLowerCase()));
            if (match2) {
                match2.click();
                return true;
            }
            return false;
        }, {timeout: 3000, interval: 120});

        if (!found) {
            log(`Warning: option for "${text}" not found in suggestions after timeout.`);
        }

        // give React time to update internal state / tokens
        await sleep(postSelectWait);
    }

    // Reliable method: click batch-add button but only AFTER ensuring previous dialog closed
    async function openBatchAddDialog() {
        // Ensure previous closed
        await waitDialogClosed(2000);

        // Find the batch button
        const $batch = $("button.add-item.with-label.batch-add-recording-relationship, button.add-item.batch-add-recording-relationship, button.add-item.with-label").filter(function() {
            const t = $(this).text().toLowerCase();
            return t.includes('batch-add') || t.includes('batch add') || (t.includes('add') && t.includes('record'));
        });

        if ($batch.length === 0) {
            log("Batch-add button not found via selectors");
            return false;
        }

        // Click it
        $batch[0].click();

        // Wait for dialog to appear
        const appeared = await waitForCondition(() => {
            const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
            return $d.length > 0;
        }, {timeout: 3000, interval: 100});

        if (!appeared) {
            // give one more small delay
            await sleep(400);
        }

        // Extra safety pause so React finishes mounting
        await sleep(300);
        return true;
    }

    // ----------------- Filling sequence (async) -----------------
    async function fillFieldsAsync(config) {
        log(`Start filling for: ${config.label} (${config.relationshipType})`);

        // 1) Relationship type
        const $relInput = await waitVisible('input.relationship-type', {timeout: 4000});
        if (!$relInput) {
            log("Relationship type input not found ‚Äî aborting this item.");
            return false;
        }
        log(`Typing relationshipType '${config.relationshipType}'`);
        await typeAndSelect($relInput, config.relationshipType, {charDelay: 40, postSelectWait: 200});

        // 2) Artist
        const $artist = await waitVisible('input[placeholder="Type to search, or paste an MBID"]', {timeout: 4000});
        if (!$artist) {
            log("Artist input not found ‚Äî aborting this item.");
            return false;
        }
        log(`Typing artist '${config.artist}'`);
        await typeAndSelect($artist, config.artist, {charDelay: 50, postSelectWait: 250});

        // 3) Instrument or Vocal
        const placeholderName = config.relationshipType === 'instruments' ? 'instrument' : 'vocal';
        const $inst = await waitVisible(`input[placeholder="${placeholderName}"]`, {timeout: 4000});
        if (!$inst) {
            log(`${placeholderName} input not found ‚Äî aborting this item.`);
            return false;
        }
        const desired = (config.relationshipType === 'instruments') ? config.instrument : config.vocal;
        if (desired && desired.length > 0) {
            log(`Typing ${placeholderName} '${desired}'`);
            await typeAndSelect($inst, desired, {charDelay: 45, postSelectWait: 300});
        } else {
            log(`No ${placeholderName} value provided, skipping selection.`);
        }

        // 4) Credited as: find correct container near the instrument/vocal input
        log("Attempting to fill 'Credited as' field‚Ä¶");
        // Strategy: find the nearest .multiselect that contains an input.attribute-credit or the 'attribute-credit' input visible.
        // We'll search visible attribute-credit inputs first, and then try to ensure it's the correct one by proximity.
        let $creditedInput = $('.attribute-credit:visible');
        if ($creditedInput.length === 0) {
            // fallback: look for input.attribute-credit anywhere inside visible multiselects
            const $multi = $('.multiselect:visible').filter(function() {
                return $(this).find('input[placeholder]').length > 0;
            }).last();
            if ($multi && $multi.length) {
                $creditedInput = $multi.find('input.attribute-credit:visible');
            }
        }

        // Another proximity attempt: find attribute-credit inside last visible .multiselect.* that also contains the placeholder input
        if ($creditedInput.length === 0) {
            const $lastMulti = $('.multiselect:visible').filter((i, el) => {
                return $(el).find(`input[placeholder="${placeholderName}"]`).length > 0;
            }).last();
            if ($lastMulti && $lastMulti.length) {
                $creditedInput = $lastMulti.find('input.attribute-credit:visible');
            }
        }

        // If still not found, try common selector: .multiselect.instrument or .multiselect.vocal
        if ($creditedInput.length === 0) {
            if (config.relationshipType === 'instruments') {
                $creditedInput = $('.multiselect.instrument').last().find('input.attribute-credit:visible');
            } else {
                $creditedInput = $('.multiselect.vocal').last().find('input.attribute-credit:visible');
            }
        }

        // Final fallback: any visible input whose name/id contains 'credit'
        if ($creditedInput.length === 0) {
            $creditedInput = $("input:visible").filter((i, el) => {
                const idn = (el.id || '').toLowerCase();
                const name = (el.name || '').toLowerCase();
                const cls = (el.className || '').toLowerCase();
                return idn.includes('credit') || name.includes('credit') || cls.includes('attribute-credit');
            }).first();
        }

        if ($creditedInput && $creditedInput.length) {
            const el = $creditedInput[0];
            const text = config.creditedAs ?? '';
            // set and dispatch react-friendly events
            setReactValueAndDispatch(el, text);
            // give React a little time
            await sleep(120);
            log(`'Credited as' set to "${text}"`);
        } else {
            log("Could not find credited-as input (it's optional); continuing.");
        }

        // 5) Click Done, but wait until Done appears and is stable
        const $doneButton = await waitVisible('button.positive:visible', {timeout: 4000});
        if ($doneButton) {
            // ensure the button text is exactly "Done" (there may be other positive buttons)
            const $exactDone = $doneButton.filter((i, btn) => $(btn).text().trim() === 'Done');
            if ($exactDone.length) {
                log("Clicking Done");
                $exactDone[0].click();
                // Wait until dialog disappears
                await waitForCondition(() => {
                    const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
                    return $d.length === 0;
                }, {timeout: 3500, interval: 120});
                // small extra breathing room
                await sleep(250);
                log(`Finished item: ${config.label}`);
                return true;
            } else {
                log("Done button not found among positive buttons ‚Äî skipping Done.");
                return true;
            }
        } else {
            log("Done button not found (timeout) ‚Äî skipping Done.");
            return true;
        }
    }

    // ----------------- Queue to process clicks sequentially -----------------
    const queue = [];
    let processing = false;

    async function processQueue() {
        if (processing) return;
        processing = true;
        while (queue.length) {
            const config = queue.shift();
            try {
                log(`Processing queue item: ${config.label}`);
                // Open dialog (ensures previous is closed and waits until the dialog is stable)
                const opened = await openBatchAddDialog();
                if (!opened) {
                    log("Could not open batch-add dialog ‚Äî skipping this item.");
                    await sleep(300);
                    continue;
                }

                // Fill all fields and click Done
                await fillFieldsAsync(config);

                // Give small pause before next item to let React settle
                await sleep(300);
            } catch (e) {
                console.error('[AA-add-instrument] Error processing item', e);
                // tiny pause and continue with next item
                await sleep(500);
            }
        }
        processing = false;
    }

    // ----------------- UI: create buttons -----------------
    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        const $container = $('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.wrap($container);

        ARTIST_BUTTONS.forEach(config => {
            // Append (i) or (v) to button label UI
            const suffix = config.relationshipType === 'instruments' ? ' (i)' : (config.relationshipType === 'vocal' ? ' (v)' : '');
            const buttonText = `${config.label}${suffix}`;

            const $button = $('<button/>', {
                text: buttonText,
                style: `
                    margin-left: 10px;
                    background-color: #38a169;
                    color: white;
                    padding: 5px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                `
            });

            $heading.parent().append($button);

            $button.on('click', () => {
                log(`Enqueued "${config.label}" (${config.relationshipType})`);
                // push a shallow copy to avoid mutation issues
                queue.push(Object.assign({}, config));
                processQueue().catch(e => console.error(e));
            });
        });

        log("AA: Injected custom buttons.");
    }

    // Start
    $(document).ready(() => {
        // Wait a bit to ensure page ready
        setTimeout(createCustomButtons, 700);
    });

})();
#+end_example


Notes & rationale (quick)

Sequential queue: pressing multiple buttons rapidly will enqueue the tasks and process them one-by-one. This prevents DOM/React racing between dialogs.

Wait for dialog lifecycle: we wait for dialogs to be closed before opening a new one and wait for them to mount before interacting.

Typing + selection: types char-by-char and only clicks suggestion options after they appear. If the suggestion isn't present, it logs a warning and continues (no accidental Return/enter).

React-friendly input setting: uses native property setter + input/change events so React sees the updates.

Credited-as resolution: multiple strategies to locate the correct credited-as input ‚Äî proximity search, .multiselect.*, and fallback name/class heuristics.

If you want, I can:

tweak timing constants (charDelay, waits) for your machine/network,

make the queue visible with an on-page status indicator,

add a per-button per-field override for custom timeouts,

or adapt selectors if your MusicBrainz theme uses different class names.

Want me to adjust timing to be even more conservative (safer) or more aggressive (faster)?

*** most robust version so far

#+begin_example
// ==UserScript==
// @name         AA - Add Instrument/Vocal Buttons (React Release Editor) Robust
// @namespace    https://musicbrainz.org/
// @version      1.9
// @description  Robust: Insert artist buttons, open batch-add dialog, reliably fill relationship type (instruments|vocal), artist, instrument/vocal, credited-as, click Done ‚Äî sequential queue + dialog lifecycle awareness.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    // --- Configuration for multiple Artist buttons ---
    const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        },
        {
            label: "Bruce Springsteen",
            relationshipType: "vocal",
            artist: "Bruce Springsteen",
            vocal: "lead vocals",
            creditedAs: ""
        }
        // Add/remove entries as needed
    ];

    // ----------------- Utilities -----------------
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    // Wait for an element matching selector that is visible
    async function waitVisible(selector, opts = {}) {
        const timeout = opts.timeout ?? 5000;
        const interval = opts.interval ?? 100;
        const start = Date.now();
        while (Date.now() - start < timeout) {
            const $el = $(selector).filter(':visible');
            if ($el.length) return $el;
            await sleep(interval);
        }
        return null;
    }

    // Wait until no visible dialog exists (used to ensure previous dialog fully closed)
    async function waitDialogClosed(timeout = 3000) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            // adjust selector if your dialog uses a specific class; generic attempt:
            const $visibleDialogs = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
            if ($visibleDialogs.length === 0) {
                // small extra breathing room so React finishes unmount
                await sleep(200);
                return true;
            }
            await sleep(100);
        }
        return false;
    }

    // Wait until a particular condition returns truthy or times out
    async function waitForCondition(conditionFn, {timeout = 3000, interval = 100} = {}) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            try {
                if (await conditionFn()) return true;
            } catch (e) { /* ignore */ }
            await sleep(interval);
        }
        return false;
    }

    // Set value for React-controlled input and dispatch events
    function setReactValueAndDispatch(el, value) {
        try {
            const nativeSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
            if (nativeSetter) nativeSetter.call(el, value);
            else el.value = value;

            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
            // some react versions also respond to these:
            el.dispatchEvent(new InputEvent('input', { bubbles: true }));
        } catch (e) {
            // fallback
            el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }

    // Clear an input cleanly (React-aware)
    function clearInput(el) {
        setReactValueAndDispatch(el, '');
    }

    // Type into autocomplete input character by character and select matching option when available.
    // This function is defensive: it waits for suggestion list, waits for an option starting with prefix (case-insensitive),
    // clicks it, then waits until some sign of selection appears (or a small delay).
    async function typeAndSelect($input, text, {charDelay = 40, postSelectWait = 300, optionSelector = "li[role='option']"} = {}) {
        const el = $input[0];
        if (!el) throw new Error('Input element missing');

        el.focus();

        // Ensure input is empty first (React-friendly)
        clearInput(el);
        await sleep(50);

        // Type characters slowly
        for (let i = 0; i < text.length; i++) {
            const ch = text[i];
            const newValue = el.value + ch;
            setReactValueAndDispatch(el, newValue);
            await sleep(charDelay);
        }

        // At end, give suggestions a moment
        await sleep(120);

        // Wait for a suggestion that startsWith text
        const found = await waitForCondition(() => {
            const $opts = $(optionSelector).filter(':visible');
            if (!$opts.length) return false;
            // prefer exact startsWith (case-insensitive)
            const match = $opts.toArray().find(o => $(o).text().trim().toLowerCase().startsWith(text.toLowerCase()));
            if (match) {
                match.click();
                return true;
            }
            // fallback: any option that includes the text
            const match2 = $opts.toArray().find(o => $(o).text().trim().toLowerCase().includes(text.toLowerCase()));
            if (match2) {
                match2.click();
                return true;
            }
            return false;
        }, {timeout: 3000, interval: 120});

        if (!found) {
            log(`Warning: option for "${text}" not found in suggestions after timeout.`);
        }

        // give React time to update internal state / tokens
        await sleep(postSelectWait);
    }

    // Reliable method: click batch-add button but only AFTER ensuring previous dialog closed
    async function openBatchAddDialog() {
        // Ensure previous closed
        await waitDialogClosed(2000);

        // Find the batch button
        const $batch = $("button.add-item.with-label.batch-add-recording-relationship, button.add-item.batch-add-recording-relationship, button.add-item.with-label").filter(function() {
            const t = $(this).text().toLowerCase();
            return t.includes('batch-add') || t.includes('batch add') || (t.includes('add') && t.includes('record'));
        });

        if ($batch.length === 0) {
            log("Batch-add button not found via selectors");
            return false;
        }

        // Click it
        $batch[0].click();

        // Wait for dialog to appear
        const appeared = await waitForCondition(() => {
            const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
            return $d.length > 0;
        }, {timeout: 3000, interval: 100});

        if (!appeared) {
            // give one more small delay
            await sleep(400);
        }

        // Extra safety pause so React finishes mounting
        await sleep(300);
        return true;
    }

    // ----------------- Filling sequence (async) -----------------
    async function fillFieldsAsync(config) {
        log(`Start filling for: ${config.label} (${config.relationshipType})`);

        // 1) Relationship type
        const $relInput = await waitVisible('input.relationship-type', {timeout: 4000});
        if (!$relInput) {
            log("Relationship type input not found ‚Äî aborting this item.");
            return false;
        }
        log(`Typing relationshipType '${config.relationshipType}'`);
        await typeAndSelect($relInput, config.relationshipType, {charDelay: 40, postSelectWait: 200});

        // 2) Artist
        const $artist = await waitVisible('input[placeholder="Type to search, or paste an MBID"]', {timeout: 4000});
        if (!$artist) {
            log("Artist input not found ‚Äî aborting this item.");
            return false;
        }
        log(`Typing artist '${config.artist}'`);
        await typeAndSelect($artist, config.artist, {charDelay: 50, postSelectWait: 250});

        // 3) Instrument or Vocal
        const placeholderName = config.relationshipType === 'instruments' ? 'instrument' : 'vocal';
        const $inst = await waitVisible(`input[placeholder="${placeholderName}"]`, {timeout: 4000});
        if (!$inst) {
            log(`${placeholderName} input not found ‚Äî aborting this item.`);
            return false;
        }
        const desired = (config.relationshipType === 'instruments') ? config.instrument : config.vocal;
        if (desired && desired.length > 0) {
            log(`Typing ${placeholderName} '${desired}'`);
            await typeAndSelect($inst, desired, {charDelay: 45, postSelectWait: 300});
        } else {
            log(`No ${placeholderName} value provided, skipping selection.`);
        }

        // 4) Credited as: find correct container near the instrument/vocal input
        log("Attempting to fill 'Credited as' field‚Ä¶");
        // Strategy: find the nearest .multiselect that contains an input.attribute-credit or the 'attribute-credit' input visible.
        // We'll search visible attribute-credit inputs first, and then try to ensure it's the correct one by proximity.
        let $creditedInput = $('.attribute-credit:visible');
        if ($creditedInput.length === 0) {
            // fallback: look for input.attribute-credit anywhere inside visible multiselects
            const $multi = $('.multiselect:visible').filter(function() {
                return $(this).find('input[placeholder]').length > 0;
            }).last();
            if ($multi && $multi.length) {
                $creditedInput = $multi.find('input.attribute-credit:visible');
            }
        }

        // Another proximity attempt: find attribute-credit inside last visible .multiselect.* that also contains the placeholder input
        if ($creditedInput.length === 0) {
            const $lastMulti = $('.multiselect:visible').filter((i, el) => {
                return $(el).find(`input[placeholder="${placeholderName}"]`).length > 0;
            }).last();
            if ($lastMulti && $lastMulti.length) {
                $creditedInput = $lastMulti.find('input.attribute-credit:visible');
            }
        }

        // If still not found, try common selector: .multiselect.instrument or .multiselect.vocal
        if ($creditedInput.length === 0) {
            if (config.relationshipType === 'instruments') {
                $creditedInput = $('.multiselect.instrument').last().find('input.attribute-credit:visible');
            } else {
                $creditedInput = $('.multiselect.vocal').last().find('input.attribute-credit:visible');
            }
        }

        // Final fallback: any visible input whose name/id contains 'credit'
        if ($creditedInput.length === 0) {
            $creditedInput = $("input:visible").filter((i, el) => {
                const idn = (el.id || '').toLowerCase();
                const name = (el.name || '').toLowerCase();
                const cls = (el.className || '').toLowerCase();
                return idn.includes('credit') || name.includes('credit') || cls.includes('attribute-credit');
            }).first();
        }

        if ($creditedInput && $creditedInput.length) {
            const el = $creditedInput[0];
            const text = config.creditedAs ?? '';
            // set and dispatch react-friendly events
            setReactValueAndDispatch(el, text);
            // give React a little time
            await sleep(120);
            log(`'Credited as' set to "${text}"`);
        } else {
            log("Could not find credited-as input (it's optional); continuing.");
        }

        // 5) Click Done, but wait until Done appears and is stable
        const $doneButton = await waitVisible('button.positive:visible', {timeout: 4000});
        if ($doneButton) {
            // ensure the button text is exactly "Done" (there may be other positive buttons)
            const $exactDone = $doneButton.filter((i, btn) => $(btn).text().trim() === 'Done');
            if ($exactDone.length) {
                log("Clicking Done");
                $exactDone[0].click();
                // Wait until dialog disappears
                await waitForCondition(() => {
                    const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
                    return $d.length === 0;
                }, {timeout: 3500, interval: 120});
                // small extra breathing room
                await sleep(250);
                log(`Finished item: ${config.label}`);
                return true;
            } else {
                log("Done button not found among positive buttons ‚Äî skipping Done.");
                return true;
            }
        } else {
            log("Done button not found (timeout) ‚Äî skipping Done.");
            return true;
        }
    }

    // ----------------- Queue to process clicks sequentially -----------------
    const queue = [];
    let processing = false;

    async function processQueue() {
        if (processing) return;
        processing = true;
        while (queue.length) {
            const config = queue.shift();
            try {
                log(`Processing queue item: ${config.label}`);
                // Open dialog (ensures previous is closed and waits until the dialog is stable)
                const opened = await openBatchAddDialog();
                if (!opened) {
                    log("Could not open batch-add dialog ‚Äî skipping this item.");
                    await sleep(300);
                    continue;
                }

                // Fill all fields and click Done
                await fillFieldsAsync(config);

                // Give small pause before next item to let React settle
                await sleep(300);
            } catch (e) {
                console.error('[AA-add-instrument] Error processing item', e);
                // tiny pause and continue with next item
                await sleep(500);
            }
        }
        processing = false;
    }

    // ----------------- UI: create buttons -----------------
    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        const $container = $('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.wrap($container);

        ARTIST_BUTTONS.forEach(config => {
            // Append (i) or (v) to button label UI
            const suffix = config.relationshipType === 'instruments' ? ' (i)' : (config.relationshipType === 'vocal' ? ' (v)' : '');
            const buttonText = `${config.label}${suffix}`;

            const $button = $('<button/>', {
                text: buttonText,
                style: `
                    margin-left: 10px;
                    background-color: #38a169;
                    color: white;
                    padding: 5px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                `
            });

            $heading.parent().append($button);

            $button.on('click', () => {
                log(`Enqueued "${config.label}" (${config.relationshipType})`);
                // push a shallow copy to avoid mutation issues
                queue.push(Object.assign({}, config));
                processQueue().catch(e => console.error(e));
            });
        });

        log("AA: Injected custom buttons.");
    }

    // Start
    $(document).ready(() => {
        // Wait a bit to ensure page ready
        setTimeout(createCustomButtons, 700);
    });

})();
#+end_example

*** add performer

Please add also support for the following ARTIST_BUTTON with 'relationshipType: "performed / performer"':

#+begin_example
        {
            label: "E Street Band",
            relationshipType: "performed / performer",
            artist: "The E Street Band"
        }
#+end_example

The 'relationshipType: "performed / performer"' doesn't have any other input type like "instrument with creditdAs" or
"vocal with creditedAs", so after entering the actual 'relationshipType: "performed / performer"' and the corresponding
artist, the DONE button should be clicked right away.

so in the code it should look like:

#+begin_example
    // --- Configuration for multiple Artist buttons ---
    const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        },
        {
            label: "Bruce Springsteen",
            relationshipType: "vocal",
            artist: "Bruce Springsteen",
            vocal: "lead vocals",
            creditedAs: ""
        },
        {
            label: "Street Band",
            relationshipType: "performed / performer",
            artist: "The E Street Band"
        }
        // Add/remove entries as needed
    ];

#+end_example


# Antwort

#+begin_example
const ARTIST_BUTTONS = [
    {
        label: "Max Weinberg",
        relationshipType: "instruments",
        artist: "Max Weinberg",
        instrument: "drums (drum set)",
        creditedAs: "drums"
    },
    {
        label: "Garry Tallent",
        relationshipType: "instruments",
        artist: "Garry Tallent",
        instrument: "electric bass guitar",
        creditedAs: ""
    },
    {
        label: "Bruce Springsteen",
        relationshipType: "vocal",
        artist: "Bruce Springsteen",
        vocal: "lead vocals",
        creditedAs: ""
    },
    {
        label: "E Street Band",
        relationshipType: "performed / performer",
        artist: "The E Street Band"
    }
];
#+end_example

Replace your current fillFields() with this:

#+begin_example
function fillFields(config) {
    if (config.relationshipType === "performed / performer") {
        fillPerformerRelationship(config);
    } else {
        fillRelationshipType(config); // instruments + vocal
    }
}
#+end_example

Add this new function right below your other fill functions:

#+begin_example
function fillPerformerRelationship(config) {
    log("Performer mode: filling relationship type‚Ä¶");

    const $input = $('input.relationship-type:visible');

    if ($input.length === 0) {
        log("Performer: relationship type field not ready ‚Äî retrying‚Ä¶");
        setTimeout(() => fillPerformerRelationship(config), 200);
        return;
    }

    typeIntoAutocomplete($input, config.relationshipType, () => {
        log("Performer mode: filling Artist‚Ä¶");
        setTimeout(() => fillPerformerArtist(config), 200);
    });
}

function fillPerformerArtist(config) {
    const $artist = $('input[placeholder="Type to search, or paste an MBID"]:visible');

    if ($artist.length === 0) {
        log("Performer: Artist field not ready ‚Äî retrying‚Ä¶");
        setTimeout(() => fillPerformerArtist(config), 200);
        return;
    }

    typeIntoAutocomplete($artist, config.artist, () => {
        log("Performer: Artist filled ‚Üí clicking Done‚Ä¶");
        clickDoneButton();
    });
}

function clickDoneButton() {
    const $done = $('button.positive:visible').filter((i, btn) => $(btn).text().trim() === "Done");

    if ($done.length) {
        log("Clicking Done button for performer relationship‚Ä¶");
        $done[0].click();
    } else {
        log("Done button not found ‚Äî retrying‚Ä¶");
        setTimeout(clickDoneButton, 200);
    }
}
#+end_example

(to mark performer buttons with (p) instead of (i) or (v))
Replace the button label generation with this version:

#+begin_example
const typeLabel =
    config.relationshipType === "instruments" ? "(i)" :
    config.relationshipType === "vocal" ? "(v)" :
    "(p)"; // performer

const buttonText = `${config.label} ${typeLabel}`;
#+end_example

If you want, I can:

‚úÖ merge everything into a single unified script
‚úÖ add automatic queuing for batch multi-button presses
‚úÖ add support for multiple performer roles
‚úÖ add color-coding or icons for button types
‚úÖ add better error handling / logging panel
Add keyboard shortcuts for buttons

Just tell me!

*** lets see

Please add color-coding and icons for button types and keyboard shortcuts for buttons but do not change any other
aspects of the following code (nothing else should be rewritten, no comments removed or changed)

#+begin_example
// ==UserScript==
// @name         AA - Add Instrument/Vocal Buttons (React Release Editor) Robust + Performer
// @namespace    https://musicbrainz.org/
// @version      1.10
// @description  Robust: Insert artist buttons, open batch-add dialog, reliably fill relationship type (instruments|vocal|performed / performer), artist, instrument/vocal, credited-as, click Done ‚Äî sequential queue + dialog lifecycle awareness.
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    // --- Configuration for multiple Artist buttons ---
    const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        },
        {
            label: "Bruce Springsteen",
            relationshipType: "vocal",
            artist: "Bruce Springsteen",
            vocal: "lead vocals",
            creditedAs: ""
        },
        {
            label: "E Street Band",
            relationshipType: "performed / performer",
            artist: "The E Street Band"
        }
        // Add/remove entries as needed
    ];

    // ----------------- Utilities -----------------
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    // Wait for an element matching selector that is visible
    async function waitVisible(selector, opts = {}) {
        const timeout = opts.timeout ?? 5000;
        const interval = opts.interval ?? 100;
        const start = Date.now();
        while (Date.now() - start < timeout) {
            const $el = $(selector).filter(':visible');
            if ($el.length) return $el;
            await sleep(interval);
        }
        return null;
    }

    // Wait until no visible dialog exists (used to ensure previous dialog fully closed)
    async function waitDialogClosed(timeout = 3000) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            // adjust selector if your dialog uses a specific class; generic attempt:
            const $visibleDialogs = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
            if ($visibleDialogs.length === 0) {
                // small extra breathing room so React finishes unmount
                await sleep(200);
                return true;
            }
            await sleep(100);
        }
        return false;
    }

    // Wait until a particular condition returns truthy or times out
    async function waitForCondition(conditionFn, {timeout = 3000, interval = 100} = {}) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            try {
                if (await conditionFn()) return true;
            } catch (e) { /* ignore */ }
            await sleep(interval);
        }
        return false;
    }

    // Set value for React-controlled input and dispatch events
    function setReactValueAndDispatch(el, value) {
        try {
            const nativeSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
            if (nativeSetter) nativeSetter.call(el, value);
            else el.value = value;

            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
            // some react versions also respond to these:
            el.dispatchEvent(new InputEvent('input', { bubbles: true }));
        } catch (e) {
            // fallback
            el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }

    // Clear an input cleanly (React-aware)
    function clearInput(el) {
        setReactValueAndDispatch(el, '');
    }

    // Type into autocomplete input character by character and select matching option when available.
    // This function is defensive: it waits for suggestion list, waits for an option starting with prefix (case-insensitive),
    // clicks it, then waits until some sign of selection appears (or a small delay).
    async function typeAndSelect($input, text, {charDelay = 40, postSelectWait = 300, optionSelector = "li[role='option']"} = {}) {
        const el = $input[0];
        if (!el) throw new Error('Input element missing');

        el.focus();

        // Ensure input is empty first (React-friendly)
        clearInput(el);
        await sleep(50);

        // Type characters slowly
        for (let i = 0; i < text.length; i++) {
            const ch = text[i];
            const newValue = el.value + ch;
            setReactValueAndDispatch(el, newValue);
            await sleep(charDelay);
        }

        // At end, give suggestions a moment
        await sleep(120);

        // Wait for a suggestion that startsWith text
        const found = await waitForCondition(() => {
            const $opts = $(optionSelector).filter(':visible');
            if (!$opts.length) return false;
            // prefer exact startsWith (case-insensitive)
            const match = $opts.toArray().find(o => $(o).text().trim().toLowerCase().startsWith(text.toLowerCase()));
            if (match) {
                match.click();
                return true;
            }
            // fallback: any option that includes the text
            const match2 = $opts.toArray().find(o => $(o).text().trim().toLowerCase().includes(text.toLowerCase()));
            if (match2) {
                match2.click();
                return true;
            }
            return false;
        }, {timeout: 3000, interval: 120});

        if (!found) {
            log(`Warning: option for "${text}" not found in suggestions after timeout.`);
        }

        // give React time to update internal state / tokens
        await sleep(postSelectWait);
    }

    // Reliable method: click batch-add button but only AFTER ensuring previous dialog closed
    async function openBatchAddDialog() {
        // Ensure previous closed
        await waitDialogClosed(2000);

        // Find the batch button
        const $batch = $("button.add-item.with-label.batch-add-recording-relationship, button.add-item.batch-add-recording-relationship, button.add-item.with-label").filter(function() {
            const t = $(this).text().toLowerCase();
            return t.includes('batch-add') || t.includes('batch add') || (t.includes('add') && t.includes('record'));
        });

        if ($batch.length === 0) {
            log("Batch-add button not found via selectors");
            return false;
        }

        // Click it
        $batch[0].click();

        // Wait for dialog to appear
        const appeared = await waitForCondition(() => {
            const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
            return $d.length > 0;
        }, {timeout: 3000, interval: 100});

        if (!appeared) {
            // give one more small delay
            await sleep(400);
        }

        // Extra safety pause so React finishes mounting
        await sleep(300);
        return true;
    }

    // Click Done helper
    async function clickDoneAndWaitClose() {
        const $doneButton = await waitVisible('button.positive:visible', {timeout: 4000});
        if ($doneButton) {
            const $exactDone = $doneButton.filter((i, btn) => $(btn).text().trim() === 'Done');
            if ($exactDone.length) {
                log("Clicking Done");
                $exactDone[0].click();
                // Wait until dialog disappears
                await waitForCondition(() => {
                    const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
                    return $d.length === 0;
                }, {timeout: 3500, interval: 120});
                // small extra breathing room
                await sleep(250);
                return true;
            }
        }
        log("Done button not found (when trying to click Done).");
        return false;
    }

    // ----------------- Filling sequence (async) -----------------
    async function fillFieldsAsync(config) {
        log(`Start filling for: ${config.label} (${config.relationshipType})`);

        // 1) Relationship type
        const $relInput = await waitVisible('input.relationship-type', {timeout: 4000});
        if (!$relInput) {
            log("Relationship type input not found ‚Äî aborting this item.");
            return false;
        }
        log(`Typing relationshipType '${config.relationshipType}'`);
        await typeAndSelect($relInput, config.relationshipType, {charDelay: 40, postSelectWait: 200});

        // 2) Artist
        const $artist = await waitVisible('input[placeholder="Type to search, or paste an MBID"]', {timeout: 4000});
        if (!$artist) {
            log("Artist input not found ‚Äî aborting this item.");
            return false;
        }
        log(`Typing artist '${config.artist}'`);
        await typeAndSelect($artist, config.artist, {charDelay: 50, postSelectWait: 250});

        // SPECIAL CASE: performed / performer -> skip instrument/vocal/credited-as and click Done
        if (config.relationshipType === 'performed / performer') {
            log("Performed / performer detected ‚Äî skipping instrument/vocal/credited-as and clicking Done.");
            await clickDoneAndWaitClose();
            log(`Finished performer item: ${config.label}`);
            return true;
        }

        // 3) Instrument or Vocal (only for instruments or vocal types)
        const placeholderName = config.relationshipType === 'instruments' ? 'instrument' : 'vocal';

        // Only attempt placeholder input if relationshipType is 'instruments' or 'vocal'
        if (config.relationshipType === 'instruments' || config.relationshipType === 'vocal') {
            const $inst = await waitVisible(`input[placeholder="${placeholderName}"]`, {timeout: 4000});
            if (!$inst) {
                log(`${placeholderName} input not found ‚Äî aborting this item.`);
                return false;
            }
            const desired = (config.relationshipType === 'instruments') ? config.instrument : config.vocal;
            if (desired && desired.length > 0) {
                log(`Typing ${placeholderName} '${desired}'`);
                await typeAndSelect($inst, desired, {charDelay: 45, postSelectWait: 300});
            } else {
                log(`No ${placeholderName} value provided, skipping selection.`);
            }
        } else {
            log(`Relationship type '${config.relationshipType}' does not require instrument/vocal step; skipping.`);
        }

        // 4) Credited as: find correct container near the instrument/vocal input
        log("Attempting to fill 'Credited as' field‚Ä¶");
        // Strategy: find the nearest .multiselect that contains an input.attribute-credit or the 'attribute-credit' input visible.
        // We'll search visible attribute-credit inputs first, and then try to ensure it's the correct one by proximity.
        let $creditedInput = $('.attribute-credit:visible');
        if ($creditedInput.length === 0) {
            // fallback: look for input.attribute-credit anywhere inside visible multiselects
            const $multi = $('.multiselect:visible').filter(function() {
                return $(this).find('input[placeholder]').length > 0;
            }).last();
            if ($multi && $multi.length) {
                $creditedInput = $multi.find('input.attribute-credit:visible');
            }
        }

        // Another proximity attempt: find attribute-credit inside last visible .multiselect.* that also contains the placeholder input
        if ($creditedInput.length === 0) {
            const $lastMulti = $('.multiselect:visible').filter((i, el) => {
                return $(el).find(`input[placeholder="${placeholderName}"]`).length > 0;
            }).last();
            if ($lastMulti && $lastMulti.length) {
                $creditedInput = $lastMulti.find('input.attribute-credit:visible');
            }
        }

        // If still not found, try common selector: .multiselect.instrument or .multiselect.vocal
        if ($creditedInput.length === 0) {
            if (config.relationshipType === 'instruments') {
                $creditedInput = $('.multiselect.instrument').last().find('input.attribute-credit:visible');
            } else {
                $creditedInput = $('.multiselect.vocal').last().find('input.attribute-credit:visible');
            }
        }

        // Final fallback: any visible input whose name/id contains 'credit'
        if ($creditedInput.length === 0) {
            $creditedInput = $("input:visible").filter((i, el) => {
                const idn = (el.id || '').toLowerCase();
                const name = (el.name || '').toLowerCase();
                const cls = (el.className || '').toLowerCase();
                return idn.includes('credit') || name.includes('credit') || cls.includes('attribute-credit');
            }).first();
        }

        if ($creditedInput && $creditedInput.length) {
            const el = $creditedInput[0];
            const text = config.creditedAs ?? '';
            // set and dispatch react-friendly events
            setReactValueAndDispatch(el, text);
            // give React a little time
            await sleep(120);
            log(`'Credited as' set to "${text}"`);
        } else {
            log("Could not find credited-as input (it's optional); continuing.");
        }

        // 5) Click Done, but wait until Done appears and is stable
        const doneClicked = await clickDoneAndWaitClose();
        if (doneClicked) {
            log(`Finished item: ${config.label}`);
            return true;
        } else {
            log("Done not clicked (not found) ‚Äî but continuing.");
            return true;
        }
    }

    // ----------------- Queue to process clicks sequentially -----------------
    const queue = [];
    let processing = false;

    async function processQueue() {
        if (processing) return;
        processing = true;
        while (queue.length) {
            const config = queue.shift();
            try {
                log(`Processing queue item: ${config.label}`);
                // Open dialog (ensures previous is closed and waits until the dialog is stable)
                const opened = await openBatchAddDialog();
                if (!opened) {
                    log("Could not open batch-add dialog ‚Äî skipping this item.");
                    await sleep(300);
                    continue;
                }

                // Fill all fields and click Done
                await fillFieldsAsync(config);

                // Give small pause before next item to let React settle
                await sleep(300);
            } catch (e) {
                console.error('[AA-add-instrument] Error processing item', e);
                // tiny pause and continue with next item
                await sleep(500);
            }
        }
        processing = false;
    }

    // ----------------- UI: create buttons -----------------
    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        const $container = $('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.wrap($container);

        ARTIST_BUTTONS.forEach(config => {
            // Append (i) or (v) or (p) to button label UI
            const suffix = config.relationshipType === 'instruments' ? ' (i)' :
                           config.relationshipType === 'vocal' ? ' (v)' :
                           config.relationshipType === 'performed / performer' ? ' (p)' : '';
            const buttonText = `${config.label}${suffix}`;

            const $button = $('<button/>', {
                text: buttonText,
                style: `
                    margin-left: 10px;
                    background-color: #38a169;
                    color: white;
                    padding: 5px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                `
            });

            $heading.parent().append($button);

            $button.on('click', () => {
                log(`Enqueued "${config.label}" (${config.relationshipType})`);
                // push a shallow copy to avoid mutation issues
                queue.push(Object.assign({}, config));
                processQueue().catch(e => console.error(e));
            });
        });

        log("AA: Injected custom buttons.");
    }

    // Start
    $(document).ready(() => {
        // Wait a bit to ensure page ready
        setTimeout(createCustomButtons, 700);
    });

})();
#+end_example


#+begin_example
// ----------------- UI: create buttons -----------------
function createCustomButtons() {
    const $heading = $(HEADING_SELECTOR);

    if ($heading.length === 0) {
        log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
        setTimeout(createCustomButtons, 500);
        return;
    }

    const $container = $('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
    $heading.wrap($container);

    // --- NEW: Keyboard shortcut mapping ---
    const SHORTCUTS = {
        "instruments": "1",
        "vocal": "2",
        "performed / performer": "3"
    };

    // Listen globally for shortcuts (Alt+Number)
    document.addEventListener("keydown", e => {
        if (!e.altKey) return;
        const key = e.key;

        const found = ARTIST_BUTTONS.find(cfg =>
            SHORTCUTS[cfg.relationshipType] === key
        );

        if (found) {
            log(`Keyboard shortcut triggered: Alt+${key} ‚Üí ${found.label}`);
            queue.push(Object.assign({}, found));
            processQueue().catch(e => console.error(e));
        }
    });

    ARTIST_BUTTONS.forEach(config => {

        // Append (i) or (v) or (p) to button label UI
        const suffix = config.relationshipType === 'instruments' ? ' (i)' :
                       config.relationshipType === 'vocal' ? ' (v)' :
                       config.relationshipType === 'performed / performer' ? ' (p)' : '';

        // --- NEW: Icons ---
        const icon = config.relationshipType === 'instruments' ? 'ü•Å ' :
                     config.relationshipType === 'vocal' ? 'üé§ ' :
                     config.relationshipType === 'performed / performer' ? 'üé∂ ' : '';

        // --- NEW: Color coding ---
        const color =
            config.relationshipType === "instruments" ? "#3182ce" :       // blue
            config.relationshipType === "vocal" ? "#d69e2e" :             // yellow/gold
            config.relationshipType === "performed / performer" ? "#805ad5" : "#38a169"; // purple

        // --- NEW: Shortcut label ---
        const shortcut = SHORTCUTS[config.relationshipType]
            ? ` [Alt+${SHORTCUTS[config.relationshipType]}]`
            : "";

        const buttonText = `${icon}${config.label}${suffix}${shortcut}`;

        const $button = $('<button/>', {
            text: buttonText,
            style: `
                margin-left: 10px;
                background-color: ${color};
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                display: inline-flex;
                align-items: center;
            `
        });

        $heading.parent().append($button);

        $button.on('click', () => {
            log(`Enqueued "${config.label}" (${config.relationshipType})`);
            // push a shallow copy to avoid mutation issues
            queue.push(Object.assign({}, config));
            processQueue().catch(e => console.error(e));
        });
    });

    log("AA: Injected custom buttons.");
}
#+end_example

*** This really fixes everything - the first time - <2025-11-29 Sat 21:34>

The issue in the following userscript

#+begin_example
// ==UserScript==
// @name         VZ: MusicBrainz - Batch Add Preconfigured Relationships To Recordings
// @namespace    https://github.com/vzell/mb-userscripts
// @version      2.0+2025-11-29
// @description  Insert buttons on the Release Edit Relationships page which add preconfigured Artists with their Relationship Type (instruments/vocal/performer)
// @author       Gemini & ChatGPT (directed by vzell)
// @tag          AI generated
// @homepageURL  https://github.com/vzell/mb-userscripts
// @supportURL   https://github.com/vzell/mb-userscripts/issues
// @downloadURL  https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @updateURL    https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @icon         https://www.google.com/s2/favicons?sz=64&domain=musicbrainz.org
// @match        https://musicbrainz.org/release/*/edit-relationships
// @grant        none
// @run-at       document-idle
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @license      MIT
// ==/UserScript==

(function() {
    'use strict';

    // *** DEBUGGING FLAGS ***
    const DEBUG = true;
    const DEBUG_VISIBILITY = false;

    // --- CONSTANTS ---
    const LOG_PREFIX = '[add-recording-relations]';
    const STORAGE_KEY = 'mb_batch_add_buttons_config';
    const HEADING_SELECTOR = "h2:contains('Track relationships')";
    const GLOBAL_CHAR_DELAY_MS = 10;
    const GLOBAL_POST_SELECT_WAIT_MS = 150;
    const SMALL_BREATHING_ROOM_MS = 150;
    const VISIBILITY_HEARTBEAT_MS = 500;

    // Define the order for sorting buttons
    const RELATIONSHIP_ORDER = {
        'instruments': 1,
        'vocal': 2,
        'performed / performer': 3,
        'default': 99
    };

    function log(...args) {
        if (DEBUG) console.log(LOG_PREFIX, ...args);
    }

    // --- Sorting Utility ---
    function sortButtons(buttons) {
        // Sorts the passed array in place based on relationship type order
        buttons.sort((a, b) => {
            const orderA = RELATIONSHIP_ORDER[a.relationshipType] || RELATIONSHIP_ORDER['default'];
            const orderB = RELATIONSHIP_ORDER[b.relationshipType] || RELATIONSHIP_ORDER['default'];

            // Secondary sort by label for consistency within groups
            if (orderA === orderB) {
                return a.label.localeCompare(b.label);
            }
            return orderA - orderB;
        });
        return buttons;
    }

    // --- DEFAULT CONFIGURATION ---
    const DEFAULT_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            vocal: "", // Kept here for consistency in the configuration object structure
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            vocal: "",
            creditedAs: ""
        },
        {
            label: "Bruce Springsteen",
            relationshipType: "vocal",
            artist: "Bruce Springsteen",
            instrument: "",
            vocal: "lead vocals",
            creditedAs: ""
        },
        {
            label: "E Street Band",
            relationshipType: "performed / performer",
            artist: "The E Street Band"
        }
    ];

    // --- STATE & PERSISTENCE ---
    let ARTIST_BUTTONS = [];

    // --- CRITICAL: GLOBAL QUEUE AND PROCESSING STATE ---
    const queue = [];
    let processing = false;

    // Helper to provide a full default object structure for merging
    const FULL_DEFAULT_BUTTON = {
        label: 'New Button',
        relationshipType: 'instruments',
        artist: '',
        instrument: '',
        vocal: '',
        creditedAs: '',
    };

    function getInitialButtons() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const parsed = JSON.parse(stored);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    log("Loaded button configuration from localStorage.");
                    const loadedButtons = parsed.map(btn => ({
                        ...FULL_DEFAULT_BUTTON, // Use default to ensure all keys exist
                        ...btn,                // Overwrite with stored values
                        // Ensure all required fields for instruments/vocal are there, even if empty
                        instrument: btn.instrument || '',
                        vocal: btn.vocal || '',
                        creditedAs: btn.creditedAs || '',
                    }));
                    return sortButtons(loadedButtons);
                }
            }
        } catch (e) {
            console.error(LOG_PREFIX, "Error loading buttons from localStorage, using default.", e);
        }
        log("Using default hardcoded button configuration.");
        return sortButtons(DEFAULT_BUTTONS.map(btn => ({...FULL_DEFAULT_BUTTON, ...btn})));
    }

    function saveButtons(buttons) {
        try {
            // 1. Filter out invalid/empty buttons
            const safeButtons = buttons.filter(btn => btn.label && btn.label.trim() !== '' && btn.artist && btn.artist.trim() !== '');

            // 2. Map and clean: only save relevant fields based on relationship type
            const cleanedButtons = safeButtons.map(btn => {
                const clean = {
                    label: btn.label,
                    relationshipType: btn.relationshipType,
                    artist: btn.artist,
                };

                if (btn.relationshipType === 'instruments') {
                    clean.instrument = btn.instrument;
                    clean.creditedAs = btn.creditedAs;
                } else if (btn.relationshipType === 'vocal') {
                    clean.vocal = btn.vocal;
                    clean.creditedAs = btn.creditedAs;
                }
                // For 'performed / performer', instrument, vocal, and creditedAs are omitted.
                return clean;
            });

            const sortedButtons = sortButtons(cleanedButtons);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(sortedButtons));
            log(`Saved ${sortedButtons.length} button configurations to localStorage.`);
            return sortedButtons;
        } catch (e) {
            console.error(LOG_PREFIX, "Error saving buttons to localStorage.", e);
            return buttons;
        }
    }

    // Initialize the buttons
    ARTIST_BUTTONS = getInitialButtons();


    // ----------------- Utilities -----------------
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
    async function waitVisible(selector, opts = {}) {
        const timeout = opts.timeout ?? 5000;
        const interval = opts.interval ?? 50;
        const start = Date.now();
        while (Date.now() - start < timeout) {
            const $el = $(selector).filter(':visible');
            if ($el.length) return $el;
            await sleep(interval);
        }
        return null;
    }
    async function waitDialogClosed(timeout = 2000) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            // Check for both the main modals and the specific config overlays
            const $visibleDialogs = $('.modal, .Dialog, .dialog, .ui-dialog, .ui-widget-overlay, #aa-config-modal-overlay, #aa-add-new-modal-overlay').filter(':visible');
            if ($visibleDialogs.length === 0) {
                await sleep(SMALL_BREATHING_ROOM_MS);
                return true;
            }
            await sleep(50);
        }
        return false;
    }
    async function waitForCondition(conditionFn, {timeout = 3000, interval = 50} = {}) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            try {
                if (await conditionFn()) return true;
            } catch (e) { /* ignore */ }
            await sleep(interval);
        }
        return false;
    }
    function setReactValueAndDispatch(el, value) {
        try {
            const nativeSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
            if (nativeSetter) nativeSetter.call(el, value);
            else el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
            el.dispatchEvent(new InputEvent('input', { bubbles: true }));
        } catch (e) {
            el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }
    function clearInput(el) { setReactValueAndDispatch(el, ''); }
    async function typeAndSelect($input, text, {
        charDelay = GLOBAL_CHAR_DELAY_MS,
        postSelectWait = GLOBAL_POST_SELECT_WAIT_MS,
        optionSelector = "li[role='option']"
    } = {}) {
        const el = $input[0];
        if (!el) throw new Error('Input element missing');
        el.focus();
        clearInput(el);
        await sleep(50);
        for (let i = 0; i < text.length; i++) {
            const ch = text[i];
            const newValue = el.value + ch;
            setReactValueAndDispatch(el, newValue);
            await sleep(charDelay);
        }
        await sleep(100);
        const found = await waitForCondition(() => {
            const $opts = $(optionSelector).filter(':visible');
            if (!$opts.length) return false;
            const match = $opts.toArray().find(o => $(o).text().trim().toLowerCase().startsWith(text.toLowerCase()));
            if (match) { match.click(); return true; }
            const match2 = $opts.toArray().find(o => $(o).text().trim().toLowerCase().includes(text.toLowerCase()));
            if (match2) { match2.click(); return true; }
            return false;
        }, {timeout: 3000, interval: 80});
        if (!found) { log(`Warning: option for "${text}" not found in suggestions after timeout.`); }
        await sleep(postSelectWait);
    }
    async function openBatchAddDialog() {
        await waitDialogClosed(2000);
        const $batch = $("button.add-item.with-label.batch-add-recording-relationship, button.add-item.batch-add-recording-relationship, button.add-item.with-label").filter(function() {
            const t = $(this).text().toLowerCase();
            return t.includes('batch-add') || t.includes('batch add') || (t.includes('add') && t.includes('record'));
        });
        if ($batch.length === 0) { log("Batch-add button not found via selectors"); return false; }
        $batch[0].click();
        const appeared = await waitForCondition(() => {
            const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
            return $d.length > 0;
        }, {timeout: 3000, interval: 80});
        if (!appeared) { await sleep(300); }
        await sleep(SMALL_BREATHING_ROOM_MS);
        return true;
    }
    async function clickDoneAndWaitClose() {
        const $doneButton = await waitVisible('button.positive:visible', {timeout: 4000});
        if ($doneButton) {
            const $exactDone = $doneButton.filter((i, btn) => $(btn).text().trim() === 'Done');
            if ($exactDone.length) {
                log("Clicking Done");
                $exactDone[0].click();
                await waitForCondition(() => {
                    const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
                    return $d.length === 0;
                }, {timeout: 3000, interval: 80});
                await sleep(SMALL_BREATHING_ROOM_MS);
                return true;
            }
        }
        log("Done button not found (when trying to click Done).");
        return false;
    }

    // --- Initial State Cleanup ---
    function resetInitialState() {
        const $allRecordings = $('#tracklist input[type="checkbox"]:not(.work)');
        const $checkedOnLoad = $allRecordings.filter(':checked');

        if ($checkedOnLoad.length > 0) {
            log(`Initial state fix: Found ${$checkedOnLoad.length} checked checkboxes on load. Forcing uncheck with aggressive click simulation.`);

            $checkedOnLoad.each(function() {
                const el = this;
                try {
                    el.dispatchEvent(new MouseEvent('click', { bubbles: true }));
                } catch(e) {
                    $(el).click();
                }
            });

            setTimeout(() => {
                const $stillChecked = $allRecordings.filter(':checked');
                if ($stillChecked.length > 0) {
                    log(`Warning: Aggressive uncheck failed. Still checked: ${$stillChecked.length}`);
                } else {
                    log("Initial state fix successful: 0 checked recordings after cleanup.");
                }
            }, 100);

            return true;
        }
        log("Initial state fix: Found 0 checked checkboxes on load. State is clean.");
        return false;
    }

    // ----------------- Filling sequence -----------------
    async function fillFieldsAsync(config) {
        log(`Start filling for: ${config.label} (${config.relationshipType})`);
        const $relInput = await waitVisible('input.relationship-type', {timeout: 4000});
        if (!$relInput) { log("Relationship type input not found ‚Äî aborting this item."); return false; }
        log(`Typing relationshipType '${config.relationshipType}'`);
        await typeAndSelect($relInput, config.relationshipType);

        const $artist = await waitVisible('input[placeholder="Type to search, or paste an MBID"]', {timeout: 4000});
        if (!$artist) { log("Artist input not found ‚Äî aborting this item."); return false; }
        log(`Typing artist '${config.artist}'`);
        await typeAndSelect($artist, config.artist);

        if (config.relationshipType === 'performed / performer') {
            // This relationship type does not have instrument, vocal, or credited-as fields.
            log("Performed / performer detected ‚Äî skipping attributes and clicking Done.");
            await clickDoneAndWaitClose();
            log(`Finished performer item: ${config.label}`);
            return true;
        }

        const placeholderName = config.relationshipType === 'instruments' ? 'instrument' : 'vocal';

        // Fill Instrument/Vocal
        if (config.relationshipType === 'instruments' || config.relationshipType === 'vocal') {
            const $inst = await waitVisible(`input[placeholder="${placeholderName}"]`, {timeout: 4000});
            if (!$inst) { log(`${placeholderName} input not found ‚Äî aborting this item.`); return false; }
            const desired = (config.relationshipType === 'instruments') ? config.instrument : config.vocal;
            if (desired && desired.length > 0) {
                log(`Typing ${placeholderName} '${desired}'`);
                await typeAndSelect($inst, desired);
            } else {
                log(`No ${placeholderName} value provided, skipping selection.`);
            }
        }

        // Fill Credited As
        const creditedAsValue = config.creditedAs ?? '';

        if (config.relationshipType !== 'performed / performer' && creditedAsValue.length > 0) {
            log("Attempting to fill 'Credited as' field‚Ä¶");
            // Find the visible 'credited as' input, prioritizing the one associated with the relationship type
            let $creditedInput = $("input:visible").filter((i, el) => {
                const cls = (el.className || '').toLowerCase();
                return cls.includes('attribute-credit');
            }).first();

            // Fallback strategy if initial filter is too broad/narrow
            if ($creditedInput.length === 0) {
                 $creditedInput = $("input:visible").filter((i, el) => {
                    const idn = (el.id || '').toLowerCase();
                    const name = (el.name || '').toLowerCase();
                    return idn.includes('credit') || name.includes('credit');
                }).first();
            }

            if ($creditedInput && $creditedInput.length) {
                const el = $creditedInput[0];
                setReactValueAndDispatch(el, creditedAsValue);
                await sleep(100);
                log(`'Credited as' set to "${creditedAsValue}"`);
            } else {
                log("Could not find credited-as input; skipping.");
            }
        } else {
            log("Skipping 'Credited as' filling (either not relevant or no value provided).");
        }

        const doneClicked = await clickDoneAndWaitClose();
        if (doneClicked) {
            log(`Finished item: ${config.label}`);
            return true;
        } else {
            log("Done not clicked (not found) ‚Äî but continuing.");
            return true;
        }
    }


    // ----------------- Queue Processing -----------------

    async function processQueue() {
        if (processing) return;
        processing = true;
        while (queue.length) {
            const config = queue.shift();
            try {
                log(`Processing queue item: ${config.label}`);
                const opened = await openBatchAddDialog();
                if (!opened) {
                    log("Could not open batch-add dialog ‚Äî skipping this item.");
                    await sleep(SMALL_BREATHING_ROOM_MS);
                    continue;
                }
                await fillFieldsAsync(config);
                await sleep(200);
            } catch (e) {
                console.error(LOG_PREFIX, "Error processing item", e);
                await sleep(500);
            }
        }
        processing = false;
        log("Batch processing queue finished.");
    }


    // ----------------- Modal UI -----------------

    // Function to dynamically show/hide fields based on relationship type
    function updateFieldVisibility($item) {
        const type = $item.find('select[name="relationshipType"]').val();

        // Hide all dynamic fields first
        $item.find('.instrument-field').hide();
        $item.find('.vocal-field').hide();
        $item.find('.creditedAs-field').show(); // Default to visible

        if (type === 'instruments') {
            $item.find('.instrument-field').show();
        } else if (type === 'vocal') {
            $item.find('.vocal-field').show();
        } else if (type === 'performed / performer') {
            // Hide all attribute fields for this type
            $item.find('.creditedAs-field').hide();
        }
    }

    function showAddButtonModal(saveCallback) {
        // Ensure only one modal is present
        $('#aa-add-new-modal-overlay').remove();

        const MODAL_STYLE = `
            #aa-add-new-modal-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.75); z-index: 10000; /* Higher Z-index than main config modal */
                display: flex; justify-content: center; align-items: center;
            }
            #aa-add-new-modal {
                background: white; padding: 20px; border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); max-width: 500px;
                width: 90%;
                font-family: Arial, sans-serif; color: #333;
            }
            #aa-add-new-modal h4 { margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
            #aa-add-new-modal label { display: block; margin-top: 8px; font-weight: bold; font-size: 0.9em; }
            #aa-add-new-modal input, #aa-add-new-modal select {
                width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box;
                border: 1px solid #ccc; border-radius: 4px;
            }
            .aa-add-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
            .aa-add-footer button { padding: 8px 15px; cursor: pointer; border-radius: 4px; border: none; }
            .aa-add-save-btn { background-color: #4CAF50; color: white; }
            .aa-add-cancel-btn { background-color: #ccc; color: #333; }
        `;

        // Add the new style block
        if ($('#aa-add-new-modal-style').length === 0) {
             $('head').append(`<style id="aa-add-new-modal-style">${MODAL_STYLE}</style>`);
        }

        const $overlay = $('<div id="aa-add-new-modal-overlay">');
        const $modal = $('<div id="aa-add-new-modal">');

        $modal.html(`
            <h4>Add New Button Configuration</h4>
            <div id="aa-add-form">
                <label>Label (Button Text): <input type="text" name="label" value="" placeholder="E.g., Max Weinberg"></label>

                <label>Relationship Type:
                    <select name="relationshipType">
                        <option value="instruments">instruments</option>
                        <option value="vocal">vocal</option>
                        <option value="performed / performer">performed / performer</option>
                    </select>
                </label>
                <label>Artist Name: <input type="text" name="artist" value="" placeholder="E.g., Max Weinberg (required)"></label>

                <!-- DYNAMIC FIELDS -->
                <label class="instrument-field">Instrument (if type='instruments'): <input type="text" name="instrument" value="" placeholder="E.g., drums (drum set)"></label>
                <label class="vocal-field">Vocal (if type='vocal'): <input type="text" name="vocal" value="" placeholder="E.g., lead vocals"></label>
                <label class="creditedAs-field">Credited As: <input type="text" name="creditedAs" value="" placeholder="E.g., drums"></label>
            </div>
            <div class="aa-add-footer">
                <button class="aa-add-cancel-btn">Cancel</button>
                <button class="aa-add-save-btn">Add Button</button>
            </div>
        `);

        const $form = $modal.find('#aa-add-form');
        const $select = $form.find(`select[name="relationshipType"]`);
        const $labelInput = $form.find('input[name="label"]');
        const $artistInput = $form.find('input[name="artist"]');

        let artistEditedManually = false;

        // 1. Artist Sync Logic
        $artistInput.on('input', () => {
            // Once the user types anything in the artist field, disable syncing
            artistEditedManually = true;
        });

        $labelInput.on('input', function() {
            if (!artistEditedManually) {
                // Only sync if the artist field hasn't been manually touched
                $artistInput.val($(this).val());
            }
        });

        // 2. Field Visibility Logic
        const updateAddModalVisibility = () => {
             // Use the same logic as the main modal updateFieldVisibility
             const type = $select.val();
             $form.find('.instrument-field').hide();
             $form.find('.vocal-field').hide();
             $form.find('.creditedAs-field').show();

             if (type === 'instruments') {
                 $form.find('.instrument-field').show();
             } else if (type === 'vocal') {
                 $form.find('.vocal-field').show();
             } else if (type === 'performed / performer') {
                 $form.find('.creditedAs-field').hide();
             }
        };

        // Initial visibility
        updateAddModalVisibility();

        // Add change listener for dynamic visibility
        $select.on('change', updateAddModalVisibility);

        const cleanupAndClose = () => {
            $(document).off('keydown', escapeHandler);
            $overlay.remove();
        }

        $modal.on('click', '.aa-add-cancel-btn', cleanupAndClose);

        $modal.on('click', '.aa-add-save-btn', function() {
            const newButton = {
                label: $labelInput.val().trim(),
                relationshipType: $select.val(),
                artist: $artistInput.val().trim(),
                instrument: $form.find('input[name="instrument"]').val().trim(),
                vocal: $form.find('input[name="vocal"]').val().trim(),
                creditedAs: $form.find('input[name="creditedAs"]').val().trim(),
            };

            if (!newButton.label || !newButton.artist) {
                // Using alert() here as it is inside a custom modal flow and should be seen
                alert("Both Label and Artist Name are required to add a new button.");
                return;
            }

            saveCallback(newButton);
            cleanupAndClose();
        });

        // Escape Key Handler
        const escapeHandler = function(e) {
            const isInput = $(e.target).is('input, select, textarea');
            if (e.key === 'Escape' && !isInput) {
                e.preventDefault();
                e.stopPropagation();
                cleanupAndClose();
            }
        };

        $(document).on('keydown', escapeHandler);

        $overlay.append($modal);
        $('body').append($overlay);
    }

    function showConfigModal() {
        // Ensure only one modal is present
        $('#aa-config-modal-overlay').remove();

        // Deep clone the current buttons for local manipulation
        // Note: currentButtons will be dynamically replaced by getCurrentConfigFromForm(true)
        // when changes occur in the DOM, making it match the current view.
        let currentButtons = ARTIST_BUTTONS.map(a => Object.assign({}, a));

        // Capture the initial state string (must be sorted for a reliable comparison)
        const initialConfigString = JSON.stringify(sortButtons(currentButtons.map(a => Object.assign({}, a))));

        const MODAL_STYLE = `
            #aa-config-modal-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.75); z-index: 9999;
                display: flex; justify-content: center; align-items: center;
            }
            #aa-config-modal {
                background: white; padding: 20px; border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); max-width: 800px;
                width: 90%; max-height: 90%;
                font-family: Arial, sans-serif; color: #333;
                display: flex; /* Flex container for scrollable content + fixed footer */
                flex-direction: column;
            }
            #aa-config-modal h3 { margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px; flex-shrink: 0; }

            #aa-config-scroll-area {
                overflow-y: auto; /* Scrollable content area */
                flex-grow: 1;
                padding-right: 5px; /* Add slight padding for scrollbar visibility */
            }

            .aa-config-item {
                border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 6px;
                background-color: #f9f9f9;
            }
            .aa-config-item h4 { margin: 0 0 10px 0; display: flex; justify-content: space-between; align-items: center; }
            .aa-config-item label { display: block; margin-top: 8px; font-weight: bold; font-size: 0.9em; }
            .aa-config-item input, .aa-config-item select {
                width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box;
                border: 1px solid #ccc; border-radius: 4px;
            }
            /* FIXED FOOTER STYLE */
            .aa-config-footer {
                display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px;
                border-top: 1px solid #ccc;
                flex-shrink: 0;
            }
            .aa-config-footer button {
                padding: 8px 15px; cursor: pointer; border-radius: 4px; border: none;
                font-weight: bold;
            }
            .aa-remove-btn { background-color: #f44336; color: white; border: none; padding: 4px 8px; font-size: 0.8em; cursor: pointer; }
            .aa-add-btn, .aa-save-btn { /* Apply cursor to Add New button */
                cursor: pointer;
            }
            .aa-add-btn { background-color: #007bff; color: white; border: none; }
            .aa-save-btn { background-color: #4CAF50; color: white; border: none; }
            .aa-close-btn { background-color: #ccc; color: #333; border: none; cursor: pointer; }
        `;

        // Apply styles
        if ($('#aa-config-modal-style').length === 0) {
             $('head').append(`<style id="aa-config-modal-style">${MODAL_STYLE}</style>`);
        }


        const $overlay = $('<div id="aa-config-modal-overlay">');
        const $modal = $('<div id="aa-config-modal">');
        $modal.html('<h3>Batch Relationship Button Configuration</h3><div id="aa-config-scroll-area"><div id="aa-config-form"></div></div>');

        const $scrollArea = $modal.find('#aa-config-scroll-area');
        const $formContainer = $modal.find('#aa-config-form');

        const renderForm = (buttons) => {
            $formContainer.empty();
            // Important: Render the *sorted* array
            buttons.forEach((config, index) => {
                const $item = $(`<div class="aa-config-item" data-index="${index}">`);

                // Use default values if keys are missing (e.g., in a cleaned 'performed / performer' object)
                const safeConfig = {...FULL_DEFAULT_BUTTON, ...config};

                // Build the item structure
                $item.append(`
                    <h4>
                        Button ${index + 1}: ${safeConfig.label}
                        <button class="aa-remove-btn">Remove</button>
                    </h4>
                    <label>Label (Button Text): <input type="text" name="label" value="${safeConfig.label || ''}" placeholder="E.g., Max Weinberg"></label>

                    <label>Relationship Type:
                        <select name="relationshipType">
                            <option value="instruments">instruments</option>
                            <option value="vocal">vocal</option>
                            <option value="performed / performer">performed / performer</option>
                        </select>
                    </label>
                    <label>Artist Name: <input type="text" name="artist" value="${safeConfig.artist || ''}" placeholder="E.g., Max Weinberg (required)"></label>

                    <!-- DYNAMIC FIELDS -->
                    <label class="instrument-field">Instrument (if type='instruments'): <input type="text" name="instrument" value="${safeConfig.instrument || ''}" placeholder="E.g., drums (drum set)"></label>
                    <label class="vocal-field">Vocal (if type='vocal'): <input type="text" name="vocal" value="${safeConfig.vocal || ''}" placeholder="E.g., lead vocals"></label>

                    <label class="creditedAs-field">Credited As: <input type="text" name="creditedAs" value="${safeConfig.creditedAs || ''}" placeholder="E.g., drums"></label>
                `);

                // Set selected value for relationshipType
                const $select = $item.find(`select[name="relationshipType"]`);
                $select.val(safeConfig.relationshipType);

                // Initial visibility update
                updateFieldVisibility($item);

                // Add change listener for dynamic visibility
                $select.on('change', function() {
                    updateFieldVisibility($item);
                });

                // Add change listener to all inputs to update the local currentButtons array instantly
                $item.find('input, select').on('change keyup', function() {
                    const fieldName = $(this).attr('name');
                    const value = $(this).val();
                    const $currentItem = $(this).closest('.aa-config-item');
                    const index = $currentItem.data('index');

                    // Update the label in the h4 for instant feedback
                    if (fieldName === 'label') {
                        $currentItem.find('h4').html(`Button ${index + 1}: ${value}<button class="aa-remove-btn">Remove</button>`);
                    }

                    // Update the local array by reading the current DOM state (sorted)
                    // This ensures currentButtons always matches the visible form for accurate removal/saving
                    currentButtons = getCurrentConfigFromForm(true);
                });


                $formContainer.append($item);
            });
        };

        // Utility to extract current form state (used for comparison)
        function getCurrentConfigFromForm(onlyReadDom = false) {
            if (onlyReadDom) {
                const currentConfig = [];
                $formContainer.find('.aa-config-item').each(function() {
                    currentConfig.push({
                        label: $(this).find('input[name="label"]').val().trim(),
                        relationshipType: $(this).find('select[name="relationshipType"]').val(),
                        artist: $(this).find('input[name="artist"]').val().trim(),
                        instrument: $(this).find('input[name="instrument"]').val().trim(),
                        vocal: $(this).find('input[name="vocal"]').val().trim(),
                        creditedAs: $(this).find('input[name="creditedAs"]').val().trim(),
                    });
                });
                return sortButtons(currentConfig);
            }
            // Fallback: use the in-memory array
            return sortButtons(currentButtons.map(a => Object.assign({}, a)));
        }

        // Initial render
        renderForm(currentButtons);

        // --- Event Handlers ---

        // Cleanup function for modal closure
        const cleanupAndClose = () => {
            $(document).off('keydown', escapeHandler);
            $('#aa-add-new-modal-overlay').remove(); // Ensure add modal is also closed
            $overlay.remove();
        }

        // Add New Button Handler
        const handleAddNewButton = () => {
             // Open the dedicated small modal
             showAddButtonModal((newButton) => {
                // Callback function when the new button is saved in the sub-modal

                // 1. Read the current DOM state to ensure we capture any pending edits
                const currentDomConfig = getCurrentConfigFromForm(true);

                // 2. Add the new button
                currentDomConfig.push(newButton);
                currentButtons = sortButtons(currentDomConfig); // Update local array

                // 3. Re-render the main form with the new, sorted button list
                renderForm(currentButtons);

                // 4. Scroll to the bottom to see the newly added button (which is now in its sorted position)
                $scrollArea.scrollTop($scrollArea[0].scrollHeight);
             });
        };


        // Remove Button (FIXED: Uses index for unique removal)
        $modal.on('click', '.aa-remove-btn', function() {
            const $item = $(this).closest('.aa-config-item');

            // Read the current state of the buttons from the form (guaranteed to match the visible list)
            const domConfig = getCurrentConfigFromForm(true);
            const indexToRemove = $item.data('index'); // This index is based on the *sorted* array shown on screen

            if (domConfig.length > 1) {

                // Remove the item at the specific index using splice
                domConfig.splice(indexToRemove, 1);

                // Update currentButtons and ensure it is sorted
                currentButtons = sortButtons(domConfig);

                renderForm(currentButtons);

            } else {
                console.warn(LOG_PREFIX, "User tried to remove the last button. Must keep at least one.");
                alert("You must keep at least one button configuration.");
            }
        });

        // Save Button
        const saveAndClose = () => {
            const newConfig = [];
            let valid = true;

            $formContainer.find('.aa-config-item').each(function() {
                const $item = $(this);
                const label = $item.find('input[name="label"]').val().trim();
                const artist = $item.find('input[name="artist"]').val().trim();

                if (!label || !artist) {
                    // Using alert() here as it is inside a custom modal flow and should be seen
                    alert(`Button configuration requires both a Label and an Artist Name. Please check item ${$item.data('index') + 1}.`);
                    valid = false;
                    return false; // Stop .each loop
                }

                newConfig.push({
                    label: label,
                    relationshipType: $item.find('select[name="relationshipType"]').val(),
                    artist: artist,
                    instrument: $item.find('input[name="instrument"]').val().trim(),
                    vocal: $item.find('input[name="vocal"]').val().trim(),
                    creditedAs: $item.find('input[name="creditedAs"]').val().trim(),
                });
            });

            if (valid) {
                // Save and sort the new configuration (saveButtons will handle stripping unnecessary fields)
                ARTIST_BUTTONS = saveButtons(newConfig);
                renderButtons(ARTIST_BUTTONS); // Re-render the batch buttons on the main page
                cleanupAndClose();
                log("Configuration saved and buttons updated.");
            }
        };

        // Escape Key Handler
        const escapeHandler = function(e) {
            // Check if the event target is inside an input field, which might be handling Esc for something else
            const isInput = $(e.target).is('input, select, textarea');
            if (e.key === 'Escape' && !isInput) {
                e.preventDefault();
                e.stopPropagation();

                const finalConfig = getCurrentConfigFromForm(true); // Read current state from DOM
                const finalConfigString = JSON.stringify(finalConfig);

                if (finalConfigString === initialConfigString) {
                    // No changes, close safely
                    cleanupAndClose();
                    log("Configuration modal closed with Esc key (no changes).");
                } else {
                    // Changes made, prompt user
                    const response = window.confirm("You have unsaved changes. Press OK to discard changes and close, or Cancel to return and Save.");
                    if (response) {
                        cleanupAndClose();
                        log("Configuration modal closed with Esc key (changes discarded).");
                    }
                }
            }
        };

        // Attach event listeners
        $(document).on('keydown', escapeHandler);

        // Footer (Fixed position achieved by putting it outside the scroll area)
        const $footer = $(`
            <div class="aa-config-footer">
                <button class="aa-close-btn">Close</button>
                <div>
                    <button class="aa-add-btn">Add New Button</button>
                    <button class="aa-save-btn">Save & Reload Buttons</button>
                </div>
            </div>
        `);

        $modal.append($footer);

        $modal.on('click', '.aa-close-btn', cleanupAndClose);
        $modal.on('click', '.aa-save-btn', saveAndClose);
        $modal.on('click', '.aa-add-btn', handleAddNewButton);

        $overlay.append($modal);
        $('body').append($overlay);
    }

    // ----------------- UI: Button Rendering and Creation -----------------

    const BUTTON_STYLE_CONFIG = {
        'instruments': { bgColor: '#4CAF50', activeColor: '#3e8e41', icon: 'üé∏ ' },
        'vocal': { bgColor: '#2196F3', activeColor: '#0b7dda', icon: 'üé§ ' },
        'performed / performer': { bgColor: '#FF9800', activeColor: '#e68a00', icon: 'üé≠ ' },
        'default': { bgColor: '#607D8B', activeColor: '#455a64', icon: 'üîó ' }
    };

    function renderButtons(buttons) {
        const $mainContainer = $('.injected-buttons-container');
        if ($mainContainer.length === 0) return;

        let $batchButtonContainer = $mainContainer.find('#aa-batch-buttons');
        if ($batchButtonContainer.length === 0) {
            $batchButtonContainer = $('<div id="aa-batch-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>');
            $mainContainer.append($batchButtonContainer);
        }

        $batchButtonContainer.empty();

        buttons.forEach(config => {
            const style = BUTTON_STYLE_CONFIG[config.relationshipType] || BUTTON_STYLE_CONFIG['default'];
            const buttonText = `${style.icon}${config.label}`;

            const buttonStyleString = `
                background-color: ${style.bgColor};
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.15s ease-in-out;
                white-space: nowrap;
                flex-shrink: 0;
                line-height: 20px;
            `;

            const $button = $('<button/>', {
                text: buttonText,
                'data-label': config.label
            });

            $button.attr('style', buttonStyleString);

            $button.on({
                'mouseenter': function() { $(this).css('opacity', 0.9); },
                'mouseleave': function() { $(this).css('opacity', 1); },
                'click': function() {
                    $(this).css('background-color', style.activeColor);
                    setTimeout(() => $(this).css('background-color', style.bgColor), 500);
                }
            });

            $batchButtonContainer.append($button);

            $button.on('click', () => {
                log(`Enqueued "${config.label}" (${config.relationshipType})`);
                queue.push(Object.assign({}, config));
                processQueue().catch(e => console.error(e));
            });
        });
    }

    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        let $container = $heading.next('.injected-buttons-container');
        if ($container.length === 0) {
            $container = $(`
                <div
                    class="injected-buttons-container"
                    style="
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        flex-wrap: wrap;
                        margin-top: 10px;
                        margin-bottom: 5px;
                        padding: 10px 0;
                        width: 100%;
                        z-index: 1000;
                    ">
                </div>
            `);
            $heading.after($container);
        } else {
             $container.find('#aa-batch-buttons').remove();
        }

        // --- 1. Create and prepend the permanent 'Configure' button with 2-line text ---
        const $configButton = $container.find('#aa-config-btn');
        if ($configButton.length === 0) {
            const configButtonStyle = `
                background-color: #607D8B;
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.15s ease-in-out;
                flex-shrink: 0;
                line-height: 1.2;
            `;

            // Updated text: "Configure recording\nrelation buttons"
            const buttonHtml = '‚öôÔ∏è Configure recording<br>relation buttons';

            const $config = $('<button/>', {
                id: 'aa-config-btn',
                html: buttonHtml
            });

            $config.attr('style', configButtonStyle);
            $container.prepend($config);
            $config.on('click', showConfigModal);
        }

        // --- 2. Render the dynamic batch-add buttons ---
        renderButtons(ARTIST_BUTTONS);


        // --- 3. VISIBILITY LOGIC ---

        function getCheckedRecordings() {
            const $checkedRecordings = $('#tracklist input[type="checkbox"]:not(.work)');
            return $checkedRecordings;
        }

        function updateButtonVisibility() {
            try {
                if (DEBUG_VISIBILITY) log("Update visibility check called.");

                const $checked = getCheckedRecordings();
                const checkedCount = $checked.length;
                const anyChecked = checkedCount > 0;

                const $batchContainer = $container.find('#aa-batch-buttons');
                if ($batchContainer.length === 0) return;

                const currentDisplay = $batchContainer.css('display');

                if (currentDisplay === 'flex' && checkedCount === 0) {
                     if (DEBUG) log("Batch buttons visible, but 0 tracks checked. Forcing OFF.");
                     $batchContainer.css('display', 'none');
                     return;
                }

                if (anyChecked) {
                    if (currentDisplay === 'none') {
                        $batchContainer.css('display', 'flex');
                        if (DEBUG) log("Toggled batch buttons ON (display: flex)");
                    }
                } else {
                    if (currentDisplay === 'flex') {
                        $batchContainer.css('display', 'none');
                        if (DEBUG) log("Toggled batch buttons OFF (display: none)");
                    }
                }
            } catch (e) {
                console.error(LOG_PREFIX, "Error in updateButtonVisibility loop:", e);
            }
        }

        updateButtonVisibility();

        $('#tracklist').on('change click input', 'input[type="checkbox"]', function() {
             try {
                 if (DEBUG) log("Checkbox event detected, updating visibility...");
                 // Use setTimeout to ensure the DOM state is settled after the click/change
                 setTimeout(updateButtonVisibility, 50);
             } catch (e) {
                console.error(LOG_PREFIX, "Error in checkbox event handler:", e);
             }
        });

        // Set up the heartbeat check
        setInterval(updateButtonVisibility, VISIBILITY_HEARTBEAT_MS);

        log("Injected custom buttons and configuration.");
    }

    // ----------------- Main Execution -----------------

    try {
        setTimeout(() => {
            log("Starting userscript execution...");
            resetInitialState();
            createCustomButtons();
        }, 2000);
    } catch (error) {
        // This catch block primarily catches sync errors during the setting of the timeout.
        console.error(LOG_PREFIX, "CRITICAL SCRIPT FAILURE during initial setup:", error);
    }

})();
#+end_example

The issue in the uploaded userscript is that both the configuration button and the action buttons are being added to the same container, and the visibility
logic is applied to the entire container.

Please achieve the following desired behavior:

Configuration Button: Always visible.

Action Buttons: Visibility controlled by recording checkboxes.

You need to create two separate containers inside the main $batchContainer: one for the configuration button (which will
always be visible) and one for the action buttons (which will be toggled).

PLEASE DO NOT TOUCH the rest of the code logic which is responsible for adding data into the modul "Add relationship" dialog with the actin buttons

#+begin_example
function createCustomButtons() {
    const $heading = $(HEADING_SELECTOR);

    if ($heading.length === 0) {
        log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
        setTimeout(createCustomButtons, 500);
        return;
    }

    // --- MAIN WRAPPER (unchanged, but now holds two sub-containers) ---
    let $container = $heading.next('.injected-buttons-container');
    if ($container.length === 0) {
        $container = $(`
            <div class="injected-buttons-container"
                 style="display:flex; flex-direction:column; gap:8px;
                        margin-top:10px; margin-bottom:5px; width:100%;">
            </div>
        `);
        $heading.after($container);
    }

    // -------------------------------
    // 1) CONFIG BUTTON CONTAINER (ALWAYS VISIBLE)
    // -------------------------------
    let $configContainer = $container.find('#aa-config-container');
    if ($configContainer.length === 0) {
        $configContainer = $(`
            <div id="aa-config-container" style="display:flex; gap:10px; flex-wrap:wrap;">
            </div>
        `);
        $container.append($configContainer);
    }

    // Add config button if missing
    let $configButton = $configContainer.find('#aa-config-btn');
    if ($configButton.length === 0) {
        const configButtonStyle = `
            background-color:#607D8B; color:white;
            padding:5px 10px; border:none; border-radius:4px;
            cursor:pointer; font-weight:bold; line-height:1.2; flex-shrink:0;
        `;

        $configButton = $('<button/>', {
            id: 'aa-config-btn',
            html: '‚öôÔ∏è Configure recording<br>relation buttons'
        });

        $configButton.attr('style', configButtonStyle);
        $configButton.on('click', showConfigModal);
        $configContainer.append($configButton);
    }

    // -------------------------------
    // 2) ACTION BUTTON CONTAINER (VISIBILITY CONTROLLED)
    // -------------------------------
    let $actionContainer = $container.find('#aa-action-buttons-container');
    if ($actionContainer.length === 0) {
        $actionContainer = $(`
            <div id="aa-action-buttons-container" style="display:none;">
                <div id="aa-batch-buttons"
                     style="display:flex; gap:10px; flex-wrap:wrap;">
                </div>
            </div>
        `);
        $container.append($actionContainer);
    }

    const $batchButtonContainer = $actionContainer.find('#aa-batch-buttons');
    $batchButtonContainer.empty();

    // Render all dynamic action buttons into this new container
    renderButtons(ARTIST_BUTTONS);

    // -------------------------------
    // Visibility logic (unchanged, except new container)
    // -------------------------------
    function getCheckedRecordings() {
        return $('#tracklist input[type="checkbox"]:not(.work)');
    }

    function updateButtonVisibility() {
        const $checked = getCheckedRecordings().filter(':checked');
        const anyChecked = $checked.length > 0;

        if (anyChecked) {
            $actionContainer.show();
        } else {
            $actionContainer.hide();
        }
    }

    updateButtonVisibility();

    $('#tracklist').on('change click input', 'input[type="checkbox"]', () => {
        setTimeout(updateButtonVisibility, 50);
    });

    setInterval(updateButtonVisibility, VISIBILITY_HEARTBEAT_MS);

    log("Injected custom buttons using separated containers.");
}
#+end_example

*** add support for choosing artist first in the pull downlist

In the current implementation of the uploaded userscript file is one piece missing.  When executing one of the
configured button actions (by pressing one of the artist labeld buttons) in the popup modal dialog it is expected that
"Artist" (<option value="artist">Artist</option>) is preselected in the "Related type" pull down list (that's true if
the page initial page is first entered):

#+begin_example
  <table class="relationship-details">
    <tbody>
      <tr>
	<td class="required section">Recording
	</td>
	<td class="fields">(31 recordings selected)
	</td>
      </tr>
      <tr>
	<td class="required section">Related type
	</td>
	<td class="fields">
	  <select class="entity-type">
	    <option value="area">Area
	    </option>
	    <option value="artist">Artist
	    </option>
	    <option value="event">Event
	    </option>
	    <option value="label">Label
	    </option>
	    <option value="place">Place
	    </option>
	    <option value="recording">Recording
	    </option>
	    <option value="release">Release
	    </option>
	    <option value="series">Series
	    </option>
	    <option value="work">Work
	    </option>
	  </select>
	</td>
      </tr>
    </tbody>
  </table>
#+end_example

So our current code directly emulates typing in the text for the "Relationship type" text field (which is React based
and uses suggested completion from the backend).

But when the user in a session manually changed the "Related type" to something different (for example "Place"), the
next time when the user presses one of our preconfigured buttons, they are executing in the wrong context ("Place"
instead of "Artist" in this example).

So please implement the following enhancement to this userscript:

Before entering relationship data, always make sure that "Artist" ist first selected from the "Related type" pulldown
list (even the very first time).

Also PLEASE do NOT change anything else in the current logic as it works perfectly. Just add the functionality before the line which says "        log(`Start filling for: ${config.label} (${config.relationshipType})`);"

#+begin_example
async function fillFieldsAsync(config) {
        // <add functionality here to make sure "Artist" is selected from the "Related type" pulldown list>
        log(`Start filling for: ${config.label} (${config.relationshipType})`);
#+end_example

#+begin_example
// ----------------- Filling sequence -----------------
async function fillFieldsAsync(config) {
    // --- START OF NEW FUNCTIONALITY ---

    // 1. Wait for the 'Related type' select element to be visible
    const $relatedTypeSelect = await waitVisible('select.entity-type:visible', {timeout: 3000});

    if ($relatedTypeSelect) {
        const el = $relatedTypeSelect[0];
        const desiredValue = 'artist';

        // 2. Check if the correct value is already selected
        if ($relatedTypeSelect.val() !== desiredValue) {
            log(`Changing 'Related type' from '${$relatedTypeSelect.val()}' to 'artist'`);

            // 3. Set the value and dispatch events
            setReactValueAndDispatch(el, desiredValue);

            // Give the application a moment to react to the entity-type change
            await sleep(SMALL_BREATHING_ROOM_MS);

        } else {
            log("'Related type' is already set to 'artist', skipping change.");
        }
    } else {
        log("Warning: 'Related type' select element not found. Continuing, but this might fail.");
    }

    // --- END OF NEW FUNCTIONALITY ---
    log(`Start filling for: ${config.label} (${config.relationshipType})`);
    const $relInput = await waitVisible('input.relationship-type', {timeout: 4000});
    if (!$relInput) { log("Relationship type input not found ‚Äî aborting this item."); return false; }
    log(`Typing relationshipType '${config.relationshipType}'`);
    await typeAndSelect($relInput, config.relationshipType);

    const $artist = await waitVisible('input[placeholder="Type to search, or paste an MBID"]', {timeout: 4000});
    if (!$artist) { log("Artist input not found ‚Äî aborting this item."); return false; }
    log(`Typing artist '${config.artist}'`);
    await typeAndSelect($artist, config.artist);

    if (config.relationshipType === 'performed / performer') {
        // This relationship type does not have instrument, vocal, or credited-as fields.
        log("Performed / performer detected ‚Äî skipping attributes and clicking Done.");
        await clickDoneAndWaitClose();
        log(`Finished performer item: ${config.label}`);
        return true;
    }

    const placeholderName = config.relationshipType === 'instruments' ? 'instrument' : 'vocal';

    // Fill Instrument/Vocal
    if (config.relationshipType === 'instruments' || config.relationshipType === 'vocal') {
        const $inst = await waitVisible(`input[placeholder="${placeholderName}"]`, {timeout: 4000});
        if (!$inst) { log(`${placeholderName} input not found ‚Äî aborting this item.`); return false; }
        const desired = (config.relationshipType === 'instruments') ? config.instrument : config.vocal;
        if (desired && desired.length > 0) {
            log(`Typing ${placeholderName} '${desired}'`);
            await typeAndSelect($inst, desired);
        } else {
            log(`No ${placeholderName} value provided, skipping selection.`);
        }
    }

    // Fill Credited As
    const creditedAsValue = config.creditedAs ?? '';

    if (config.relationshipType !== 'performed / performer' && creditedAsValue.length > 0) {
        log("Attempting to fill 'Credited as' field‚Ä¶");
        // Find the visible 'credited as' input, prioritizing the one associated with the relationship type
        let $creditedInput = $("input:visible").filter((i, el) => {
            const cls = (el.className || '').toLowerCase();
            return cls.includes('attribute-credit');
        }).first();

        // Fallback strategy if initial filter is too broad/narrow
        if ($creditedInput.length === 0) {
             $creditedInput = $("input:visible").filter((i, el) => {
                const idn = (el.id || '').toLowerCase();
                const name = (el.name || '').toLowerCase();
                return idn.includes('credit') || name.includes('credit');
            }).first();
        }

        if ($creditedInput && $creditedInput.length) {
            const el = $creditedInput[0];
            setReactValueAndDispatch(el, creditedAsValue);
            await sleep(100);
            log(`'Credited as' set to "${creditedAsValue}"`);
        } else {
            log("Could not find credited-as input; skipping.");
        }
    } else {
        log("Skipping 'Credited as' filling (either not relevant or no value provided).");
    }

    const doneClicked = await clickDoneAndWaitClose();
    if (doneClicked) {
        log(`Finished item: ${config.label}`);
        return true;
    } else {
        log("Done not clicked (not found) ‚Äî but continuing.");
        return true;
    }
}
#+end_example

#+begin_example
// ==UserScript==
// @name         VZ: MusicBrainz - Batch Add Preconfigured Relationships To Recordings
// @namespace    https://github.com/vzell/mb-userscripts
// @version      2.0+2025-11-29
// @description  Insert buttons on the Release Edit Relationships page which add preconfigured Artists with their Relationship Type (instruments/vocal/performer)
// @author       Gemini & ChatGPT (directed by vzell)
// @tag          AI generated
// @homepageURL  https://github.com/vzell/mb-userscripts
// @supportURL   https://github.com/vzell/mb-userscripts/issues
// @downloadURL  https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @updateURL    https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @icon         https://www.google.com/s2/favicons?sz=64&domain=musicbrainz.org
// @match        https://musicbrainz.org/release/*/edit-relationships
// @grant        none
// @run-at       document-idle
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @license      MIT
// ==/UserScript==

(function() {
    'use strict';

    // *** DEBUGGING FLAGS ***
    const DEBUG = true;
    const DEBUG_VISIBILITY = false;

    // --- CONSTANTS ---
    const LOG_PREFIX = '[add-recording-relations]';
    const STORAGE_KEY = 'mb_batch_add_buttons_config';
    const HEADING_SELECTOR = "h2:contains('Track relationships')";
    const GLOBAL_CHAR_DELAY_MS = 10;
    const GLOBAL_POST_SELECT_WAIT_MS = 150;
    const SMALL_BREATHING_ROOM_MS = 150;
    const VISIBILITY_HEARTBEAT_MS = 500;

    // Define the order for sorting buttons
    const RELATIONSHIP_ORDER = {
        'instruments': 1,
        'vocal': 2,
        'performed / performer': 3,
        'default': 99
    };

    function log(...args) {
        if (DEBUG) console.log(LOG_PREFIX, ...args);
    }

    // --- Sorting Utility ---
    function sortButtons(buttons) {
        // Sorts the passed array in place based on relationship type order
        buttons.sort((a, b) => {
            const orderA = RELATIONSHIP_ORDER[a.relationshipType] || RELATIONSHIP_ORDER['default'];
            const orderB = RELATIONSHIP_ORDER[b.relationshipType] || RELATIONSHIP_ORDER['default'];

            // Secondary sort by label for consistency within groups
            if (orderA === orderB) {
                return a.label.localeCompare(b.label);
            }
            return orderA - orderB;
        });
        return buttons;
    }

    // --- DEFAULT CONFIGURATION ---
    const DEFAULT_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            vocal: "", // Kept here for consistency in the configuration object structure
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            vocal: "",
            creditedAs: ""
        },
        {
            label: "Bruce Springsteen",
            relationshipType: "vocal",
            artist: "Bruce Springsteen",
            instrument: "",
            vocal: "lead vocals",
            creditedAs: ""
        },
        {
            label: "E Street Band",
            relationshipType: "performed / performer",
            artist: "The E Street Band"
        }
    ];

    // --- STATE & PERSISTENCE ---
    let ARTIST_BUTTONS = [];

    // --- CRITICAL: GLOBAL QUEUE AND PROCESSING STATE ---
    const queue = [];
    let processing = false;

    // Helper to provide a full default object structure for merging
    const FULL_DEFAULT_BUTTON = {
        label: 'New Button',
        relationshipType: 'instruments',
        artist: '',
        instrument: '',
        vocal: '',
        creditedAs: '',
    };

    function getInitialButtons() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const parsed = JSON.parse(stored);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    log("Loaded button configuration from localStorage.");
                    const loadedButtons = parsed.map(btn => ({
                        ...FULL_DEFAULT_BUTTON, // Use default to ensure all keys exist
                        ...btn,                // Overwrite with stored values
                        // Ensure all required fields for instruments/vocal are there, even if empty
                        instrument: btn.instrument || '',
                        vocal: btn.vocal || '',
                        creditedAs: btn.creditedAs || '',
                    }));
                    return sortButtons(loadedButtons);
                }
            }
        } catch (e) {
            console.error(LOG_PREFIX, "Error loading buttons from localStorage, using default.", e);
        }
        log("Using default hardcoded button configuration.");
        return sortButtons(DEFAULT_BUTTONS.map(btn => ({...FULL_DEFAULT_BUTTON, ...btn})));
    }

    function saveButtons(buttons) {
        try {
            // 1. Filter out invalid/empty buttons
            const safeButtons = buttons.filter(btn => btn.label && btn.label.trim() !== '' && btn.artist && btn.artist.trim() !== '');

            // 2. Map and clean: only save relevant fields based on relationship type
            const cleanedButtons = safeButtons.map(btn => {
                const clean = {
                    label: btn.label,
                    relationshipType: btn.relationshipType,
                    artist: btn.artist,
                };

                if (btn.relationshipType === 'instruments') {
                    clean.instrument = btn.instrument;
                    clean.creditedAs = btn.creditedAs;
                } else if (btn.relationshipType === 'vocal') {
                    clean.vocal = btn.vocal;
                    clean.creditedAs = btn.creditedAs;
                }
                // For 'performed / performer', instrument, vocal, and creditedAs are omitted.
                return clean;
            });

            const sortedButtons = sortButtons(cleanedButtons);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(sortedButtons));
            log(`Saved ${sortedButtons.length} button configurations to localStorage.`);
            return sortedButtons;
        } catch (e) {
            console.error(LOG_PREFIX, "Error saving buttons to localStorage.", e);
            return buttons;
        }
    }

    // Initialize the buttons
    ARTIST_BUTTONS = getInitialButtons();


    // ----------------- Utilities -----------------
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
    async function waitVisible(selector, opts = {}) {
        const timeout = opts.timeout ?? 5000;
        const interval = opts.interval ?? 50;
        const start = Date.now();
        while (Date.now() - start < timeout) {
            const $el = $(selector).filter(':visible');
            if ($el.length) return $el;
            await sleep(interval);
        }
        return null;
    }
    async function waitDialogClosed(timeout = 2000) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            // Check for both the main modals and the specific config overlays
            const $visibleDialogs = $('.modal, .Dialog, .dialog, .ui-dialog, .ui-widget-overlay, #aa-config-modal-overlay, #aa-add-new-modal-overlay').filter(':visible');
            if ($visibleDialogs.length === 0) {
                await sleep(SMALL_BREATHING_ROOM_MS);
                return true;
            }
            await sleep(50);
        }
        return false;
    }
    async function waitForCondition(conditionFn, {timeout = 3000, interval = 50} = {}) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            try {
                if (await conditionFn()) return true;
            } catch (e) { /* ignore */ }
            await sleep(interval);
        }
        return false;
    }
    function setReactValueAndDispatch(el, value) {
        try {
            const nativeSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
            if (nativeSetter) nativeSetter.call(el, value);
            else el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
            el.dispatchEvent(new InputEvent('input', { bubbles: true }));
        } catch (e) {
            el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }
    function clearInput(el) { setReactValueAndDispatch(el, ''); }
    async function typeAndSelect($input, text, {
        charDelay = GLOBAL_CHAR_DELAY_MS,
        postSelectWait = GLOBAL_POST_SELECT_WAIT_MS,
        optionSelector = "li[role='option']"
    } = {}) {
        const el = $input[0];
        if (!el) throw new Error('Input element missing');
        el.focus();
        clearInput(el);
        await sleep(50);
        for (let i = 0; i < text.length; i++) {
            const ch = text[i];
            const newValue = el.value + ch;
            setReactValueAndDispatch(el, newValue);
            await sleep(charDelay);
        }
        await sleep(100);
        const found = await waitForCondition(() => {
            const $opts = $(optionSelector).filter(':visible');
            if (!$opts.length) return false;
            const match = $opts.toArray().find(o => $(o).text().trim().toLowerCase().startsWith(text.toLowerCase()));
            if (match) { match.click(); return true; }
            const match2 = $opts.toArray().find(o => $(o).text().trim().toLowerCase().includes(text.toLowerCase()));
            if (match2) { match2.click(); return true; }
            return false;
        }, {timeout: 3000, interval: 80});
        if (!found) { log(`Warning: option for "${text}" not found in suggestions after timeout.`); }
        await sleep(postSelectWait);
    }
    async function openBatchAddDialog() {
        await waitDialogClosed(2000);
        const $batch = $("button.add-item.with-label.batch-add-recording-relationship, button.add-item.batch-add-recording-relationship, button.add-item.with-label").filter(function() {
            const t = $(this).text().toLowerCase();
            return t.includes('batch-add') || t.includes('batch add') || (t.includes('add') && t.includes('record'));
        });
        if ($batch.length === 0) { log("Batch-add button not found via selectors"); return false; }
        $batch[0].click();
        const appeared = await waitForCondition(() => {
            const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
            return $d.length > 0;
        }, {timeout: 3000, interval: 80});
        if (!appeared) { await sleep(300); }
        await sleep(SMALL_BREATHING_ROOM_MS);
        return true;
    }
    async function clickDoneAndWaitClose() {
        const $doneButton = await waitVisible('button.positive:visible', {timeout: 4000});
        if ($doneButton) {
            const $exactDone = $doneButton.filter((i, btn) => $(btn).text().trim() === 'Done');
            if ($exactDone.length) {
                log("Clicking Done");
                $exactDone[0].click();
                await waitForCondition(() => {
                    const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
                    return $d.length === 0;
                }, {timeout: 3000, interval: 80});
                await sleep(SMALL_BREATHING_ROOM_MS);
                return true;
            }
        }
        log("Done button not found (when trying to click Done).");
        return false;
    }

    // --- Initial State Cleanup ---
    function resetInitialState() {
        const $allRecordings = $('#tracklist input[type="checkbox"]:not(.work)');
        const $checkedOnLoad = $allRecordings.filter(':checked');

        if ($checkedOnLoad.length > 0) {
            log(`Initial state fix: Found ${$checkedOnLoad.length} checked checkboxes on load. Forcing uncheck with aggressive click simulation.`);

            $checkedOnLoad.each(function() {
                const el = this;
                try {
                    el.dispatchEvent(new MouseEvent('click', { bubbles: true }));
                } catch(e) {
                    $(el).click();
                }
            });

            setTimeout(() => {
                const $stillChecked = $allRecordings.filter(':checked');
                if ($stillChecked.length > 0) {
                    log(`Warning: Aggressive uncheck failed. Still checked: ${$stillChecked.length}`);
                } else {
                    log("Initial state fix successful: 0 checked recordings after cleanup.");
                }
            }, 100);

            return true;
        }
        log("Initial state fix: Found 0 checked checkboxes on load. State is clean.");
        return false;
    }

    // ----------------- Filling sequence -----------------
    async function fillFieldsAsync(config) {
        // --- START OF ENHANCEMENT: Ensure "Related type" is "Artist" ---
        const $relatedTypeSelect = await waitVisible('select.entity-type:visible', {timeout: 3000});
        const desiredValue = 'artist';

        if ($relatedTypeSelect) {
            const el = $relatedTypeSelect[0];

            if ($relatedTypeSelect.val() !== desiredValue) {
                log(`Changing 'Related type' from '${$relatedTypeSelect.val()}' to 'artist'`);

                // Set the value and dispatch events to trigger React re-render
                setReactValueAndDispatch(el, desiredValue);

                // Give the application a moment to react to the entity-type change
                await sleep(SMALL_BREATHING_ROOM_MS);

            } else {
                log("'Related type' is already set to 'artist', skipping change.");
            }
        } else {
            log("Warning: 'Related type' select element not found. Continuing, but this might fail.");
        }
        // --- END OF ENHANCEMENT ---

        log(`Start filling for: ${config.label} (${config.relationshipType})`);
        const $relInput = await waitVisible('input.relationship-type', {timeout: 4000});
        if (!$relInput) { log("Relationship type input not found ‚Äî aborting this item."); return false; }
        log(`Typing relationshipType '${config.relationshipType}'`);
        await typeAndSelect($relInput, config.relationshipType);

        const $artist = await waitVisible('input[placeholder="Type to search, or paste an MBID"]', {timeout: 4000});
        if (!$artist) { log("Artist input not found ‚Äî aborting this item."); return false; }
        log(`Typing artist '${config.artist}'`);
        await typeAndSelect($artist, config.artist);

        if (config.relationshipType === 'performed / performer') {
            // This relationship type does not have instrument, vocal, or credited-as fields.
            log("Performed / performer detected ‚Äî skipping attributes and clicking Done.");
            await clickDoneAndWaitClose();
            log(`Finished performer item: ${config.label}`);
            return true;
        }

        const placeholderName = config.relationshipType === 'instruments' ? 'instrument' : 'vocal';

        // Fill Instrument/Vocal
        if (config.relationshipType === 'instruments' || config.relationshipType === 'vocal') {
            const $inst = await waitVisible(`input[placeholder="${placeholderName}"]`, {timeout: 4000});
            if (!$inst) { log(`${placeholderName} input not found ‚Äî aborting this item.`); return false; }
            const desired = (config.relationshipType === 'instruments') ? config.instrument : config.vocal;
            if (desired && desired.length > 0) {
                log(`Typing ${placeholderName} '${desired}'`);
                await typeAndSelect($inst, desired);
            } else {
                log(`No ${placeholderName} value provided, skipping selection.`);
            }
        }

        // Fill Credited As
        const creditedAsValue = config.creditedAs ?? '';

        if (config.relationshipType !== 'performed / performer' && creditedAsValue.length > 0) {
            log("Attempting to fill 'Credited as' field‚Ä¶");
            // Find the visible 'credited as' input, prioritizing the one associated with the relationship type
            let $creditedInput = $("input:visible").filter((i, el) => {
                const cls = (el.className || '').toLowerCase();
                return cls.includes('attribute-credit');
            }).first();

            // Fallback strategy if initial filter is too broad/narrow
            if ($creditedInput.length === 0) {
                 $creditedInput = $("input:visible").filter((i, el) => {
                    const idn = (el.id || '').toLowerCase();
                    const name = (el.name || '').toLowerCase();
                    return idn.includes('credit') || name.includes('credit');
                }).first();
            }

            if ($creditedInput && $creditedInput.length) {
                const el = $creditedInput[0];
                setReactValueAndDispatch(el, creditedAsValue);
                await sleep(100);
                log(`'Credited as' set to "${creditedAsValue}"`);
            } else {
                log("Could not find credited-as input; skipping.");
            }
        } else {
            log("Skipping 'Credited as' filling (either not relevant or no value provided).");
        }

        const doneClicked = await clickDoneAndWaitClose();
        if (doneClicked) {
            log(`Finished item: ${config.label}`);
            return true;
        } else {
            log("Done not clicked (not found) ‚Äî but continuing.");
            return true;
        }
    }


    // ----------------- Queue Processing -----------------

    async function processQueue() {
        if (processing) return;
        processing = true;
        while (queue.length) {
            const config = queue.shift();
            try {
                log(`Processing queue item: ${config.label}`);
                const opened = await openBatchAddDialog();
                if (!opened) {
                    log("Could not open batch-add dialog ‚Äî skipping this item.");
                    await sleep(SMALL_BREATHING_ROOM_MS);
                    continue;
                }
                await fillFieldsAsync(config);
                await sleep(200);
            } catch (e) {
                console.error(LOG_PREFIX, "Error processing item", e);
                await sleep(500);
            }
        }
        processing = false;
        log("Batch processing queue finished.");
    }


    // ----------------- Modal UI -----------------

    // Function to dynamically show/hide fields based on relationship type
    function updateFieldVisibility($item) {
        const type = $item.find('select[name="relationshipType"]').val();

        // Hide all dynamic fields first
        $item.find('.instrument-field').hide();
        $item.find('.vocal-field').hide();
        $item.find('.creditedAs-field').show(); // Default to visible

        if (type === 'instruments') {
            $item.find('.instrument-field').show();
        } else if (type === 'vocal') {
            $item.find('.vocal-field').show();
        } else if (type === 'performed / performer') {
            // Hide all attribute fields for this type
            $item.find('.creditedAs-field').hide();
        }
    }

    function showAddButtonModal(saveCallback) {
        // Ensure only one modal is present
        $('#aa-add-new-modal-overlay').remove();

        const MODAL_STYLE = `
            #aa-add-new-modal-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.75); z-index: 10000; /* Higher Z-index than main config modal */
                display: flex; justify-content: center; align-items: center;
            }
            #aa-add-new-modal {
                background: white; padding: 20px; border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); max-width: 500px;
                width: 90%;
                font-family: Arial, sans-serif; color: #333;
            }
            #aa-add-new-modal h4 { margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
            #aa-add-new-modal label { display: block; margin-top: 8px; font-weight: bold; font-size: 0.9em; }
            #aa-add-new-modal input, #aa-add-new-modal select {
                width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box;
                border: 1px solid #ccc; border-radius: 4px;
            }
            .aa-add-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
            .aa-add-footer button { padding: 8px 15px; cursor: pointer; border-radius: 4px; border: none; }
            .aa-add-save-btn { background-color: #4CAF50; color: white; }
            .aa-add-cancel-btn { background-color: #ccc; color: #333; }
        `;

        // Add the new style block
        if ($('#aa-add-new-modal-style').length === 0) {
             $('head').append(`<style id="aa-add-new-modal-style">${MODAL_STYLE}</style>`);
        }

        const $overlay = $('<div id="aa-add-new-modal-overlay">');
        const $modal = $('<div id="aa-add-new-modal">');

        $modal.html(`
            <h4>Add New Button Configuration</h4>
            <div id="aa-add-form">
                <label>Label (Button Text): <input type="text" name="label" value="" placeholder="E.g., Max Weinberg"></label>

                <label>Relationship Type:
                    <select name="relationshipType">
                        <option value="instruments">instruments</option>
                        <option value="vocal">vocal</option>
                        <option value="performed / performer">performed / performer</option>
                    </select>
                </label>
                <label>Artist Name: <input type="text" name="artist" value="" placeholder="E.g., Max Weinberg (required)"></label>

                <label class="instrument-field">Instrument (if type='instruments'): <input type="text" name="instrument" value="" placeholder="E.g., drums (drum set)"></label>
                <label class="vocal-field">Vocal (if type='vocal'): <input type="text" name="vocal" value="" placeholder="E.g., lead vocals"></label>
                <label class="creditedAs-field">Credited As: <input type="text" name="creditedAs" value="" placeholder="E.g., drums"></label>
            </div>
            <div class="aa-add-footer">
                <button class="aa-add-cancel-btn">Cancel</button>
                <button class="aa-add-save-btn">Add Button</button>
            </div>
        `);

        const $form = $modal.find('#aa-add-form');
        const $select = $form.find(`select[name="relationshipType"]`);
        const $labelInput = $form.find('input[name="label"]');
        const $artistInput = $form.find('input[name="artist"]');

        let artistEditedManually = false;

        // 1. Artist Sync Logic
        $artistInput.on('input', () => {
            // Once the user types anything in the artist field, disable syncing
            artistEditedManually = true;
        });

        $labelInput.on('input', function() {
            if (!artistEditedManually) {
                // Only sync if the artist field hasn't been manually touched
                $artistInput.val($(this).val());
            }
        });

        // 2. Field Visibility Logic
        const updateAddModalVisibility = () => {
             // Use the same logic as the main modal updateFieldVisibility
             const type = $select.val();
             $form.find('.instrument-field').hide();
             $form.find('.vocal-field').hide();
             $form.find('.creditedAs-field').show();

             if (type === 'instruments') {
                 $form.find('.instrument-field').show();
             } else if (type === 'vocal') {
                 $form.find('.vocal-field').show();
             } else if (type === 'performed / performer') {
                 $form.find('.creditedAs-field').hide();
             }
        };

        // Initial visibility
        updateAddModalVisibility();

        // Add change listener for dynamic visibility
        $select.on('change', updateAddModalVisibility);

        const cleanupAndClose = () => {
            $(document).off('keydown', escapeHandler);
            $overlay.remove();
        }

        $modal.on('click', '.aa-add-cancel-btn', cleanupAndClose);

        $modal.on('click', '.aa-add-save-btn', function() {
            const newButton = {
                label: $labelInput.val().trim(),
                relationshipType: $select.val(),
                artist: $artistInput.val().trim(),
                instrument: $form.find('input[name="instrument"]').val().trim(),
                vocal: $form.find('input[name="vocal"]').val().trim(),
                creditedAs: $form.find('input[name="creditedAs"]').val().trim(),
            };

            if (!newButton.label || !newButton.artist) {
                // Using alert() here as it is inside a custom modal flow and should be seen
                alert("Both Label and Artist Name are required to add a new button.");
                return;
            }

            saveCallback(newButton);
            cleanupAndClose();
        });

        // Escape Key Handler
        const escapeHandler = function(e) {
            const isInput = $(e.target).is('input, select, textarea');
            if (e.key === 'Escape' && !isInput) {
                e.preventDefault();
                e.stopPropagation();
                cleanupAndClose();
            }
        };

        $(document).on('keydown', escapeHandler);

        $overlay.append($modal);
        $('body').append($overlay);
    }

    function showConfigModal() {
        // Ensure only one modal is present
        $('#aa-config-modal-overlay').remove();

        // Deep clone the current buttons for local manipulation
        // Note: currentButtons will be dynamically replaced by getCurrentConfigFromForm(true)
        // when changes occur in the DOM, making it match the current view.
        let currentButtons = ARTIST_BUTTONS.map(a => Object.assign({}, a));

        // Capture the initial state string (must be sorted for a reliable comparison)
        const initialConfigString = JSON.stringify(sortButtons(currentButtons.map(a => Object.assign({}, a))));

        const MODAL_STYLE = `
            #aa-config-modal-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.75); z-index: 9999;
                display: flex; justify-content: center; align-items: center;
            }
            #aa-config-modal {
                background: white; padding: 20px; border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); max-width: 800px;
                width: 90%; max-height: 90%;
                font-family: Arial, sans-serif; color: #333;
                display: flex; /* Flex container for scrollable content + fixed footer */
                flex-direction: column;
            }
            #aa-config-modal h3 { margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px; flex-shrink: 0; }

            #aa-config-scroll-area {
                overflow-y: auto; /* Scrollable content area */
                flex-grow: 1;
                padding-right: 5px; /* Add slight padding for scrollbar visibility */
            }

            .aa-config-item {
                border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 6px;
                background-color: #f9f9f9;
            }
            .aa-config-item h4 { margin: 0 0 10px 0; display: flex; justify-content: space-between; align-items: center; }
            .aa-config-item label { display: block; margin-top: 8px; font-weight: bold; font-size: 0.9em; }
            .aa-config-item input, .aa-config-item select {
                width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box;
                border: 1px solid #ccc; border-radius: 4px;
            }
            /* FIXED FOOTER STYLE */
            .aa-config-footer {
                display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px;
                border-top: 1px solid #ccc;
                flex-shrink: 0;
            }
            .aa-config-footer button {
                padding: 8px 15px; cursor: pointer; border-radius: 4px; border: none;
                font-weight: bold;
            }
            .aa-remove-btn { background-color: #f44336; color: white; border: none; padding: 4px 8px; font-size: 0.8em; cursor: pointer; }
            .aa-add-btn, .aa-save-btn { /* Apply cursor to Add New button */
                cursor: pointer;
            }
            .aa-add-btn { background-color: #007bff; color: white; border: none; }
            .aa-save-btn { background-color: #4CAF50; color: white; border: none; }
            .aa-close-btn { background-color: #ccc; color: #333; border: none; cursor: pointer; }
        `;

        // Apply styles
        if ($('#aa-config-modal-style').length === 0) {
             $('head').append(`<style id="aa-config-modal-style">${MODAL_STYLE}</style>`);
        }


        const $overlay = $('<div id="aa-config-modal-overlay">');
        const $modal = $('<div id="aa-config-modal">');
        $modal.html('<h3>Batch Relationship Button Configuration</h3><div id="aa-config-scroll-area"><div id="aa-config-form"></div></div>');

        const $scrollArea = $modal.find('#aa-config-scroll-area');
        const $formContainer = $modal.find('#aa-config-form');

        const renderForm = (buttons) => {
            $formContainer.empty();
            // Important: Render the *sorted* array
            buttons.forEach((config, index) => {
                const $item = $(`<div class="aa-config-item" data-index="${index}">`);

                // Use default values if keys are missing (e.g., in a cleaned 'performed / performer' object)
                const safeConfig = {...FULL_DEFAULT_BUTTON, ...config};

                // Build the item structure
                $item.append(`
                    <h4>
                        Button ${index + 1}: ${safeConfig.label}
                        <button class="aa-remove-btn">Remove</button>
                    </h4>
                    <label>Label (Button Text): <input type="text" name="label" value="${safeConfig.label || ''}" placeholder="E.g., Max Weinberg"></label>

                    <label>Relationship Type:
                        <select name="relationshipType">
                            <option value="instruments">instruments</option>
                            <option value="vocal">vocal</option>
                            <option value="performed / performer">performed / performer</option>
                        </select>
                    </label>
                    <label>Artist Name: <input type="text" name="artist" value="${safeConfig.artist || ''}" placeholder="E.g., Max Weinberg (required)"></label>

                    <label class="instrument-field">Instrument (if type='instruments'): <input type="text" name="instrument" value="${safeConfig.instrument || ''}" placeholder="E.g., drums (drum set)"></label>
                    <label class="vocal-field">Vocal (if type='vocal'): <input type="text" name="vocal" value="${safeConfig.vocal || ''}" placeholder="E.g., lead vocals"></label>

                    <label class="creditedAs-field">Credited As: <input type="text" name="creditedAs" value="${safeConfig.creditedAs || ''}" placeholder="E.g., drums"></label>
                `);

                // Set selected value for relationshipType
                const $select = $item.find(`select[name="relationshipType"]`);
                $select.val(safeConfig.relationshipType);

                // Initial visibility update
                updateFieldVisibility($item);

                // Add change listener for dynamic visibility
                $select.on('change', function() {
                    updateFieldVisibility($item);
                });

                // Add change listener to all inputs to update the local currentButtons array instantly
                $item.find('input, select').on('change keyup', function() {
                    const fieldName = $(this).attr('name');
                    const value = $(this).val();
                    const $currentItem = $(this).closest('.aa-config-item');
                    const index = $currentItem.data('index');

                    // Update the label in the h4 for instant feedback
                    if (fieldName === 'label') {
                        $currentItem.find('h4').html(`Button ${index + 1}: ${value}<button class="aa-remove-btn">Remove</button>`);
                    }

                    // Update the local array by reading the current DOM state (sorted)
                    // This ensures currentButtons always matches the visible form for accurate removal/saving
                    currentButtons = getCurrentConfigFromForm(true);
                });


                $formContainer.append($item);
            });
        };

        // Utility to extract current form state (used for comparison)
        function getCurrentConfigFromForm(onlyReadDom = false) {
            if (onlyReadDom) {
                const currentConfig = [];
                $formContainer.find('.aa-config-item').each(function() {
                    currentConfig.push({
                        label: $(this).find('input[name="label"]').val().trim(),
                        relationshipType: $(this).find('select[name="relationshipType"]').val(),
                        artist: $(this).find('input[name="artist"]').val().trim(),
                        instrument: $(this).find('input[name="instrument"]').val().trim(),
                        vocal: $(this).find('input[name="vocal"]').val().trim(),
                        creditedAs: $(this).find('input[name="creditedAs"]').val().trim(),
                    });
                });
                return sortButtons(currentConfig);
            }
            // Fallback: use the in-memory array
            return sortButtons(currentButtons.map(a => Object.assign({}, a)));
        }

        // Initial render
        renderForm(currentButtons);

        // --- Event Handlers ---

        // Cleanup function for modal closure
        const cleanupAndClose = () => {
            $(document).off('keydown', escapeHandler);
            $('#aa-add-new-modal-overlay').remove(); // Ensure add modal is also closed
            $overlay.remove();
        }

        // Add New Button Handler
        const handleAddNewButton = () => {
             // Open the dedicated small modal
             showAddButtonModal((newButton) => {
                // Callback function when the new button is saved in the sub-modal

                // 1. Read the current DOM state to ensure we capture any pending edits
                const currentDomConfig = getCurrentConfigFromForm(true);

                // 2. Add the new button
                currentDomConfig.push(newButton);
                currentButtons = sortButtons(currentDomConfig); // Update local array

                // 3. Re-render the main form with the new, sorted button list
                renderForm(currentButtons);

                // 4. Scroll to the bottom to see the newly added button (which is now in its sorted position)
                $scrollArea.scrollTop($scrollArea[0].scrollHeight);
             });
        };


        // Remove Button (FIXED: Uses index for unique removal)
        $modal.on('click', '.aa-remove-btn', function() {
            const $item = $(this).closest('.aa-config-item');

            // Read the current state of the buttons from the form (guaranteed to match the visible list)
            const domConfig = getCurrentConfigFromForm(true);
            const indexToRemove = $item.data('index'); // This index is based on the *sorted* array shown on screen

            if (domConfig.length > 1) {

                // Remove the item at the specific index using splice
                domConfig.splice(indexToRemove, 1);

                // Update currentButtons and ensure it is sorted
                currentButtons = sortButtons(domConfig);

                renderForm(currentButtons);

            } else {
                console.warn(LOG_PREFIX, "User tried to remove the last button. Must keep at least one.");
                alert("You must keep at least one button configuration.");
            }
        });

        // Save Button
        const saveAndClose = () => {
            const newConfig = [];
            let valid = true;

            $formContainer.find('.aa-config-item').each(function() {
                const $item = $(this);
                const label = $item.find('input[name="label"]').val().trim();
                const artist = $item.find('input[name="artist"]').val().trim();

                if (!label || !artist) {
                    // Using alert() here as it is inside a custom modal flow and should be seen
                    alert(`Button configuration requires both a Label and an Artist Name. Please check item ${$item.data('index') + 1}.`);
                    valid = false;
                    return false; // Stop .each loop
                }

                newConfig.push({
                    label: label,
                    relationshipType: $item.find('select[name="relationshipType"]').val(),
                    artist: artist,
                    instrument: $item.find('input[name="instrument"]').val().trim(),
                    vocal: $item.find('input[name="vocal"]').val().trim(),
                    creditedAs: $item.find('input[name="creditedAs"]').val().trim(),
                });
            });

            if (valid) {
                // Save and sort the new configuration (saveButtons will handle stripping unnecessary fields)
                ARTIST_BUTTONS = saveButtons(newConfig);
                renderButtons(ARTIST_BUTTONS); // Re-render the batch buttons on the main page
                cleanupAndClose();
                log("Configuration saved and buttons updated.");
            }
        };

        // Escape Key Handler
        const escapeHandler = function(e) {
            // Check if the event target is inside an input field, which might be handling Esc for something else
            const isInput = $(e.target).is('input, select, textarea');
            if (e.key === 'Escape' && !isInput) {
                e.preventDefault();
                e.stopPropagation();

                const finalConfig = getCurrentConfigFromForm(true); // Read current state from DOM
                const finalConfigString = JSON.stringify(finalConfig);

                if (finalConfigString === initialConfigString) {
                    // No changes, close safely
                    cleanupAndClose();
                    log("Configuration modal closed with Esc key (no changes).");
                } else {
                    // Changes made, prompt user
                    const response = window.confirm("You have unsaved changes. Press OK to discard changes and close, or Cancel to return and Save.");
                    if (response) {
                        cleanupAndClose();
                        log("Configuration modal closed with Esc key (changes discarded).");
                    }
                }
            }
        };

        // Attach event listeners
        $(document).on('keydown', escapeHandler);

        // Footer (Fixed position achieved by putting it outside the scroll area)
        const $footer = $(`
            <div class="aa-config-footer">
                <button class="aa-close-btn">Close</button>
                <div>
                    <button class="aa-add-btn">Add New Button</button>
                    <button class="aa-save-btn">Save & Reload Buttons</button>
                </div>
            </div>
        `);

        $modal.append($footer);

        $modal.on('click', '.aa-close-btn', cleanupAndClose);
        $modal.on('click', '.aa-save-btn', saveAndClose);
        $modal.on('click', '.aa-add-btn', handleAddNewButton);

        $overlay.append($modal);
        $('body').append($overlay);
    }

    // ----------------- UI: Button Rendering and Creation -----------------

    const BUTTON_STYLE_CONFIG = {
        'instruments': { bgColor: '#4CAF50', activeColor: '#3e8e41', icon: 'üé∏ ' },
        'vocal': { bgColor: '#2196F3', activeColor: '#0b7dda', icon: 'üé§ ' },
        'performed / performer': { bgColor: '#FF9800', activeColor: '#e68a00', icon: 'üé≠ ' },
        'default': { bgColor: '#607D8B', activeColor: '#455a64', icon: 'üîó ' }
    };

    function renderButtons(buttons) {
        const $mainContainer = $('.injected-buttons-container');
        if ($mainContainer.length === 0) return;

        let $batchButtonContainer = $mainContainer.find('#aa-batch-buttons');
        if ($batchButtonContainer.length === 0) {
            $batchButtonContainer = $('<div id="aa-batch-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>');
            $mainContainer.append($batchButtonContainer);
        }

        $batchButtonContainer.empty();

        buttons.forEach(config => {
            const style = BUTTON_STYLE_CONFIG[config.relationshipType] || BUTTON_STYLE_CONFIG['default'];
            const buttonText = `${style.icon}${config.label}`;

            const buttonStyleString = `
                background-color: ${style.bgColor};
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.15s ease-in-out;
                white-space: nowrap;
                flex-shrink: 0;
                line-height: 20px;
            `;

            const $button = $('<button/>', {
                text: buttonText,
                'data-label': config.label
            });

            $button.attr('style', buttonStyleString);

            $button.on({
                'mouseenter': function() { $(this).css('opacity', 0.9); },
                'mouseleave': function() { $(this).css('opacity', 1); },
                'click': function() {
                    $(this).css('background-color', style.activeColor);
                    setTimeout(() => $(this).css('background-color', style.bgColor), 500);
                }
            });

            $batchButtonContainer.append($button);

            $button.on('click', () => {
                log(`Enqueued "${config.label}" (${config.relationshipType})`);
                queue.push(Object.assign({}, config));
                processQueue().catch(e => console.error(e));
            });
        });
    }

    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        // --- MAIN WRAPPER (unchanged, but now holds two sub-containers) ---
        let $container = $heading.next('.injected-buttons-container');
        if ($container.length === 0) {
            $container = $(`
                <div class="injected-buttons-container"
                     style="display:flex; flex-direction:column; gap:8px;
                            margin-top:10px; margin-bottom:5px; width:100%;">
                </div>
            `);
            $heading.after($container);
        }

        // -------------------------------
        // 1) CONFIG BUTTON CONTAINER (ALWAYS VISIBLE)
        // -------------------------------
        let $configContainer = $container.find('#aa-config-container');
        if ($configContainer.length === 0) {
            $configContainer = $(`
                <div id="aa-config-container" style="display:flex; gap:10px; flex-wrap:wrap;">
                </div>
            `);
            $container.append($configContainer);
        }

        // Add config button if missing
        let $configButton = $configContainer.find('#aa-config-btn');
        if ($configButton.length === 0) {
            const configButtonStyle = `
                background-color:#607D8B; color:white;
                padding:5px 10px; border:none; border-radius:4px;
                cursor:pointer; font-weight:bold; line-height:1.2; flex-shrink:0;
            `;

            $configButton = $('<button/>', {
                id: 'aa-config-btn',
                html: '‚öôÔ∏è Configure recording<br>relation buttons'
            });

            $configButton.attr('style', configButtonStyle);
            $configButton.on('click', showConfigModal);
            $configContainer.append($configButton);
        }

        // -------------------------------
        // 2) ACTION BUTTON CONTAINER (VISIBILITY CONTROLLED)
        // -------------------------------
        let $actionContainer = $container.find('#aa-action-buttons-container');
        if ($actionContainer.length === 0) {
            $actionContainer = $(`
                <div id="aa-action-buttons-container" style="display:none;">
                    <div id="aa-batch-buttons"
                         style="display:flex; gap:10px; flex-wrap:wrap;">
                    </div>
                </div>
            `);
            $container.append($actionContainer);
        }

        const $batchButtonContainer = $actionContainer.find('#aa-batch-buttons');
        $batchButtonContainer.empty();

        // Render all dynamic action buttons into this new container
        renderButtons(ARTIST_BUTTONS);

        // -------------------------------
        // Visibility logic (unchanged, except new container)
        // -------------------------------
        function getCheckedRecordings() {
            return $('#tracklist input[type="checkbox"]:not(.work)');
        }

        function updateButtonVisibility() {
            const $checked = getCheckedRecordings().filter(':checked');
            const anyChecked = $checked.length > 0;

            if (anyChecked) {
                $actionContainer.show();
            } else {
                $actionContainer.hide();
            }
        }

        updateButtonVisibility();

        $('#tracklist').on('change click input', 'input[type="checkbox"]', () => {
            setTimeout(updateButtonVisibility, 50);
        });

        setInterval(updateButtonVisibility, VISIBILITY_HEARTBEAT_MS);

        log("Injected custom buttons using separated containers.");
    }

    // ----------------- Main Execution -----------------

    try {
        setTimeout(() => {
            log("Starting userscript execution...");
            resetInitialState();
            createCustomButtons();
        }, 2000);
    } catch (error) {
        // This catch block primarily catches sync errors during the setting of the timeout.
        console.error(LOG_PREFIX, "CRITICAL SCRIPT FAILURE during initial setup:", error);
    }

})();
#+end_example

** gemini
*** tuning timeouts

Can the following userscript be fine tuned (especially the timeouts). I can literally watch the script typing, this
should probably be enhanced without breaking the logic itself.

#+begin_example
// ==UserScript==
// @name         BatchAddRelationshipsToRecordings.user.js
// @namespace    https://github.com/vzell/mb-userscripts
// @version      1.0
// @description  Insert artist buttons, open batch-add dialog, reliably fill relationship type (instruments|vocal|performed / performer), artist, instrument/vocal, credited-as, click Done ‚Äî sequential queue + dialog lifecycle awareness.
// @homepageURL  https://github.com/vzell/mb-userscripts
// @tag          vzell with the help of ChatGPT
// @homepageURL  https://github.com/vzell/mb-userscripts
// @downloadURL  https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @updateURL    https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    // --- Configuration for multiple Artist buttons ---
    const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        },
        {
            label: "Bruce Springsteen",
            relationshipType: "vocal",
            artist: "Bruce Springsteen",
            vocal: "lead vocals",
            creditedAs: ""
        },
        {
            label: "E Street Band",
            relationshipType: "performed / performer",
            artist: "The E Street Band"
        }
        // Add/remove entries as needed
    ];

    // ----------------- Utilities -----------------
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    // Wait for an element matching selector that is visible
    async function waitVisible(selector, opts = {}) {
        const timeout = opts.timeout ?? 5000;
        const interval = opts.interval ?? 100;
        const start = Date.now();
        while (Date.now() - start < timeout) {
            const $el = $(selector).filter(':visible');
            if ($el.length) return $el;
            await sleep(interval);
        }
        return null;
    }

    // Wait until no visible dialog exists (used to ensure previous dialog fully closed)
    async function waitDialogClosed(timeout = 3000) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            // adjust selector if your dialog uses a specific class; generic attempt:
            const $visibleDialogs = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
            if ($visibleDialogs.length === 0) {
                // small extra breathing room so React finishes unmount
                await sleep(200);
                return true;
            }
            await sleep(100);
        }
        return false;
    }

    // Wait until a particular condition returns truthy or times out
    async function waitForCondition(conditionFn, {timeout = 3000, interval = 100} = {}) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            try {
                if (await conditionFn()) return true;
            } catch (e) { /* ignore */ }
            await sleep(interval);
        }
        return false;
    }

    // Set value for React-controlled input and dispatch events
    function setReactValueAndDispatch(el, value) {
        try {
            const nativeSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
            if (nativeSetter) nativeSetter.call(el, value);
            else el.value = value;

            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
            // some react versions also respond to these:
            el.dispatchEvent(new InputEvent('input', { bubbles: true }));
        } catch (e) {
            // fallback
            el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }

    // Clear an input cleanly (React-aware)
    function clearInput(el) {
        setReactValueAndDispatch(el, '');
    }

    // Type into autocomplete input character by character and select matching option when available.
    // This function is defensive: it waits for suggestion list, waits for an option starting with prefix (case-insensitive),
    // clicks it, then waits until some sign of selection appears (or a small delay).
    async function typeAndSelect($input, text, {charDelay = 40, postSelectWait = 300, optionSelector = "li[role='option']"} = {}) {
        const el = $input[0];
        if (!el) throw new Error('Input element missing');

        el.focus();

        // Ensure input is empty first (React-friendly)
        clearInput(el);
        await sleep(50);

        // Type characters slowly
        for (let i = 0; i < text.length; i++) {
            const ch = text[i];
            const newValue = el.value + ch;
            setReactValueAndDispatch(el, newValue);
            await sleep(charDelay);
        }

        // At end, give suggestions a moment
        await sleep(120);

        // Wait for a suggestion that startsWith text
        const found = await waitForCondition(() => {
            const $opts = $(optionSelector).filter(':visible');
            if (!$opts.length) return false;
            // prefer exact startsWith (case-insensitive)
            const match = $opts.toArray().find(o => $(o).text().trim().toLowerCase().startsWith(text.toLowerCase()));
            if (match) {
                match.click();
                return true;
            }
            // fallback: any option that includes the text
            const match2 = $opts.toArray().find(o => $(o).text().trim().toLowerCase().includes(text.toLowerCase()));
            if (match2) {
                match2.click();
                return true;
            }
            return false;
        }, {timeout: 3000, interval: 120});

        if (!found) {
            log(`Warning: option for "${text}" not found in suggestions after timeout.`);
        }

        // give React time to update internal state / tokens
        await sleep(postSelectWait);
    }

    // Reliable method: click batch-add button but only AFTER ensuring previous dialog closed
    async function openBatchAddDialog() {
        // Ensure previous closed
        await waitDialogClosed(2000);

        // Find the batch button
        const $batch = $("button.add-item.with-label.batch-add-recording-relationship, button.add-item.batch-add-recording-relationship, button.add-item.with-label").filter(function() {
            const t = $(this).text().toLowerCase();
            return t.includes('batch-add') || t.includes('batch add') || (t.includes('add') && t.includes('record'));
        });

        if ($batch.length === 0) {
            log("Batch-add button not found via selectors");
            return false;
        }

        // Click it
        $batch[0].click();

        // Wait for dialog to appear
        const appeared = await waitForCondition(() => {
            const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
            return $d.length > 0;
        }, {timeout: 3000, interval: 100});

        if (!appeared) {
            // give one more small delay
            await sleep(400);
        }

        // Extra safety pause so React finishes mounting
        await sleep(300);
        return true;
    }

    // Click Done helper
    async function clickDoneAndWaitClose() {
        const $doneButton = await waitVisible('button.positive:visible', {timeout: 4000});
        if ($doneButton) {
            const $exactDone = $doneButton.filter((i, btn) => $(btn).text().trim() === 'Done');
            if ($exactDone.length) {
                log("Clicking Done");
                $exactDone[0].click();
                // Wait until dialog disappears
                await waitForCondition(() => {
                    const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
                    return $d.length === 0;
                }, {timeout: 3500, interval: 120});
                // small extra breathing room
                await sleep(250);
                return true;
            }
        }
        log("Done button not found (when trying to click Done).");
        return false;
    }

    // ----------------- Filling sequence (async) -----------------
    async function fillFieldsAsync(config) {
        log(`Start filling for: ${config.label} (${config.relationshipType})`);

        // 1) Relationship type
        const $relInput = await waitVisible('input.relationship-type', {timeout: 4000});
        if (!$relInput) {
            log("Relationship type input not found ‚Äî aborting this item.");
            return false;
        }
        log(`Typing relationshipType '${config.relationshipType}'`);
        await typeAndSelect($relInput, config.relationshipType, {charDelay: 40, postSelectWait: 200});

        // 2) Artist
        const $artist = await waitVisible('input[placeholder="Type to search, or paste an MBID"]', {timeout: 4000});
        if (!$artist) {
            log("Artist input not found ‚Äî aborting this item.");
            return false;
        }
        log(`Typing artist '${config.artist}'`);
        await typeAndSelect($artist, config.artist, {charDelay: 50, postSelectWait: 250});

        // SPECIAL CASE: performed / performer -> skip instrument/vocal/credited-as and click Done
        if (config.relationshipType === 'performed / performer') {
            log("Performed / performer detected ‚Äî skipping instrument/vocal/credited-as and clicking Done.");
            await clickDoneAndWaitClose();
            log(`Finished performer item: ${config.label}`);
            return true;
        }

        // 3) Instrument or Vocal (only for instruments or vocal types)
        const placeholderName = config.relationshipType === 'instruments' ? 'instrument' : 'vocal';

        // Only attempt placeholder input if relationshipType is 'instruments' or 'vocal'
        if (config.relationshipType === 'instruments' || config.relationshipType === 'vocal') {
            const $inst = await waitVisible(`input[placeholder="${placeholderName}"]`, {timeout: 4000});
            if (!$inst) {
                log(`${placeholderName} input not found ‚Äî aborting this item.`);
                return false;
            }
            const desired = (config.relationshipType === 'instruments') ? config.instrument : config.vocal;
            if (desired && desired.length > 0) {
                log(`Typing ${placeholderName} '${desired}'`);
                await typeAndSelect($inst, desired, {charDelay: 45, postSelectWait: 300});
            } else {
                log(`No ${placeholderName} value provided, skipping selection.`);
            }
        } else {
            log(`Relationship type '${config.relationshipType}' does not require instrument/vocal step; skipping.`);
        }

        // 4) Credited as: find correct container near the instrument/vocal input
        log("Attempting to fill 'Credited as' field‚Ä¶");
        // Strategy: find the nearest .multiselect that contains an input.attribute-credit or the 'attribute-credit' input visible.
        // We'll search visible attribute-credit inputs first, and then try to ensure it's the correct one by proximity.
        let $creditedInput = $('.attribute-credit:visible');
        if ($creditedInput.length === 0) {
            // fallback: look for input.attribute-credit anywhere inside visible multiselects
            const $multi = $('.multiselect:visible').filter(function() {
                return $(this).find('input[placeholder]').length > 0;
            }).last();
            if ($multi && $multi.length) {
                $creditedInput = $multi.find('input.attribute-credit:visible');
            }
        }

        // Another proximity attempt: find attribute-credit inside last visible .multiselect.* that also contains the placeholder input
        if ($creditedInput.length === 0) {
            const $lastMulti = $('.multiselect:visible').filter((i, el) => {
                return $(el).find(`input[placeholder="${placeholderName}"]`).length > 0;
            }).last();
            if ($lastMulti && $lastMulti.length) {
                $creditedInput = $lastMulti.find('input.attribute-credit:visible');
            }
        }

        // If still not found, try common selector: .multiselect.instrument or .multiselect.vocal
        if ($creditedInput.length === 0) {
            if (config.relationshipType === 'instruments') {
                $creditedInput = $('.multiselect.instrument').last().find('input.attribute-credit:visible');
            } else {
                $creditedInput = $('.multiselect.vocal').last().find('input.attribute-credit:visible');
            }
        }

        // Final fallback: any visible input whose name/id contains 'credit'
        if ($creditedInput.length === 0) {
            $creditedInput = $("input:visible").filter((i, el) => {
                const idn = (el.id || '').toLowerCase();
                const name = (el.name || '').toLowerCase();
                const cls = (el.className || '').toLowerCase();
                return idn.includes('credit') || name.includes('credit') || cls.includes('attribute-credit');
            }).first();
        }

        if ($creditedInput && $creditedInput.length) {
            const el = $creditedInput[0];
            const text = config.creditedAs ?? '';
            // set and dispatch react-friendly events
            setReactValueAndDispatch(el, text);
            // give React a little time
            await sleep(120);
            log(`'Credited as' set to "${text}"`);
        } else {
            log("Could not find credited-as input (it's optional); continuing.");
        }

        // 5) Click Done, but wait until Done appears and is stable
        const doneClicked = await clickDoneAndWaitClose();
        if (doneClicked) {
            log(`Finished item: ${config.label}`);
            return true;
        } else {
            log("Done not clicked (not found) ‚Äî but continuing.");
            return true;
        }
    }

    // ----------------- Queue to process clicks sequentially -----------------
    const queue = [];
    let processing = false;

    async function processQueue() {
        if (processing) return;
        processing = true;
        while (queue.length) {
            const config = queue.shift();
            try {
                log(`Processing queue item: ${config.label}`);
                // Open dialog (ensures previous is closed and waits until the dialog is stable)
                const opened = await openBatchAddDialog();
                if (!opened) {
                    log("Could not open batch-add dialog ‚Äî skipping this item.");
                    await sleep(300);
                    continue;
                }

                // Fill all fields and click Done
                await fillFieldsAsync(config);

                // Give small pause before next item to let React settle
                await sleep(300);
            } catch (e) {
                console.error('[AA-add-instrument] Error processing item', e);
                // tiny pause and continue with next item
                await sleep(500);
            }
        }
        processing = false;
    }

    // ----------------- UI: create buttons -----------------
    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        const $container = $('<div style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.wrap($container);

        ARTIST_BUTTONS.forEach(config => {
            // Append (i) or (v) or (p) to button label UI
            const suffix = config.relationshipType === 'instruments' ? ' (i)' :
                           config.relationshipType === 'vocal' ? ' (v)' :
                           config.relationshipType === 'performed / performer' ? ' (p)' : '';
            const buttonText = `${config.label}${suffix}`;

            const $button = $('<button/>', {
                text: buttonText,
                style: `
                    margin-left: 10px;
                    background-color: #38a169;
                    color: white;
                    padding: 5px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                `
            });

            $heading.parent().append($button);

            $button.on('click', () => {
                log(`Enqueued "${config.label}" (${config.relationshipType})`);
                // push a shallow copy to avoid mutation issues
                queue.push(Object.assign({}, config));
                processQueue().catch(e => console.error(e));
            });
        });

        log("AA: Injected custom buttons.");
    }

    // Start
    $(document).ready(() => {
        // Wait a bit to ensure page ready
        setTimeout(createCustomButtons, 700);
    });

})();
#+end_example

*** icons on button

Starting from the following userscript

#+begin_example
// ==UserScript==
// @name         Batch Add Relationships To Recordings
// @namespace    https://github.com/vzell/mb-userscripts
// @version      1.1 (Optimized)
// @description  Insert artist buttons, open batch-add dialog, reliably fill relationship type (instruments|vocal|performed / performer), artist, instrument/vocal, credited-as, click Done ‚Äî sequential queue + dialog lifecycle awareness. Optimized for speed.
// @homepageURL  https://github.com/vzell/mb-userscripts
// @tag          vzell with the help of ChatGPT
// @downloadURL  https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @updateURL    https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    const DEBUG = true;
    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    // --- OPTIMIZATION CONSTANTS ---
    /**
     * @constant {number} GLOBAL_CHAR_DELAY_MS - Delay between typing each individual character.
     * Original was 40-50ms. Reduced to 10ms for near-instant typing. Adjust higher if issues occur.
     */
    const GLOBAL_CHAR_DELAY_MS = 10;

    /**
     * @constant {number} GLOBAL_POST_SELECT_WAIT_MS - Wait time after clicking an autocomplete suggestion.
     * This is crucial for React state updates. Original was 200-300ms. Reduced to 150ms.
     */
    const GLOBAL_POST_SELECT_WAIT_MS = 150;

    /**
     * @constant {number} SMALL_BREATHING_ROOM_MS - Small general pause used after closing dialogs or setting values.
     */
    const SMALL_BREATHING_ROOM_MS = 150;


    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    // --- Configuration for multiple Artist buttons (UNCHANGED) ---
    const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        },
        {
            label: "Bruce Springsteen",
            relationshipType: "vocal",
            artist: "Bruce Springsteen",
            vocal: "lead vocals",
            creditedAs: ""
        },
        {
            label: "E Street Band",
            relationshipType: "performed / performer",
            artist: "The E Street Band"
        }
        // Add/remove entries as needed
    ];

    // ----------------- Utilities -----------------
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    // Wait for an element matching selector that is visible
    async function waitVisible(selector, opts = {}) {
        const timeout = opts.timeout ?? 5000;
        // Reduced interval for faster checking
        const interval = opts.interval ?? 50;
        const start = Date.now();
        while (Date.now() - start < timeout) {
            const $el = $(selector).filter(':visible');
            if ($el.length) return $el;
            await sleep(interval);
        }
        return null;
    }

    // Wait until no visible dialog exists (used to ensure previous dialog fully closed)
    async function waitDialogClosed(timeout = 2000) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            // Check for common dialog selectors
            const $visibleDialogs = $('.modal, .Dialog, .dialog, .ui-dialog, .ui-widget-overlay').filter(':visible');
            if ($visibleDialogs.length === 0) {
                // small extra breathing room so React finishes unmount
                await sleep(SMALL_BREATHING_ROOM_MS);
                return true;
            }
            await sleep(50); // Reduced interval
        }
        return false;
    }

    // Wait until a particular condition returns truthy or times out
    async function waitForCondition(conditionFn, {timeout = 3000, interval = 50} = {}) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            try {
                if (await conditionFn()) return true;
            } catch (e) { /* ignore */ }
            await sleep(interval);
        }
        return false;
    }

    // Set value for React-controlled input and dispatch events
    function setReactValueAndDispatch(el, value) {
        try {
            const nativeSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
            if (nativeSetter) nativeSetter.call(el, value);
            else el.value = value;

            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
            // Some React versions also respond to these:
            el.dispatchEvent(new InputEvent('input', { bubbles: true }));
        } catch (e) {
            // fallback
            el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }

    // Clear an input cleanly (React-aware)
    function clearInput(el) {
        setReactValueAndDispatch(el, '');
    }

    /**
     * Type into autocomplete input character by character and select matching option.
     * @param {jQuery} $input - The input element.
     * @param {string} text - The text to type.
     * @param {object} [opts] - Options.
     */
    async function typeAndSelect($input, text, {
        charDelay = GLOBAL_CHAR_DELAY_MS, // Optimized: 10ms
        postSelectWait = GLOBAL_POST_SELECT_WAIT_MS, // Optimized: 150ms
        optionSelector = "li[role='option']"
    } = {}) {
        const el = $input[0];
        if (!el) throw new Error('Input element missing');

        el.focus();

        // Ensure input is empty first (React-friendly)
        clearInput(el);
        await sleep(50);

        // Type characters quickly (optimized charDelay)
        for (let i = 0; i < text.length; i++) {
            const ch = text[i];
            const newValue = el.value + ch;
            setReactValueAndDispatch(el, newValue);
            await sleep(charDelay);
        }

        // At end, give suggestions a moment
        await sleep(100); // Reduced slightly from 120ms

        // Wait for a suggestion that startsWith text
        const found = await waitForCondition(() => {
            const $opts = $(optionSelector).filter(':visible');
            if (!$opts.length) return false;
            // prefer exact startsWith (case-insensitive)
            const match = $opts.toArray().find(o => $(o).text().trim().toLowerCase().startsWith(text.toLowerCase()));
            if (match) {
                match.click();
                return true;
            }
            // fallback: any option that includes the text
            const match2 = $opts.toArray().find(o => $(o).text().trim().toLowerCase().includes(text.toLowerCase()));
            if (match2) {
                match2.click();
                return true;
            }
            return false;
        }, {timeout: 3000, interval: 80}); // Reduced interval

        if (!found) {
            log(`Warning: option for "${text}" not found in suggestions after timeout.`);
        }

        // give React time to update internal state / tokens (optimized postSelectWait)
        await sleep(postSelectWait);
    }

    // Reliable method: click batch-add button but only AFTER ensuring previous dialog closed
    async function openBatchAddDialog() {
        // Ensure previous closed
        await waitDialogClosed(2000);

        // Find the batch button
        const $batch = $("button.add-item.with-label.batch-add-recording-relationship, button.add-item.batch-add-recording-relationship, button.add-item.with-label").filter(function() {
            const t = $(this).text().toLowerCase();
            return t.includes('batch-add') || t.includes('batch add') || (t.includes('add') && t.includes('record'));
        });

        if ($batch.length === 0) {
            log("Batch-add button not found via selectors");
            return false;
        }

        // Click it
        $batch[0].click();

        // Wait for dialog to appear
        const appeared = await waitForCondition(() => {
            const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
            return $d.length > 0;
        }, {timeout: 3000, interval: 80}); // Reduced interval

        if (!appeared) {
            // give one more small delay
            await sleep(300); // Retained for mounting stability
        }

        // Extra safety pause so React finishes mounting
        await sleep(SMALL_BREATHING_ROOM_MS); // Using optimized constant
        return true;
    }

    // Click Done helper
    async function clickDoneAndWaitClose() {
        const $doneButton = await waitVisible('button.positive:visible', {timeout: 4000});
        if ($doneButton) {
            const $exactDone = $doneButton.filter((i, btn) => $(btn).text().trim() === 'Done');
            if ($exactDone.length) {
                log("Clicking Done");
                $exactDone[0].click();
                // Wait until dialog disappears
                await waitForCondition(() => {
                    const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
                    return $d.length === 0;
                }, {timeout: 3000, interval: 80}); // Reduced interval
                // small extra breathing room
                await sleep(SMALL_BREATHING_ROOM_MS); // Using optimized constant
                return true;
            }
        }
        log("Done button not found (when trying to click Done).");
        return false;
    }

    // ----------------- Filling sequence (async) -----------------
    async function fillFieldsAsync(config) {
        log(`Start filling for: ${config.label} (${config.relationshipType})`);

        // 1) Relationship type
        const $relInput = await waitVisible('input.relationship-type', {timeout: 4000});
        if (!$relInput) {
            log("Relationship type input not found ‚Äî aborting this item.");
            return false;
        }
        log(`Typing relationshipType '${config.relationshipType}'`);
        // Using global optimized defaults
        await typeAndSelect($relInput, config.relationshipType);

        // 2) Artist
        const $artist = await waitVisible('input[placeholder="Type to search, or paste an MBID"]', {timeout: 4000});
        if (!$artist) {
            log("Artist input not found ‚Äî aborting this item.");
            return false;
        }
        log(`Typing artist '${config.artist}'`);
        // Using global optimized defaults
        await typeAndSelect($artist, config.artist);

        // SPECIAL CASE: performed / performer -> skip instrument/vocal/credited-as and click Done
        if (config.relationshipType === 'performed / performer') {
            log("Performed / performer detected ‚Äî skipping instrument/vocal/credited-as and clicking Done.");
            await clickDoneAndWaitClose();
            log(`Finished performer item: ${config.label}`);
            return true;
        }

        // 3) Instrument or Vocal (only for instruments or vocal types)
        const placeholderName = config.relationshipType === 'instruments' ? 'instrument' : 'vocal';

        // Only attempt placeholder input if relationshipType is 'instruments' or 'vocal'
        if (config.relationshipType === 'instruments' || config.relationshipType === 'vocal') {
            const $inst = await waitVisible(`input[placeholder="${placeholderName}"]`, {timeout: 4000});
            if (!$inst) {
                log(`${placeholderName} input not found ‚Äî aborting this item.`);
                return false;
            }
            const desired = (config.relationshipType === 'instruments') ? config.instrument : config.vocal;
            if (desired && desired.length > 0) {
                log(`Typing ${placeholderName} '${desired}'`);
                // Using global optimized defaults
                await typeAndSelect($inst, desired);
            } else {
                log(`No ${placeholderName} value provided, skipping selection.`);
            }
        } else {
            log(`Relationship type '${config.relationshipType}' does not require instrument/vocal step; skipping.`);
        }

        // 4) Credited as: find correct container near the instrument/vocal input
        log("Attempting to fill 'Credited as' field‚Ä¶");
        // Strategy: find the nearest .multiselect that contains an input.attribute-credit or the 'attribute-credit' input visible.
        // We'll search visible attribute-credit inputs first, and then try to ensure it's the correct one by proximity.
        let $creditedInput = $('.attribute-credit:visible');
        if ($creditedInput.length === 0) {
            // fallback: look for input.attribute-credit anywhere inside visible multiselects
            const $multi = $('.multiselect:visible').filter(function() {
                return $(this).find('input[placeholder]').length > 0;
            }).last();
            if ($multi && $multi.length) {
                $creditedInput = $multi.find('input.attribute-credit:visible');
            }
        }

        // Another proximity attempt: find attribute-credit inside last visible .multiselect.* that also contains the placeholder input
        if ($creditedInput.length === 0) {
            const $lastMulti = $('.multiselect:visible').filter((i, el) => {
                return $(el).find(`input[placeholder="${placeholderName}"]`).length > 0;
            }).last();
            if ($lastMulti && $lastMulti.length) {
                $creditedInput = $lastMulti.find('input.attribute-credit:visible');
            }
        }

        // If still not found, try common selector: .multiselect.instrument or .multiselect.vocal
        if ($creditedInput.length === 0) {
            if (config.relationshipType === 'instruments') {
                $creditedInput = $('.multiselect.instrument').last().find('input.attribute-credit:visible');
            } else if (config.relationshipType === 'vocal') {
                $creditedInput = $('.multiselect.vocal').last().find('input.attribute-credit:visible');
            }
        }

        // Final fallback: any visible input whose name/id contains 'credit'
        if ($creditedInput.length === 0) {
            $creditedInput = $("input:visible").filter((i, el) => {
                const idn = (el.id || '').toLowerCase();
                const name = (el.name || '').toLowerCase();
                const cls = (el.className || '').toLowerCase();
                return idn.includes('credit') || name.includes('credit') || cls.includes('attribute-credit');
            }).first();
        }

        if ($creditedInput && $creditedInput.length) {
            const el = $creditedInput[0];
            const text = config.creditedAs ?? '';
            // set and dispatch react-friendly events
            setReactValueAndDispatch(el, text);
            // give React a little time (Optimized)
            await sleep(100);
            log(`'Credited as' set to "${text}"`);
        } else {
            log("Could not find credited-as input (it's optional); continuing.");
        }

        // 5) Click Done, but wait until Done appears and is stable
        const doneClicked = await clickDoneAndWaitClose();
        if (doneClicked) {
            log(`Finished item: ${config.label}`);
            return true;
        } else {
            log("Done not clicked (not found) ‚Äî but continuing.");
            return true;
        }
    }

    // ----------------- Queue to process clicks sequentially -----------------
    const queue = [];
    let processing = false;

    async function processQueue() {
        if (processing) return;
        processing = true;
        while (queue.length) {
            const config = queue.shift();
            try {
                log(`Processing queue item: ${config.label}`);
                // Open dialog (ensures previous is closed and waits until the dialog is stable)
                const opened = await openBatchAddDialog();
                if (!opened) {
                    log("Could not open batch-add dialog ‚Äî skipping this item.");
                    await sleep(SMALL_BREATHING_ROOM_MS); // Using optimized constant
                    continue;
                }

                // Fill all fields and click Done
                await fillFieldsAsync(config);

                // Give small pause before next item to let React settle
                await sleep(200); // Reduced slightly from 300ms
            } catch (e) {
                console.error('[AA-add-instrument] Error processing item', e);
                // tiny pause and continue with next item
                await sleep(500);
            }
        }
        processing = false;
        log("Batch processing queue finished.");
    }

    // ----------------- UI: create buttons -----------------
    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        // If the buttons are already injected, don't do it again
        if ($heading.parent().hasClass('injected-buttons-container')) {
             return;
        }

        const $container = $('<div class="injected-buttons-container" style="display:flex;align-items:center;margin-bottom:5px;"></div>');
        $heading.wrap($container);

        ARTIST_BUTTONS.forEach(config => {
            // Append (i) or (v) or (p) to button label UI
            const suffix = config.relationshipType === 'instruments' ? ' (i)' :
                           config.relationshipType === 'vocal' ? ' (v)' :
                           config.relationshipType === 'performed / performer' ? ' (p)' : '';
            const buttonText = `${config.label}${suffix}`;

            const $button = $('<button/>', {
                text: buttonText,
                style: `
                    margin-left: 10px;
                    background-color: #38a169;
                    color: white;
                    padding: 5px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                    transition: all 0.15s ease-in-out;
                `,
                // Add hover effect for better UX
                on: {
                    mouseenter: function() { $(this).css('opacity', 0.9); },
                    mouseleave: function() { $(this).css('opacity', 1); },
                    click: function() {
                        // Optional: Highlight button when clicked to show action is in progress
                        $(this).css('background-color', '#2f855a');
                        setTimeout(() => $(this).css('background-color', '#38a169'), 500);
                    }
                }
            });

            $heading.parent().append($button);

            $button.on('click', () => {
                log(`Enqueued "${config.label}" (${config.relationshipType})`);
                // push a shallow copy to avoid mutation issues
                queue.push(Object.assign({}, config));
                processQueue().catch(e => console.error(e));
            });
        });

        log("AA: Injected custom buttons.");
    }

    // Start
    $(document).ready(() => {
        // Wait a bit to ensure page ready, but slightly reduced time
        setTimeout(createCustomButtons, 500);
    });

})();

#+end_example

please do NOT touch the code logic or comments in the script at all (as it works perfectly), but instead apply icons and
different button colors (make them configurable) to the different button types, so instead of

#+begin_example
"Max Weinberg (i)"
"Garry Tallent (i)"
"Bruce Springsteen (v)"
"E Street Band (p)"
#+end_example

where (i) stands for "instruments", (v) stands for "vocal", (p) stands for "performed / performer"

each button should look like

#+begin_example
"<'instruments' Icon> Max Weinberg"
"<'instruments' Icon> Garry Tallent"
"<'vocal' Icon> Bruce Springsteen"
"<'performed / performer' Icon> E Street Band"
#+end_example

Maybe using a variable like this (but including the ability to apply different button colors also)

#+begin_example
const icon = config.relationshipType === 'instruments' ? 'ü•Å ' :
                     config.relationshipType === 'vocal' ? 'üé§ ' :
                     config.relationshipType === 'performed / performer' ? 'üé∂ ' : '';
#+end_example

*** check for checkboxes on recordings
**** 1

Thanks it works.

Please from now on use the following versioning (below the current version)

#+begin_example
// @version      1.2.0+2025-11-28 (styled)
#+end_example

Please again do NOT touch the code logic or comments in the script at all (as it works perfectly), but extend the button
display logic in such a way, that they are ONLY displayed (visible) when at least one recording on the current page has
the checkbox checked. The React based HTML code for each row starts with

#+begin_example
<td class="recording">
  <input class="recording" type="checkbox">
  <a class="wrap-anywhere" target="_blank" href="/recording/96853f8b-da57-438a-b3b3-0eaf44f8597c">
    <bdi>Out in the Street
    </bdi>
  </a> (5:02)
#+end_example

**** 2

It's not working. The logic should be that initially when entering the "edit-relationships" URL

https://musicbrainz.org/release/6ccbd780-3eb1-48ff-8fe0-04d4669e8846/edit-relationships

(please parse it to get an idea how it looks like)

the buttons should not be visible as no recording is checkmarked yet (an [x] on the checkbox in front of the recordings).
As soon as least one recording has the checkbox checked, the buttons should be visible, and when no recording is checked, they shouldn't be rendered again.

**** 3

No not working at all. Initially when entering the page the buttons are already visible (which should never happen as
no recording can't be selected with a checkbox).
Also when removing all checkboxes from recordings, the buttons should alo vanish.

**** 4

Well the initial hiding works now, but the scripts doesn't actually react on checkmarkig the recordings.

**** 5

Here the console output, after cechkmarking some recording, nothngs happens

#+begin_example
[AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] AA: Injected custom buttons.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
#+end_example

Plus here the HTML snippet of the beginning of the recording table

#+begin_example
<div class="release-relationship-editor"><div class="injected-buttons-container" style="display:none;align-items:center;margin-bottom:5px;"><h2>Track relationships</h2><button style="
                    margin-left: 10px;
                    background-color: #e67e22;
                    color: white;
                    padding: 5px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                    transition: all 0.15s ease-in-out;
                ">ü•Å Max Weinberg</button><button style="
                    margin-left: 10px;
                    background-color: #e67e22;
                    color: white;
                    padding: 5px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                    transition: all 0.15s ease-in-out;
                ">ü•Å Garry Tallent</button><button style="
                    margin-left: 10px;
                    background-color: #3498db;
                    color: white;
                    padding: 5px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                    transition: all 0.15s ease-in-out;
                ">üé§ Bruce Springsteen</button><button style="
                    margin-left: 10px;
                    background-color: #9b59b6;
                    color: white;
                    padding: 5px 10px;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-weight: bold;
                    transition: all 0.15s ease-in-out;
                ">üé∂ E Street Band</button></div><table id="batch-tools"><tbody><tr><td><span class="tooltip-wrapper"><button class="add-item with-label batch-add-recording-relationship" aria-haspopup="dialog" type="button">Batch-add a relationship to recordings</button></span></td><td><span class="tooltip-wrapper"><button class="add-item with-label batch-create-works" aria-haspopup="dialog" type="button">Batch-add new works</button></span></td><td><span class="tooltip-wrapper"><button class="add-item with-label batch-add-work-relationship" aria-haspopup="dialog" disabled="" type="button">Batch-add a relationship to works</button><span class="tooltip-container"><span class="tooltip-triangle"></span><span class="tooltip-content">To use this tool, select some works using the checkboxes below.</span></span></span></td></tr></tbody></table><span id="medium-toolbox"><button class="btn-link" id="expand-all-mediums" type="button">Expand all mediums</button> | <button class="btn-link" id="collapse-all-mediums" type="button">Collapse all mediums</button></span><table class="tbl" id="tracklist"><thead><tr><th class="pos t">#</th><th class="recordings"><input class="all-recordings" type="checkbox"> Recording (35 recordings selected)</th><th class="works"><input class="all-works" type="checkbox"> Related works (0 works selected)</th></tr></thead><tbody><tr class="subh"><td></td><td><input class="medium-recordings" id="medium-recordings-checkbox-2141987" type="checkbox"> <a class="expand-medium" href="/medium/45ae406b-c2a7-3403-a751-9fe18e340cdf" id="disc1"><span>1</span><span class="expand-triangle">‚ñº</span>CD</a></td><td><input class="medium-works" id="medium-works-checkbox-2141987" type="checkbox"></td></tr></tbody><tbody><tr class="track odd"><td class="pos t">1</td><td class="recording"><input class="recording" type="checkbox"> <a class="wrap-anywhere" target="_blank" href="/recording/96853f8b-da57-438a-b3b3-0eaf44f8597c"><bdi>Out in the Street</bdi></a> (5:02)<table class="rel-editor-table"><tbody><tr class="lead-vocals"><th class="link-phrase"><label>lead vocals:</label> <button class="icon add-item add-another-entity" title="Add another artist" aria-haspopup="dialog" type="button"></button></th><td class="relationship-list"><div class="relationship-item"><button class="icon remove-item" id="remove-relationship-artist-recording-10171920" type="button"></button><button class="icon edit-item" id="edit-relationship-artist-recording-10171920" aria-haspopup="dialog" type="button"></button> <span class="rel-noop"><a class="wrap-anywhere" target="_blank" href="/artist/70248960-cb53-4ea4-943a-edb18f7d336f" title="Springsteen, Bruce"><bdi>Bruce Springsteen</bdi></a> (on 1981-01-26)</span></div></td></tr><tr class="performer"><th class="link-phrase"><label>performer:</label> <button class="icon add-item add-another-entity" title="Add another artist" aria-haspopup="dialog" type="button"></button></th><td class="relationship-list"><div class="relationship-item"><button class="icon remove-item" id="remove-relationship-artist-recording-10171919" type="button"></button><button class="icon edit-item" id="edit-relationship-artist-recording-10171919" aria-haspopup="dialog" type="button"></button> <span class="rel-noop"><a class="wrap-anywhere" target="_blank" href="/artist/d6652e7b-33fe-49ef-8336-4c863b4f996f" title="E Street Band, The"><bdi>The E Street Band</bdi></a> (on 1981-01-26)</span></div></td></tr><tr class="recorded-at"><th class="link-phrase"><label>recorded at:</label> <button class="icon add-item add-another-entity" title="Add another event" aria-haspopup="dialog" type="button"></button></th><td class="relationship-list"><div class="relationship-item"><button class="icon remove-item" id="remove-relationship-event-recording-63542" type="button"></button><button class="icon edit-item" id="edit-relationship-event-recording-63542" aria-haspopup="dialog" type="button"></button> <span class="rel-noop"><a class="wrap-anywhere" target="_blank" href="/event/77e3d6eb-0aaa-4e5d-bd0e-21a91aa68f5b"><bdi>1981‚Äê01‚Äê26: Athletic &amp; Convocation Center, University of Notre Dame, South Bend, IN, USA</bdi></a> (1981-01-26) </span></div></td></tr><tr class="recorded-at"><th class="link-phrase"><label>recorded at:</label> <button class="icon add-item add-another-entity" title="Add another place" aria-haspopup="dialog" type="button"></button></th><td class="relationship-list"><div class="relationship-item"><button class="icon remove-item" id="remove-relationship-place-recording-1229474" type="button"></button><button class="icon edit-item" id="edit-relationship-place-recording-1229474" aria-haspopup="dialog" type="button"></button> <span class="rel-noop"><a class="wrap-anywhere" target="_blank" href="/place/083d7301-c8e2-4886-a972-42604d8c4e83"><bdi>Edmund P. Joyce Athletic &amp; Convocation Center</bdi></a> in <a target="_blank" href="/area/b6f9c5ef-1e4b-47b8-a81f-40bac4f95a87"><bdi>Notre Dame</bdi></a>, <a href="/area/cc55c78b-15c9-45dd-8ff4-4a212c54eff3"><bdi>Indiana</bdi></a>, <span class="flag flag-US"><a href="/area/489ce91b-6658-3307-9877-795b68554c98"><bdi>United States</bdi></a></span> (on 1981-01-26)</span></div></td></tr><tr class="recording-of"><th class="link-phrase"><label>recording of:</label> <button class="icon add-item add-another-entity" title="Add another work" aria-haspopup="dialog" type="button"></button></th><td class="relationship-list"><div class="relationship-item"><button class="icon remove-item" id="remove-relationship-recording-work-3496682" type="button"></button><button class="icon edit-item" id="edit-relationship-recording-work-3496682" aria-haspopup="dialog" type="button"></button> <span class="rel-noop"><a class="wrap-anywhere" target="_blank" href="/work/35fdc4a9-fd0a-3a68-a539-5b377464a3ac"><bdi>Out in the Street</bdi></a> (on 1981-01-26) (live)</span></div></td></tr><tr><td></td><td><label style="padding: 6px;"><input type="checkbox"> These relationships have a specific ordering</label></td></tr><tr><td class="add-relationship"><button class="add-item with-label add-relationship" aria-haspopup="dialog" type="button">Add relationship</button></td><td></td></tr></tbody></table></td><td class="works"><button class="add-item with-label" aria-haspopup="dialog" type="button">Add related work</button><h3><input class="work" type="checkbox"> <button class="icon remove-item" type="button"></button> <a class="wrap-anywhere" target="_blank" href="/work/35fdc4a9-fd0a-3a68-a539-5b377464a3ac"><bdi>Out in the Street</bdi></a></h3><table class="rel-editor-table"><tbody><tr class="publisher"><th class="link-phrase"><label>publisher:</label> <button class="icon add-item add-another-entity" title="Add another artist" aria-haspopup="dialog" type="button"></button></th><td class="relationship-list"><div class="relationship-item"><button class="icon remove-item" id="remove-relationship-artist-work-2749421" type="button"></button><button class="icon edit-item" id="edit-relationship-artist-work-2749421" aria-haspopup="dialog" type="button"></button> <span class="rel-noop"><a class="wrap-anywhere" target="_blank" href="/artist/70248960-cb53-4ea4-943a-edb18f7d336f" title="Springsteen, Bruce"><bdi>Bruce Springsteen</bdi></a> (in 1980)</span></div></td></tr><tr class="lyricist"><th class="link-phrase"><label>lyricist:</label> <button class="icon add-item add-another-entity" title="Add another artist" aria-haspopup="dialog" type="button"></button></th><td class="relationship-list"><div class="relationship-item"><button class="icon remove-item" id="remove-relationship-artist-work-298317" type="button"></button><button class="icon edit-item" id="edit-relationship-artist-work-298317" aria-haspopup="dialog" type="button"></button> <span class="rel-noop"><a class="wrap-anywhere" target="_blank" href="/artist/70248960-cb53-4ea4-943a-edb18f7d336f" title="Springsteen, Bruce"><bdi>Bruce Springsteen</bdi></a> (from 1979 until 1980)</span></div></td></tr><tr class="composer"><th class="link-phrase"><label>composer:</label> <button class="icon add-item add-another-entity" title="Add another artist" aria-haspopup="dialog" type="button"></button></th><td class="relationship-list"><div class="relationship-item"><button class="icon remove-item" id="remove-relationship-artist-work-298306" type="button"></button><button class="icon edit-item" id="edit-relationship-artist-work-298306" aria-haspopup="dialog" type="button"></button> <span class="rel-noop"><a class="wrap-anywhere" target="_blank" href="/artist/70248960-cb53-4ea4-943a-edb18f7d336f" title="Springsteen, Bruce"><bdi>Bruce Springsteen</bdi></a>
#+end_example

**** 7

#+begin_example
Got it: https://www.discogs.com/release/6889744
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Toggled buttons ON (display: flex)
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] AA: Injected custom buttons.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
3userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Checkbox event detected, updating visibility...
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
3userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Checkbox event detected, updating visibility...
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 3 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 3 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 3 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 3 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 3 checked recordings. Current display: flex
3userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Checkbox event detected, updating visibility...
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 4 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 4 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Visibility check: Selector found 4 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:33 [AA-add-instrument] Update visibility check called
#+end_example

**** 8

OK, below is the complete console output. Initially the checkboxes were already displayed (although NO record was selected - [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: none)
then I checkmarked 2 more (the count in the console output went up from 1->2->3) and unchecked them again (console output 3->2->1)

Somehow the script assumes that there is initially already a checked recording

#+begin_example
[AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Toggled buttons ON (display: flex)
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] AA: Injected custom buttons.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
3userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Checkbox event detected, updating visibility...
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
3userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Checkbox event detected, updating visibility...
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 3 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 3 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 3 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 3 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 3 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 3 checked recordings. Current display: flex
3userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Checkbox event detected, updating visibility...
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
3userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Checkbox event detected, updating visibility...
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
#+end_example

**** 9

#+begin_example
[AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Toggled buttons ON (display: flex)
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] AA: Injected custom buttons.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
#+end_example

**** 10

Now I get the following output, but the buttons NEVER appear:

#+begin_example
[AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] AA: Injected custom buttons.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
3userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Checkbox event detected, updating visibility...
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
3userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Checkbox event detected, updating visibility...
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
3userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Checkbox event detected, updating visibility...
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 0 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
#+end_example

**** 11

Now I get the following without doing anything (remeber this pages are React based)

#+begin_src bash
[AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Toggled buttons ON (display: flex)
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] AA: Injected custom buttons.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
#+end_src

Do you need the HTML code of the page again ?

#+begin_example
That is excellent news for the logic, but frustrating for the visibility!

The logs now prove that the visibility control is working perfectly: it correctly detects 1 checked recording and successfully changes the container's style from display: none to display: flex.

Since the code is forcing the container to be visible but you still can't see it, the container must be:

Hidden by an external CSS rule (e.g., overflow: hidden on a parent element).

Obscured by a higher-stacked element (a z-index issue).

Have zero height/width despite display: flex.

I'm updating the CSS of the button container to be more aggressive by adding a guaranteed width: 100%, a high z-index, and a bright blue border for debugging. If the border appears but the buttons don't, we know the container exists but is empty. If nothing appears, the container itself is being suppressed.

Please try this version. If you see a bright blue line, but no buttons, that would be a key piece of information!

If the blue border appears, then the container is injected correctly, and the issue is just the buttons inside it. If nothing appears, the entire container is being suppressed by a parent element's CSS. Let me know what you see!
#+end_example

**** 13

No, again the buttons appear right away, even if nothing is checked

#+begin_example
[AA-add-instrument] AA: Button creation finished. Expected: 4, Actually created/appended: 4
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] AA: Container check: It now has 4 children.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Toggled buttons ON (display: flex)
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] AA: Injected custom buttons.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
3userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Checkbox event detected, updating visibility...
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 2 checked recordings. Current display: flex
3userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Checkbox event detected, updating visibility...
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
#+end_example

**** 14

#+begin_example
[AA-add-instrument] Initial state fix: Found 1 checked checkboxes on load. Forcing uncheck.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Warning: Failed to uncheck all initial boxes. Still checked: 1
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: none
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Toggled buttons ON (display: flex)
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] AA: Injected custom buttons.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Visibility check: Selector found 1 checked recordings. Current display: flex
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called
#+end_example

**** final working version - buttons are preconfigured - show only if at least one recording is checked

#+begin_example
// ==UserScript==
// @name         Batch Add Relationships To Recordings
// @namespace    https://github.com/vzell/mb-userscripts
// @version      1.2.14+2025-11-28 (Aggressive initial uncheck to fix phantom checked state)
// @description  Insert artist buttons, open batch-add dialog, reliably fill relationship type (instruments|vocal|performed / performer), artist, instrument/vocal, credited-as, click Done ‚Äî sequential queue + dialog lifecycle awareness. Optimized for speed.
// @homepageURL  https://github.com/vzell/mb-userscripts
// @tag          vzell with the help of ChatGPT
// @downloadURL  https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @updateURL    https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    // *** DEBUGGING IS PERMANENTLY ENABLED ***
    const DEBUG = true;
    // *** DEBUGGING FOR VISIBILITY CHECKS (COUNT) ONLY (DISABLED by default) ***
    const DEBUG_VISIBILITY = false;

    const HEADING_SELECTOR = "h2:contains('Track relationships')";

    // --- OPTIMIZATION CONSTANTS ---
    const GLOBAL_CHAR_DELAY_MS = 10;
    const GLOBAL_POST_SELECT_WAIT_MS = 150;
    const SMALL_BREATHING_ROOM_MS = 150;
    const VISIBILITY_HEARTBEAT_MS = 500;


    function log(...args) {
        if (DEBUG) console.log('[AA-add-instrument]', ...args);
    }

    // --- Configuration for multiple Artist buttons (UNCHANGED) ---
    const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        },
        {
            label: "Bruce Springsteen",
            relationshipType: "vocal",
            artist: "Bruce Springsteen",
            vocal: "lead vocals",
            creditedAs: ""
        },
        {
            label: "E Street Band",
            relationshipType: "performed / performer",
            artist: "The E Street Band"
        }
    ];

    // ----------------- Utilities (UNCHANGED) -----------------
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
    async function waitVisible(selector, opts = {}) {
        const timeout = opts.timeout ?? 5000;
        const interval = opts.interval ?? 50;
        const start = Date.now();
        while (Date.now() - start < timeout) {
            const $el = $(selector).filter(':visible');
            if ($el.length) return $el;
            await sleep(interval);
        }
        return null;
    }
    async function waitDialogClosed(timeout = 2000) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            const $visibleDialogs = $('.modal, .Dialog, .dialog, .ui-dialog, .ui-widget-overlay').filter(':visible');
            if ($visibleDialogs.length === 0) {
                await sleep(SMALL_BREATHING_ROOM_MS);
                return true;
            }
            await sleep(50);
        }
        return false;
    }
    async function waitForCondition(conditionFn, {timeout = 3000, interval = 50} = {}) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            try {
                if (await conditionFn()) return true;
            } catch (e) { /* ignore */ }
            await sleep(interval);
        }
        return false;
    }
    function setReactValueAndDispatch(el, value) {
        try {
            const nativeSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
            if (nativeSetter) nativeSetter.call(el, value);
            else el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
            el.dispatchEvent(new InputEvent('input', { bubbles: true }));
        } catch (e) {
            el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }
    function clearInput(el) { setReactValueAndDispatch(el, ''); }
    async function typeAndSelect($input, text, {
        charDelay = GLOBAL_CHAR_DELAY_MS,
        postSelectWait = GLOBAL_POST_SELECT_WAIT_MS,
        optionSelector = "li[role='option']"
    } = {}) {
        const el = $input[0];
        if (!el) throw new Error('Input element missing');
        el.focus();
        clearInput(el);
        await sleep(50);
        for (let i = 0; i < text.length; i++) {
            const ch = text[i];
            const newValue = el.value + ch;
            setReactValueAndDispatch(el, newValue);
            await sleep(charDelay);
        }
        await sleep(100);
        const found = await waitForCondition(() => {
            const $opts = $(optionSelector).filter(':visible');
            if (!$opts.length) return false;
            const match = $opts.toArray().find(o => $(o).text().trim().toLowerCase().startsWith(text.toLowerCase()));
            if (match) { match.click(); return true; }
            const match2 = $opts.toArray().find(o => $(o).text().trim().toLowerCase().includes(text.toLowerCase()));
            if (match2) { match2.click(); return true; }
            return false;
        }, {timeout: 3000, interval: 80});
        if (!found) { log(`Warning: option for "${text}" not found in suggestions after timeout.`); }
        await sleep(postSelectWait);
    }
    async function openBatchAddDialog() {
        await waitDialogClosed(2000);
        const $batch = $("button.add-item.with-label.batch-add-recording-relationship, button.add-item.batch-add-recording-relationship, button.add-item.with-label").filter(function() {
            const t = $(this).text().toLowerCase();
            return t.includes('batch-add') || t.includes('batch add') || (t.includes('add') && t.includes('record'));
        });
        if ($batch.length === 0) { log("Batch-add button not found via selectors"); return false; }
        $batch[0].click();
        const appeared = await waitForCondition(() => {
            const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
            return $d.length > 0;
        }, {timeout: 3000, interval: 80});
        if (!appeared) { await sleep(300); }
        await sleep(SMALL_BREATHING_ROOM_MS);
        return true;
    }
    async function clickDoneAndWaitClose() {
        const $doneButton = await waitVisible('button.positive:visible', {timeout: 4000});
        if ($doneButton) {
            const $exactDone = $doneButton.filter((i, btn) => $(btn).text().trim() === 'Done');
            if ($exactDone.length) {
                log("Clicking Done");
                $exactDone[0].click();
                await waitForCondition(() => {
                    const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
                    return $d.length === 0;
                }, {timeout: 3000, interval: 80});
                await sleep(SMALL_BREATHING_ROOM_MS);
                return true;
            }
        }
        log("Done button not found (when trying to click Done).");
        return false;
    }

    // --- MODIFIED: Force the initial state to be clean using native click event ---
    function resetInitialState() {
        // Find all track relationship checkboxes (excluding 'work' checkboxes)
        const $allRecordings = $('#tracklist input[type="checkbox"]:not(.work)');
        const $checkedOnLoad = $allRecordings.filter(':checked');

        if ($checkedOnLoad.length > 0) {
            log(`Initial state fix: Found ${$checkedOnLoad.length} checked checkboxes on load. Forcing uncheck with aggressive click simulation.`);

            $checkedOnLoad.each(function() {
                const el = this;
                // Dispatch a native click event to trigger React's internal handler
                // This is generally more reliable than setting .checked property directly
                try {
                    el.dispatchEvent(new MouseEvent('click', { bubbles: true }));
                } catch(e) {
                    // Fallback to jQuery click if native fails
                    $(el).click();
                }
            });

            // Re-check state after a small wait to allow React to process the click event
            setTimeout(() => {
                const $stillChecked = $allRecordings.filter(':checked');
                if ($stillChecked.length > 0) {
                    log(`Warning: Aggressive uncheck failed. Still checked: ${$stillChecked.length}`);
                } else {
                    log("Initial state fix successful: 0 checked recordings after cleanup.");
                }
            }, 100);

            return true;
        }
        log("Initial state fix: Found 0 checked checkboxes on load. State is clean.");
        return false;
    }

    // ----------------- Filling sequence (UNCHANGED) -----------------
    async function fillFieldsAsync(config) {
        log(`Start filling for: ${config.label} (${config.relationshipType})`);
        const $relInput = await waitVisible('input.relationship-type', {timeout: 4000});
        if (!$relInput) { log("Relationship type input not found ‚Äî aborting this item."); return false; }
        log(`Typing relationshipType '${config.relationshipType}'`);
        await typeAndSelect($relInput, config.relationshipType);

        const $artist = await waitVisible('input[placeholder="Type to search, or paste an MBID"]', {timeout: 4000});
        if (!$artist) { log("Artist input not found ‚Äî aborting this item."); return false; }
        log(`Typing artist '${config.artist}'`);
        await typeAndSelect($artist, config.artist);

        if (config.relationshipType === 'performed / performer') {
            log("Performed / performer detected ‚Äî skipping instrument/vocal/credited-as and clicking Done.");
            await clickDoneAndWaitClose();
            log(`Finished performer item: ${config.label}`);
            return true;
        }

        const placeholderName = config.relationshipType === 'instruments' ? 'instrument' : 'vocal';

        if (config.relationshipType === 'instruments' || config.relationshipType === 'vocal') {
            const $inst = await waitVisible(`input[placeholder="${placeholderName}"]`, {timeout: 4000});
            if (!$inst) { log(`${placeholderName} input not found ‚Äî aborting this item.`); return false; }
            const desired = (config.relationshipType === 'instruments') ? config.instrument : config.vocal;
            if (desired && desired.length > 0) {
                log(`Typing ${placeholderName} '${desired}'`);
                await typeAndSelect($inst, desired);
            } else {
                log(`No ${placeholderName} value provided, skipping selection.`);
            }
        } else {
            log(`Relationship type '${config.relationshipType}' does not require instrument/vocal step; skipping.`);
        }

        log("Attempting to fill 'Credited as' field‚Ä¶");
        let $creditedInput = $('.attribute-credit:visible');
        if ($creditedInput.length === 0) {
            const $lastMulti = $('.multiselect:visible').filter((i, el) => {
                return $(el).find(`input[placeholder="${placeholderName}"]`).length > 0;
            }).last();
            if ($lastMulti && $lastMulti.length) {
                $creditedInput = $lastMulti.find('input.attribute-credit:visible');
            }
        }
        if ($creditedInput.length === 0) {
            if (config.relationshipType === 'instruments') {
                $creditedInput = $('.multiselect.instrument').last().find('input.attribute-credit:visible');
            } else if (config.relationshipType === 'vocal') {
                $creditedInput = $('.multiselect.vocal').last().find('input.attribute-credit:visible');
            }
        }
        if ($creditedInput.length === 0) {
            $creditedInput = $("input:visible").filter((i, el) => {
                const idn = (el.id || '').toLowerCase();
                const name = (el.name || '').toLowerCase();
                const cls = (el.className || '').toLowerCase();
                return idn.includes('credit') || name.includes('credit') || cls.includes('attribute-credit');
            }).first();
        }

        if ($creditedInput && $creditedInput.length) {
            const el = $creditedInput[0];
            const text = config.creditedAs ?? '';
            setReactValueAndDispatch(el, text);
            await sleep(100);
            log(`'Credited as' set to "${text}"`);
        } else {
            log("Could not find credited-as input (it's optional); continuing.");
        }

        const doneClicked = await clickDoneAndWaitClose();
        if (doneClicked) {
            log(`Finished item: ${config.label}`);
            return true;
        } else {
            log("Done not clicked (not found) ‚Äî but continuing.");
            return true;
        }
    }

    // ----------------- Queue to process clicks sequentially (UNCHANGED) -----------------
    const queue = [];
    let processing = false;

    async function processQueue() {
        if (processing) return;
        processing = true;
        while (queue.length) {
            const config = queue.shift();
            try {
                log(`Processing queue item: ${config.label}`);
                const opened = await openBatchAddDialog();
                if (!opened) {
                    log("Could not open batch-add dialog ‚Äî skipping this item.");
                    await sleep(SMALL_BREATHING_ROOM_MS);
                    continue;
                }
                await fillFieldsAsync(config);
                await sleep(200);
            } catch (e) {
                console.error('[AA-add-instrument] Error processing item', e);
                await sleep(500);
            }
        }
        processing = false;
        log("Batch processing queue finished.");
    }

    // ----------------- UI: create buttons (UNCHANGED) -----------------
    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        // Check if container already exists
        const $existingContainer = $heading.next('.injected-buttons-container');
        if ($existingContainer.length > 0) {
             return;
        }

        // Create container, explicitly set to hidden, then append
        const $container = $(`
            <div
                class="injected-buttons-container"
                style="
                    display: none; /* Must be hidden initially */
                    align-items: center;
                    gap: 10px;
                    flex-wrap: wrap;
                    margin-top: 10px;
                    margin-bottom: 5px;
                    padding: 10px 0;
                    width: 100%;
                    z-index: 1000;
                ">
            </div>
        `);

        $heading.after($container);

        ARTIST_BUTTONS.forEach(config => {
            const STYLE_CONFIG = {
                'instruments': { bgColor: '#4CAF50', activeColor: '#3e8e41', icon: 'üé∏ ' },
                'vocal': { bgColor: '#2196F3', activeColor: '#0b7dda', icon: 'üé§ ' },
                'performed / performer': { bgColor: '#FF9800', activeColor: '#e68a00', icon: 'üé≠ ' },
                'default': { bgColor: '#607D8B', activeColor: '#455a64', icon: 'üîó ' }
            };

            const style = STYLE_CONFIG[config.relationshipType] || STYLE_CONFIG['default'];
            const buttonText = `${style.icon}${config.label}`;

            const buttonStyleString = `
                background-color: ${style.bgColor};
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.15s ease-in-out;
                white-space: nowrap;
                flex-shrink: 0;
                line-height: 20px;
            `;

            const $button = $('<button/>', {
                text: buttonText,
                'data-label': config.label
            });

            $button.attr('style', buttonStyleString);

            $button.on({
                'mouseenter': function() { $(this).css('opacity', 0.9); },
                'mouseleave': function() { $(this).css('opacity', 1); },
                'click': function() {
                    $(this).css('background-color', style.activeColor);
                    setTimeout(() => $(this).css('background-color', style.bgColor), 500);
                }
            });

            $container.append($button);

            $button.on('click', () => {
                log(`Enqueued "${config.label}" (${config.relationshipType})`);
                queue.push(Object.assign({}, config));
                processQueue().catch(e => console.error(e));
            });
        });

        // --- VISIBILITY LOGIC START: FINAL, ROBUST SELECTOR ---

        function getCheckedRecordings() {
            // Target any checked checkbox inside the #tracklist area
            // that is NOT related to 'work' relationships.
            const $checkedRecordings = $('#tracklist input[type="checkbox"]:checked:not(.work)');
            return $checkedRecordings;
        }

        // Function to toggle visibility based on checkboxes
        function updateButtonVisibility() {
            log("Update visibility check called.");

            const $checked = getCheckedRecordings();
            const checkedCount = $checked.length;
            const anyChecked = checkedCount > 0;

            const currentDisplay = $container.css('display');

            // Log status for debugging, now controlled by DEBUG_VISIBILITY
            if (DEBUG_VISIBILITY) {
                 log(`Visibility check: Selector found ${checkedCount} checked recordings. Current display: ${currentDisplay}`);
            }

            // Handle contradiction (Buttons visible but nothing checked)
            if (currentDisplay === 'flex' && checkedCount === 0) {
                 log("!!! CONTRADICTION: Buttons are visible, but 0 tracks are checked. Forcing OFF.");
                 $container.css('display', 'none');
                 return;
            }

            if (anyChecked) {
                // Show if currently hidden
                if (currentDisplay === 'none') {
                    $container.css('display', 'flex');
                    log("Toggled buttons ON (display: flex)");
                }
            } else {
                // Hide if currently visible
                if (currentDisplay === 'flex') {
                    $container.css('display', 'none');
                    log("Toggled buttons OFF (display: none)");
                }
            }
        }

        // 1. Run once immediately to set initial state correctly
        updateButtonVisibility();

        // 2. Listen for interactions (using the more general #tracklist selector)
        $('#tracklist').on('change click input', 'input[type="checkbox"]', function() {
            log("Checkbox event detected, updating visibility...");
            // Use a short delay just in case the check/uncheck DOM update is slightly asynchronous
            setTimeout(updateButtonVisibility, 50);
        });

        // 3. Fallback heartbeat
        setInterval(updateButtonVisibility, VISIBILITY_HEARTBEAT_MS);
        // --- VISIBILITY LOGIC END ---

        log("AA: Injected custom buttons.");
    }

    // Start with a slightly longer delay (2000ms) to ensure React loads,
    // run the cleanup, then create buttons.
    setTimeout(() => {
        // Step 1: Clean up any initial, unchecked state
        resetInitialState();

        // Step 2: Inject buttons
        createCustomButtons();
    }, 2000);

})();
#+end_example

**** adding a config dialog

Please add a new button at the very beginning of all the other buttons, but make it always visible with the button text
"‚öôÔ∏è Configure".  When pressed present an UI which which it should be possible to configure the "const ARTIST_BUTTONS"
variable, initially populated from the current value:

#+begin_example
    const ARTIST_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            creditedAs: ""
        },
        {
            label: "Bruce Springsteen",
            relationshipType: "vocal",
            artist: "Bruce Springsteen",
            vocal: "lead vocals",
            creditedAs: ""
        },
        {
            label: "E Street Band",
            relationshipType: "performed / performer",
            artist: "The E Street Band"
        }
    ];
#+end_example

It should be possible to add new and remove existing entries from the structure and persist the resulting data to
browser storage, so that different kind of users are supported.

**** 1

The buttons are created, but nothing happens when pressed. Here the console ouput:

#+begin_example
[AA-add-instrument] Using default hardcoded button configuration.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Initial state fix: Found 1 checked checkboxes on load. Forcing uncheck with aggressive click simulation.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] !!! CONTRADICTION: Batch buttons are visible, but 0 tracks checked. Forcing OFF.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] AA: Injected custom buttons and configuration.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Initial state fix successful: 0 checked recordings after cleanup.
250userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Saved 5 button configurations to localStorage.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Configuration saved and buttons updated.
7userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
3userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Checkbox event detected, updating visibility...
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Toggled batch buttons ON (display: flex)
39userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Enqueued "Clarence Clemons" (instruments)
helpers.js:119 Uncaught ReferenceError: queue is not defined
(anonymous) @ userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:483
dispatch @ userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:3
v.handle @ userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:3
r @ helpers.js:97
17userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Enqueued "Clarence Clemons" (instruments)
helpers.js:119 Uncaught ReferenceError: queue is not defined
(anonymous) @ userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:483
dispatch @ userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:3
v.handle @ userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:3
r @ helpers.js:97
4userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Enqueued "E Street Band" (performed / performer)
helpers.js:119 Uncaught ReferenceError: queue is not defined
(anonymous) @ userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:483
dispatch @ userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:3
v.handle @ userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:3
r @ helpers.js:97
98userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
3userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Checkbox event detected, updating visibility...
8userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Enqueued "Garry Tallent" (instruments)
helpers.js:119 Uncaught ReferenceError: queue is not defined
(anonymous) @ userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:483
dispatch @ userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:3
v.handle @ userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:3
r @ helpers.js:97
49userscript.html?name=Batch-Add-Relationships-To-Recordings.user.js&id=fb0ca461-f2ac-4e46-8869-a35c80afece8:35 [AA-add-instrument] Update visibility check called.
#+end_example

**** 2

Now it works perfect. Can the "Configure" button have the text in 2 lines like "Configure\nrec. relations" but still with the icon in front

**** 3

1.) Please change in the log output the prefix "[AA-add-instrument]" to "[add-recording-relations]".
2.) Change the "Configure" button text to "Configure\nrecording relations" but still with the icon in front.
3.) Make sure when new buttons are added they get inserted after the other buttons of the same "Relationship type" like "instruments".
4.) To close the UI it should also be possible to press the "Esc" key when nothing has changed,
    but if something has been changed, pressing the "Esc" key should provide a warning and ask if the data sould be saved or ignored

**** 4

Actually the UI currently doesn't show the data of

#+begin_example
        {
            label: "E Street Band",
            relationshipType: "performed / performer",
            artist: "The E Street Band"
        }
#+end_example

although the button IS present.

1.) Change the "Configure" button text to "Configure\nrecording relations" but still with the icon in front.
2.) fix the UI to also show the "E Street Band" performer
3.) the UI should NOT present the
    - "Vocal (if type='vocal')" field when the actual "Relationship Type" is "instruments"
    - "Instrument (if type='instruments')" field when the actual "Relationship Type" is "vocal"
    - "Vocal (if type='vocal')" field and "Instrument (if type='instruments')" field when the actual "Relationship Type" is "performed / performer"

**** 5

There is still a glitch when the 'relationshipType:' is '"performed / performer"'.
In that case what you currently have generated

#+begin_example
        {
            label: "E Street Band",
            relationshipType: "performed / performer",
            artist: "The E Street Band",
            // These fields are intentionally empty for "performed / performer"
            instrument: "",
            vocal: "",
            creditedAs: ""
        }
#+end_example

should really be

#+begin_example
        {
            label: "E Street Band",
            relationshipType: "performed / performer",
            artist: "The E Street Band"
        }
#+end_example

as there are NO fields like "instrument", "vocal" and "creditedAs" for that specific relationshipType.


1.) Change the "Configure" button text to "Configure recording\nrelation buttons" but still with the icon in front.
2.) The UI should also not present "Credite As:" for the 'relationshipType: "performed / performer"' as it currently does

**** new button dialog on it's own

Everything works perfect so far. A couple of enhancements are still needed.

1.) The blue "Add New Button" button should also show the same behaviour like the "Save & Reload Buttons" button, the mouse pointer should change to a pointing finger when hover over it.
2.) Both buttons should stay at the bottom of the UI dialog, even when scrolling the configuration entries for other buttons, they should NOT move when using the scroll bar
3.) Wen pressing the blue "Add New Button" button a new dialog should open just for entering the new data for the new button configuration instead of positioning it right at the end of the other "instruments" based buttons.

**** add default

Almost perfect. Please add the additional functionality of

1.) When entering the value for the "Label" of the button, the initial default value for the "Artist Name" should be the same. After leaving the "Label" field the first time, the "Artist Name" should be separately be edited if the value should change
2.) When pressing the red "Remove" button only that specific configuration entry should be removed (and it's button). Right now what has happened

I had two entries

#+begin_example
        {
            label: "Patti Scialfa",
            relationshipType: "vocal",
            artist: "Patti Scialfa",
            instrument: "",
            vocal: "background vocals",
            creditedAs: "harmony"
        },
        {
            label: "Patti Scialfa",
            relationshipType: "vocal",
            artist: "Patti Scialfa",
            instrument: "",
            vocal: "background vocals",
            creditedAs: ""
        }
#+end_example

and when I remove one, actually both were removed

#+begin_example
// ==UserScript==
// @name         Batch Add Relationships To Recordings
// @namespace    https://github.com/vzell/mb-userscripts
// @version      1.6.2+2025-11-28 (Feature: Linked fields in Add-Modal, unique removal fix)
// @description  Insert artist buttons, open batch-add dialog, reliably fill relationship type (instruments|vocal|performed / performer), artist, instrument/vocal, credited-as, click Done ‚Äî sequential queue + dialog lifecycle awareness. Optimized for speed.
// @homepageURL  https://github.com/vzell/mb-userscripts
// @tag          vzell with the help of ChatGPT
// @downloadURL  https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @updateURL    https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    // *** DEBUGGING FLAGS ***
    const DEBUG = true;
    const DEBUG_VISIBILITY = false;

    // --- CONSTANTS ---
    const LOG_PREFIX = '[add-recording-relations]';
    const STORAGE_KEY = 'mb_batch_add_buttons_config';
    const HEADING_SELECTOR = "h2:contains('Track relationships')";
    const GLOBAL_CHAR_DELAY_MS = 10;
    const GLOBAL_POST_SELECT_WAIT_MS = 150;
    const SMALL_BREATHING_ROOM_MS = 150;
    const VISIBILITY_HEARTBEAT_MS = 500;

    // Define the order for sorting buttons
    const RELATIONSHIP_ORDER = {
        'instruments': 1,
        'vocal': 2,
        'performed / performer': 3,
        'default': 99
    };

    function log(...args) {
        if (DEBUG) console.log(LOG_PREFIX, ...args);
    }

    // --- Sorting Utility ---
    function sortButtons(buttons) {
        // Sorts the passed array in place based on relationship type order
        buttons.sort((a, b) => {
            const orderA = RELATIONSHIP_ORDER[a.relationshipType] || RELATIONSHIP_ORDER['default'];
            const orderB = RELATIONSHIP_ORDER[b.relationshipType] || RELATIONSHIP_ORDER['default'];

            // Secondary sort by label for consistency within groups
            if (orderA === orderB) {
                return a.label.localeCompare(b.label);
            }
            return orderA - orderB;
        });
        return buttons;
    }

    // --- DEFAULT CONFIGURATION ---
    const DEFAULT_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            vocal: "", // Kept here for consistency in the configuration object structure
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            vocal: "",
            creditedAs: ""
        },
        {
            label: "Bruce Springsteen",
            relationshipType: "vocal",
            artist: "Bruce Springsteen",
            instrument: "",
            vocal: "lead vocals",
            creditedAs: ""
        },
        {
            label: "E Street Band",
            relationshipType: "performed / performer",
            artist: "The E Street Band"
        }
    ];

    // --- STATE & PERSISTENCE ---
    let ARTIST_BUTTONS = [];

    // --- CRITICAL: GLOBAL QUEUE AND PROCESSING STATE ---
    const queue = [];
    let processing = false;

    // Helper to provide a full default object structure for merging
    const FULL_DEFAULT_BUTTON = {
        label: 'New Button',
        relationshipType: 'instruments',
        artist: '',
        instrument: '',
        vocal: '',
        creditedAs: '',
    };

    function getInitialButtons() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const parsed = JSON.parse(stored);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    log("Loaded button configuration from localStorage.");
                    const loadedButtons = parsed.map(btn => ({
                        ...FULL_DEFAULT_BUTTON, // Use default to ensure all keys exist
                        ...btn,                // Overwrite with stored values
                        // Ensure all required fields for instruments/vocal are there, even if empty
                        instrument: btn.instrument || '',
                        vocal: btn.vocal || '',
                        creditedAs: btn.creditedAs || '',
                    }));
                    return sortButtons(loadedButtons);
                }
            }
        } catch (e) {
            console.error(LOG_PREFIX, "Error loading buttons from localStorage, using default.", e);
        }
        log("Using default hardcoded button configuration.");
        return sortButtons(DEFAULT_BUTTONS.map(btn => ({...FULL_DEFAULT_BUTTON, ...btn})));
    }

    function saveButtons(buttons) {
        try {
            // 1. Filter out invalid/empty buttons
            const safeButtons = buttons.filter(btn => btn.label && btn.label.trim() !== '' && btn.artist && btn.artist.trim() !== '');

            // 2. Map and clean: only save relevant fields based on relationship type
            const cleanedButtons = safeButtons.map(btn => {
                const clean = {
                    label: btn.label,
                    relationshipType: btn.relationshipType,
                    artist: btn.artist,
                };

                if (btn.relationshipType === 'instruments') {
                    clean.instrument = btn.instrument;
                    clean.creditedAs = btn.creditedAs;
                } else if (btn.relationshipType === 'vocal') {
                    clean.vocal = btn.vocal;
                    clean.creditedAs = btn.creditedAs;
                }
                // For 'performed / performer', instrument, vocal, and creditedAs are omitted.
                return clean;
            });

            const sortedButtons = sortButtons(cleanedButtons);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(sortedButtons));
            log(`Saved ${sortedButtons.length} button configurations to localStorage.`);
            return sortedButtons;
        } catch (e) {
            console.error(LOG_PREFIX, "Error saving buttons to localStorage.", e);
            return buttons;
        }
    }

    // Initialize the buttons
    ARTIST_BUTTONS = getInitialButtons();


    // ----------------- Utilities -----------------
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
    async function waitVisible(selector, opts = {}) {
        const timeout = opts.timeout ?? 5000;
        const interval = opts.interval ?? 50;
        const start = Date.now();
        while (Date.now() - start < timeout) {
            const $el = $(selector).filter(':visible');
            if ($el.length) return $el;
            await sleep(interval);
        }
        return null;
    }
    async function waitDialogClosed(timeout = 2000) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            // Check for both the main modals and the specific config overlays
            const $visibleDialogs = $('.modal, .Dialog, .dialog, .ui-dialog, .ui-widget-overlay, #aa-config-modal-overlay, #aa-add-new-modal-overlay').filter(':visible');
            if ($visibleDialogs.length === 0) {
                await sleep(SMALL_BREATHING_ROOM_MS);
                return true;
            }
            await sleep(50);
        }
        return false;
    }
    async function waitForCondition(conditionFn, {timeout = 3000, interval = 50} = {}) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            try {
                if (await conditionFn()) return true;
            } catch (e) { /* ignore */ }
            await sleep(interval);
        }
        return false;
    }
    function setReactValueAndDispatch(el, value) {
        try {
            const nativeSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
            if (nativeSetter) nativeSetter.call(el, value);
            else el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
            el.dispatchEvent(new InputEvent('input', { bubbles: true }));
        } catch (e) {
            el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }
    function clearInput(el) { setReactValueAndDispatch(el, ''); }
    async function typeAndSelect($input, text, {
        charDelay = GLOBAL_CHAR_DELAY_MS,
        postSelectWait = GLOBAL_POST_SELECT_WAIT_MS,
        optionSelector = "li[role='option']"
    } = {}) {
        const el = $input[0];
        if (!el) throw new Error('Input element missing');
        el.focus();
        clearInput(el);
        await sleep(50);
        for (let i = 0; i < text.length; i++) {
            const ch = text[i];
            const newValue = el.value + ch;
            setReactValueAndDispatch(el, newValue);
            await sleep(charDelay);
        }
        await sleep(100);
        const found = await waitForCondition(() => {
            const $opts = $(optionSelector).filter(':visible');
            if (!$opts.length) return false;
            const match = $opts.toArray().find(o => $(o).text().trim().toLowerCase().startsWith(text.toLowerCase()));
            if (match) { match.click(); return true; }
            const match2 = $opts.toArray().find(o => $(o).text().trim().toLowerCase().includes(text.toLowerCase()));
            if (match2) { match2.click(); return true; }
            return false;
        }, {timeout: 3000, interval: 80});
        if (!found) { log(`Warning: option for "${text}" not found in suggestions after timeout.`); }
        await sleep(postSelectWait);
    }
    async function openBatchAddDialog() {
        await waitDialogClosed(2000);
        const $batch = $("button.add-item.with-label.batch-add-recording-relationship, button.add-item.batch-add-recording-relationship, button.add-item.with-label").filter(function() {
            const t = $(this).text().toLowerCase();
            return t.includes('batch-add') || t.includes('batch add') || (t.includes('add') && t.includes('record'));
        });
        if ($batch.length === 0) { log("Batch-add button not found via selectors"); return false; }
        $batch[0].click();
        const appeared = await waitForCondition(() => {
            const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
            return $d.length > 0;
        }, {timeout: 3000, interval: 80});
        if (!appeared) { await sleep(300); }
        await sleep(SMALL_BREATHING_ROOM_MS);
        return true;
    }
    async function clickDoneAndWaitClose() {
        const $doneButton = await waitVisible('button.positive:visible', {timeout: 4000});
        if ($doneButton) {
            const $exactDone = $doneButton.filter((i, btn) => $(btn).text().trim() === 'Done');
            if ($exactDone.length) {
                log("Clicking Done");
                $exactDone[0].click();
                await waitForCondition(() => {
                    const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
                    return $d.length === 0;
                }, {timeout: 3000, interval: 80});
                await sleep(SMALL_BREATHING_ROOM_MS);
                return true;
            }
        }
        log("Done button not found (when trying to click Done).");
        return false;
    }

    // --- Initial State Cleanup ---
    function resetInitialState() {
        const $allRecordings = $('#tracklist input[type="checkbox"]:not(.work)');
        const $checkedOnLoad = $allRecordings.filter(':checked');

        if ($checkedOnLoad.length > 0) {
            log(`Initial state fix: Found ${$checkedOnLoad.length} checked checkboxes on load. Forcing uncheck with aggressive click simulation.`);

            $checkedOnLoad.each(function() {
                const el = this;
                try {
                    el.dispatchEvent(new MouseEvent('click', { bubbles: true }));
                } catch(e) {
                    $(el).click();
                }
            });

            setTimeout(() => {
                const $stillChecked = $allRecordings.filter(':checked');
                if ($stillChecked.length > 0) {
                    log(`Warning: Aggressive uncheck failed. Still checked: ${$stillChecked.length}`);
                } else {
                    log("Initial state fix successful: 0 checked recordings after cleanup.");
                }
            }, 100);

            return true;
        }
        log("Initial state fix: Found 0 checked checkboxes on load. State is clean.");
        return false;
    }

    // ----------------- Filling sequence -----------------
    async function fillFieldsAsync(config) {
        log(`Start filling for: ${config.label} (${config.relationshipType})`);
        const $relInput = await waitVisible('input.relationship-type', {timeout: 4000});
        if (!$relInput) { log("Relationship type input not found ‚Äî aborting this item."); return false; }
        log(`Typing relationshipType '${config.relationshipType}'`);
        await typeAndSelect($relInput, config.relationshipType);

        const $artist = await waitVisible('input[placeholder="Type to search, or paste an MBID"]', {timeout: 4000});
        if (!$artist) { log("Artist input not found ‚Äî aborting this item."); return false; }
        log(`Typing artist '${config.artist}'`);
        await typeAndSelect($artist, config.artist);

        if (config.relationshipType === 'performed / performer') {
            // This relationship type does not have instrument, vocal, or credited-as fields.
            log("Performed / performer detected ‚Äî skipping attributes and clicking Done.");
            await clickDoneAndWaitClose();
            log(`Finished performer item: ${config.label}`);
            return true;
        }

        const placeholderName = config.relationshipType === 'instruments' ? 'instrument' : 'vocal';

        // Fill Instrument/Vocal
        if (config.relationshipType === 'instruments' || config.relationshipType === 'vocal') {
            const $inst = await waitVisible(`input[placeholder="${placeholderName}"]`, {timeout: 4000});
            if (!$inst) { log(`${placeholderName} input not found ‚Äî aborting this item.`); return false; }
            const desired = (config.relationshipType === 'instruments') ? config.instrument : config.vocal;
            if (desired && desired.length > 0) {
                log(`Typing ${placeholderName} '${desired}'`);
                await typeAndSelect($inst, desired);
            } else {
                log(`No ${placeholderName} value provided, skipping selection.`);
            }
        }

        // Fill Credited As
        const creditedAsValue = config.creditedAs ?? '';

        if (config.relationshipType !== 'performed / performer' && creditedAsValue.length > 0) {
            log("Attempting to fill 'Credited as' field‚Ä¶");
            // Find the visible 'credited as' input, prioritizing the one associated with the relationship type
            let $creditedInput = $("input:visible").filter((i, el) => {
                const cls = (el.className || '').toLowerCase();
                return cls.includes('attribute-credit');
            }).first();

            // Fallback strategy if initial filter is too broad/narrow
            if ($creditedInput.length === 0) {
                 $creditedInput = $("input:visible").filter((i, el) => {
                    const idn = (el.id || '').toLowerCase();
                    const name = (el.name || '').toLowerCase();
                    return idn.includes('credit') || name.includes('credit');
                }).first();
            }

            if ($creditedInput && $creditedInput.length) {
                const el = $creditedInput[0];
                setReactValueAndDispatch(el, creditedAsValue);
                await sleep(100);
                log(`'Credited as' set to "${creditedAsValue}"`);
            } else {
                log("Could not find credited-as input; skipping.");
            }
        } else {
            log("Skipping 'Credited as' filling (either not relevant or no value provided).");
        }

        const doneClicked = await clickDoneAndWaitClose();
        if (doneClicked) {
            log(`Finished item: ${config.label}`);
            return true;
        } else {
            log("Done not clicked (not found) ‚Äî but continuing.");
            return true;
        }
    }


    // ----------------- Queue Processing -----------------

    async function processQueue() {
        if (processing) return;
        processing = true;
        while (queue.length) {
            const config = queue.shift();
            try {
                log(`Processing queue item: ${config.label}`);
                const opened = await openBatchAddDialog();
                if (!opened) {
                    log("Could not open batch-add dialog ‚Äî skipping this item.");
                    await sleep(SMALL_BREATHING_ROOM_MS);
                    continue;
                }
                await fillFieldsAsync(config);
                await sleep(200);
            } catch (e) {
                console.error(LOG_PREFIX, "Error processing item", e);
                await sleep(500);
            }
        }
        processing = false;
        log("Batch processing queue finished.");
    }


    // ----------------- Modal UI -----------------

    // Function to dynamically show/hide fields based on relationship type
    function updateFieldVisibility($item) {
        const type = $item.find('select[name="relationshipType"]').val();

        // Hide all dynamic fields first
        $item.find('.instrument-field').hide();
        $item.find('.vocal-field').hide();
        $item.find('.creditedAs-field').show(); // Default to visible

        if (type === 'instruments') {
            $item.find('.instrument-field').show();
        } else if (type === 'vocal') {
            $item.find('.vocal-field').show();
        } else if (type === 'performed / performer') {
            // Hide all attribute fields for this type
            $item.find('.creditedAs-field').hide();
        }
    }

    function showAddButtonModal(saveCallback) {
        // Ensure only one modal is present
        $('#aa-add-new-modal-overlay').remove();

        const MODAL_STYLE = `
            #aa-add-new-modal-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.75); z-index: 10000; /* Higher Z-index than main config modal */
                display: flex; justify-content: center; align-items: center;
            }
            #aa-add-new-modal {
                background: white; padding: 20px; border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); max-width: 500px;
                width: 90%;
                font-family: Arial, sans-serif; color: #333;
            }
            #aa-add-new-modal h4 { margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
            #aa-add-new-modal label { display: block; margin-top: 8px; font-weight: bold; font-size: 0.9em; }
            #aa-add-new-modal input, #aa-add-new-modal select {
                width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box;
                border: 1px solid #ccc; border-radius: 4px;
            }
            .aa-add-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
            .aa-add-footer button { padding: 8px 15px; cursor: pointer; border-radius: 4px; border: none; }
            .aa-add-save-btn { background-color: #4CAF50; color: white; }
            .aa-add-cancel-btn { background-color: #ccc; color: #333; }
        `;

        // Add the new style block
        if ($('#aa-add-new-modal-style').length === 0) {
             $('head').append(`<style id="aa-add-new-modal-style">${MODAL_STYLE}</style>`);
        }

        const $overlay = $('<div id="aa-add-new-modal-overlay">');
        const $modal = $('<div id="aa-add-new-modal">');

        $modal.html(`
            <h4>Add New Button Configuration</h4>
            <div id="aa-add-form">
                <label>Label (Button Text): <input type="text" name="label" value="" placeholder="E.g., Max Weinberg"></label>

                <label>Relationship Type:
                    <select name="relationshipType">
                        <option value="instruments">instruments</option>
                        <option value="vocal">vocal</option>
                        <option value="performed / performer">performed / performer</option>
                    </select>
                </label>
                <label>Artist Name: <input type="text" name="artist" value="" placeholder="E.g., Max Weinberg (required)"></label>

                <!-- DYNAMIC FIELDS -->
                <label class="instrument-field">Instrument (if type='instruments'): <input type="text" name="instrument" value="" placeholder="E.g., drums (drum set)"></label>
                <label class="vocal-field">Vocal (if type='vocal'): <input type="text" name="vocal" value="" placeholder="E.g., lead vocals"></label>
                <label class="creditedAs-field">Credited As: <input type="text" name="creditedAs" value="" placeholder="E.g., drums"></label>
            </div>
            <div class="aa-add-footer">
                <button class="aa-add-cancel-btn">Cancel</button>
                <button class="aa-add-save-btn">Add Button</button>
            </div>
        `);

        const $form = $modal.find('#aa-add-form');
        const $select = $form.find(`select[name="relationshipType"]`);
        const $labelInput = $form.find('input[name="label"]');
        const $artistInput = $form.find('input[name="artist"]');

        let artistEditedManually = false;

        // 1. Artist Sync Logic
        $artistInput.on('input', () => {
            // Once the user types anything in the artist field, disable syncing
            artistEditedManually = true;
        });

        $labelInput.on('input', function() {
            if (!artistEditedManually) {
                // Only sync if the artist field hasn't been manually touched
                $artistInput.val($(this).val());
            }
        });

        // 2. Field Visibility Logic
        const updateAddModalVisibility = () => {
             // Use the same logic as the main modal updateFieldVisibility
             const type = $select.val();
             $form.find('.instrument-field').hide();
             $form.find('.vocal-field').hide();
             $form.find('.creditedAs-field').show();

             if (type === 'instruments') {
                 $form.find('.instrument-field').show();
             } else if (type === 'vocal') {
                 $form.find('.vocal-field').show();
             } else if (type === 'performed / performer') {
                 $form.find('.creditedAs-field').hide();
             }
        };

        // Initial visibility
        updateAddModalVisibility();

        // Add change listener for dynamic visibility
        $select.on('change', updateAddModalVisibility);

        const cleanupAndClose = () => {
            $(document).off('keydown', escapeHandler);
            $overlay.remove();
        }

        $modal.on('click', '.aa-add-cancel-btn', cleanupAndClose);

        $modal.on('click', '.aa-add-save-btn', function() {
            const newButton = {
                label: $labelInput.val().trim(),
                relationshipType: $select.val(),
                artist: $artistInput.val().trim(),
                instrument: $form.find('input[name="instrument"]').val().trim(),
                vocal: $form.find('input[name="vocal"]').val().trim(),
                creditedAs: $form.find('input[name="creditedAs"]').val().trim(),
            };

            if (!newButton.label || !newButton.artist) {
                // Using alert() here as it is inside a custom modal flow and should be seen
                alert("Both Label and Artist Name are required to add a new button.");
                return;
            }

            saveCallback(newButton);
            cleanupAndClose();
        });

        // Escape Key Handler
        const escapeHandler = function(e) {
            const isInput = $(e.target).is('input, select, textarea');
            if (e.key === 'Escape' && !isInput) {
                e.preventDefault();
                e.stopPropagation();
                cleanupAndClose();
            }
        };

        $(document).on('keydown', escapeHandler);

        $overlay.append($modal);
        $('body').append($overlay);
    }

    function showConfigModal() {
        // Ensure only one modal is present
        $('#aa-config-modal-overlay').remove();

        // Deep clone the current buttons for local manipulation
        // Note: currentButtons will be dynamically replaced by getCurrentConfigFromForm(true)
        // when changes occur in the DOM, making it match the current view.
        let currentButtons = ARTIST_BUTTONS.map(a => Object.assign({}, a));

        // Capture the initial state string (must be sorted for a reliable comparison)
        const initialConfigString = JSON.stringify(sortButtons(currentButtons.map(a => Object.assign({}, a))));

        const MODAL_STYLE = `
            #aa-config-modal-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.75); z-index: 9999;
                display: flex; justify-content: center; align-items: center;
            }
            #aa-config-modal {
                background: white; padding: 20px; border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); max-width: 800px;
                width: 90%; max-height: 90%;
                font-family: Arial, sans-serif; color: #333;
                display: flex; /* Flex container for scrollable content + fixed footer */
                flex-direction: column;
            }
            #aa-config-modal h3 { margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px; flex-shrink: 0; }

            #aa-config-scroll-area {
                overflow-y: auto; /* Scrollable content area */
                flex-grow: 1;
                padding-right: 5px; /* Add slight padding for scrollbar visibility */
            }

            .aa-config-item {
                border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 6px;
                background-color: #f9f9f9;
            }
            .aa-config-item h4 { margin: 0 0 10px 0; display: flex; justify-content: space-between; align-items: center; }
            .aa-config-item label { display: block; margin-top: 8px; font-weight: bold; font-size: 0.9em; }
            .aa-config-item input, .aa-config-item select {
                width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box;
                border: 1px solid #ccc; border-radius: 4px;
            }
            /* FIXED FOOTER STYLE */
            .aa-config-footer {
                display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px;
                border-top: 1px solid #ccc;
                flex-shrink: 0;
            }
            .aa-config-footer button {
                padding: 8px 15px; cursor: pointer; border-radius: 4px; border: none;
                font-weight: bold;
            }
            .aa-remove-btn { background-color: #f44336; color: white; border: none; padding: 4px 8px; font-size: 0.8em; cursor: pointer; }
            .aa-add-btn, .aa-save-btn { /* Apply cursor to Add New button */
                cursor: pointer;
            }
            .aa-add-btn { background-color: #007bff; color: white; border: none; }
            .aa-save-btn { background-color: #4CAF50; color: white; border: none; }
            .aa-close-btn { background-color: #ccc; color: #333; border: none; cursor: pointer; }
        `;

        // Apply styles
        if ($('#aa-config-modal-style').length === 0) {
             $('head').append(`<style id="aa-config-modal-style">${MODAL_STYLE}</style>`);
        }


        const $overlay = $('<div id="aa-config-modal-overlay">');
        const $modal = $('<div id="aa-config-modal">');
        $modal.html('<h3>Batch Relationship Button Configuration</h3><div id="aa-config-scroll-area"><div id="aa-config-form"></div></div>');

        const $scrollArea = $modal.find('#aa-config-scroll-area');
        const $formContainer = $modal.find('#aa-config-form');

        const renderForm = (buttons) => {
            $formContainer.empty();
            // Important: Render the *sorted* array
            buttons.forEach((config, index) => {
                const $item = $(`<div class="aa-config-item" data-index="${index}">`);

                // Use default values if keys are missing (e.g., in a cleaned 'performed / performer' object)
                const safeConfig = {...FULL_DEFAULT_BUTTON, ...config};

                // Build the item structure
                $item.append(`
                    <h4>
                        Button ${index + 1}: ${safeConfig.label}
                        <button class="aa-remove-btn">Remove</button>
                    </h4>
                    <label>Label (Button Text): <input type="text" name="label" value="${safeConfig.label || ''}" placeholder="E.g., Max Weinberg"></label>

                    <label>Relationship Type:
                        <select name="relationshipType">
                            <option value="instruments">instruments</option>
                            <option value="vocal">vocal</option>
                            <option value="performed / performer">performed / performer</option>
                        </select>
                    </label>
                    <label>Artist Name: <input type="text" name="artist" value="${safeConfig.artist || ''}" placeholder="E.g., Max Weinberg (required)"></label>

                    <!-- DYNAMIC FIELDS -->
                    <label class="instrument-field">Instrument (if type='instruments'): <input type="text" name="instrument" value="${safeConfig.instrument || ''}" placeholder="E.g., drums (drum set)"></label>
                    <label class="vocal-field">Vocal (if type='vocal'): <input type="text" name="vocal" value="${safeConfig.vocal || ''}" placeholder="E.g., lead vocals"></label>

                    <label class="creditedAs-field">Credited As: <input type="text" name="creditedAs" value="${safeConfig.creditedAs || ''}" placeholder="E.g., drums"></label>
                `);

                // Set selected value for relationshipType
                const $select = $item.find(`select[name="relationshipType"]`);
                $select.val(safeConfig.relationshipType);

                // Initial visibility update
                updateFieldVisibility($item);

                // Add change listener for dynamic visibility
                $select.on('change', function() {
                    updateFieldVisibility($item);
                });

                // Add change listener to all inputs to update the local currentButtons array instantly
                $item.find('input, select').on('change keyup', function() {
                    const fieldName = $(this).attr('name');
                    const value = $(this).val();
                    const $currentItem = $(this).closest('.aa-config-item');
                    const index = $currentItem.data('index');

                    // Update the label in the h4 for instant feedback
                    if (fieldName === 'label') {
                        $currentItem.find('h4').html(`Button ${index + 1}: ${value}<button class="aa-remove-btn">Remove</button>`);
                    }

                    // Update the local array by reading the current DOM state (sorted)
                    // This ensures currentButtons always matches the visible form for accurate removal/saving
                    currentButtons = getCurrentConfigFromForm(true);
                });


                $formContainer.append($item);
            });
        };

        // Utility to extract current form state (used for comparison)
        function getCurrentConfigFromForm(onlyReadDom = false) {
            if (onlyReadDom) {
                const currentConfig = [];
                $formContainer.find('.aa-config-item').each(function() {
                    currentConfig.push({
                        label: $(this).find('input[name="label"]').val().trim(),
                        relationshipType: $(this).find('select[name="relationshipType"]').val(),
                        artist: $(this).find('input[name="artist"]').val().trim(),
                        instrument: $(this).find('input[name="instrument"]').val().trim(),
                        vocal: $(this).find('input[name="vocal"]').val().trim(),
                        creditedAs: $(this).find('input[name="creditedAs"]').val().trim(),
                    });
                });
                return sortButtons(currentConfig);
            }
            // Fallback: use the in-memory array
            return sortButtons(currentButtons.map(a => Object.assign({}, a)));
        }

        // Initial render
        renderForm(currentButtons);

        // --- Event Handlers ---

        // Cleanup function for modal closure
        const cleanupAndClose = () => {
            $(document).off('keydown', escapeHandler);
            $('#aa-add-new-modal-overlay').remove(); // Ensure add modal is also closed
            $overlay.remove();
        }

        // Add New Button Handler
        const handleAddNewButton = () => {
             // Open the dedicated small modal
             showAddButtonModal((newButton) => {
                // Callback function when the new button is saved in the sub-modal

                // 1. Read the current DOM state to ensure we capture any pending edits
                const currentDomConfig = getCurrentConfigFromForm(true);

                // 2. Add the new button
                currentDomConfig.push(newButton);
                currentButtons = sortButtons(currentDomConfig); // Update local array

                // 3. Re-render the main form with the new, sorted button list
                renderForm(currentButtons);

                // 4. Scroll to the bottom to see the newly added button (which is now in its sorted position)
                $scrollArea.scrollTop($scrollArea[0].scrollHeight);
             });
        };


        // Remove Button (FIXED: Uses index for unique removal)
        $modal.on('click', '.aa-remove-btn', function() {
            const $item = $(this).closest('.aa-config-item');

            // Read the current state of the buttons from the form (guaranteed to match the visible list)
            const domConfig = getCurrentConfigFromForm(true);
            const indexToRemove = $item.data('index'); // This index is based on the *sorted* array shown on screen

            if (domConfig.length > 1) {

                // Remove the item at the specific index using splice
                domConfig.splice(indexToRemove, 1);

                // Update currentButtons and ensure it is sorted
                currentButtons = sortButtons(domConfig);

                renderForm(currentButtons);

            } else {
                console.warn(LOG_PREFIX, "User tried to remove the last button. Must keep at least one.");
                alert("You must keep at least one button configuration.");
            }
        });

        // Save Button
        const saveAndClose = () => {
            const newConfig = [];
            let valid = true;

            $formContainer.find('.aa-config-item').each(function() {
                const $item = $(this);
                const label = $item.find('input[name="label"]').val().trim();
                const artist = $item.find('input[name="artist"]').val().trim();

                if (!label || !artist) {
                    // Using alert() here as it is inside a custom modal flow and should be seen
                    alert(`Button configuration requires both a Label and an Artist Name. Please check item ${$item.data('index') + 1}.`);
                    valid = false;
                    return false; // Stop .each loop
                }

                newConfig.push({
                    label: label,
                    relationshipType: $item.find('select[name="relationshipType"]').val(),
                    artist: artist,
                    instrument: $item.find('input[name="instrument"]').val().trim(),
                    vocal: $item.find('input[name="vocal"]').val().trim(),
                    creditedAs: $item.find('input[name="creditedAs"]').val().trim(),
                });
            });

            if (valid) {
                // Save and sort the new configuration (saveButtons will handle stripping unnecessary fields)
                ARTIST_BUTTONS = saveButtons(newConfig);
                renderButtons(ARTIST_BUTTONS); // Re-render the batch buttons on the main page
                cleanupAndClose();
                log("Configuration saved and buttons updated.");
            }
        };

        // Escape Key Handler
        const escapeHandler = function(e) {
            // Check if the event target is inside an input field, which might be handling Esc for something else
            const isInput = $(e.target).is('input, select, textarea');
            if (e.key === 'Escape' && !isInput) {
                e.preventDefault();
                e.stopPropagation();

                const finalConfig = getCurrentConfigFromForm(true); // Read current state from DOM
                const finalConfigString = JSON.stringify(finalConfig);

                if (finalConfigString === initialConfigString) {
                    // No changes, close safely
                    cleanupAndClose();
                    log("Configuration modal closed with Esc key (no changes).");
                } else {
                    // Changes made, prompt user
                    const response = window.confirm("You have unsaved changes. Press OK to discard changes and close, or Cancel to return and Save.");
                    if (response) {
                        cleanupAndClose();
                        log("Configuration modal closed with Esc key (changes discarded).");
                    }
                }
            }
        };

        // Attach event listeners
        $(document).on('keydown', escapeHandler);

        // Footer (Fixed position achieved by putting it outside the scroll area)
        const $footer = $(`
            <div class="aa-config-footer">
                <button class="aa-close-btn">Close</button>
                <div>
                    <button class="aa-add-btn">Add New Button</button>
                    <button class="aa-save-btn">Save & Reload Buttons</button>
                </div>
            </div>
        `);

        $modal.append($footer);

        $modal.on('click', '.aa-close-btn', cleanupAndClose);
        $modal.on('click', '.aa-save-btn', saveAndClose);
        $modal.on('click', '.aa-add-btn', handleAddNewButton);

        $overlay.append($modal);
        $('body').append($overlay);
    }

    // ----------------- UI: Button Rendering and Creation -----------------

    const BUTTON_STYLE_CONFIG = {
        'instruments': { bgColor: '#4CAF50', activeColor: '#3e8e41', icon: 'üé∏ ' },
        'vocal': { bgColor: '#2196F3', activeColor: '#0b7dda', icon: 'üé§ ' },
        'performed / performer': { bgColor: '#FF9800', activeColor: '#e68a00', icon: 'üé≠ ' },
        'default': { bgColor: '#607D8B', activeColor: '#455a64', icon: 'üîó ' }
    };

    function renderButtons(buttons) {
        const $mainContainer = $('.injected-buttons-container');
        if ($mainContainer.length === 0) return;

        let $batchButtonContainer = $mainContainer.find('#aa-batch-buttons');
        if ($batchButtonContainer.length === 0) {
            $batchButtonContainer = $('<div id="aa-batch-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>');
            $mainContainer.append($batchButtonContainer);
        }

        $batchButtonContainer.empty();

        buttons.forEach(config => {
            const style = BUTTON_STYLE_CONFIG[config.relationshipType] || BUTTON_STYLE_CONFIG['default'];
            const buttonText = `${style.icon}${config.label}`;

            const buttonStyleString = `
                background-color: ${style.bgColor};
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.15s ease-in-out;
                white-space: nowrap;
                flex-shrink: 0;
                line-height: 20px;
            `;

            const $button = $('<button/>', {
                text: buttonText,
                'data-label': config.label
            });

            $button.attr('style', buttonStyleString);

            $button.on({
                'mouseenter': function() { $(this).css('opacity', 0.9); },
                'mouseleave': function() { $(this).css('opacity', 1); },
                'click': function() {
                    $(this).css('background-color', style.activeColor);
                    setTimeout(() => $(this).css('background-color', style.bgColor), 500);
                }
            });

            $batchButtonContainer.append($button);

            $button.on('click', () => {
                log(`Enqueued "${config.label}" (${config.relationshipType})`);
                queue.push(Object.assign({}, config));
                processQueue().catch(e => console.error(e));
            });
        });
    }

    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        let $container = $heading.next('.injected-buttons-container');
        if ($container.length === 0) {
            $container = $(`
                <div
                    class="injected-buttons-container"
                    style="
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        flex-wrap: wrap;
                        margin-top: 10px;
                        margin-bottom: 5px;
                        padding: 10px 0;
                        width: 100%;
                        z-index: 1000;
                    ">
                </div>
            `);
            $heading.after($container);
        } else {
             $container.find('#aa-batch-buttons').remove();
        }

        // --- 1. Create and prepend the permanent 'Configure' button with 2-line text ---
        const $configButton = $container.find('#aa-config-btn');
        if ($configButton.length === 0) {
            const configButtonStyle = `
                background-color: #607D8B;
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.15s ease-in-out;
                flex-shrink: 0;
                line-height: 1.2;
            `;

            // Updated text: "Configure recording\nrelation buttons"
            const buttonHtml = '‚öôÔ∏è Configure recording<br>relation buttons';

            const $config = $('<button/>', {
                id: 'aa-config-btn',
                html: buttonHtml
            });

            $config.attr('style', configButtonStyle);
            $container.prepend($config);
            $config.on('click', showConfigModal);
        }

        // --- 2. Render the dynamic batch-add buttons ---
        renderButtons(ARTIST_BUTTONS);


        // --- 3. VISIBILITY LOGIC ---

        function getCheckedRecordings() {
            const $checkedRecordings = $('#tracklist input[type="checkbox"]:not(.work)');
            return $checkedRecordings;
        }

        function updateButtonVisibility() {
            try {
                if (DEBUG_VISIBILITY) log("Update visibility check called.");

                const $checked = getCheckedRecordings();
                const checkedCount = $checked.length;
                const anyChecked = checkedCount > 0;

                const $batchContainer = $container.find('#aa-batch-buttons');
                if ($batchContainer.length === 0) return;

                const currentDisplay = $batchContainer.css('display');

                if (currentDisplay === 'flex' && checkedCount === 0) {
                     if (DEBUG) log("Batch buttons visible, but 0 tracks checked. Forcing OFF.");
                     $batchContainer.css('display', 'none');
                     return;
                }

                if (anyChecked) {
                    if (currentDisplay === 'none') {
                        $batchContainer.css('display', 'flex');
                        if (DEBUG) log("Toggled batch buttons ON (display: flex)");
                    }
                } else {
                    if (currentDisplay === 'flex') {
                        $batchContainer.css('display', 'none');
                        if (DEBUG) log("Toggled batch buttons OFF (display: none)");
                    }
                }
            } catch (e) {
                console.error(LOG_PREFIX, "Error in updateButtonVisibility loop:", e);
            }
        }

        updateButtonVisibility();

        $('#tracklist').on('change click input', 'input[type="checkbox"]', function() {
             try {
                 if (DEBUG) log("Checkbox event detected, updating visibility...");
                 // Use setTimeout to ensure the DOM state is settled after the click/change
                 setTimeout(updateButtonVisibility, 50);
             } catch (e) {
                console.error(LOG_PREFIX, "Error in checkbox event handler:", e);
             }
        });

        // Set up the heartbeat check
        setInterval(updateButtonVisibility, VISIBILITY_HEARTBEAT_MS);

        log("Injected custom buttons and configuration.");
    }

    // ----------------- Main Execution -----------------

    try {
        setTimeout(() => {
            log("Starting userscript execution...");
            resetInitialState();
            createCustomButtons();
        }, 2000);
    } catch (error) {
        // This catch block primarily catches sync errors during the setting of the timeout.
        console.error(LOG_PREFIX, "CRITICAL SCRIPT FAILURE during initial setup:", error);
    }

})();
#+end_example

*** make sure artist is seleted first

In the uploaded userscript, when pressing one of the generated buttons there pops up a dynamically generated dialog (React based) with the following content:

#+begin_example
<div class="form">
  <div class="dialog-titlebar">
    <h1>Add relationship
    </h1>
    <div class="buttons-right">
      <span style="font-weight: normal;">(
	<a href="#">help
	</a>)
      </span>
    </div>
  </div>
  <p>This will add a relationship to all checked recordings.
  </p>
  <table class="relationship-details">
    <tbody>
      <tr>
	<td class="required section">Recording
	</td>
	<td class="fields">(31 recordings selected)
	</td>
      </tr>
      <tr>
	<td class="required section">Related type
	</td>
	<td class="fields">
	  <select class="entity-type">
	    <option value="area">Area
	    </option>
	    <option value="artist">Artist
	    </option>
	    <option value="event">Event
	    </option>
	    <option value="label">Label
	    </option>
	    <option value="place">Place
	    </option>
	    <option value="recording">Recording
	    </option>
	    <option value="release">Release
	    </option>
	    <option value="series">Series
	    </option>
	    <option value="work">Work
	    </option>
	  </select>
	</td>
      </tr>
    </tbody>
  </table>
  <h2>
    <div class="heading-line">
    </div>
    <span class="heading-text">Relationship
    </span>
  </h2>
  <table class="relationship-details">
    <tbody>
      <tr>
	<td class="required section">Relationship type
	</td>
	<td class="fields">
	  <label class="autocomplete2-label required" for="relationship-type-artist-recording--915" id="relationship-type-artist-recording--915-label">Type or click to search:
	  </label>
	  <div class="autocomplete2 relationship-type">
	    <div aria-expanded="false" aria-haspopup="listbox" aria-owns="relationship-type-artist-recording--915-menu" class="required" role="combobox">
	      <input aria-autocomplete="list" aria-controls="relationship-type-artist-recording--915-menu" aria-labelledby="relationship-type-artist-recording--915-label" aria-required="true" autocomplete="off" class="relationship-type required" id="relationship-type-artist-recording--915" placeholder="Type or click to search" type="text" value="">
	      <button aria-controls="relationship-type-artist-recording--915-menu" aria-haspopup="true" aria-label="Search" class="search" data-toggle="true" role="button" tabindex="-1" title="Search" type="button">
	      </button>
	    </div>
	    <ul aria-controls="relationship-type-artist-recording--915-status" aria-labelledby="relationship-type-artist-recording--915-label" id="relationship-type-artist-recording--915-menu" role="listbox" tabindex="-1">
	      <li aria-disabled="true" aria-selected="false" class="disabled header-item " id="relationship-type-artist-recording--915-item-recent-items-header" role="option">Recent items
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-type-artist-recording--915-item-148-recent" role="option">instruments
		<br>
		<span class="autocomplete-comment">Indicates an artist that performed one or more instruments on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-type-artist-recording--915-item-156-recent" role="option">performed / performer
		<br>
		<span class="autocomplete-comment">Indicates an artist that performed on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-type-artist-recording--915-item-149-recent" role="option">vocals
		<br>
		<span class="autocomplete-comment">Indicates an artist that performed vocals on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="action-item " id="relationship-type-artist-recording--915-item-clear-recent-items" role="option">Clear recent items
	      </li>
	      <li aria-disabled="true" aria-selected="false" class="disabled separator option-item " id="relationship-type-artist-recording--915-item-122" role="option">performance
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-156" role="option">performed / performer
		<br>
		<span class="autocomplete-comment">Indicates an artist that performed on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level2 option-item " id="relationship-type-artist-recording--915-item-148" role="option">instruments
		<br>
		<span class="autocomplete-comment">Indicates an artist that performed one or more instruments on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level2 option-item " id="relationship-type-artist-recording--915-item-149" role="option">vocals
		<br>
		<span class="autocomplete-comment">Indicates an artist that performed vocals on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-150" role="option">orchestra
		<br>
		<span class="autocomplete-comment">Indicates an orchestra that performed on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-151" role="option">conducted / conductor
		<br>
		<span class="autocomplete-comment">This indicates an artist who conducted an orchestra, band or choir on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-152" role="option">chorus master
		<br>
		<span class="autocomplete-comment">This indicates the chorus master of a choir which performed on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-760" role="option">concertmaster for / concertmaster
		<br>
		<span class="autocomplete-comment">This indicates an artist who was the concertmaster/leader for an orchestra or band on this recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-1186" role="option">audio director for / audio director
		<br>
		<span class="autocomplete-comment">This indicates the artist was an audio director for this recording. This is the artist responsible for the creative realization of an audio project (such as an audio drama or audiobook), which is usually based on a written template and involves the performance of voice actors.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-type-artist-recording--915-item-297" role="option">arranged / arranger
		<br>
		<span class="autocomplete-comment">This indicates the artist who arranged a tune into a form suitable for performance. ‚ÄúArrangement‚Äù is used as a catch-all term for all processes that turn a composition into a form that can be played by a specific type of ensemble.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-158" role="option">instruments arranged / instruments arranger
		<br>
		<span class="autocomplete-comment">This indicates the artist who arranged a tune into a form suitable for performance. ‚ÄúArrangement‚Äù is used as a catch-all term for all processes that turn a composition into a form that can be played by a specific type of ensemble.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level2 option-item " id="relationship-type-artist-recording--915-item-300" role="option">orchestrated / orchestrator
		<br>
		<span class="autocomplete-comment">This indicates the person who orchestrated the recording. Orchestration is a special type of arrangement. It means the adaptation of a composition for an orchestra, done in a way that the musical substance remains essentially unchanged. The orchestrator is also responsible for writing scores for an orchestra, band, choral group, individual instrumentalist(s) or vocalist(s). In practical terms it consists of deciding which instruments should play which notes in a piece of music.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-298" role="option">vocals arranged / vocals arranger
		<br>
		<span class="autocomplete-comment">This indicates the artist who arranged a tune into a form suitable for performance. ‚ÄúArrangement‚Äù is used as a catch-all term for all processes that turn a composition into a form that can be played by a specific type of ensemble.
		</span>
	      </li>
	      <li aria-disabled="true" aria-selected="false" class="disabled option-item " id="relationship-type-artist-recording--915-item-157" role="option">remixes and compilations
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-147" role="option">compiled / compiler
		<br>
		<span class="autocomplete-comment">This indicates the person who selected the tracks and the sequence for a compilation. This applies to one long recording which contains multiple songs, one after the other. If the tracks are pitched or blended into each other, it is more appropriate to credit this person as a DJ-mixer.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-155" role="option">DJ-mixed / DJ-mixer
		<br>
		<span class="autocomplete-comment">This links a DJ-mix to the artist who mixed it.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-153" role="option">remixed / remixer
		<br>
		<span class="autocomplete-comment">This links a recording to the person who remixed it by taking one or more other tracks, substantially altering them and mixing them together with other material. Note that this includes the artist who created a mash-up or used samples as well.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-154" role="option">produced material that was sampled in / contains samples by
		<br>
		<span class="autocomplete-comment">Indicates that the recording contains samples from material by the indicated artist. Use this only if you really cannot figure out the particular recording that has been sampled.
		</span>
	      </li>
	      <li aria-disabled="true" aria-selected="false" class="disabled option-item " id="relationship-type-artist-recording--915-item-961" role="option">video
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-858" role="option">appears on video / visual appearances
		<br>
		<span class="autocomplete-comment">This indicates that an artist appears on a music video, but doesn't actually perform on the audio track.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-962" role="option">video director for / video director
		<br>
		<span class="autocomplete-comment">This indicates the artist was the director of this video recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-1243" role="option">animation
		<br>
		<span class="autocomplete-comment">This credits a person or agency who worked on animation for a video recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level1 option-item " id="relationship-type-artist-recording--915-item-1241" role="option">artwork
		<br>
		<span class="autocomplete-comment">This indicates an artist who provided artwork for a video recording when no more specific information is available.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level2 option-item " id="relationship-type-artist-recording--915-item-1242" role="option">design
		<br>
		<span class="autocomplete-comment">This indicates an artist who did design for a video recording.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="level3 option-item " id="relationship-type-artist-recording--915-item-125" role="option">graphic design
		<br>
		<span class="autocomplete-comment">This credits the people or agency who did the graphic design / layout for a video recording, arranging pieces of content into a coherent and aesthetically-pleasing whole.
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="separator action-item " id="relationship-type-artist-recording--915-item-show-more" role="option">Show more...
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="separator action-item " id="relationship-type-artist-recording--915-item-toggle-descriptions" role="option">Hide descriptions
	      </li>
	    </ul>
	    <div aria-live="assertive" aria-relevant="additions text" id="relationship-type-artist-recording--915-status" role="status">
	    </div>
	  </div>
	  <div aria-atomic="true" class="error" role="alert">
	  </div>
	</td>
      </tr>
      <tr>
	<td class="required section">Artist
	</td>
	<td class="fields">
	  <label class="autocomplete2-label required" for="relationship-target--915" id="relationship-target--915-label">Search for an artist:
	  </label>
	  <div class="autocomplete2 relationship-target">
	    <div aria-expanded="false" aria-haspopup="listbox" aria-owns="relationship-target--915-menu" class="required" role="combobox">
	      <input aria-autocomplete="list" aria-controls="relationship-target--915-menu" aria-labelledby="relationship-target--915-label" aria-required="true" autocomplete="off" class="relationship-target required" id="relationship-target--915" placeholder="Type to search, or paste an MBID" type="text" value="">
	      <button aria-controls="relationship-target--915-menu" aria-haspopup="true" aria-label="Search" class="search" data-toggle="true" role="button" tabindex="-1" title="Search" type="button">
	      </button>
	    </div>
	    <ul aria-controls="relationship-target--915-status" aria-labelledby="relationship-target--915-label" id="relationship-target--915-menu" role="listbox" tabindex="-1">
	      <li aria-disabled="true" aria-selected="false" class="disabled header-item " id="relationship-target--915-item-recent-items-header" role="option">Recent items
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-339449-recent" role="option">Max Weinberg
		<br>
		<span class="autocomplete-comment">Person, 1951-04-13 ‚Äì
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-813-recent" role="option">Bruce Springsteen
		<br>
		<span class="autocomplete-comment">Person, 1949-09-23 ‚Äì
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-47784-recent" role="option">J.D. Souther
		<br>
		<span class="autocomplete-comment">Person, 1945-11-02 ‚Äì 2024-09-17
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-1086-recent" role="option">Jackson Browne
		<span class="autocomplete-comment">(American singer-songwriter)
		</span>
		<br>
		<span class="autocomplete-comment">Person, 1948-10-09 ‚Äì
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-11058-recent" role="option">Crosby, Stills, Nash &amp; Young
		<br>
		<span class="autocomplete-comment">Group, 1969 ‚Äì 2015
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-964-recent" role="option">Neil Young
		<span class="autocomplete-comment">(Canadian singer, songwriter &amp; musician)
		</span>
		<br>
		<span class="autocomplete-comment">Person, 1945-11-12 ‚Äì
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-1240195-recent" role="option">The E Street Band
		<br>
		<span class="autocomplete-comment">Group, 1972-10 ‚Äì
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-131161-recent" role="option">Eddie Vedder
		<br>
		<span class="autocomplete-comment">Person, 1964-12-23 ‚Äì
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="option-item " id="relationship-target--915-item-713674-recent" role="option">Garry Tallent
		<br>
		<span class="autocomplete-comment">Person, 1949-10-27 ‚Äì
		</span>
	      </li>
	      <li aria-disabled="false" aria-selected="false" class="action-item " id="relationship-target--915-item-clear-recent-items" role="option">Clear recent items
	      </li>
	    </ul>
	    <div aria-live="assertive" aria-relevant="additions text" id="relationship-target--915-status" role="status">
	    </div>
	  </div>
	  <div class="error">
	  </div>
	</td>
      </tr>
    </tbody>
  </table>
  <h2>
    <div class="heading-line">
    </div>
    <span class="heading-text">Preview
    </span>
  </h2>
  <p class="required-fields-note">Please fill out all required fields.
  </p>
  <div class="buttons" style="margin-top: 1em;">
    <button class="negative" type="button">Cancel
    </button>
    <div class="buttons-right">
      <button class="positive" disabled="" type="button">Done
      </button>
    </div>
  </div>
</div>
#+end_example

Make sure that in the list option part of the above HTML code, '<option value="artist">Artist</option>' is selected first before executing the rest of the filling logic

#+begin_example
	<td class="fields">
	  <select class="entity-type">
	    <option value="area">Area
	    </option>
	    <option value="artist">Artist
	    </option>
	    <option value="event">Event
	    </option>
	    <option value="label">Label
	    </option>
	    <option value="place">Place
	    </option>
	    <option value="recording">Recording
	    </option>
	    <option value="release">Release
	    </option>
	    <option value="series">Series
	    </option>
	    <option value="work">Work
	    </option>
	  </select>
	</td>
#+end_example

That should be the only code change to do, please dont' touch existing logic and comments as everything else works perfectly

#+begin_example
// ==UserScript==
// @name         Batch Add Relationships To Recordings
// @namespace    https://github.com/vzell/mb-userscripts
// @version      1.6.2+2025-11-29 (Feature: Linked fields in Add-Modal, unique removal fix, Entity Type Fix)
// @description  Insert artist buttons, open batch-add dialog, reliably fill relationship type (instruments|vocal|performed / performer), artist, instrument/vocal, credited-as, click Done ‚Äî sequential queue + dialog lifecycle awareness. Optimized for speed.
// @homepageURL  https://github.com/vzell/mb-userscripts
// @tag          vzell with the help of ChatGPT
// @downloadURL  https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @updateURL    https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    // *** DEBUGGING FLAGS ***
    const DEBUG = true;
    const DEBUG_VISIBILITY = false;

    // --- CONSTANTS ---
    const LOG_PREFIX = '[add-recording-relations]';
    const STORAGE_KEY = 'mb_batch_add_buttons_config';
    const HEADING_SELECTOR = "h2:contains('Track relationships')";
    const MODAL_DIALOG_SELECTOR = 'div.ui-dialog.relationship-editor:visible';
    const VISIBILITY_HEARTBEAT_MS = 2000;
    const AUTOCLOSE_DELAY_MS = 200; // Delay before closing the dialog after 'Done' is clicked

    // --- State Variables ---
    let $batchContainer; // Container for the custom buttons
    let dialogQueue = []; // Queue for relationship tasks
    let isProcessing = false; // Flag to prevent multiple parallel dialog openings

    // --- Utility Functions ---

    /**
     * Console log wrapper.
     */
    function log(message, ...args) {
        if (DEBUG) {
            console.log(LOG_PREFIX, message, ...args);
        }
    }

    /**
     * Custom version of forceValue to handle React-controlled inputs.
     * @param {HTMLElement} input The element to set the value on.
     * @param {string} value The value to set.
     */
    function forceValue(input, value) {
        if (!input) {
            log("Attempted to force value on null input.", value);
            return;
        }

        // 1. Set the value directly
        input.value = value;

        // 2. Dispatch 'input' event (bubbles up to notify React of change)
        let inputEvent = new InputEvent('input', { bubbles: true });
        input.dispatchEvent(inputEvent);

        // 3. Dispatch 'change' event (standard event for select/input fields)
        let changeEvent = new Event('change', { bubbles: true });
        input.dispatchEvent(changeEvent);

        // 4. Dispatch 'blur' event (often triggers validation/save state in frameworks)
        let blurEvent = new Event('blur', { bubbles: true });
        input.dispatchEvent(blurEvent);

        log(`Forced value "${value}" on`, input);
    }

    /**
     * Utility to simulate a click on an element.
     * @param {HTMLElement} element The element to click.
     */
    function simulateClick(element) {
        if (element) {
            element.click();
            log("Clicked element:", element);
        }
    }

    /**
     * Waits for the batch relationship dialog to appear.
     * @param {number} timeoutMillis Max time to wait.
     * @returns {Promise<JQuery<HTMLElement>>} Promise that resolves with the dialog element.
     */
    function waitForDialog(timeoutMillis = 10000) {
        const startTime = Date.now();

        return new Promise((resolve, reject) => {
            const check = () => {
                const $dialog = $(MODAL_DIALOG_SELECTOR).filter(':has(h1:contains("Add relationship"))');
                if ($dialog.length) {
                    log("Dialog appeared.", $dialog[0]);
                    resolve($dialog);
                    return;
                }
                if (Date.now() - startTime > timeoutMillis) {
                    reject(new Error("Timeout waiting for batch relationship dialog to appear."));
                    return;
                }
                setTimeout(check, 50);
            };
            check();
        });
    }

    /**
     * Fills the fields in the open dialog based on the task data.
     * @param {JQuery<HTMLElement>} $dialog The jQuery object for the dialog.
     * @param {object} task The task object containing relationship details.
     * @returns {Promise<void>}
     */
    async function fillDialogFields($dialog, task) {
        log("Attempting to fill dialog fields for task:", task);

        // --------------------------------------------------------
        // CRITICAL FIX: Ensure 'Artist' is selected as the Entity Type.
        // This is necessary because relationship types like 'instruments' or 'performer'
        // are only available when the target entity type is 'artist'.
        // --------------------------------------------------------
        const $entityTypeSelect = $dialog.find('select.entity-type');
        if ($entityTypeSelect.length) {
            const artistOptionValue = 'artist';
            forceValue($entityTypeSelect[0], artistOptionValue);
            log(`Set entity type to "${artistOptionValue}".`);

            // MusicBrainz needs time to update the UI (relationship type autocomplete)
            // after the entity-type selection. Wait briefly.
            await new Promise(r => setTimeout(r, 200));
        }

        // 1. Fill Relationship Type (Autocomplete Input)
        const $typeInput = $dialog.find('input.relationship-type');
        if ($typeInput.length) {
            // Note: Autocomplete needs the full text value
            forceValue($typeInput[0], task.type);

            // Wait for autocomplete menu to appear and select the item
            await new Promise(r => setTimeout(r, 100)); // Wait for search results

            const $menu = $typeInput.closest('.autocomplete2').find('ul[role="listbox"]');
            const $targetItem = $menu.find(`li[role="option"]:contains('${task.type}')`).filter(function() {
                // Ensure we select the main option, not a recent or comment item
                return $(this).text().trim().toLowerCase().startsWith(task.type.toLowerCase());
            }).first();

            if ($targetItem.length) {
                simulateClick($targetItem[0]);
                log(`Selected relationship type from menu: ${task.type}`);
            } else {
                log(`WARN: Could not find menu item for relationship type: ${task.type}. Proceeding anyway.`);
            }

            // Wait for field value to settle and potentially load sub-fields
            await new Promise(r => setTimeout(r, 100));
        }

        // 2. Fill Target Entity (Artist Autocomplete Input)
        const $targetInput = $dialog.find('input.relationship-target');
        if ($targetInput.length) {
            forceValue($targetInput[0], task.artistName);

            // Wait for autocomplete menu to appear and select the item
            await new Promise(r => setTimeout(r, 100));

            const $menu = $targetInput.closest('.autocomplete2').find('ul[role="listbox"]');
            // Try to find an exact match first, or the first option
            const $targetItem = $menu.find(`li[role="option"]:contains('${task.artistName}')`).filter(function() {
                return $(this).text().trim().split('\n')[0].toLowerCase() === task.artistName.toLowerCase();
            }).first();

            if ($targetItem.length) {
                simulateClick($targetItem[0]);
                log(`Selected target artist from menu: ${task.artistName}`);
            } else {
                log(`WARN: Could not find exact menu item for artist: ${task.artistName}. Proceeding anyway.`);
                // If we can't find an exact match, try clicking the first available recent item or simply rely on the text value.
                const $firstRecent = $menu.find('li.option-item').not('.disabled').first();
                 if ($firstRecent.length) {
                     simulateClick($firstRecent[0]);
                     log(`WARN: Falling back to clicking the first available option.`);
                 }
            }

            // Wait for field value to settle
            await new Promise(r => setTimeout(r, 100));
        }

        // 3. Fill Attribute Fields (Instrument/Vocal, Credited As)
        // Find all text inputs within the relationship details table that are NOT the artist input
        const $attributeFields = $dialog.find('table.relationship-details').last().find('input[type="text"]').not($targetInput);

        // Note: The structure of attributes is highly variable, so we rely on input order/labeling.
        $attributeFields.each((index, input) => {
            const $input = $(input);
            const value = task.attributes[index];
            if (value !== undefined) {
                forceValue(input, value);
                log(`Set attribute field ${index + 1} to: ${value}`);
            }
        });

        // Final brief wait before clicking Done
        await new Promise(r => setTimeout(r, 100));
    }


    /**
     * Processes the queue: waits for the dialog, fills fields, clicks 'Done', and moves to the next task.
     */
    async function processQueue() {
        if (isProcessing || dialogQueue.length === 0) {
            return;
        }

        isProcessing = true;
        const task = dialogQueue[0];
        log(`Starting processing for task: ${task.artistName} / ${task.type}`);

        try {
            // Open the dialog if it's not already open (should be handled by the button click)
            const $dialog = await waitForDialog(15000); // 15 second timeout

            await fillDialogFields($dialog, task);

            // Click the 'Done' button
            const $doneButton = $dialog.find('button.positive:contains("Done")').not(':disabled');

            if ($doneButton.length) {
                simulateClick($doneButton[0]);
                log("Clicked 'Done' button.");

                // Wait for the dialog to close and the underlying React state to update
                await new Promise(r => setTimeout(r, AUTOCLOSE_DELAY_MS));
                dialogQueue.shift(); // Remove completed task
                log(`Task completed. ${dialogQueue.length} tasks remaining.`);
            } else {
                log("WARN: 'Done' button not enabled/found. Dialog state likely invalid. Skipping task.");
                dialogQueue.shift(); // Remove failed task to prevent infinite loop
                await new Promise(r => setTimeout(r, 1000)); // Wait for error state to stabilize
            }
        } catch (error) {
            console.error(LOG_PREFIX, "Error during queue processing:", error);
            dialogQueue.shift(); // Remove failed task
            await new Promise(r => setTimeout(r, 500)); // Wait before trying next
        } finally {
            isProcessing = false;
            // Continue processing the next item if available
            if (dialogQueue.length > 0) {
                // Ensure all checkboxes are checked before opening the dialog again
                $(':checkbox.select-recording').prop('checked', true).trigger('change');
                setTimeout(openBatchAddDialog, 100); // Re-open the dialog for the next task
            } else {
                log("Queue finished.");
            }
        }
    }


    /**
     * Opens the batch relationship dialog by simulating a click on the 'Add' button.
     */
    function openBatchAddDialog() {
        const $addButton = $('button.add-multiple-relationships-button').not(':disabled');
        if ($addButton.length) {
            simulateClick($addButton[0]);
            log("Opening batch relationship dialog.");
            // Start processing queue after opening dialog
            setTimeout(processQueue, 50);
        } else {
            console.error(LOG_PREFIX, "Batch 'Add' button not found or disabled.");
            isProcessing = false; // Reset processing flag if we fail to open
        }
    }

    // --- Configuration and UI ---

    /**
     * Loads the custom button configuration from storage.
     * @returns {Array<object>} The array of button configurations.
     */
    function loadButtonConfig() {
        // Default configuration
        const defaultConfig = [
            { type: 'performed / performer', label: 'Performer' },
            { type: 'instruments', label: 'Instruments' },
            { type: 'vocals', label: 'Vocals' },
            { type: 'conducted / conductor', label: 'Conductor' },
            { type: 'remixed / remixer', label: 'Remixer' },
        ];

        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            const config = stored ? JSON.parse(stored) : defaultConfig;
            return Array.isArray(config) ? config : defaultConfig;
        } catch (e) {
            console.error(LOG_PREFIX, "Error loading config:", e);
            return defaultConfig;
        }
    }

    /**
     * Saves the custom button configuration to storage.
     * @param {Array<object>} config The configuration to save.
     */
    function saveButtonConfig(config) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(config));
            log("Config saved.", config);
        } catch (e) {
            console.error(LOG_PREFIX, "Error saving config:", e);
        }
    }

    /**
     * Shows the configuration dialog.
     */
    function showConfigDialog() {
        const currentConfig = loadButtonConfig();
        const dialogId = 'mb-batch-add-config-dialog';
        let $dialog = $(`#${dialogId}`);

        if ($dialog.length) {
            $dialog.dialog('open');
            return;
        }

        const configHtml = `
            <div id="${dialogId}" title="Configure Batch Relationship Buttons" style="display:none;">
                <p>Add/edit buttons for quick-adding relationships to selected recordings.</p>
                <div id="button-list"></div>
                <button id="add-new-button" class="btn-default">+</button>
                <div class="tip" style="margin-top: 10px;">
                    <strong>Tip:</strong> The Relationship Type must match the exact text found in the dropdown (e.g., 'performed / performer').
                    Attributes are optional fields (like instrument or credited-as).
                </div>
            </div>
        `;
        $('body').append(configHtml);
        $dialog = $(`#${dialogId}`);
        const $list = $dialog.find('#button-list');

        const renderList = () => {
            $list.empty();
            currentConfig.forEach((btn, index) => {
                const item = $(`
                    <div class="mb-config-item" style="display:flex; gap: 5px; margin-bottom: 5px; align-items: center; padding: 5px; border: 1px solid #eee; border-radius: 4px;">
                        <input type="text" class="mb-type-input" placeholder="Relationship Type" value="${btn.type}" style="flex: 2;"/>
                        <input type="text" class="mb-label-input" placeholder="Button Label" value="${btn.label}" style="flex: 1;"/>
                        <input type="text" class="mb-attr-input" placeholder="Attributes (comma-separated)" value="${(btn.attributes || []).join(', ')}" style="flex: 2;"/>
                        <button class="remove-button btn-danger btn-xs" data-index="${index}" type="button" style="padding: 2px 5px; line-height: 1.2;">-</button>
                    </div>
                `);
                $list.append(item);
            });
        };

        renderList();

        $dialog.on('click', '.remove-button', function() {
            const index = $(this).data('index');
            currentConfig.splice(index, 1);
            renderList();
        });

        $dialog.on('click', '#add-new-button', function() {
            currentConfig.push({ type: '', label: '', attributes: [] });
            renderList();
        });

        $dialog.dialog({
            autoOpen: true,
            modal: true,
            width: 700,
            buttons: {
                "Save": function() {
                    const newConfig = [];
                    $list.find('.mb-config-item').each(function() {
                        const type = $(this).find('.mb-type-input').val().trim();
                        const label = $(this).find('.mb-label-input').val().trim();
                        const attrStr = $(this).find('.mb-attr-input').val().trim();
                        const attributes = attrStr ? attrStr.split(',').map(s => s.trim()) : [];

                        if (type && label) {
                            newConfig.push({ type, label, attributes });
                        }
                    });
                    saveButtonConfig(newConfig);
                    $(this).dialog("close");
                    // Reload UI after save
                    $batchContainer.remove();
                    createCustomButtons();
                    updateButtonVisibility();
                },
                "Cancel": function() {
                    $(this).dialog("close");
                }
            }
        });
    }

    /**
     * Creates and inserts the custom quick-add buttons into the DOM.
     */
    function createCustomButtons() {
        const $target = $(HEADING_SELECTOR);
        if ($target.length === 0) {
            log("Target heading not found. Cannot inject buttons.");
            return;
        }

        const config = loadButtonConfig();

        // Remove existing container if script runs multiple times
        if ($batchContainer) {
            $batchContainer.remove();
        }

        // Create the container
        $batchContainer = $('<div id="batch-add-relationships-container" style="display:none; margin-top: 10px; margin-bottom: 5px; display: flex; flex-wrap: wrap; gap: 5px; align-items: center;"></div>');

        // Create buttons from config
        config.forEach(taskConfig => {
            const button = $(`<button type="button" class="btn-default" title="Batch add '${taskConfig.type}'">
                ${taskConfig.label}
            </button>`);

            button.on('click', function(e) {
                e.preventDefault();
                log(`Button clicked: ${taskConfig.label}`);

                // 1. Uncheck and re-check all checkboxes to ensure React state is fresh
                $(':checkbox.select-recording').prop('checked', false).trigger('change');
                $(':checkbox.select-recording').prop('checked', true).trigger('change');

                // 2. Prepare tasks for the queue
                const artistInput = $(`#batch-add-relationships-container .mb-artist-input[data-label="${taskConfig.label}"]`);
                const artistName = artistInput.length ? artistInput.val().trim() : '';

                if (!artistName) {
                    console.error(LOG_PREFIX, `Artist name is required for button: ${taskConfig.label}`);
                    // Instead of alert, use the message box functionality if available, or just log an error.
                    $('<div title="Missing Artist" style="padding: 10px;">Please enter an artist name in the input field next to the button before using it.</div>')
                        .dialog({ modal: true, buttons: { Ok: function() { $(this).dialog("close"); } } });
                    return;
                }

                dialogQueue.push({
                    type: taskConfig.type,
                    artistName: artistName,
                    attributes: taskConfig.attributes || []
                });

                // 3. Start processing (opens the dialog for the first task)
                openBatchAddDialog();
            });

            // Create input field for the artist
            const artistInput = $(`
                <input type="text"
                       class="mb-artist-input"
                       data-label="${taskConfig.label}"
                       placeholder="Artist for ${taskConfig.label}"
                       style="width: 150px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px; height: 28px;"/>
            `);

            // Wrap button and input in a group container
            const group = $(`<div class="mb-button-group" style="display: flex; gap: 2px;"></div>`);
            group.append(artistInput, button);
            $batchContainer.append(group);
        });

        // Add the config button
        const configButton = $(`<button type="button" class="btn-default" style="margin-left: auto;" title="Configure Buttons">‚öôÔ∏è</button>`);
        configButton.on('click', showConfigDialog);
        $batchContainer.append(configButton);

        // Insert container after the target heading
        $target.after($batchContainer);
        log("Custom buttons injected.");
    }

    /**
     * Resets the initial state of the checkboxes and the queue.
     * This is useful on initial load or if the user navigates back to the page.
     */
    function resetInitialState() {
        dialogQueue = [];
        isProcessing = false;
        // Check all recordings by default
        $(':checkbox.select-recording').prop('checked', true).trigger('change');
    }

    /**
     * Checks the state of checkboxes and updates the custom button visibility.
     */
    function updateButtonVisibility() {
        if (!$batchContainer) {
            if (DEBUG_VISIBILITY) log("Container not ready.");
            return;
        }

        const $checkedCheckboxes = $(':checkbox.select-recording:checked');
        const $addButton = $('button.add-multiple-relationships-button'); // MusicBrainz native button

        try {
            if (dialogQueue.length > 0) {
                // If queue is active, keep buttons hidden to prevent user interruption
                $batchContainer.css('display', 'none');
                if (DEBUG_VISIBILITY) log("Queue active, hiding batch buttons.");
                return;
            }

            if ($checkedCheckboxes.length > 0 && $addButton.length > 0 && !$addButton.is(':disabled')) {
                // If at least one recording is checked and the native button is active, show custom buttons
                $batchContainer.css('display', 'flex');
                if (DEBUG_VISIBILITY) log("Checked recordings found, showing batch buttons.");
            } else {
                // No checked recordings or native button is disabled, hide custom buttons
                // Only hide if not currently processing
                const currentDisplay = $batchContainer.css('display');
                if (currentDisplay === 'flex') {
                    $batchContainer.css('display', 'none');
                    if (DEBUG_VISIBILITY) log("Toggled batch buttons OFF (display: none)");
                }
            }
        } catch (e) {
            console.error(LOG_PREFIX, "Error in updateButtonVisibility loop:", e);
        }
    }


    // ----------------- Main Execution -----------------

    function initialize() {
        log("Starting userscript execution...");
        // Ensure jQuery UI dialog is available if running on a standard MB page
        // If not available, the config dialog will gracefully fail to open but the core functionality will work.

        resetInitialState();
        createCustomButtons();

        // Initial check and subsequent checks for visibility change
        updateButtonVisibility();

        // Listen for changes to the checkbox states to toggle button visibility
        $('#tracklist').on('change click input', 'input[type="checkbox"]', function() {
             try {
                 if (DEBUG) log("Checkbox event detected, updating visibility...");
                 // Use setTimeout to ensure the DOM state is settled after the click/change
                 setTimeout(updateButtonVisibility, 50);
             } catch (e) {
                console.error(LOG_PREFIX, "Error in checkbox event handler:", e);
             }
        });

        // Set up the heartbeat check for dialog status and visibility
        setInterval(updateButtonVisibility, VISIBILITY_HEARTBEAT_MS);

        log("Injected custom buttons and configuration.");
    }

    // Use a small delay to ensure all required elements (like jQuery) are loaded
    try {
        setTimeout(initialize, 500);
    } catch (error) {
        console.error(LOG_PREFIX, "CRITICAL SCRIPT FAILURE during initial setup:", error);
    }

})();
#+end_example

*** last action in the night - <2025-11-28 Fri 21:34>

Please leave the following userscript completly intact and just add the critical fix funtionality right after the line

#+begin_example
log(`Start filling for: ${config.label} (${config.relationshipType})`);
#+end_example

This is the complete userscript:

#+begin_example
// ==UserScript==
// @name         Batch Add Relationships To Recordings
// @namespace    https://github.com/vzell/mb-userscripts
// @version      1.6.2+2025-11-28 (Feature: Linked fields in Add-Modal, unique removal fix)
// @description  Insert artist buttons, open batch-add dialog, reliably fill relationship type (instruments|vocal|performed / performer), artist, instrument/vocal, credited-as, click Done ‚Äî sequential queue + dialog lifecycle awareness. Optimized for speed.
// @homepageURL  https://github.com/vzell/mb-userscripts
// @tag          vzell with the help of ChatGPT
// @downloadURL  https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @updateURL    https://raw.githubusercontent.com/vzell/mb-userscripts/master/BatchAddRelationshipsToRecordings.user.js
// @match        https://musicbrainz.org/release/*/edit-relationships*
// @grant        none
// @require      https://code.jquery.com/jquery-3.6.0.min.js
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    // *** DEBUGGING FLAGS ***
    const DEBUG = true;
    const DEBUG_VISIBILITY = false;

    // --- CONSTANTS ---
    const LOG_PREFIX = '[add-recording-relations]';
    const STORAGE_KEY = 'mb_batch_add_buttons_config';
    const HEADING_SELECTOR = "h2:contains('Track relationships')";
    const GLOBAL_CHAR_DELAY_MS = 10;
    const GLOBAL_POST_SELECT_WAIT_MS = 150;
    const SMALL_BREATHING_ROOM_MS = 150;
    const VISIBILITY_HEARTBEAT_MS = 500;

    // Define the order for sorting buttons
    const RELATIONSHIP_ORDER = {
        'instruments': 1,
        'vocal': 2,
        'performed / performer': 3,
        'default': 99
    };

    function log(...args) {
        if (DEBUG) console.log(LOG_PREFIX, ...args);
    }

    // --- Sorting Utility ---
    function sortButtons(buttons) {
        // Sorts the passed array in place based on relationship type order
        buttons.sort((a, b) => {
            const orderA = RELATIONSHIP_ORDER[a.relationshipType] || RELATIONSHIP_ORDER['default'];
            const orderB = RELATIONSHIP_ORDER[b.relationshipType] || RELATIONSHIP_ORDER['default'];

            // Secondary sort by label for consistency within groups
            if (orderA === orderB) {
                return a.label.localeCompare(b.label);
            }
            return orderA - orderB;
        });
        return buttons;
    }

    // --- DEFAULT CONFIGURATION ---
    const DEFAULT_BUTTONS = [
        {
            label: "Max Weinberg",
            relationshipType: "instruments",
            artist: "Max Weinberg",
            instrument: "drums (drum set)",
            vocal: "", // Kept here for consistency in the configuration object structure
            creditedAs: "drums"
        },
        {
            label: "Garry Tallent",
            relationshipType: "instruments",
            artist: "Garry Tallent",
            instrument: "electric bass guitar",
            vocal: "",
            creditedAs: ""
        },
        {
            label: "Bruce Springsteen",
            relationshipType: "vocal",
            artist: "Bruce Springsteen",
            instrument: "",
            vocal: "lead vocals",
            creditedAs: ""
        },
        {
            label: "E Street Band",
            relationshipType: "performed / performer",
            artist: "The E Street Band"
        }
    ];

    // --- STATE & PERSISTENCE ---
    let ARTIST_BUTTONS = [];

    // --- CRITICAL: GLOBAL QUEUE AND PROCESSING STATE ---
    const queue = [];
    let processing = false;

    // Helper to provide a full default object structure for merging
    const FULL_DEFAULT_BUTTON = {
        label: 'New Button',
        relationshipType: 'instruments',
        artist: '',
        instrument: '',
        vocal: '',
        creditedAs: '',
    };

    function getInitialButtons() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            if (stored) {
                const parsed = JSON.parse(stored);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    log("Loaded button configuration from localStorage.");
                    const loadedButtons = parsed.map(btn => ({
                        ...FULL_DEFAULT_BUTTON, // Use default to ensure all keys exist
                        ...btn,                // Overwrite with stored values
                        // Ensure all required fields for instruments/vocal are there, even if empty
                        instrument: btn.instrument || '',
                        vocal: btn.vocal || '',
                        creditedAs: btn.creditedAs || '',
                    }));
                    return sortButtons(loadedButtons);
                }
            }
        } catch (e) {
            console.error(LOG_PREFIX, "Error loading buttons from localStorage, using default.", e);
        }
        log("Using default hardcoded button configuration.");
        return sortButtons(DEFAULT_BUTTONS.map(btn => ({...FULL_DEFAULT_BUTTON, ...btn})));
    }

    function saveButtons(buttons) {
        try {
            // 1. Filter out invalid/empty buttons
            const safeButtons = buttons.filter(btn => btn.label && btn.label.trim() !== '' && btn.artist && btn.artist.trim() !== '');

            // 2. Map and clean: only save relevant fields based on relationship type
            const cleanedButtons = safeButtons.map(btn => {
                const clean = {
                    label: btn.label,
                    relationshipType: btn.relationshipType,
                    artist: btn.artist,
                };

                if (btn.relationshipType === 'instruments') {
                    clean.instrument = btn.instrument;
                    clean.creditedAs = btn.creditedAs;
                } else if (btn.relationshipType === 'vocal') {
                    clean.vocal = btn.vocal;
                    clean.creditedAs = btn.creditedAs;
                }
                // For 'performed / performer', instrument, vocal, and creditedAs are omitted.
                return clean;
            });

            const sortedButtons = sortButtons(cleanedButtons);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(sortedButtons));
            log(`Saved ${sortedButtons.length} button configurations to localStorage.`);
            return sortedButtons;
        } catch (e) {
            console.error(LOG_PREFIX, "Error saving buttons to localStorage.", e);
            return buttons;
        }
    }

    // Initialize the buttons
    ARTIST_BUTTONS = getInitialButtons();


    // ----------------- Utilities -----------------
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
    async function waitVisible(selector, opts = {}) {
        const timeout = opts.timeout ?? 5000;
        const interval = opts.interval ?? 50;
        const start = Date.now();
        while (Date.now() - start < timeout) {
            const $el = $(selector).filter(':visible');
            if ($el.length) return $el;
            await sleep(interval);
        }
        return null;
    }
    async function waitDialogClosed(timeout = 2000) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            // Check for both the main modals and the specific config overlays
            const $visibleDialogs = $('.modal, .Dialog, .dialog, .ui-dialog, .ui-widget-overlay, #aa-config-modal-overlay, #aa-add-new-modal-overlay').filter(':visible');
            if ($visibleDialogs.length === 0) {
                await sleep(SMALL_BREATHING_ROOM_MS);
                return true;
            }
            await sleep(50);
        }
        return false;
    }
    async function waitForCondition(conditionFn, {timeout = 3000, interval = 50} = {}) {
        const start = Date.now();
        while (Date.now() - start < timeout) {
            try {
                if (await conditionFn()) return true;
            } catch (e) { /* ignore */ }
            await sleep(interval);
        }
        return false;
    }
    function setReactValueAndDispatch(el, value) {
        try {
            const nativeSetter = Object.getOwnPropertyDescriptor(el.__proto__, 'value')?.set;
            if (nativeSetter) nativeSetter.call(el, value);
            else el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
            el.dispatchEvent(new InputEvent('input', { bubbles: true }));
        } catch (e) {
            el.value = value;
            el.dispatchEvent(new Event('input', { bubbles: true }));
            el.dispatchEvent(new Event('change', { bubbles: true }));
        }
    }
    function clearInput(el) { setReactValueAndDispatch(el, ''); }
    async function typeAndSelect($input, text, {
        charDelay = GLOBAL_CHAR_DELAY_MS,
        postSelectWait = GLOBAL_POST_SELECT_WAIT_MS,
        optionSelector = "li[role='option']"
    } = {}) {
        const el = $input[0];
        if (!el) throw new Error('Input element missing');
        el.focus();
        clearInput(el);
        await sleep(50);
        for (let i = 0; i < text.length; i++) {
            const ch = text[i];
            const newValue = el.value + ch;
            setReactValueAndDispatch(el, newValue);
            await sleep(charDelay);
        }
        await sleep(100);
        const found = await waitForCondition(() => {
            const $opts = $(optionSelector).filter(':visible');
            if (!$opts.length) return false;
            const match = $opts.toArray().find(o => $(o).text().trim().toLowerCase().startsWith(text.toLowerCase()));
            if (match) { match.click(); return true; }
            const match2 = $opts.toArray().find(o => $(o).text().trim().toLowerCase().includes(text.toLowerCase()));
            if (match2) { match2.click(); return true; }
            return false;
        }, {timeout: 3000, interval: 80});
        if (!found) { log(`Warning: option for "${text}" not found in suggestions after timeout.`); }
        await sleep(postSelectWait);
    }
    async function openBatchAddDialog() {
        await waitDialogClosed(2000);
        const $batch = $("button.add-item.with-label.batch-add-recording-relationship, button.add-item.batch-add-recording-relationship, button.add-item.with-label").filter(function() {
            const t = $(this).text().toLowerCase();
            return t.includes('batch-add') || t.includes('batch add') || (t.includes('add') && t.includes('record'));
        });
        if ($batch.length === 0) { log("Batch-add button not found via selectors"); return false; }
        $batch[0].click();
        const appeared = await waitForCondition(() => {
            const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
            return $d.length > 0;
        }, {timeout: 3000, interval: 80});
        if (!appeared) { await sleep(300); }
        await sleep(SMALL_BREATHING_ROOM_MS);
        return true;
    }
    async function clickDoneAndWaitClose() {
        const $doneButton = await waitVisible('button.positive:visible', {timeout: 4000});
        if ($doneButton) {
            const $exactDone = $doneButton.filter((i, btn) => $(btn).text().trim() === 'Done');
            if ($exactDone.length) {
                log("Clicking Done");
                $exactDone[0].click();
                await waitForCondition(() => {
                    const $d = $('.modal, .Dialog, .dialog, .ui-dialog').filter(':visible');
                    return $d.length === 0;
                }, {timeout: 3000, interval: 80});
                await sleep(SMALL_BREATHING_ROOM_MS);
                return true;
            }
        }
        log("Done button not found (when trying to click Done).");
        return false;
    }

    // --- Initial State Cleanup ---
    function resetInitialState() {
        const $allRecordings = $('#tracklist input[type="checkbox"]:not(.work)');
        const $checkedOnLoad = $allRecordings.filter(':checked');

        if ($checkedOnLoad.length > 0) {
            log(`Initial state fix: Found ${$checkedOnLoad.length} checked checkboxes on load. Forcing uncheck with aggressive click simulation.`);

            $checkedOnLoad.each(function() {
                const el = this;
                try {
                    el.dispatchEvent(new MouseEvent('click', { bubbles: true }));
                } catch(e) {
                    $(el).click();
                }
            });

            setTimeout(() => {
                const $stillChecked = $allRecordings.filter(':checked');
                if ($stillChecked.length > 0) {
                    log(`Warning: Aggressive uncheck failed. Still checked: ${$stillChecked.length}`);
                } else {
                    log("Initial state fix successful: 0 checked recordings after cleanup.");
                }
            }, 100);

            return true;
        }
        log("Initial state fix: Found 0 checked checkboxes on load. State is clean.");
        return false;
    }

    // ----------------- Filling sequence -----------------
    async function fillFieldsAsync(config) {
        log(`Start filling for: ${config.label} (${config.relationshipType})`);
        const $relInput = await waitVisible('input.relationship-type', {timeout: 4000});
        if (!$relInput) { log("Relationship type input not found ‚Äî aborting this item."); return false; }
        log(`Typing relationshipType '${config.relationshipType}'`);
        await typeAndSelect($relInput, config.relationshipType);

        const $artist = await waitVisible('input[placeholder="Type to search, or paste an MBID"]', {timeout: 4000});
        if (!$artist) { log("Artist input not found ‚Äî aborting this item."); return false; }
        log(`Typing artist '${config.artist}'`);
        await typeAndSelect($artist, config.artist);

        if (config.relationshipType === 'performed / performer') {
            // This relationship type does not have instrument, vocal, or credited-as fields.
            log("Performed / performer detected ‚Äî skipping attributes and clicking Done.");
            await clickDoneAndWaitClose();
            log(`Finished performer item: ${config.label}`);
            return true;
        }

        const placeholderName = config.relationshipType === 'instruments' ? 'instrument' : 'vocal';

        // Fill Instrument/Vocal
        if (config.relationshipType === 'instruments' || config.relationshipType === 'vocal') {
            const $inst = await waitVisible(`input[placeholder="${placeholderName}"]`, {timeout: 4000});
            if (!$inst) { log(`${placeholderName} input not found ‚Äî aborting this item.`); return false; }
            const desired = (config.relationshipType === 'instruments') ? config.instrument : config.vocal;
            if (desired && desired.length > 0) {
                log(`Typing ${placeholderName} '${desired}'`);
                await typeAndSelect($inst, desired);
            } else {
                log(`No ${placeholderName} value provided, skipping selection.`);
            }
        }

        // Fill Credited As
        const creditedAsValue = config.creditedAs ?? '';

        if (config.relationshipType !== 'performed / performer' && creditedAsValue.length > 0) {
            log("Attempting to fill 'Credited as' field‚Ä¶");
            // Find the visible 'credited as' input, prioritizing the one associated with the relationship type
            let $creditedInput = $("input:visible").filter((i, el) => {
                const cls = (el.className || '').toLowerCase();
                return cls.includes('attribute-credit');
            }).first();

            // Fallback strategy if initial filter is too broad/narrow
            if ($creditedInput.length === 0) {
                 $creditedInput = $("input:visible").filter((i, el) => {
                    const idn = (el.id || '').toLowerCase();
                    const name = (el.name || '').toLowerCase();
                    return idn.includes('credit') || name.includes('credit');
                }).first();
            }

            if ($creditedInput && $creditedInput.length) {
                const el = $creditedInput[0];
                setReactValueAndDispatch(el, creditedAsValue);
                await sleep(100);
                log(`'Credited as' set to "${creditedAsValue}"`);
            } else {
                log("Could not find credited-as input; skipping.");
            }
        } else {
            log("Skipping 'Credited as' filling (either not relevant or no value provided).");
        }

        const doneClicked = await clickDoneAndWaitClose();
        if (doneClicked) {
            log(`Finished item: ${config.label}`);
            return true;
        } else {
            log("Done not clicked (not found) ‚Äî but continuing.");
            return true;
        }
    }


    // ----------------- Queue Processing -----------------

    async function processQueue() {
        if (processing) return;
        processing = true;
        while (queue.length) {
            const config = queue.shift();
            try {
                log(`Processing queue item: ${config.label}`);
                const opened = await openBatchAddDialog();
                if (!opened) {
                    log("Could not open batch-add dialog ‚Äî skipping this item.");
                    await sleep(SMALL_BREATHING_ROOM_MS);
                    continue;
                }
                await fillFieldsAsync(config);
                await sleep(200);
            } catch (e) {
                console.error(LOG_PREFIX, "Error processing item", e);
                await sleep(500);
            }
        }
        processing = false;
        log("Batch processing queue finished.");
    }


    // ----------------- Modal UI -----------------

    // Function to dynamically show/hide fields based on relationship type
    function updateFieldVisibility($item) {
        const type = $item.find('select[name="relationshipType"]').val();

        // Hide all dynamic fields first
        $item.find('.instrument-field').hide();
        $item.find('.vocal-field').hide();
        $item.find('.creditedAs-field').show(); // Default to visible

        if (type === 'instruments') {
            $item.find('.instrument-field').show();
        } else if (type === 'vocal') {
            $item.find('.vocal-field').show();
        } else if (type === 'performed / performer') {
            // Hide all attribute fields for this type
            $item.find('.creditedAs-field').hide();
        }
    }

    function showAddButtonModal(saveCallback) {
        // Ensure only one modal is present
        $('#aa-add-new-modal-overlay').remove();

        const MODAL_STYLE = `
            #aa-add-new-modal-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.75); z-index: 10000; /* Higher Z-index than main config modal */
                display: flex; justify-content: center; align-items: center;
            }
            #aa-add-new-modal {
                background: white; padding: 20px; border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5); max-width: 500px;
                width: 90%;
                font-family: Arial, sans-serif; color: #333;
            }
            #aa-add-new-modal h4 { margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
            #aa-add-new-modal label { display: block; margin-top: 8px; font-weight: bold; font-size: 0.9em; }
            #aa-add-new-modal input, #aa-add-new-modal select {
                width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box;
                border: 1px solid #ccc; border-radius: 4px;
            }
            .aa-add-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
            .aa-add-footer button { padding: 8px 15px; cursor: pointer; border-radius: 4px; border: none; }
            .aa-add-save-btn { background-color: #4CAF50; color: white; }
            .aa-add-cancel-btn { background-color: #ccc; color: #333; }
        `;

        // Add the new style block
        if ($('#aa-add-new-modal-style').length === 0) {
             $('head').append(`<style id="aa-add-new-modal-style">${MODAL_STYLE}</style>`);
        }

        const $overlay = $('<div id="aa-add-new-modal-overlay">');
        const $modal = $('<div id="aa-add-new-modal">');

        $modal.html(`
            <h4>Add New Button Configuration</h4>
            <div id="aa-add-form">
                <label>Label (Button Text): <input type="text" name="label" value="" placeholder="E.g., Max Weinberg"></label>

                <label>Relationship Type:
                    <select name="relationshipType">
                        <option value="instruments">instruments</option>
                        <option value="vocal">vocal</option>
                        <option value="performed / performer">performed / performer</option>
                    </select>
                </label>
                <label>Artist Name: <input type="text" name="artist" value="" placeholder="E.g., Max Weinberg (required)"></label>

                <!-- DYNAMIC FIELDS -->
                <label class="instrument-field">Instrument (if type='instruments'): <input type="text" name="instrument" value="" placeholder="E.g., drums (drum set)"></label>
                <label class="vocal-field">Vocal (if type='vocal'): <input type="text" name="vocal" value="" placeholder="E.g., lead vocals"></label>
                <label class="creditedAs-field">Credited As: <input type="text" name="creditedAs" value="" placeholder="E.g., drums"></label>
            </div>
            <div class="aa-add-footer">
                <button class="aa-add-cancel-btn">Cancel</button>
                <button class="aa-add-save-btn">Add Button</button>
            </div>
        `);

        const $form = $modal.find('#aa-add-form');
        const $select = $form.find(`select[name="relationshipType"]`);
        const $labelInput = $form.find('input[name="label"]');
        const $artistInput = $form.find('input[name="artist"]');

        let artistEditedManually = false;

        // 1. Artist Sync Logic
        $artistInput.on('input', () => {
            // Once the user types anything in the artist field, disable syncing
            artistEditedManually = true;
        });

        $labelInput.on('input', function() {
            if (!artistEditedManually) {
                // Only sync if the artist field hasn't been manually touched
                $artistInput.val($(this).val());
            }
        });

        // 2. Field Visibility Logic
        const updateAddModalVisibility = () => {
             // Use the same logic as the main modal updateFieldVisibility
             const type = $select.val();
             $form.find('.instrument-field').hide();
             $form.find('.vocal-field').hide();
             $form.find('.creditedAs-field').show();

             if (type === 'instruments') {
                 $form.find('.instrument-field').show();
             } else if (type === 'vocal') {
                 $form.find('.vocal-field').show();
             } else if (type === 'performed / performer') {
                 $form.find('.creditedAs-field').hide();
             }
        };

        // Initial visibility
        updateAddModalVisibility();

        // Add change listener for dynamic visibility
        $select.on('change', updateAddModalVisibility);

        const cleanupAndClose = () => {
            $(document).off('keydown', escapeHandler);
            $overlay.remove();
        }

        $modal.on('click', '.aa-add-cancel-btn', cleanupAndClose);

        $modal.on('click', '.aa-add-save-btn', function() {
            const newButton = {
                label: $labelInput.val().trim(),
                relationshipType: $select.val(),
                artist: $artistInput.val().trim(),
                instrument: $form.find('input[name="instrument"]').val().trim(),
                vocal: $form.find('input[name="vocal"]').val().trim(),
                creditedAs: $form.find('input[name="creditedAs"]').val().trim(),
            };

            if (!newButton.label || !newButton.artist) {
                // Using alert() here as it is inside a custom modal flow and should be seen
                alert("Both Label and Artist Name are required to add a new button.");
                return;
            }

            saveCallback(newButton);
            cleanupAndClose();
        });

        // Escape Key Handler
        const escapeHandler = function(e) {
            const isInput = $(e.target).is('input, select, textarea');
            if (e.key === 'Escape' && !isInput) {
                e.preventDefault();
                e.stopPropagation();
                cleanupAndClose();
            }
        };

        $(document).on('keydown', escapeHandler);

        $overlay.append($modal);
        $('body').append($overlay);
    }

    function showConfigModal() {
        // Ensure only one modal is present
        $('#aa-config-modal-overlay').remove();

        // Deep clone the current buttons for local manipulation
        // Note: currentButtons will be dynamically replaced by getCurrentConfigFromForm(true)
        // when changes occur in the DOM, making it match the current view.
        let currentButtons = ARTIST_BUTTONS.map(a => Object.assign({}, a));

        // Capture the initial state string (must be sorted for a reliable comparison)
        const initialConfigString = JSON.stringify(sortButtons(currentButtons.map(a => Object.assign({}, a))));

        const MODAL_STYLE = `
            #aa-config-modal-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.75); z-index: 9999;
                display: flex; justify-content: center; align-items: center;
            }
            #aa-config-modal {
                background: white; padding: 20px; border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); max-width: 800px;
                width: 90%; max-height: 90%;
                font-family: Arial, sans-serif; color: #333;
                display: flex; /* Flex container for scrollable content + fixed footer */
                flex-direction: column;
            }
            #aa-config-modal h3 { margin-top: 0; border-bottom: 1px solid #ccc; padding-bottom: 10px; flex-shrink: 0; }

            #aa-config-scroll-area {
                overflow-y: auto; /* Scrollable content area */
                flex-grow: 1;
                padding-right: 5px; /* Add slight padding for scrollbar visibility */
            }

            .aa-config-item {
                border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 6px;
                background-color: #f9f9f9;
            }
            .aa-config-item h4 { margin: 0 0 10px 0; display: flex; justify-content: space-between; align-items: center; }
            .aa-config-item label { display: block; margin-top: 8px; font-weight: bold; font-size: 0.9em; }
            .aa-config-item input, .aa-config-item select {
                width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box;
                border: 1px solid #ccc; border-radius: 4px;
            }
            /* FIXED FOOTER STYLE */
            .aa-config-footer {
                display: flex; justify-content: space-between; margin-top: 15px; padding-top: 15px;
                border-top: 1px solid #ccc;
                flex-shrink: 0;
            }
            .aa-config-footer button {
                padding: 8px 15px; cursor: pointer; border-radius: 4px; border: none;
                font-weight: bold;
            }
            .aa-remove-btn { background-color: #f44336; color: white; border: none; padding: 4px 8px; font-size: 0.8em; cursor: pointer; }
            .aa-add-btn, .aa-save-btn { /* Apply cursor to Add New button */
                cursor: pointer;
            }
            .aa-add-btn { background-color: #007bff; color: white; border: none; }
            .aa-save-btn { background-color: #4CAF50; color: white; border: none; }
            .aa-close-btn { background-color: #ccc; color: #333; border: none; cursor: pointer; }
        `;

        // Apply styles
        if ($('#aa-config-modal-style').length === 0) {
             $('head').append(`<style id="aa-config-modal-style">${MODAL_STYLE}</style>`);
        }


        const $overlay = $('<div id="aa-config-modal-overlay">');
        const $modal = $('<div id="aa-config-modal">');
        $modal.html('<h3>Batch Relationship Button Configuration</h3><div id="aa-config-scroll-area"><div id="aa-config-form"></div></div>');

        const $scrollArea = $modal.find('#aa-config-scroll-area');
        const $formContainer = $modal.find('#aa-config-form');

        const renderForm = (buttons) => {
            $formContainer.empty();
            // Important: Render the *sorted* array
            buttons.forEach((config, index) => {
                const $item = $(`<div class="aa-config-item" data-index="${index}">`);

                // Use default values if keys are missing (e.g., in a cleaned 'performed / performer' object)
                const safeConfig = {...FULL_DEFAULT_BUTTON, ...config};

                // Build the item structure
                $item.append(`
                    <h4>
                        Button ${index + 1}: ${safeConfig.label}
                        <button class="aa-remove-btn">Remove</button>
                    </h4>
                    <label>Label (Button Text): <input type="text" name="label" value="${safeConfig.label || ''}" placeholder="E.g., Max Weinberg"></label>

                    <label>Relationship Type:
                        <select name="relationshipType">
                            <option value="instruments">instruments</option>
                            <option value="vocal">vocal</option>
                            <option value="performed / performer">performed / performer</option>
                        </select>
                    </label>
                    <label>Artist Name: <input type="text" name="artist" value="${safeConfig.artist || ''}" placeholder="E.g., Max Weinberg (required)"></label>

                    <!-- DYNAMIC FIELDS -->
                    <label class="instrument-field">Instrument (if type='instruments'): <input type="text" name="instrument" value="${safeConfig.instrument || ''}" placeholder="E.g., drums (drum set)"></label>
                    <label class="vocal-field">Vocal (if type='vocal'): <input type="text" name="vocal" value="${safeConfig.vocal || ''}" placeholder="E.g., lead vocals"></label>

                    <label class="creditedAs-field">Credited As: <input type="text" name="creditedAs" value="${safeConfig.creditedAs || ''}" placeholder="E.g., drums"></label>
                `);

                // Set selected value for relationshipType
                const $select = $item.find(`select[name="relationshipType"]`);
                $select.val(safeConfig.relationshipType);

                // Initial visibility update
                updateFieldVisibility($item);

                // Add change listener for dynamic visibility
                $select.on('change', function() {
                    updateFieldVisibility($item);
                });

                // Add change listener to all inputs to update the local currentButtons array instantly
                $item.find('input, select').on('change keyup', function() {
                    const fieldName = $(this).attr('name');
                    const value = $(this).val();
                    const $currentItem = $(this).closest('.aa-config-item');
                    const index = $currentItem.data('index');

                    // Update the label in the h4 for instant feedback
                    if (fieldName === 'label') {
                        $currentItem.find('h4').html(`Button ${index + 1}: ${value}<button class="aa-remove-btn">Remove</button>`);
                    }

                    // Update the local array by reading the current DOM state (sorted)
                    // This ensures currentButtons always matches the visible form for accurate removal/saving
                    currentButtons = getCurrentConfigFromForm(true);
                });


                $formContainer.append($item);
            });
        };

        // Utility to extract current form state (used for comparison)
        function getCurrentConfigFromForm(onlyReadDom = false) {
            if (onlyReadDom) {
                const currentConfig = [];
                $formContainer.find('.aa-config-item').each(function() {
                    currentConfig.push({
                        label: $(this).find('input[name="label"]').val().trim(),
                        relationshipType: $(this).find('select[name="relationshipType"]').val(),
                        artist: $(this).find('input[name="artist"]').val().trim(),
                        instrument: $(this).find('input[name="instrument"]').val().trim(),
                        vocal: $(this).find('input[name="vocal"]').val().trim(),
                        creditedAs: $(this).find('input[name="creditedAs"]').val().trim(),
                    });
                });
                return sortButtons(currentConfig);
            }
            // Fallback: use the in-memory array
            return sortButtons(currentButtons.map(a => Object.assign({}, a)));
        }

        // Initial render
        renderForm(currentButtons);

        // --- Event Handlers ---

        // Cleanup function for modal closure
        const cleanupAndClose = () => {
            $(document).off('keydown', escapeHandler);
            $('#aa-add-new-modal-overlay').remove(); // Ensure add modal is also closed
            $overlay.remove();
        }

        // Add New Button Handler
        const handleAddNewButton = () => {
             // Open the dedicated small modal
             showAddButtonModal((newButton) => {
                // Callback function when the new button is saved in the sub-modal

                // 1. Read the current DOM state to ensure we capture any pending edits
                const currentDomConfig = getCurrentConfigFromForm(true);

                // 2. Add the new button
                currentDomConfig.push(newButton);
                currentButtons = sortButtons(currentDomConfig); // Update local array

                // 3. Re-render the main form with the new, sorted button list
                renderForm(currentButtons);

                // 4. Scroll to the bottom to see the newly added button (which is now in its sorted position)
                $scrollArea.scrollTop($scrollArea[0].scrollHeight);
             });
        };


        // Remove Button (FIXED: Uses index for unique removal)
        $modal.on('click', '.aa-remove-btn', function() {
            const $item = $(this).closest('.aa-config-item');

            // Read the current state of the buttons from the form (guaranteed to match the visible list)
            const domConfig = getCurrentConfigFromForm(true);
            const indexToRemove = $item.data('index'); // This index is based on the *sorted* array shown on screen

            if (domConfig.length > 1) {

                // Remove the item at the specific index using splice
                domConfig.splice(indexToRemove, 1);

                // Update currentButtons and ensure it is sorted
                currentButtons = sortButtons(domConfig);

                renderForm(currentButtons);

            } else {
                console.warn(LOG_PREFIX, "User tried to remove the last button. Must keep at least one.");
                alert("You must keep at least one button configuration.");
            }
        });

        // Save Button
        const saveAndClose = () => {
            const newConfig = [];
            let valid = true;

            $formContainer.find('.aa-config-item').each(function() {
                const $item = $(this);
                const label = $item.find('input[name="label"]').val().trim();
                const artist = $item.find('input[name="artist"]').val().trim();

                if (!label || !artist) {
                    // Using alert() here as it is inside a custom modal flow and should be seen
                    alert(`Button configuration requires both a Label and an Artist Name. Please check item ${$item.data('index') + 1}.`);
                    valid = false;
                    return false; // Stop .each loop
                }

                newConfig.push({
                    label: label,
                    relationshipType: $item.find('select[name="relationshipType"]').val(),
                    artist: artist,
                    instrument: $item.find('input[name="instrument"]').val().trim(),
                    vocal: $item.find('input[name="vocal"]').val().trim(),
                    creditedAs: $item.find('input[name="creditedAs"]').val().trim(),
                });
            });

            if (valid) {
                // Save and sort the new configuration (saveButtons will handle stripping unnecessary fields)
                ARTIST_BUTTONS = saveButtons(newConfig);
                renderButtons(ARTIST_BUTTONS); // Re-render the batch buttons on the main page
                cleanupAndClose();
                log("Configuration saved and buttons updated.");
            }
        };

        // Escape Key Handler
        const escapeHandler = function(e) {
            // Check if the event target is inside an input field, which might be handling Esc for something else
            const isInput = $(e.target).is('input, select, textarea');
            if (e.key === 'Escape' && !isInput) {
                e.preventDefault();
                e.stopPropagation();

                const finalConfig = getCurrentConfigFromForm(true); // Read current state from DOM
                const finalConfigString = JSON.stringify(finalConfig);

                if (finalConfigString === initialConfigString) {
                    // No changes, close safely
                    cleanupAndClose();
                    log("Configuration modal closed with Esc key (no changes).");
                } else {
                    // Changes made, prompt user
                    const response = window.confirm("You have unsaved changes. Press OK to discard changes and close, or Cancel to return and Save.");
                    if (response) {
                        cleanupAndClose();
                        log("Configuration modal closed with Esc key (changes discarded).");
                    }
                }
            }
        };

        // Attach event listeners
        $(document).on('keydown', escapeHandler);

        // Footer (Fixed position achieved by putting it outside the scroll area)
        const $footer = $(`
            <div class="aa-config-footer">
                <button class="aa-close-btn">Close</button>
                <div>
                    <button class="aa-add-btn">Add New Button</button>
                    <button class="aa-save-btn">Save & Reload Buttons</button>
                </div>
            </div>
        `);

        $modal.append($footer);

        $modal.on('click', '.aa-close-btn', cleanupAndClose);
        $modal.on('click', '.aa-save-btn', saveAndClose);
        $modal.on('click', '.aa-add-btn', handleAddNewButton);

        $overlay.append($modal);
        $('body').append($overlay);
    }

    // ----------------- UI: Button Rendering and Creation -----------------

    const BUTTON_STYLE_CONFIG = {
        'instruments': { bgColor: '#4CAF50', activeColor: '#3e8e41', icon: 'üé∏ ' },
        'vocal': { bgColor: '#2196F3', activeColor: '#0b7dda', icon: 'üé§ ' },
        'performed / performer': { bgColor: '#FF9800', activeColor: '#e68a00', icon: 'üé≠ ' },
        'default': { bgColor: '#607D8B', activeColor: '#455a64', icon: 'üîó ' }
    };

    function renderButtons(buttons) {
        const $mainContainer = $('.injected-buttons-container');
        if ($mainContainer.length === 0) return;

        let $batchButtonContainer = $mainContainer.find('#aa-batch-buttons');
        if ($batchButtonContainer.length === 0) {
            $batchButtonContainer = $('<div id="aa-batch-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>');
            $mainContainer.append($batchButtonContainer);
        }

        $batchButtonContainer.empty();

        buttons.forEach(config => {
            const style = BUTTON_STYLE_CONFIG[config.relationshipType] || BUTTON_STYLE_CONFIG['default'];
            const buttonText = `${style.icon}${config.label}`;

            const buttonStyleString = `
                background-color: ${style.bgColor};
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.15s ease-in-out;
                white-space: nowrap;
                flex-shrink: 0;
                line-height: 20px;
            `;

            const $button = $('<button/>', {
                text: buttonText,
                'data-label': config.label
            });

            $button.attr('style', buttonStyleString);

            $button.on({
                'mouseenter': function() { $(this).css('opacity', 0.9); },
                'mouseleave': function() { $(this).css('opacity', 1); },
                'click': function() {
                    $(this).css('background-color', style.activeColor);
                    setTimeout(() => $(this).css('background-color', style.bgColor), 500);
                }
            });

            $batchButtonContainer.append($button);

            $button.on('click', () => {
                log(`Enqueued "${config.label}" (${config.relationshipType})`);
                queue.push(Object.assign({}, config));
                processQueue().catch(e => console.error(e));
            });
        });
    }

    function createCustomButtons() {
        const $heading = $(HEADING_SELECTOR);

        if ($heading.length === 0) {
            log("Heading 'Track relationships' not found yet ‚Äî retrying‚Ä¶");
            setTimeout(createCustomButtons, 500);
            return;
        }

        let $container = $heading.next('.injected-buttons-container');
        if ($container.length === 0) {
            $container = $(`
                <div
                    class="injected-buttons-container"
                    style="
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        flex-wrap: wrap;
                        margin-top: 10px;
                        margin-bottom: 5px;
                        padding: 10px 0;
                        width: 100%;
                        z-index: 1000;
                    ">
                </div>
            `);
            $heading.after($container);
        } else {
             $container.find('#aa-batch-buttons').remove();
        }

        // --- 1. Create and prepend the permanent 'Configure' button with 2-line text ---
        const $configButton = $container.find('#aa-config-btn');
        if ($configButton.length === 0) {
            const configButtonStyle = `
                background-color: #607D8B;
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.15s ease-in-out;
                flex-shrink: 0;
                line-height: 1.2;
            `;

            // Updated text: "Configure recording\nrelation buttons"
            const buttonHtml = '‚öôÔ∏è Configure recording<br>relation buttons';

            const $config = $('<button/>', {
                id: 'aa-config-btn',
                html: buttonHtml
            });

            $config.attr('style', configButtonStyle);
            $container.prepend($config);
            $config.on('click', showConfigModal);
        }

        // --- 2. Render the dynamic batch-add buttons ---
        renderButtons(ARTIST_BUTTONS);


        // --- 3. VISIBILITY LOGIC ---

        function getCheckedRecordings() {
            const $checkedRecordings = $('#tracklist input[type="checkbox"]:not(.work)');
            return $checkedRecordings;
        }

        function updateButtonVisibility() {
            try {
                if (DEBUG_VISIBILITY) log("Update visibility check called.");

                const $checked = getCheckedRecordings();
                const checkedCount = $checked.length;
                const anyChecked = checkedCount > 0;

                const $batchContainer = $container.find('#aa-batch-buttons');
                if ($batchContainer.length === 0) return;

                const currentDisplay = $batchContainer.css('display');

                if (currentDisplay === 'flex' && checkedCount === 0) {
                     if (DEBUG) log("Batch buttons visible, but 0 tracks checked. Forcing OFF.");
                     $batchContainer.css('display', 'none');
                     return;
                }

                if (anyChecked) {
                    if (currentDisplay === 'none') {
                        $batchContainer.css('display', 'flex');
                        if (DEBUG) log("Toggled batch buttons ON (display: flex)");
                    }
                } else {
                    if (currentDisplay === 'flex') {
                        $batchContainer.css('display', 'none');
                        if (DEBUG) log("Toggled batch buttons OFF (display: none)");
                    }
                }
            } catch (e) {
                console.error(LOG_PREFIX, "Error in updateButtonVisibility loop:", e);
            }
        }

        updateButtonVisibility();

        $('#tracklist').on('change click input', 'input[type="checkbox"]', function() {
             try {
                 if (DEBUG) log("Checkbox event detected, updating visibility...");
                 // Use setTimeout to ensure the DOM state is settled after the click/change
                 setTimeout(updateButtonVisibility, 50);
             } catch (e) {
                console.error(LOG_PREFIX, "Error in checkbox event handler:", e);
             }
        });

        // Set up the heartbeat check
        setInterval(updateButtonVisibility, VISIBILITY_HEARTBEAT_MS);

        log("Injected custom buttons and configuration.");
    }

    // ----------------- Main Execution -----------------

    try {
        setTimeout(() => {
            log("Starting userscript execution...");
            resetInitialState();
            createCustomButtons();
        }, 2000);
    } catch (error) {
        // This catch block primarily catches sync errors during the setting of the timeout.
        console.error(LOG_PREFIX, "CRITICAL SCRIPT FAILURE during initial setup:", error);
    }

})();
#+end_example

*** config button placement

In the uploaded userscript, can you place the

#+begin_example
                <div id="aa-config-container" style="display:flex; gap:10px; flex-wrap:wrap;">
#+end_example

together with its button '<button id="aa-config-btn"' with a little space after the

#+begin_example
<h2>Track relationships</h2>
#+end_example

but in the same line when the page loads.

But leave the '<div id="aa-action-buttons-container" style="display: none;">' with its buttons '<div id="aa-batch-buttons"'
below the line with the "Track relationships" header

Please DO NOT make any code changes, as everything works ok.

** button doubling

In the uploaded userscript, can you double the following

#+begin_example
                <div id="aa-config-container" style="display:flex; gap:10px; flex-wrap:wrap;">
#+end_example

together with its button '<button id="aa-config-btn"' with a little space after the

#+begin_example
<h2>Track relationships</h2>
#+end_example

and NOT touch the rest of the script

** direct MBID handling

In the uploaded userscript, if the config.artist is an MBID directly instead of  just the artist name
(for example MBID=70248960-cb53-4ea4-943a-edb18f7d336f for artist="Bruce Springsteen")

adjust the logic in the function "sync function typeAndSelect" so that instead of typing each character of the MBID,
insert it as is and wait for completion on the whole MBID string, instead of typing char by char of an artist name and wait for completion after each inserted char.

It should be much faster.

* Guess Related Works
** Gemini

In the uploaded userscript, the whole UI dialog starting with

#+begin_example
    <summary style="display: block;margin-left: 8px;cursor: pointer;">
      <h3 style="display: list-item;">
        Search for works
      </h3>
    </summary>
#+end_example

is collapsible. Please make also the sub dialog starting with

#+begin_example
<h3>Link to parts of a main Work</h3>
#+end_example

collapsible.

** 1

A couple of little observations:

1.) Can you indent the sub dialog a litle bit
2.) The sub dialog should initially be collapsed
3.) The mouse pointer should change to a finger when over the "Guess works" button
4.) The button should visually react when clicking on it

Please make this changes

** 2

In the uploaded script, make the following changes

1.) collapse the whole UI by default initially
2.) Add an additional button with the same name "Guess works" right behind the "Search for works:"

#+begin_example
    <summary style="display: block;margin-left: 8px;cursor: pointer;">
      <h3 style="display: list-item;">
        Search for works:
      </h3>
    </summary>
#+end_example

So this button should never collapse. The other button

#+begin_example
      <input type="button" id="searchWork" value="Guess works">
#+end_example

should still remain. Both buttons when clicked should execute the same  functionality

** 3

Please put the browser's default disclosure triangle (the visual handle) right in front of the "Search for works:" heading
Also shade the buttons light grey and make them dark grey when the curser moves over them

** 4

The actual trianle handle before the deading is actually not visible, but by clicking the header I can
uncollapse. Please make the trinagle alos visible

** 5

The triangle overlaps with the beginning char of "Search for works:" So its hardly visible.
Also iniitally everything should be collapsed


* Copy Dates On Recording Relations
** gemini

In the uploaded userscript, the UI dialog should be changed in such a way that

1.) The mouse pointer should change to a finger when over the "Copy dates" and "Remove dates" buttons
2.) The buttons should visually react when clicking on them

Additionally the button "Copy dates" should be there two times and also be placed directly after "<h3>Dates:</h3>" in the same line

** 1

Remove one instance ot the "Copy dates" button and make the whole dialog initially collapsed

** 2

Also render the following part

#+begin_example
<label for="replaceDates">Replace dates if pre-existing:&nbsp;</label>
                    <input type="checkbox" id="replaceDates">
#+end_example

right after the "Remove dates" button, so there is no need to use collapsing

** change the button style

In the uploaded userscript, change the button style to be the same as the recently implmented ones (I mean the grey handling)


* Set Relation Attributes

In the uploaded userscript, the UI dialog should be changed in such a way that

1.) The mouse pointer should change to a finger when over buttons
2.) The buttons should visually react when clicking on them
3.) Also shade the buttons light grey and make them dark grey when the curser moves over them


Additionally the button "Set live" should be there two times and also be placed directly after "Relation attributes:" in the same line
The whole UI should be collapsed initially.

Actually its the same stuff what we did before with the other uploaded usercript "GuessRelatedWorks"


* Clone Recording Relations Onto Other Recordings In Relation Editor

In the uploaded userscript, the UI dialog should be changed in such a way that

1.) The mouse pointer should change to a finger when over buttons
2.) The buttons should visually react when clicking on them
3.) Also shade the buttons light grey and make them dark grey when the curser moves over them

Adjust the rendering the following way:

The following info from the "details" section with id="clone_rels_script_toggle"

#+begin_example
      <details id="clone_rels_script_toggle">
        <summary style="display: block;margin-left: 8px;cursor: pointer;">
          <h3 style="display: list-item;">
            Clone recording relations to selected recordings:
          </h3>
        </summary>
        <div>
          <span>
            Source recording index in selection:
          </span>
          &nbsp;
          <input type="text" id="cloneRef" placeholder="empty or n or 'n1-n2'">
          <span title="${cloneIdxHelp}">üõà</span>
          &nbsp;
          <span>OR recording link:&nbsp;</span>
          <input type="text" id="cloneExtRecording" placeholder="recording mbid">
          <br />
          <input type="button" id="cloneAR" value="Apply">
        </div>
      </details>
#+end_example

should be rendered non-collapsable in one line right after the heading "Clone recording relations to selected recordings:"

Additionally the info from the "details" section with id="clone_release_rels_script_toggle"

#+begin_example
      <details id="clone_release_rels_script_toggle">
        <summary style="display: block;margin-left: 8px;cursor: pointer;">
          <h3 style="display: list-item;">
            Clone release relations from another release:
          </h3>
        </summary>
        <div>
          <span>release link:&nbsp;</span>
          <input type="text" id="cloneExtRelease" placeholder="release mbid">
          <br />
          <input type="button" id="cloneReleaseAR" value="Apply">
        </div>
      </details>
#+end_example

should also be rendered non-collapsable in one line right after the heading "Clone release relations from another release:"
one line below the above one.

PLEASE DO NOT make any changes to the code logic, just the button appearance and placing.


* Replace Release Relations By Recording Relations In Relation Editor

In the uploaded userscript, the UI dialog should be changed in such a way that

These two elements should be rendered in one line

#+begin_example
        <h3>Move release relations to recordings</h3>
        <input type="button" id="moveAR" value="Move release relations to selected recordings">
#+end_example

althought the button text should be changed to just "Move to selected recordings"

1.) The mouse pointer should change to a finger when over buttons
2.) The buttons should visually react when clicking on them
3.) Also shade the buttons light grey and make them dark grey when the curser moves over them

PLEASE DO NOT make any changes to the code logic, just the button appearance and placing.


* Set Role In Recording-Artist Relation In Relation Editor

In the uploaded userscript, the UI dialog should be changed in such a way that

1.) The mouse pointer should change to a finger when over buttons
2.) The buttons should visually react when clicking on them
3.) Also shade the buttons light grey and make them dark grey when the curser moves over them

Additionally place the browser's default disclosure triangle (the visual handle) right in front of the "Replace artist role:"
heading and the "Apply" button '<input type="button" id="setRole" value='Apply'>' right after the heading
"Replace artist role:", so all should be in one line. Right now the "Replace artist role:" is place after the disclosure triangle.

PLEASE DO NOT make any changes to the code logic, just the button appearance and placing.


* common functions
** gemini

In the uploaded userscript, the UI dialog should be changed in such a way that in the following code

#+begin_example
      <div id="loujine-menu"
         style="background-color: white;
            padding: 8px; margin: 0px -6px 6px;
            border: 5px dotted rgb(115, 109, 171);">
        <h2>loujine GM tools</h2>
        <a href="${wikiUrl}" target="_blank">documentation</a>
      </div>
#+end_example

#+begin_example
        <h2>loujine GM tools</h2>
        <a href="${wikiUrl}" target="_blank">documentation</a>
#+end_example

Should be rendered in one line, the link after "loujine GM tools". Also the background of the whole area should be a very light grey and the border should be a continues line.

** 1

Why does on one browser get the container "div#vz-menu" rendered multiple times (once for each execution of a userscript
which requires the definition from the same .js library file), but on another it is just rendered once



* refactoring buttons

All the uploaded userscripts are displaying buttons for their respective UI, they also all require the same "https://raw.githubusercontent.com/vzell/mb-userscripts/refs/heads/master/vz-common.js"
Could this be refactored and the button shape, color, changing the icon to a finger when hovering over and so on, be included somehow in the library file vz-common.js

please adjust the style for the "mb-userscript-button" in out library file to look like in the following definition

#+begin_example
        const saveButton = document.createElement('button');
        saveButton.textContent = 'Save';
        saveButton.className = 'submit';
        saveButton.style.padding = '6px 12px';
        saveButton.style.border = '1px solid #4CAF50';
        saveButton.style.borderRadius = '4px';
        saveButton.style.backgroundColor = '#4CAF50';
        saveButton.style.color = 'white';
        saveButton.style.cursor = 'pointer';
        saveButton.style.fontWeight = 'bold';
#+end_example

** library code

#+begin_example
// ... (rest of RelationshipEditor class content)

  /**
   * Common button style for all userscripts
   */
  commonButtonStyle() {
    return `
      <style>
          .mb-userscript-button {
              /* Based on user request (green 'Save' button style) */
              padding: 6px 12px;
              border: 1px solid #4CAF50;
              border-radius: 4px;
              background-color: #4CAF50;
              color: white;
              cursor: pointer; /* Sets the cursor to a finger on hover */
              font-weight: bold;
              /* Added effects for a better UI experience */
              transition: background-color 0.2s ease, transform 0.1s ease;
              display: inline-block;
          }
          .mb-userscript-button:hover {
              background-color: #45a049; /* Slightly darker green on hover */
          }
          .mb-userscript-button:active {
              background-color: #3e8e41; /* Even darker green on click */
              transform: translateY(1px); /* Visual click feedback */
          }
          /* Ensure headings inside the container don't have excessive margins */
          #vzell-menu h3 {
              margin: 0;
          }
      </style>
    `;
  }

  container(node) {
    const container = document.getElementById('vzell-menu');
    if (container !== null) {
      // Return the inner toolbar list container if the main container already exists
      return document.getElementById('vzell-menu-toolbar-list');
    }
    // Inject common styles and the main container
    node.insertAdjacentHTML('afterend', `
      <div id="vzell-menu"
          style="background-color: #f5f5f5;
                 padding: 8px; margin: 0px -6px 6px;
                 border: 5px solid rgb(115, 109, 171);">
          ${this.commonButtonStyle()}
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
              <h2 style="margin: 0; font-size: 1.5em;">loujine GM tools (adapted by <a href="https://github.com/vzell/mb-userscripts" target="_blank">vzell</a>)</h2>
              <a href="${wikiUrl}" target="_blank">documentation</a>
          </div>
          <div id="vzell-menu-toolbar-list">
             </div>
      </div>
    `);
    // Return the new inner div where specific toolbars will be placed
    return document.getElementById('vzell-menu-toolbar-list');
  }

// ... (rest of RelationshipEditor class content)
#+end_example

** MoveReleaseRelationsToRecordings.user.js

Remove the entire local <style> block and update the button class.

#+begin_example
// ... (start of file)

(function displayToolbar() {
    relEditor.container(document.querySelector('div.tabs'))
             .insertAdjacentHTML('beforeend', `
        <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
            <h3 style="margin: 0;">Move release relations to recordings:</h3>
            <input type="button" id="moveAR" value="Move to selected recordings" class="mb-userscript-button">
        </div>
    `);
})();

// ... (end of file)
#+end_example

** CopyDatesOnRecordingRelations.user.js

Remove the redundant button styling, replace .date-button with .mb-userscript-button, and simplify the container
logic. Note that the essential .inline-checkbox-label style remains because it's specific to the script's layout, not
the button appearance.

#+begin_example
// ... (start of file)

(function displayToolbar() {
    relEditor.container(document.querySelector('div.tabs'))
    .insertAdjacentHTML('beforeend', `
        <style>
            /* Style to align the checkbox label/input pair inline with buttons (specific layout) */
            .inline-checkbox-label {
                display: flex;
                align-items: center;
                gap: 4px; /* Space between label text and checkbox */
            }
            .inline-checkbox-label input[type="checkbox"] {
                margin: 0; /* Remove default margin */
            }
        </style>
        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
            <h3>Dates:</h3>
            <input type="button" class="mb-userscript-button" id="copyDates" value="Copy dates">
            <input type="button" class="mb-userscript-button" id="removeDates" value="Remove dates">

            <label for="replaceDates" class="inline-checkbox-label" style="font-weight: normal; margin-left: 8px;">
                Replace dates if pre-existing:&nbsp;
                <input type="checkbox" id="replaceDates">
            </label>
        </div>
    `);
})();

// ... (end of file)
#+end_example

** CloneRecordingRelations.user.js

Replace the old class (.work-button-style) with the new one (.mb-userscript-button).

#+begin_example
// ... (start of file)

(function displayToolbar() {
    relEditor.container(document.querySelector('div.tabs'))
             .insertAdjacentHTML('beforeend', `
        <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
            <h3 style="margin: 0;">Clone recording relations from the recording at track list position:</h3>
            <input type="number" id="cloneRef" placeholder="track #">
            <input type="button" id="cloneAR" value="Apply" class="mb-userscript-button">
        </div>
        <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px;">
            <h3 style="margin: 0;">Clone recording relations from another recording:</h3>
            <span>Recording link:&nbsp;</span>
            <input type="text" id="cloneExtRecording" placeholder="Recording MBID">
            <input type="button" id="cloneAR" value="Apply" class="mb-userscript-button">
        </div>
        <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px; margin-bottom: 10px;">
            <h3 style="margin: 0;">Clone release relations from another release:</h3>
            <span>Release link:&nbsp;</span>
            <input type="text" id="cloneExtRelease" placeholder="Release MBID">
            <input type="button" id="cloneReleaseAR" value="Apply" class="mb-userscript-button">
        </div>`);
})();

// ... (end of file)
#+end_example

** SetRelationAttributes.user.js

Replace the old class (.work-button-style) with the new one (.mb-userscript-button) in all button definitions.

#+begin_example
// ... (start of file)

(function displayToolbar() {
    relEditor.container(document.querySelector('div.tabs'))
             .insertAdjacentHTML('beforeend', `
        <details>
            <summary class="v-details-summary">
                <h3 style="display: inline-block;">Work Relation Attributes</h3>
                <input type="button" id="setLiveUncollapsed" value="Set live" class="mb-userscript-button">
            </summary>
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
                <h3>Work Relation Attributes:</h3>
                <input type="button" id="setCover" value="Set cover" class="mb-userscript-button">
                <input type="button" id="toggleCover" value="Toggle cover" class="mb-userscript-button">
                <input type="button" id="setLive" value="Set live" class="mb-userscript-button">
                <input type="button" id="toggleLive" value="Toggle live" class="mb-userscript-button">
                <input type="button" id="setPartial" value="Set partial" class="mb-userscript-button">
                <input type="button" id="togglePartial" value="Toggle partial" class="mb-userscript-button">
                <input type="button" id="setInstrumental" value="Set instrumental" class="mb-userscript-button">
                <input type="button" id="toggleInstrumental" value="Toggle instrumental" class="mb-userscript-button">
                <input type="button" id="setMedley" value="Set medley" class="mb-userscript-button">
                <input type="button" id="toggleMedley" value="Toggle medley" class="mb-userscript-button">
            </div>
            <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
                <h3>Recording-Artist relation attributes</h3>
                <input type="button" id="toggleSolo" value="Toggle solo" class="mb-userscript-button">
                <input type="button" id="toggleAdditional" value="Toggle additional" class="mb-userscript-button">
                <input type="button" id="toggleGuest" value="Toggle guest" class="mb-userscript-button">
            </div>
        </details>
    `);
})();

// ... (end of file)
#+end_example

** GuessRelatedWorks.user.js

Replace the old class (.work-button-style) with the new one (.mb-userscript-button).

#+begin_example
// ... (start of file)

(function displayToolbar() {
    const repeatHelp = 'Comma-separated list of track numbers (one-based) to be linked to the work, e.g. "1,2,5". If left empty, all selected recordings will be used.';
    relEditor.container(document.querySelector('div.tabs'))
             .insertAdjacentHTML('beforeend', `
    <details>
      <summary class="v-details-summary">
        <h3 style="display: inline-block;">Guess related works</h3>
        <input type="button" id="searchWorkUncollapsed" value="Guess work" class="mb-userscript-button">
      </summary>
      <div style="display: flex; align-items: center; gap: 8px; margin-top: 10px; flex-wrap: wrap;">
          <input type="button" id="searchWork" value="Guess work" class="mb-userscript-button">
          <input type="button" id="openEditor" value="Set attributes" class="mb-userscript-button">
          <input type="button" id="removeWorks" value="Remove works" class="mb-userscript-button">
        <br />
        <details>
          <summary class="v-details-summary">
            <h3 style="display: inline-block;">Subworks</h3>
          </summary>
            <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 8px; margin-top: 10px;">
              <span>Track numbers:&nbsp;</span>
              <input type="text" id="trackNumbers" placeholder="n1,n2,n3... (optional)">
              <span title="${repeatHelp}">üõà</span>
              <br />
              <label for="replaceSubworks">Replace work if pre-existing:&nbsp;</label>
              <input type="checkbox" id="replaceSubworks">
              <br />
              <span>Main work name:&nbsp;</span>
              <input type="text" id="mainWork" placeholder="main work mbid">
              <input type="button" id="fetchSubworks" value="Load subworks" class="mb-userscript-button">
            </div>
          </details>
        </div>
    </details>
  `);
})();

// ... (end of file)
#+end_example

** SetRoleInRecording-ArtistRelation.user.js

Replace the old class (.work-button-style) with the new one (.mb-userscript-button).

#+begin_example
// ... (start of file)

(function displayToolbar() {
    relEditor.container(document.querySelector('div.tabs'))
             .insertAdjacentHTML('beforeend', `
        <details>
            <summary class="v-details-summary">
                <h3 style="display: inline-block;">Recording-Artist relation attributes</h3>
                <input type="button" id="setRole" value="Set role" class="mb-userscript-button">
            </summary>
            <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 8px; margin-top: 10px;">
                <p>
                    From relation type:
                    <select id="fromRole">
                        <option selected>Do not filter</option>
                        ${roles.roles}
                    </select>
                    and optional instrument/vocal attribute or similar:
                    <select id="fromRoleAttrs">${roles.roleAttrs}</select>
                    <input type="text" id="fromId" value="" placeholder="or use instrument/vocal id">
                </p>
                <p>
                    To relation type:
                    <select id="toRole">${roles.roles}</select>
                    and optional instrument/vocal attribute or similar:
                      <select id="toRoleAttrs">${roles.roleAttrs}</select>
                    <input type="text" id="toId" value="" placeholder="or use instrument/vocal id">
                    <br />
                    <input type="text" id="toCredit" value="" placeholder="instrument credit">
                </p>
            </div>
        </details>
    `);
})();

// ... (end of file)
#+end_example


* Edit recording comments

In the uploaded userscript, the <button>Edit recording comments</button> button should be change to have "padding: 2px 10px"
and it should also react to hovering and activation, something like

#+begin_example
<style>
            .work-button-style {
                cursor: pointer; /* change cursor to finger */
                transition: background-color 0.1s ease, color 0.1s ease, transform 0.1s ease;
                /* light grey */
                background-color: #f0f0f0;
                border: 1px solid #ccc;
                border-radius: 3px;
                padding: 2px 10px;
                font-size: 11px;
                color: #333; /* text color */
                display: inline-block;
            }
            .work-button-style:hover {
                /* dark grey on hover */
                background-color: #555555;
                color: white;
            }
            .work-button-style:active {
                /* visual click feedback */
                background-color: #444444;
                transform: translateY(1px);
            }
        </style>
#+end_example

Please DO NOT make any code changes, as everything works ok.

** 1

In the uploaded userscript, can you place the "Edit recording comments" button and the settings icon "‚öôÔ∏è" after the line

#+begin_example
<h2 class="tracklist">Tracklist</h2>
#+end_example

when the page loads.

Please DO NOT make any code changes, as everything works ok.


* Discogs importer

In the uploaded userscript "goodalignment.js", please double the button "Import relationships from Discogs" and checkbox "Process Tracklist relationships too"

in the same line as the heading

#+begin_example
<h2>Release relationships</h2>
#+end_example

with a little space after it.

Use the logic provided in the uploaded userscript "place-button.js", as this one works.

#+begin_example
// ==UserScript==
// @name         MB: Add Test Button After Release Relationships Heading (Working)
// @namespace    https://github.com/vzell/mb-userscripts
// @version      1.1
// @match        https://musicbrainz.org/release/*/edit-relationships
// @grant        none
// ==/UserScript==

(function() {
    'use strict';

    function waitForHeading() {
        // Find ANY h2 whose text is exactly "Release relationships"
        const h2 = [...document.querySelectorAll('h2')]
            .find(el => el.textContent.trim() === "Release relationships");

        if (!h2) {
            // Retry until React renders it
            return setTimeout(waitForHeading, 300);
        }

        // Make h2 flex so the button aligns nicely
        h2.style.display = "flex";
        h2.style.alignItems = "center";

        // Create the test button
        const btn = document.createElement("button");
        btn.textContent = "Test";
        btn.style.marginLeft = "10px";

        h2.appendChild(btn);

        btn.addEventListener("click", () => {
            alert("Test button clicked!");
        });

        console.log("Test button inserted successfully.");
    }

    waitForHeading();
})();
#+end_example

** gemini
*** new button

In the uploaded userscript please add a new functionality so that a new button "Show/Hide Discogs Relationship Importer
Dialog" will be added in the same line as the heading

#+begin_example
<h2>Release relationships</h2>
#+end_example

with a little space after it.

Use the following function as a starting point, or maybe use it right away if just works

#+begin_example
function waitForHeading() {
    // Find ANY h2 whose text is exactly "Release relationships"
    const h2 = [...document.querySelectorAll('h2')]
        .find(el => el.textContent.trim() === "Release relationships");

    if (!h2) {
        // Retry until React renders it
        return setTimeout(waitForHeading, 300);
    }

    // Make h2 flex so the button aligns nicely
    h2.style.display = "flex";
    h2.style.alignItems = "center";

    // Create the test button
    const btn = document.createElement("button");
    btn.textContent = "Show/Hide Discogs Relationship Importer Dialog";
    btn.style.marginLeft = "10px";

    h2.appendChild(btn);

    btn.addEventListener("click", () => {
        alert("Button clicked!");
    });

    console.log("DR: Button inserted successfully.");
}
#+end_example

The functionality when the button is clicked, should be that the

#+begin_example
<div class="discogs-wrapper">
#+end_example

container should be hidden when currently shown, or shown when currently hidden. So basically a toogle to hide and show
the container.

*** result

Replace your existing $(document).ready(function () { ... }); block (lines 42‚Äì114) with the code below.

The only change here is the addition of the line addToggleWrapperButton(divWrapper); right after the button is registered.

#+begin_example
// NEW: Initialize the toggle button
                addToggleWrapperButton(divWrapper);
#+end_example

Add this function anywhere in your script (e.g., after the registerButton function). This is your requested logic
adapted to toggle the wrapper's specific display property (grid).

#+begin_example
function addToggleWrapperButton(wrapperDiv) {
    // Find ANY h2 whose text is exactly "Release relationships"
    const h2 = [...document.querySelectorAll('h2')]
        .find(el => el.textContent.trim() === "Release relationships");

    if (!h2) {
        // Retry until React/DOM renders it
        return setTimeout(() => { addToggleWrapperButton(wrapperDiv); }, 300);
    }

    // Check if button already exists to prevent duplicates
    if (h2.querySelector('.discogs-toggle-btn')) return;

    // Make h2 flex so the button aligns nicely
    h2.style.display = "flex";
    h2.style.alignItems = "center";

    // Create the test button
    const btn = document.createElement("button");
    btn.textContent = "Show/Hide Discogs Relationship Importer Dialog";
    btn.classList.add('discogs-toggle-btn'); // Add a class to identify it
    btn.style.marginLeft = "10px";
    btn.style.fontSize = "0.8rem"; // Optional: make it fit slightly better

    h2.appendChild(btn);

    btn.addEventListener("click", (e) => {
        e.preventDefault();
        // Toggle logic: The wrapper uses 'display: grid' in CSS.
        if (wrapperDiv.style.display === 'none') {
            wrapperDiv.style.display = 'grid';
        } else {
            wrapperDiv.style.display = 'none';
        }
    });

    console.log("DR: Button inserted successfully.");
}
#+end_example

*** 2

Now please change the code so that

1.) initially the "discogs-wrapper" container is hidden
2.) the text "'Process Tracklist relationships too'" together
    with the checkbox is renderded with a little space right after the 'Import relationships from Discogs' button, so it should not flow to the right when the browser window is widened

*** answer

Here is the updated $(document).ready block.

I have made the following specific changes:

Hidden by default: Added divWrapper.style.display = 'none'; immediately after the container is created.

Layout fix: Updated the CSS within the script.

Changed grid-template-columns to 200px auto auto 1fr. This forces the button and label columns (auto) to shrink to their content size, while the empty 4th column (1fr) takes up the remaining space, keeping the elements grouped to the left.

Added align-self: center to the label so it aligns vertically with the button.

Replace your existing $(document).ready block with this code:

#+begin_example
$(document).ready(function () {
    const re = new RegExp('musicbrainz.org/release/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/edit-relationships', 'i');
    let m;
    if ((m = window.location.href.match(re))) {
        hasDiscogsLinkDefined(m[1]).then(discogsUrlParam => {
            discogsUrl = discogsUrlParam;
            console.log(`Got it: ${discogsUrl}`);
            if (discogsUrl) {
                const createrelsbutton = document.createElement('button');
                createrelsbutton.innerText = 'Import relationships from Discogs';
                createrelsbutton.style.marginRight = '10px'; // Reduced slightly for tighter grouping
                const processTracklistLbl = document.createElement('label');
                processTracklistLbl.innerText = 'Process Tracklist relationships too';
                const processTracklistCheckbox = document.createElement('input');
                processTracklistCheckbox.type = 'checkbox';
                processTracklistCheckbox.checked = true;
                processTracklistLbl.appendChild(processTracklistCheckbox);

                const divWrapper = document.createElement('div');
                divWrapper.style.display = 'none'; // <--- 1.) INITIALLY HIDDEN

                createrelsbutton.addEventListener(
                    'click',
                    () => {
                        logs = document.createElement('ul');
                        logs.classList.add('logs');
                        summary = document.createElement('p');
                        summary.classList.add('summary');
                        divWrapper.appendChild(summary);
                        divWrapper.appendChild(logs);

                        startImportRels(discogsUrl, processTracklistCheckbox.checked);
                    },
                    false
                );

                divWrapper.classList.add('discogs-wrapper');
                const logo = document.createElement('img');
                logo.src = DISCOGS_LOGO_URL;
                divWrapper.appendChild(logo);
                const description = document.createElement('p');
                description.innerHTML = `This tool will import the relationships found on <a href="${discogsUrl}" rel="nofollow noopener noreferrer" targe="_blank">${discogsUrl}</a> and apply them to the release. The tool isn't perfect and result's should be used as a starting point and also validated before submitting.<br>For example common issues include:<ul><li>On compilations all publishers and labels for individual tracks are listed on the release on discogs. These need to be manually moved to the appropriate tracks</li><li>MusicBrainz has clear guidance on the case of artists, Discogs does not and so you may see some artist names incorrectly capitalized</li><li>The tool isn't 100% perfect at matching instruments, so please review closely.</li></ul><br/>I'm always happy to recieve any feedback over on the <a href="https://community.metabrainz.org/">forums</a>.`;
                const title = document.createElement('h3');
                title.innerText = 'Discogs Relationship Importer';
                divWrapper.appendChild(logo);
                divWrapper.appendChild(title);
                divWrapper.appendChild(description);
                divWrapper.appendChild(processTracklistLbl);
                divWrapper.appendChild(createrelsbutton);
                const style = document.createElement('style');
                style.rel = 'stylesheet';
                // 2.) CSS UPDATED BELOW FOR LAYOUT
                style.innerText = `.discogs-wrapper {
                    display: grid;
                    border: 1px solid #ccc;
                    border-radius: 1rem;
                    padding: 2rem;
                    /* Changed columns: fixed logo | auto button | auto label | remaining space */
                    grid-template-columns: 200px auto auto 1fr;
                    grid-template-rows: auto;
                    grid-template-areas:
                        "logo header header header"
                        "logo description description description"
                        ". button label ."
                        "summary summary summary summary"
                        "logs logs logs logs";
                    width: calc(100vw - 7rem);
                    overflow: hidden;
                }
                .discogs-wrapper img {
                    height: 150px;
                    grid-area: logo;
                }
                .discogs-wrapper h3 {
                    grid-area: header;
                }
                .discogs-wrapper > p {
                    grid-area: description;
                }
                .discogs-wrapper > button {
                    grid-area: button;
                    /* Removed max-width restriction so it fits text */
                }
                .discogs-wrapper > label {
                    grid-area: label;
                    /* Removed max-width */
                    margin: 1rem 0; /* Removed horizontal margin to keep it close */
                    align-self: center; /* Aligns vertically with the button */
                    white-space: nowrap; /* Prevents text wrapping */
                }
                .discogs-wrapper .summary {
                    grid-area: summary;
                    width: 100%;
                }
                .discogs-wrapper .logs {
                    grid-area: logs;
                    width: 100%;
                }`;

                document.head.appendChild(style);

                registerButton(divWrapper);
                addToggleWrapperButton(divWrapper);
            }
        });
    }
});
#+end_example

*** toggel button with icon

#+begin_example
function addToggleWrapperButton(wrapperDiv) {
    // Icons: ‚äï (U+2295 Circled Plus) for 'Show', ‚äñ (U+2296 Circled Minus) for 'Hide'
    const showIcon = '\u2295';
    const hideIcon = '\u2296';
    const dialogText = ' Discogs Relationship Importer Dialog';

    // Find ANY h2 whose text is exactly "Release relationships"
    const h2 = [...document.querySelectorAll('h2')]
        .find(el => el.textContent.trim() === "Release relationships");

    if (!h2) {
        // Retry until React/DOM renders it
        return setTimeout(() => { addToggleWrapperButton(wrapperDiv); }, 300);
    }

    // Check if button already exists to prevent duplicates
    if (h2.querySelector('.discogs-toggle-btn')) return;

    // Make h2 flex so the button aligns nicely
    h2.style.display = "flex";
    h2.style.alignItems = "center";

    // The wrapperDiv is initially hidden, so we start with the 'Show' icon
    const btn = document.createElement("button");
    btn.textContent = showIcon + dialogText;
    btn.classList.add('discogs-toggle-btn'); // Add a class to identify it
    btn.style.marginLeft = "10px";
    btn.style.fontSize = "0.8rem";

    h2.appendChild(btn);

    btn.addEventListener("click", (e) => {
        e.preventDefault();

        // Toggle logic
        if (wrapperDiv.style.display === 'none') {
            // Currently hidden, so show it (set to 'grid' as defined in CSS)
            wrapperDiv.style.display = 'grid';
            // Update button text to the 'Hide' state icon
            btn.textContent = hideIcon + dialogText;
        } else {
            // Currently visible, so hide it
            wrapperDiv.style.display = 'none';
            // Update button text to the 'Show' state icon
            btn.textContent = showIcon + dialogText;
        }
    });

    console.log("DR: Button inserted successfully.");
}
#+end_example


* BruceBase
** ChatGPT
*** recent changes

Write a userscript which automatically selects on the following URL http://brucebase.wikidot.com/system:recent-changes
in the "Revisions per page:" pull-down list the entry "200"

*** 1

#+begin_example
<td>
					<select id="rev-perpage">
						<option value="10">10</option>
						<option value="20" selected="selected">20</option>
						<option value="50">50</option>
						<option value="100">100</option>
						<option value="200">200</option>
					</select>
				</td>
#+end_example

*** 2

Here is the console output, 200 was actuallly already selected

#+begin_example
[Auto200] select set to 200
userscript.html?name=Brucebase-Recent-Changes-%25E2%2580%2593-Auto-200-Revisions-robust.user.js&id=7a956ba3-2f01-4304-8b58-1d4ff4f149b1:18 [Auto200] clicking update button <input type=‚Äã"button" class=‚Äã"btn btn-default btn-sm" value=‚Äã"Update list" onclick=‚Äã"WIKIDOT.modules.SiteChangesModule.listeners.updateList(null)‚Äã">‚Äã
#+end_example

** gemini

Write a userscript which automatically selects on the following URL http://brucebase.wikidot.com/system:recent-changes
in the "Revisions per page:" pull-down list (<select id="rev-perpage">) the option "200" and execute the button click on the "Update list" button (<input type="button" class="btn btn-default btn-sm" value="Update list" onclick="WIKIDOT.modules.SiteChangesModule.listeners.updateList(null)">)

#+begin_example
<form onsubmit="return false;" action="dummy.html" method="get">
		<table class="form">
			<tbody><tr>
				<td>
					Revision types:
				</td>
				<td>
                    <input class="checkbox" type="checkbox" id="rev-type-all" checked="checked">&nbsp;ALL<br>
                    <input class="checkbox" type="checkbox" id="rev-type-new">&nbsp;new pages<br>
                    <input class="checkbox" type="checkbox" id="rev-type-source">&nbsp;source changes<br>
                    <input class="checkbox" type="checkbox" id="rev-type-title">&nbsp;title changes<br>
                    <input class="checkbox" type="checkbox" id="rev-type-move">&nbsp;page name changes<br>
                    <input class="checkbox" type="checkbox" id="rev-type-tags">&nbsp;tags changes<br>
                    <input class="checkbox" type="checkbox" id="rev-type-meta">&nbsp;metadata changes<br>
                    <input class="checkbox" type="checkbox" id="rev-type-files">&nbsp;files changes				</td>
			</tr>
			<tr>
				<td>
					From categories: 
				</td>
				<td>
					<select id="rev-category">
						<option value="" selected="selected">Whole site</option>
													<option value="15810706">_default</option>
													<option value="38050900">admin</option>
													<option value="15810704">admincss</option>
											</select>
				</td>
			</tr>
			<tr>
				<td>
					Revisions per page:
				</td>
				<td>
					<select id="rev-perpage">
						<option value="10">10</option>
						<option value="20" selected="selected">20</option>
						<option value="50">50</option>
						<option value="100">100</option>
						<option value="200">200</option>
					</select>
				</td>
			</tr>
		</tbody></table>
		<div class="buttons">
			<input type="button" class="btn btn-default btn-sm" value="Update list" onclick="WIKIDOT.modules.SiteChangesModule.listeners.updateList(null)">
		</div>
	</form>
#+end_example

** answer

#+begin_example
// ==UserScript==
// @name         Wikidot Recent Changes Auto-200
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  Automatically sets the "Revisions per page" to 200 and triggers the list update on the Brucebase Recent Changes page.
// @author       Gemini
// @match        http://brucebase.wikidot.com/system:recent-changes
// @grant        none
// @run-at       document-idle
// ==/UserScript==

(function() {
    'use strict';

    // Wait for the window to fully load to ensure the WIKIDOT object is available
    window.addEventListener('load', function() {
        // 1. Select the '200' option in the 'Revisions per page' dropdown
        const selectElement = document.getElementById('rev-perpage');

        if (selectElement) {
            // Set the value of the dropdown to "200"
            selectElement.value = '200';

            // Dispatch a 'change' event to notify the page's underlying scripts
            // that the value has been updated, ensuring consistency.
            const changeEvent = new Event('change', { bubbles: true });
            selectElement.dispatchEvent(changeEvent);
        }

        // 2. Execute the 'Update list' action by calling the button's click handler directly.
        // This is the most reliable method as it bypasses potential issues with simulating a click event.
        if (typeof WIKIDOT !== 'undefined' &&
            WIKIDOT.modules &&
            WIKIDOT.modules.SiteChangesModule &&
            WIKIDOT.modules.SiteChangesModule.listeners &&
            typeof WIKIDOT.modules.SiteChangesModule.listeners.updateList === 'function') {

            console.log('Userscript: Setting revisions to 200 and executing updateList.');

            // Execute the update function with 'null' as the original onclick specified
            WIKIDOT.modules.SiteChangesModule.listeners.updateList(null);

        } else {
            console.error('Userscript Error: Could not find the WIKIDOT update function to execute the click action.');
        }
    });
})();
#+end_example

** 1

The output says:

#+begin_example
Userscript: Setting revisions to 200 and executing updateList.
#+end_example

The script actually selects the 200 option but somehow does not clikc the button, instead the mouse pointer changes to "Always busy" icon

** 2

Output now:

#+begin_example
Userscript: Successfully set "Revisions per page" to 200.
userscript.html?name=VZ%253A-Brucebase-%25E2%2580%2593-Auto-200-Revisions.user.js&id=f0954a20-f72e-43fe-9107-6c79b27c36ea:60 Userscript: Triggered WIKIDOT.modules.SiteChangesModule.listeners.updateList(null).
#+end_example

but same effect as before

** 3

The output says:

#+begin_example
Wikidot Auto-200: Set to 200 and updated list.
#+end_example

The script actually selects the 200 option but somehow does not click the button, instead the mouse pointer changes to "Always busy" icon

** 4

Still the same

the log says:

#+begin_example
GET https://cdn.onesignal.com/sdks/OneSignalSDK.js net::ERR_BLOCKED_BY_CLIENT    system:recent-changes:108
cdn.onesignal.com/sdks/OneSignalSDK.js:1  Failed to load resource: net::ERR_BLOCKED_BY_CLIENT    cdn.onesignal.com/sdks/OneSignalSDK.js:1
GET http://stats.g.doubleclick.net/dc.js net::ERR_BLOCKED_BY_CLIENT  system:recent-changes:1173
Failed to load resource: net::ERR_BLOCKED_BY_CLIENT  stats.g.doubleclick.net/dc.js:1 
SiteChangesModule.js:1 Uncaught TypeError: $(...).getElementsByTagName is not a function  SiteChangesModule.js:1
  	(anonymous)	@	SiteChangesModule.js:1
onDomReady	@	init.combined.js:79
(anonymous)	@	VM3701:1
setTimeout		
onDomReady	@	init.combined.js:79
WIKIDOT.modules.SiteChangesModule.init	@	SiteChangesModule.js:1
(anonymous)	@	SiteChangesModule.js:1
Wikidot Auto-200: Triggering updateList directly...
#+end_example


* SpringsteenLyrics
** ChatGPT

#+begin_example
Is this pop-up dialog text from the browser itslef: The page that you're looking for used information that you entered. Returning to that page might cause any action you took to be repeated. Do you want to continue?
#+end_example

** avoid post

#+begin_example
// ==UserScript==
// @name         Avoid Post-Back Dialog
// @namespace    https://example.com/
// @version      1.0
// @description  Avoid "resubmit form" warning on a specific page
// @match        https://www.springsteenlyrics.com/collection.php
// @run-at       document-start
// ==/UserScript==

(function() {
    'use strict';

    // Intercept form submissions
    document.addEventListener('submit', function(event) {
        const form = event.target;
        event.preventDefault(); // Stop the normal POST

        // Convert form data to URLSearchParams
        const formData = new FormData(form);
        const params = new URLSearchParams();
        for (const [key, value] of formData.entries()) {
            params.append(key, value);
        }

        // Use fetch instead of normal POST
        fetch(form.action, {
            method: form.method,
            body: params,
            credentials: 'same-origin'
        })
        .then(response => response.text())
        .then(html => {
            // Redirect to a "safe" results page (or reload current page)
            // Replace document content to avoid resubmission dialog
            document.open();
            document.write(html);
            document.close();
        })
        .catch(err => console.error('Form submission failed:', err));
    }, true);
})();
#+end_example


* cover-art batch editing
** gemini

Given the following URL https://musicbrainz.org/release/ee42732a-383b-4175-a007-e4773f618a00/cover-art

Emulate pressing the "Edit" button for each cover image and create one aggegated web page to edit all images
simultaneously (types and comment for each image), instead of showing the edit-cover-art page for each image individually like
for example the image

https://musicbrainz.org/release/ee42732a-383b-4175-a007-e4773f618a00/edit-cover-art/30876987005

The "Edit cover art" parts to edit "Types:" and "Comment:" for each image should be placed below each other for each
image. There should be a submit button at the end of the page named "Enter edit" (together with an "Edit note: text
field) which iterates over all images and submits changes to each changed image.

The iteration and submit logic could be grabbed from a similar user script at https://update.greasyfork.org/scripts/541232/MusicBrainz%3A%20Batch%20Remove%20Cover%20Art.user.js which submits removals of tagged images.

** answer

#+begin_example
// ==UserScript==
// @name         MusicBrainz: Batch Edit Cover Art
// @namespace    https://musicbrainz.org/
// @version      1.0
// @description  Edit types and comments of all cover art images on one page.
// @author       Gemini
// @match        *://*.musicbrainz.org/release/*/cover-art
// @grant        GM_xmlhttpRequest
// @connect      musicbrainz.org
// ==/UserScript==

(function() {
    'use strict';

    const RELEASE_MBID = window.location.pathname.split('/')[2];
    const TYPES = ["Front", "Back", "Booklet", "Medium", "Tray", "Liner", "Sticker", "Other", "Watermark", "Icon", "Track"];

    // UI Elements
    let batchContainer = document.createElement('div');
    batchContainer.id = 'batch-edit-container';
    batchContainer.style = 'margin-top: 20px; padding: 20px; border: 2px solid #600; display: none; background: #f2f2f2;';

    const init = () => {
        const coverArtHeader = document.querySelector('.tabs');
        if (!coverArtHeader) return;

        let batchBtn = document.createElement('button');
        batchBtn.innerText = 'Batch Edit Types/Comments';
        batchBtn.className = 'styled-button';
        batchBtn.style.marginLeft = '10px';
        batchBtn.onclick = toggleBatchMode;

        document.querySelector('.subnav').appendChild(batchBtn);
        document.querySelector('#content').insertBefore(batchContainer, document.querySelector('.cover-art-grid'));
    };

    const toggleBatchMode = async (e) => {
        e.preventDefault();
        if (batchContainer.style.display === 'block') {
            batchContainer.style.display = 'none';
            return;
        }

        batchContainer.innerHTML = '<h3>Loading image data...</h3>';
        batchContainer.style.display = 'block';

        const images = getImages();
        if (images.length === 0) {
            batchContainer.innerHTML = 'No images found.';
            return;
        }

        let html = '<h3>Batch Edit Cover Art</h3><table style="width:100%; border-collapse: collapse;">';
        
        for (const img of images) {
            const data = await fetchImageData(img.editUrl);
            html += `
                <tr style="border-bottom: 1px solid #ccc;" class="batch-row" data-id="${img.id}" data-edit-url="${img.editUrl}">
                    <td style="padding: 10px; width: 150px;">
                        <img src="${img.thumb}" style="max-width: 120px;">
                    </td>
                    <td style="padding: 10px;">
                        <strong>Types:</strong><br>
                        <div class="type-checkboxes">
                            ${TYPES.map(t => `
                                <label style="margin-right: 8px; display: inline-block;">
                                    <input type="checkbox" value="${t}" ${data.types.includes(t) ? 'checked' : ''}> ${t}
                                </label>
                            `).join('')}
                        </div>
                        <br>
                        <strong>Comment:</strong><br>
                        <input type="text" class="batch-comment" style="width: 100%;" value="${data.comment}">
                    </td>
                </tr>`;
        }

        html += `</table>
            <div style="margin-top: 20px;">
                <strong>Edit Note:</strong><br>
                <textarea id="batch-edit-note" style="width: 100%; height: 60px;"></textarea><br><br>
                <button id="submit-batch-edit" class="styled-button">Enter edit</button>
            </div>`;

        batchContainer.innerHTML = html;
        document.getElementById('submit-batch-edit').onclick = submitAll;
    };

    const getImages = () => {
        const images = [];
        document.querySelectorAll('.cover-art-image').forEach(div => {
            const editLink = div.parentElement.querySelector('a[href*="/edit-cover-art/"]');
            if (editLink) {
                images.push({
                    id: editLink.getAttribute('href').split('/').pop(),
                    editUrl: editLink.href,
                    thumb: div.querySelector('img').src
                });
            }
        });
        return images;
    };

    const fetchImageData = (url) => {
        return new Promise((resolve) => {
            GM_xmlhttpRequest({
                method: "GET",
                url: url,
                onload: (res) => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(res.responseText, "text/html");
                    const comment = doc.querySelector('input[name="edit-cover-art.comment"]')?.value || "";
                    const types = Array.from(doc.querySelectorAll('input[name="edit-cover-art.type_id"]:checked'))
                        .map(cb => cb.parentElement.textContent.trim());
                    resolve({ comment, types });
                }
            });
        });
    };

    const submitAll = async () => {
        const rows = document.querySelectorAll('.batch-row');
        const editNote = document.getElementById('batch-edit-note').value;
        const btn = document.getElementById('submit-batch-edit');
        
        btn.disabled = true;
        btn.innerText = 'Submitting...';

        for (const row of rows) {
            const id = row.getAttribute('data-id');
            const editUrl = row.getAttribute('data-edit-url');
            const comment = row.querySelector('.batch-comment').value;
            const selectedTypes = Array.from(row.querySelectorAll('.type-checkboxes input:checked')).map(cb => cb.value);

            // Fetch the page first to get the CSRF/Edit tokens and type IDs
            const formInfo = await getFormPayload(editUrl);
            
            const formData = new FormData();
            formData.append('edit-cover-art.comment', comment);
            formData.append('edit-cover-art.edit_note', editNote);
            
            // Map type names back to the internal IDs found on the page
            formInfo.typeMapping.forEach(mapping => {
                if (selectedTypes.includes(mapping.name)) {
                    formData.append('edit-cover-art.type_id', mapping.id);
                }
            });

            // Add hidden validation fields required by MusicBrainz
            formInfo.hiddenFields.forEach(field => {
                formData.append(field.name, field.value);
            });

            await postEdit(editUrl, formData);
            row.style.backgroundColor = '#dff0d8'; // Success color
        }

        btn.innerText = 'Finished! Reloading...';
        setTimeout(() => window.location.reload(), 1000);
    };

    const getFormPayload = (url) => {
        return new Promise((resolve) => {
            GM_xmlhttpRequest({
                method: "GET",
                url: url,
                onload: (res) => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(res.responseText, "text/html");
                    const hiddenFields = Array.from(doc.querySelectorAll('form input[type="hidden"]'))
                        .map(input => ({ name: input.name, value: input.value }));
                    
                    const typeMapping = Array.from(doc.querySelectorAll('input[name="edit-cover-art.type_id"]'))
                        .map(input => ({
                            name: input.parentElement.textContent.trim(),
                            id: input.value
                        }));
                    
                    resolve({ hiddenFields, typeMapping });
                }
            });
        });
    };

    const postEdit = (url, formData) => {
        return new Promise((resolve) => {
            GM_xmlhttpRequest({
                method: "POST",
                url: url,
                data: formData,
                onload: () => resolve()
            });
        });
    };

    init();
})();
#+end_example

** 1

There is NO "Batch Edit Types/Comments" at all on the page

** 2

Now I get "No editable images found on this page"

** 3

Again no more button

Place the button after the "Download scans" button to the right, see the following code:

#+begin_example
<div class="buttons ui-helper-clearfix">
  <a href="/release/6ccbd780-3eb1-48ff-8fe0-04d4669e8846/add-cover-art">
    <bdi>Add cover art
    </bdi>
  </a>
  <a href="/release/6ccbd780-3eb1-48ff-8fe0-04d4669e8846/reorder-cover-art">
    <bdi>Reorder cover art
    </bdi>
  </a>
  <a class="ame-download-scans">
    <bdi>Download scans
    </bdi>
  </a>
  <a title="https://www.discogs.com/release/6889744" href="https://musicbrainz.org/release/6ccbd780-3eb1-48ff-8fe0-04d4669e8846/add-cover-art?x_seed.image.0.url=https%3A%2F%2Fwww.discogs.com%2Frelease%2F6889744">
    <img src="https://catalog-assets.discogs.com/e95f0cd9.png" alt="Discogs">
    <span>Import from Discogs
    </span>
  </a>
</div>
#+end_example

** 4

The button now works, it now loads the metadata for each image but not complete. When there is more then one type ticked
for an image it only loads the first one.

There are alos more types than what you have included in the variable TYPES

#+begin_example
const TYPES = ["Front", "Back", "Booklet", "Medium", "Tray", "Liner", "Sticker", "Other", "Watermark", "Icon", "Track"];
#+end_example

see, the following code of an edit-cover-art page of a single image

#+begin_example
<fieldset class="cover-art-types row">
  <legend>Types:
  </legend>
  <ul class="cover-art-type-checkboxes">
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" checked="" value="1">Front
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="2">Back
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="3">Booklet
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="4">Medium
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="5">Obi
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="6">Spine
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="7">Track
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="9">Tray
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="10">Sticker
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="11">Poster
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="12">Liner
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="13">Watermark
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="14">Raw/Unedited
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="15">Matrix/Runout
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="48">Top
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="49">Bottom
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="81">Panel
      </label>
    </li>
    <li>
      <label>
	<input name="edit-cover-art.type_id" type="checkbox" value="8">Other
      </label>
    </li>
  </ul>
</fieldset>
#+end_example

please also add the missing types.

** 5

Yes this seems to work. Can you also place each image above it's corresponding "ID:".

For example above "ID: 43679006067" in the code:

#+begin_example
<td style="padding: 15px; width: 120px; text-align: center; border-right: 1px solid #eee; background: #fafafa;">
                        <img src="" style="max-width: 100px; max-height: 100px; border: 1px solid #ccc;">
                        <small style="color: #666; display:block; margin-top:5px;">ID: 43679006067</small>
</td>
#+end_example

** 6

Actually NO images are shown at all in the "Batch Edit Cover Art" dialog

** 7

We now get for example for the first image (it shows a broken image, not clickable on the web page), and heres the code:

#+begin_example
<td style="padding: 15px; width: 140px; text-align: center; border-right: 1px solid #eee; background: #fafafa; vertical-align: top;">
                        <img src="" style="max-width: 120px; max-height: 120px; border: 1px solid #ccc; display: block; margin: 0 auto;" alt="Thumb 43679006067">
                        <small style="color: #666; display:block; margin-top:5px;">ID: 43679006067</small>
</td>
#+end_example

The real image looks like:

#+begin_example
<img src="//archive.org/download/mbid-6ccbd780-3eb1-48ff-8fe0-04d4669e8846/mbid-6ccbd780-3eb1-48ff-8fe0-04d4669e8846-43679006067_thumb500.jpg" title="Front" ropdebee_lazydimensions="Dimensions: 1623√ó1372">
#+end_example

** 8

This works now.

But please add the "Batch Edit Cover Art" button after the "Reorder cover art" button and name it "Batch edit cover art".
Also place the whole "id="batch-edit-container" below the row with the current action buttons

#+begin_example
<div class="buttons ui-helper-clearfix">
  <a href="/release/6ccbd780-3eb1-48ff-8fe0-04d4669e8846/add-cover-art">
    <bdi>Add cover art
    </bdi>
  </a>
  <a href="/release/6ccbd780-3eb1-48ff-8fe0-04d4669e8846/reorder-cover-art">
    <bdi>Reorder cover art
    </bdi>
  </a>
  <a class="ame-download-scans">
    <bdi>Download scans
    </bdi>
  </a>
  <a id="batch-edit-trigger" href="#" style="margin-left: 10px;">
    <bdi>Batch Edit Cover Art
    </bdi>
  </a>
  <a title="https://www.discogs.com/release/6889744" href="https://musicbrainz.org/release/6ccbd780-3eb1-48ff-8fe0-04d4669e8846/add-cover-art?x_seed.image.0.url=https%3A%2F%2Fwww.discogs.com%2Frelease%2F6889744">
    <img src="https://catalog-assets.discogs.com/e95f0cd9.png" alt="Discogs">
    <span>Import from Discogs
    </span>
  </a>
</div>
#+end_example

** 9

It works perfect now.

But please adjust the script for the case if the user hasn't made any changes but still presses the "Submit" button. In
that case a popup should explain the fact, with a chance to cancel the popup window.

** implement history

Please implement for the uploaded user script in the "Comment" text field autocomplete history for already typed in text comments

#+begin_example
                        <div style="margin-top: 10px;">
                            <strong style="color: #555;">Comment:</strong>
                            <input type="text" class="batch-comment" style="width: 100%; padding: 6px; margin-top: 5px; border: 1px solid #ccc; border-radius: 3px;" value="${data.comment}">
#+end_example

Initially when clicking in one of the "Comment" text fields for an image, a popup should show up with the last 20
entries type in (the rest scrollable, up to a predefined maixmum). When starting typing autocomplete should kick in
showing only entries which have the typed text in the comment.

** 10

It works so far. Please also implement, beside clicking on a autocompletion (whic works), keyboard navigation with the
up/down arrow keys in the completion list + accepting an entry when pressing "Return"

** add predefined comments

In the uploaded userscript "BatchEditCoverArt.user.js" add another button with the title "‚öôÔ∏è Configure immutable comments"
to the "id="batch-edit-container" container with the following logic when pressed (see also an example of such
an implementation in the uploaded user script "AutoSelectExternalLinkTypeReleases.user.js"):

It should be possible to configure predefined comments in a popup GUI when pressing a button "Add New Comment" (also
removal and editing should be possible by clicking on ‚úèÔ∏è ‚ùå buttons). A "Close" button or pressing the "Escape" key
should close the dialog.

In the "Comment" text field autocomplete history should also include the predefined comments above. These predefined
comments should also be stored in browser storage together with already stored entries but should never be overwritten
and also should not count in the MAX_HISTORY variable.

** 1

Yes, add a search/filter field inside the configuration popup to help manage the list if it grows very large and place
the ‚úèÔ∏è and ‚ùå buttons after each other and not above.

** 2

Place the "‚öôÔ∏è Configure immutable comments" to the right of the text "Batch Edit Cover Art"
Don't touch the rest of the code.

** 3

Store and display the comments sorted, in the configuratin dialog and the autocomplete listing.
Don't touch the rest of the code.

** sorting

Somehow the sorting doesn't seem to work properly:

 - When adding a new immutable comment, the list of configured immutable comments should be sorted right away for display
   purposes and stored sorted in browser storage
 - For the non immutable comments, the newly entered comments should also be stored sorted in browser storage, but also
   displayed sorted when first clicked in a "Comment:" text field.
 - When a newly entered immutable comment is added and the same comment exists in the list of non immutable comments, it
   should be removed from the list of non immutable comments

** add delete button

Everything works up to now.
Add a ‚ùå button also at the end inside the search filed in the "Configure Immutable Comments" popup dialog which quickly
empties the search field.
Don't touch the rest of the code.

** placement

Please add the "Batch edit cover art" button after the "Add cover art" instead of the "Reorder cover art" button.
Don't touch the rest of the code or the existing comments (only when necessary).

** unicode symbols

Add the following association table to the uploaded userscript in a javascript variable

| diacritic | ascii equivalent |
|-----------+------------------|
| ‚Äê         | -                |
| ‚Äí         | -                |
| ‚Äì         | -                |
| ‚Äî         | -                |
| ‚Äú         | "                |
| ‚Äù         | "                |
| ‚Äò         | '                |
| ‚Äô         | '                |

and add the following functionality:

 - when typing in the "Comment:" text field of an image, and one of the "ascii equivalent" characters are encountered the
   autocompletion should also in addition try to display candidates using the "diacritic" versions.
 - When a "diacritic" charachter is typed in directly, use that unconditionally

** 1

There is an additional problem now. When clicking in an EMPTY "Comment:" field of an image, the complete auto-completion
list is NOT shown at all (it was before).

Otherwise when starting typing in an EMPYT "Comment:" field of an image, the auto-completion list candidates show up
properly. Also the diacritics logic works fine.

Please change

** 2

Yes it's working now. But please add the same diacritic logic also in the "Configure Immutable Comments" popup dialog 

** regexp

Create another configuration button for "Regular expressions" titled "‚öôÔ∏è Configure regexps" with the same functionality like the "‚öôÔ∏è Configure immutable comments"
but without the diacritics handling.

When pressing the "Enter edit" button, the changed "Comment:" entries of all the images should be compared against the
list of regexps (starting with an intitial empty list) and they SHOULD NOT be stored in browser storage when matching a regexp.

** generate regexp

Generate a regexp which matches "Matrix / Runout (disc 1): 8258-BS751018D1" and "Matrix / Runout (disc 2): 8258-BS751018D2"
disc can have an arbitrary discnumber after it the pattern aber the colon : could have numbers,
uppercase letters and hyphens in it

Generate a regexp which matches "run‚Äêout groove side A: 377275A" and "run‚Äêout groove side B: 377275B"
"side" can have an arbitrary uppercase letter A-Z after it.
The pattern aber the colon : could have numbers, uppercase letters and hyphens in it

run‚Äêout groove side [A-Z]: [A-Z0-9-]+

CD Mirror Band (disc 1): 

** change button text

Add the following logic:

 - The button text should change from "Submit changes (marked red)" to "Submitting...(<current change number>/<total change number>)"
 - Place the text "<n number of images> matching regexps and so will not be stored in browser storage" after the "Submitting..." button.

** add remember logic for edit notes

Please integrate the same remember logic for edit notes, which is part of the uploaded user script "BatchRemoveCoverArt.user.js"
between

#+begin_example
 // --- START OF ELEPHANT EDITOR LOGIC (adapted from original) ---
#+end_example

and

#+begin_example
// --- END OF ELEPHANT EDITOR LOGIC ---
#+end_example

into the "BatchEditCoverArt.user.js" user script

** 1

Please check the user script logic in the uploaded userscript "BatchRemoveCoverArt.user.js" for the elephant logic which remembers the last type in text in the textarea field
and compare why in the uploaded script "BatchEditCoverArt.user.js" the '<div class="buttons">' doesn't show up above the texarea field with the id="batch-edit-note"

** remove batch-remove-container

In the uploaded userscript after pressing the "Batch edit cover art" button check if the container

#+begin_example
<div class="batch-remove-container">
#+end_example

is present and temporarily hide it from display as long as the "Batch Edit Cover Art" functionality is about to execute.

** dont add the batch edit cover art when no images are present

Add a check to the uploaded userscript, so that the "Batch edit cover art" button is not added when no images are present.
This can be checked if the text "We do not currently have any cover art for " can be found after the heading "Cover art"

See the following HTML code as an example

#+begin_example
<h2>Cover art</h2>
<p>We do not currently have any cover art for <a href="/release/e450f184-3ea7-423b-912f-5ecc68115f6f"><bdi>The Roxy 18 Oct 1975 (Early Show)</bdi></a>.</p>
#+end_example

** add autocomplete also to add-cover-art

In the uploaded userscript, please also add support for the following pages

#+begin_example
// @match        *://*.musicbrainz.org/release/*/add-cover-art
#+end_example

in the following ways:

On the "/add-cover-art" page the two buttons

#+begin_example
<button id="config-immutable" style="cursor:pointer; padding: 4px 8px; font-size: 0.85em; background: #fff; border: 1px solid #999;">‚öôÔ∏è Configure immutable comments</button>
<button id="config-regex" style="cursor:pointer; padding: 4px 8px; font-size: 0.85em; background: #fff; border: 1px solid #999;">‚öôÔ∏è Configure regexps</button>
#+end_example

should be created right after the heading (to the right)

#+begin_example
<h2>Add cover art</h2>
#+end_example

Otherwise the same configuration action for the two buttons should apply.

Additionally on the "/add-cover-art" page the same autocomplete logic for the "Comment" textfield should apply as on the "/cover-art" page.

** 1

The buttons are there and working, but the autocompletion doesn't work at all, probably because on the "/add-cover-art"
page the "Comment:" field is located according to the following HTML code:

#+begin_example
<div class="comment row" data-bind="visible: status() == 'waiting'" style="">
  <label>Comment:</label>
  <input class="comment" type="text" size="47" data-bind="value: comment">
</div>
#+end_example

** add edited indicator (in red)

Add the following logic to the uploaded userscript "BatchEditCoverArt.user.js" similar to the uploaded userscript "GenerateRecordingCommentForRelease.user.js":

When a change happens to one of the image "Comment:" text fields, the text field should get a red border to highlight
that change. When successfully submitting a comment, the border should get the oroginal color again.

** 1

In the uploaded userscript:

It look's like on the pages "*://*.musicbrainz.org/release/*/add-cover-art" the comments do not get the red border when edits are made

#+begin_example
<div class="comment row" data-bind="visible: status() == 'waiting'" style="">
              <label>Comment:</label>
              <input class="comment" type="text" size="47" data-bind="value: comment" data-autocomplete-bound="true">
            </div>
#+end_example

whereas on the "*://*.musicbrainz.org/release/*/cover-art" everything works fine.

Please add that behaviour but don't touch the functioning code

** add button color

In the uploaded userscript:

- Make the button colors of the two buttons "‚öôÔ∏è Configure immutable comments" and "‚öôÔ∏è Configure regexps" the same as the
button color of "Copy 1st types" but don't touch the "Clear all types" and "Reset to original" buttons

** add red border to changed checkboxes

In the uploaded userscript:

When a change happens to one of the image "Type:" checkboxes, configured in the following variable

#+begin_example
    const TYPES = [
        "Front", "Back", "Booklet", "Medium", "Obi", "Spine", "Track", "Tray",
        "Sticker", "Poster", "Liner", "Watermark", "Raw/Unedited",
        "Matrix/Runout", "Top", "Bottom", "Panel", "Other"
    ];
#+end_example

change the description of the changed checkboxes to red. So for example if the "Front" checkbox was toggled, the text
"Front" should become red. When successfully submitting data for an image, the red text should get the original color
again.

** 1

In the uploaded userscript:

Also add that functionality if the page is of type "// @match        *://*.musicbrainz.org/release/*/add-cover-art".
In that case remember that the "types" and "labels" are located in the following HTML structure

#+begin_example
<div class="cover-art-types row" data-bind="visible: status() == 'waiting'" style="">
              <label>Types:</label>
              <ul class="cover-art-type-checkboxes" data-bind="foreach: types">
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="1">
                    <span data-bind="text: name">Front</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="2">
                    <span data-bind="text: name">Back</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="3">
                    <span data-bind="text: name">Booklet</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="4">
                    <span data-bind="text: name">Medium</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="5">
                    <span data-bind="text: name">Obi</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="6">
                    <span data-bind="text: name">Spine</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="7">
                    <span data-bind="text: name">Track</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="8">
                    <span data-bind="text: name">Other</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="9">
                    <span data-bind="text: name">Tray</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="10">
                    <span data-bind="text: name">Sticker</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="11">
                    <span data-bind="text: name">Poster</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="12">
                    <span data-bind="text: name">Liner</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="13">
                    <span data-bind="text: name">Watermark</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="14">
                    <span data-bind="text: name">Raw/Unedited</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="15">
                    <span data-bind="text: name">Matrix/Runout</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="48">
                    <span data-bind="text: name">Top</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="49">
                    <span data-bind="text: name">Bottom</span></label>
                </li>
              
                <li>
                  <label>
                    <input type="checkbox" class="type" data-bind="checked: checked, value: id" value="81">
                    <span data-bind="text: name">Panel</span></label>
                </li>
              </ul>
            </div>
#+end_example


* Add submitting...(n/m) also to the disambiguation script
** gemini

Add the following logic to the uploaded userscript:

 - The button text should change from "Submit changes (marked red)" to "Submitting...(<current change number>/<total change number>)"

when submitting the changed recording comments.   

** progress for the individual tracks

Assuming 14 as "<total change number>":

Right now it says "Submitting...(0/14)" and then changing to "Submitting...(14/14)" when all changes have been submitted.
Could you display the progress for the individual tracks in the button.

** 2

Add the following logic to the uploaded userscript:

change the button text from "Submitting ${editData.length} changes..." to "Submitting ${editData.length} changes... DONE"


* add reload functionality to batch remove cover art

In the uploaded "BatchRemoveCoverArt.user.js" user script please also add the following functionality from the uploaded
user script "BatchEditCoverArt.user.js"

#+begin_example
        btn.innerText = 'Finished! Reloading...';
        setTimeout(() => window.location.reload(), 1000);
#+end_example

to reload the page after removeing images


* I once mentioned this new userscript in the
https://community.metabrainz.org/t/chabans-userscripts-and-bookmarklet-support-thread/768583/53 topic, but I think it
belongs to here, as I recently made some more changes to it.

This userscript adds a "Batch edit cover art" button after the standard "Add cover art" button.

When pressed it loads the metadata off all the images in a new container (it also offers a couple of convenience buttons
like "Clear all types" and "Reset to original"). In that container you can add/remove/change types and comments of all
the images as usual, and submit them all at once. The script remembers the last 50 different comments and offers
auto-completion for these during the new edits. There is a button "‚öôÔ∏è Configure immutable comments" in the container
where comments can be specified which should always be offered for auto-completion. With another button "‚öôÔ∏è Configure
regexps" a list of regular expressions can be defined so that comments matching these are never stored in browser
storage and don't count to the latest 50 entered comments.

The auto-completion functionality together with the configuration options are now also supported when entering new
images to a release.

Additionally for entering edit notes as a whole, the Elephant functionality (developed by jesus2099 and adopted by
chaban in his userscript "Batch remove cover art") is now also included.

You can get the script at https://github.com/vzell/mb-userscripts under [Batch Edit Cover
Art](https://github.com/vzell/mb-userscripts?tab=readme-ov-file#mb_batch_edit_coverart)


* add convenience buttons to edit-relationships

Create a Tampermonkey userscript for "// @match        https://musicbrainz.org/release/*/edit-relationships"

that should kick in when the following popup UI appears

basically the header should be

#+begin_example
      <h1>Edit relationship
      </h1>
#+end_example

the 'class="required section"' MUST be of "Related type" Work

#+begin_example
<td class="required section">Related type
	  </td>
#+end_example

#+begin_example
<td class="fields">Work
	  </td>
#+end_example

Here as an example a complete HTML popup dialog

#+begin_example
<div tabindex="-1" data-floating-ui-focusable="" class="dialog popover relationship-dialog" id="edit-relationship-dialog" role="dialog" style="position: absolute; left: 0px; top: 0px; transform: translate(252px, 2432.8px);">
  <div class="form">
    <div class="dialog-titlebar">
      <h1>Edit relationship
      </h1>
      <div class="buttons-right">
	<span style="font-weight: normal;">(
	  <a href="#">help
	  </a>)
	</span>
      </div>
    </div>
    <table class="relationship-details">
      <tbody>
	<tr>
	  <td class="required section">Recording
	  </td>
	  <td class="fields">
	    <a class="wrap-anywhere" target="_blank" href="/recording/7e2eedbe-0951-472f-b5b7-fffe50ccc909">
	      <bdi>Sha La La
	      </bdi>
	    </a>
	    <div class="error">
	    </div>
	  </td>
	</tr>
	<tr>
	  <td class="required section">Related type
	  </td>
	  <td class="fields">Work
	  </td>
	</tr>
      </tbody>
    </table>
    <h2>
      <div class="heading-line">
      </div>
      <span class="heading-text">Relationship
      </span>
    </h2>
    <table class="relationship-details">
      <tbody>
	<tr>
	  <td class="required section">Relationship type
	  </td>
	  <td class="fields">
	    <label class="autocomplete2-label required" for="relationship-type-recording-work--496" id="relationship-type-recording-work--496-label">Type or click to search:
	    </label>
	    <div class="autocomplete2 relationship-type">
	      <div aria-expanded="false" aria-haspopup="listbox" aria-owns="relationship-type-recording-work--496-menu" class="required" role="combobox">
		<input aria-autocomplete="list" aria-controls="relationship-type-recording-work--496-menu" aria-labelledby="relationship-type-recording-work--496-label" aria-required="true" autocomplete="off" class="relationship-type lookup-performed" id="relationship-type-recording-work--496" placeholder="Type or click to search" type="text" value="recording of / recordings">
		<button aria-controls="relationship-type-recording-work--496-menu" aria-haspopup="true" aria-label="Search" class="search" data-toggle="true" role="button" tabindex="-1" title="Search" type="button">
		</button>
	      </div>
	      <ul aria-controls="relationship-type-recording-work--496-status" aria-labelledby="relationship-type-recording-work--496-label" id="relationship-type-recording-work--496-menu" role="listbox" tabindex="-1">
		<li aria-disabled="false" aria-selected="false" class="selected option-item " id="relationship-type-recording-work--496-item-278" role="option">recording of / recordings
		  <br>
		  <span class="autocomplete-comment">This is used to link works to their recordings.
		  </span>
		</li>
		<li aria-disabled="false" aria-selected="false" class="separator action-item " id="relationship-type-recording-work--496-item-toggle-descriptions" role="option">Hide descriptions
		</li>
	      </ul>
	      <div aria-live="assertive" aria-relevant="additions text" id="relationship-type-recording-work--496-status" role="status">performance
	      </div>
	    </div>
	    <div aria-atomic="true" class="error" role="alert">
	    </div>
	  </td>
	</tr>
	<tr>
	  <td class="required section">Work
	  </td>
	  <td class="fields">
	    <label class="autocomplete2-label required" for="relationship-target--496" id="relationship-target--496-label">Search for a work:
	    </label>
	    <div class="autocomplete2 relationship-target">
	      <div aria-expanded="false" aria-haspopup="listbox" aria-owns="relationship-target--496-menu" class="required" role="combobox">
		<input aria-autocomplete="list" aria-controls="relationship-target--496-menu" aria-labelledby="relationship-target--496-label" aria-required="true" autocomplete="off" class="relationship-target lookup-performed" id="relationship-target--496" placeholder="Type to search, or paste an MBID" type="text" value="Sha‚ÄêLa‚ÄêLa">
		<button aria-controls="relationship-target--496-menu" aria-haspopup="true" aria-label="Search" class="search" data-toggle="true" role="button" tabindex="-1" title="Search" type="button">
		</button>
	      </div>
	      <ul aria-controls="relationship-target--496-status" aria-labelledby="relationship-target--496-label" id="relationship-target--496-menu" role="listbox" tabindex="-1">
	      </ul>
	      <div aria-live="assertive" aria-relevant="additions text" id="relationship-target--496-status" role="status">Sha‚ÄêLa‚ÄêLa
	      </div>
	    </div>
	    <div class="error">
	    </div>
	  </td>
	</tr>
	<tr class="link-order">
	  <td class="section">Order
	  </td>
	  <td class="fields">
	    <input max="2147483647" min="0" type="number" value="0">
	    <span class="tooltip-wrapper">
	      <span class="img icon help" style="display: inline-block; margin-left: 10px; vertical-align: text-top;">
	      </span>
	      <span class="tooltip-container">
		<span class="tooltip-triangle">
		</span>
		<span class="tooltip-content">If this relationship has a specific order among others of the same type, you may set its position in the list here (as an alternative to the up- and down-arrow buttons).
		</span>
	      </span>
	    </span>
	  </td>
	</tr>
      </tbody>
    </table>
    <h2>
      <div class="heading-line">
      </div>
      <span class="heading-text">Attributes
      </span>
    </h2>
    <table class="relationship-details">
      <tbody>
	<tr>
	  <td class="section">
	  </td>
	  <td class="fields">
	    <div class="attribute-container checkbox acappella">
	      <label>
		<input class="boolean" id="acappella-checkbox" type="checkbox"> acappella
	      </label>
	    </div>
	  </td>
	</tr>
	<tr>
	  <td class="section">
	  </td>
	  <td class="fields">
	    <div class="attribute-container checkbox cover">
	      <label>
		<input class="boolean" id="cover-checkbox" type="checkbox"> cover
	      </label>
	    </div>
	  </td>
	</tr>
	<tr>
	  <td class="section">
	  </td>
	  <td class="fields">
	    <div class="attribute-container checkbox demo">
	      <label>
		<input class="boolean" id="demo-checkbox" type="checkbox"> demo
	      </label>
	    </div>
	  </td>
	</tr>
	<tr>
	  <td class="section">
	  </td>
	  <td class="fields">
	    <div class="attribute-container checkbox instrumental">
	      <label>
		<input class="boolean" id="instrumental-checkbox" type="checkbox"> instrumental
	      </label>
	    </div>
	  </td>
	</tr>
	<tr>
	  <td class="section">
	  </td>
	  <td class="fields">
	    <div class="attribute-container checkbox karaoke">
	      <label>
		<input class="boolean" id="karaoke-checkbox" type="checkbox"> karaoke
	      </label>
	    </div>
	  </td>
	</tr>
	<tr>
	  <td class="section">
	  </td>
	  <td class="fields">
	    <div class="attribute-container checkbox live">
	      <label>
		<input class="boolean" id="live-checkbox" type="checkbox"> live
	      </label>
	    </div>
	  </td>
	</tr>
	<tr>
	  <td class="section">
	  </td>
	  <td class="fields">
	    <div class="attribute-container checkbox medley">
	      <label>
		<input class="boolean" id="medley-checkbox" type="checkbox"> medley
	      </label>
	    </div>
	  </td>
	</tr>
	<tr>
	  <td class="section">
	  </td>
	  <td class="fields">
	    <div class="attribute-container checkbox partial">
	      <label>
		<input class="boolean" id="partial-checkbox" type="checkbox"> partial
	      </label>
	    </div>
	  </td>
	</tr>
	<tr>
	  <td class="section">
	    <label for="id-period.begin_date.year">Begin date
	    </label>
	  </td>
	  <td class="fields">
	    <span class="partial-date">
	      <input class="partial-date-year" id="id-period.begin_date.year" maxlength="4" name="period.begin_date.year" placeholder="YYYY" size="4" type="text" value="">-
	      <input class="partial-date-month" id="id-period.begin_date.month" maxlength="2" name="period.begin_date.month" placeholder="MM" size="2" type="text" value="">-
	      <input class="partial-date-day" id="id-period.begin_date.day" maxlength="2" name="period.begin_date.day" placeholder="DD" size="2" type="text" value="">
	    </span>
	    <button class="icon copy-date" title="Copy to end date" type="button">
	    </button>
	  </td>
	</tr>
	<tr>
	  <td class="section">
	    <label for="id-period.end_date.year">End date
	    </label>
	  </td>
	  <td class="fields end-date">
	    <span class="partial-date">
	      <input class="partial-date-year" id="id-period.end_date.year" maxlength="4" name="period.end_date.year" placeholder="YYYY" size="4" type="text" value="">-
	      <input class="partial-date-month" id="id-period.end_date.month" maxlength="2" name="period.end_date.month" placeholder="MM" size="2" type="text" value="">-
	      <input class="partial-date-day" id="id-period.end_date.day" maxlength="2" name="period.end_date.day" placeholder="DD" size="2" type="text" value="">
	    </span>
	    <br>
	    <div class="row">
	      <label class="inline">
		<input id="id-period.ended" name="period.ended" type="checkbox" value="1"> This relationship has ended.
	      </label>
	    </div>
	  </td>
	</tr>
      </tbody>
    </table>
    <h2>
      <div class="heading-line">
      </div>
      <span class="heading-text">Preview
      </span>
    </h2>
    <table class="preview details add-relationship">
      <tbody>
	<tr>
	  <th>Relationship:
	  </th>
	  <td>
	    <a class="wrap-anywhere" target="_blank" href="/recording/7e2eedbe-0951-472f-b5b7-fffe50ccc909">
	      <bdi>Sha La La
	      </bdi>
	    </a> is a  live    cover   recording of
	    <a class="wrap-anywhere" target="_blank" href="/work/53838f9a-6d1a-3dc3-bb15-40f80c4510e7">
	      <bdi>Sha‚ÄêLa‚ÄêLa
	      </bdi>
	    </a>
	  </td>
	</tr>
      </tbody>
    </table>
    <div class="buttons" style="margin-top: 1em;">
      <button class="negative" type="button">Cancel
      </button>
      <div class="buttons-right">
	<button class="positive" type="button">Done
	</button>
      </div>
    </div>
  </div>
  <svg fill="currentColor" aria-hidden="true" width="26" height="24" viewBox="0 0 24 24" style="position: absolute; pointer-events: none; transform: rotate(90deg); top: 279px; right: calc(100% - 1px);">
    <path clip-path="url(#:rhc:)" fill="none" stroke="#AAA" stroke-width="3" d="M0,0 H24 L12,12 Q12,12 12,12 Z">
    </path>
    <path stroke="currentColor" d="M0,0 H24 L12,12 Q12,12 12,12 Z">
    </path>
    <clipPath id=":rhc:">
      <rect x="-1" y="1" width="26" height="24">
      </rect>
    </clipPath>
  </svg>
</div>
#+end_example

Add additional buttons between the "Cancel" and "Done" buttons with the following text and actions:

The button text maps to the following generic action: Toggle the corresponding "Attribute" checkbox which has the same checkbox description and in all cases press the "Done" button at the end

- Button Text: "cover" --> Action: Toggle the "cover" checkbox
- Button Text: "live"  --> Action: Toggle the "live" checkbox
- Button Text: "live/cover" --> Action: Toggle the "live" and "cover" checkboxes
- Button Text: "partial" --> Action: Toggle the "partial" checkbox
- Button Text: "partial/live" --> Action: Toggle the "partial" and "live" checkboxes
- Button Text: "partial/live/cover" --> Action: Toggle the "partial", "live" and "cover" checkboxes

Remember to press the DONE button after toggling all the checkboxes.

** 1

Implement console debug logging, as nothing happened, now buttons appear.

** 2

[MB-Debug] Relationship dialog detected in DOM
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:105 [MB-Debug] Header text: "Edit relationship"
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:115 [MB-Debug] Is Related type "Work"? true
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:59 [MB-Debug] Injecting custom buttons
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:87 Uncaught NotFoundError: Failed to execute 'insertBefore' on 'Node': The node before which the new node is to be inserted is not a child of this node.
    at injectButtons (userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:87:33)
    at MutationObserver.checkDialog (userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:118:29)
    
** 3

Here the popup HTML code again

#+begin_example
<div tabindex="-1" data-floating-ui-focusable="" class="dialog popover relationship-dialog" id="edit-relationship-dialog" role="dialog" style="position: absolute; left: 0px; top: 0px; transform: translate(252px, 524px);"><div class="form"><div class="dialog-titlebar"><h1>Edit relationship</h1><div class="buttons-right"><span style="font-weight: normal;">(<a href="#">help</a>)</span></div></div><table class="relationship-details"><tbody><tr><td class="required section">Recording</td><td class="fields"><a class="wrap-anywhere" target="_blank" href="/recording/96853f8b-da57-438a-b3b3-0eaf44f8597c"><bdi>Out in the Street</bdi></a><div class="error"></div></td></tr><tr><td class="required section">Related type</td><td class="fields">Work</td></tr></tbody></table><h2><div class="heading-line"></div><span class="heading-text">Relationship</span></h2><table class="relationship-details"><tbody><tr><td class="required section">Relationship type</td><td class="fields"><label class="autocomplete2-label required" for="relationship-type-recording-work-3496682" id="relationship-type-recording-work-3496682-label">Type or click to search:</label><div class="autocomplete2 relationship-type"><div aria-expanded="false" aria-haspopup="listbox" aria-owns="relationship-type-recording-work-3496682-menu" class="required" role="combobox"><input aria-autocomplete="list" aria-controls="relationship-type-recording-work-3496682-menu" aria-labelledby="relationship-type-recording-work-3496682-label" aria-required="true" autocomplete="off" class="relationship-type lookup-performed" id="relationship-type-recording-work-3496682" placeholder="Type or click to search" type="text" value="recording of / recordings"><button aria-controls="relationship-type-recording-work-3496682-menu" aria-haspopup="true" aria-label="Search" class="search" data-toggle="true" role="button" tabindex="-1" title="Search" type="button"></button></div><ul aria-controls="relationship-type-recording-work-3496682-status" aria-labelledby="relationship-type-recording-work-3496682-label" id="relationship-type-recording-work-3496682-menu" role="listbox" tabindex="-1"><li aria-disabled="false" aria-selected="false" class="selected option-item " id="relationship-type-recording-work-3496682-item-278" role="option">recording of / recordings<br><span class="autocomplete-comment">This is used to link works to their recordings.</span></li><li aria-disabled="false" aria-selected="false" class="separator action-item " id="relationship-type-recording-work-3496682-item-toggle-descriptions" role="option">Hide descriptions</li></ul><div aria-live="assertive" aria-relevant="additions text" id="relationship-type-recording-work-3496682-status" role="status">performance</div></div><div aria-atomic="true" class="error" role="alert"></div></td></tr><tr><td class="required section">Work</td><td class="fields"><label class="autocomplete2-label required" for="relationship-target-3496682" id="relationship-target-3496682-label">Search for a work:</label><div class="autocomplete2 relationship-target"><div aria-expanded="false" aria-haspopup="listbox" aria-owns="relationship-target-3496682-menu" class="required" role="combobox"><input aria-autocomplete="list" aria-controls="relationship-target-3496682-menu" aria-labelledby="relationship-target-3496682-label" aria-required="true" autocomplete="off" class="relationship-target lookup-performed" id="relationship-target-3496682" placeholder="Type to search, or paste an MBID" type="text" value="Out in the Street"><button aria-controls="relationship-target-3496682-menu" aria-haspopup="true" aria-label="Search" class="search" data-toggle="true" role="button" tabindex="-1" title="Search" type="button"></button></div><ul aria-controls="relationship-target-3496682-status" aria-labelledby="relationship-target-3496682-label" id="relationship-target-3496682-menu" role="listbox" tabindex="-1"></ul><div aria-live="assertive" aria-relevant="additions text" id="relationship-target-3496682-status" role="status">Out in the Street</div></div><div class="error"></div></td></tr><tr class="link-order"><td class="section">Order</td><td class="fields"><input max="2147483647" min="0" type="number" value="0"><span class="tooltip-wrapper"><span class="img icon help" style="display: inline-block; margin-left: 10px; vertical-align: text-top;"></span><span class="tooltip-container"><span class="tooltip-triangle"></span><span class="tooltip-content">If this relationship has a specific order among others of the same type, you may set its position in the list here (as an alternative to the up- and down-arrow buttons).</span></span></span></td></tr></tbody></table><h2><div class="heading-line"></div><span class="heading-text">Attributes</span></h2><table class="relationship-details"><tbody><tr><td class="section"></td><td class="fields"><div class="attribute-container checkbox acappella"><label><input class="boolean" id="acappella-checkbox" type="checkbox"> acappella</label></div></td></tr><tr><td class="section"></td><td class="fields"><div class="attribute-container checkbox cover"><label><input class="boolean" id="cover-checkbox" type="checkbox"> cover</label></div></td></tr><tr><td class="section"></td><td class="fields"><div class="attribute-container checkbox demo"><label><input class="boolean" id="demo-checkbox" type="checkbox"> demo</label></div></td></tr><tr><td class="section"></td><td class="fields"><div class="attribute-container checkbox instrumental"><label><input class="boolean" id="instrumental-checkbox" type="checkbox"> instrumental</label></div></td></tr><tr><td class="section"></td><td class="fields"><div class="attribute-container checkbox karaoke"><label><input class="boolean" id="karaoke-checkbox" type="checkbox"> karaoke</label></div></td></tr><tr><td class="section"></td><td class="fields"><div class="attribute-container checkbox live"><label><input class="boolean" id="live-checkbox" type="checkbox" checked=""> live</label></div></td></tr><tr><td class="section"></td><td class="fields"><div class="attribute-container checkbox medley"><label><input class="boolean" id="medley-checkbox" type="checkbox"> medley</label></div></td></tr><tr><td class="section"></td><td class="fields"><div class="attribute-container checkbox partial"><label><input class="boolean" id="partial-checkbox" type="checkbox"> partial</label></div></td></tr><tr><td class="section"><label for="id-period.begin_date.year">Begin date</label></td><td class="fields"><span class="partial-date"><input class="partial-date-year" id="id-period.begin_date.year" maxlength="4" name="period.begin_date.year" placeholder="YYYY" size="4" type="text" value="1981">-<input class="partial-date-month" id="id-period.begin_date.month" maxlength="2" name="period.begin_date.month" placeholder="MM" size="2" type="text" value="1">-<input class="partial-date-day" id="id-period.begin_date.day" maxlength="2" name="period.begin_date.day" placeholder="DD" size="2" type="text" value="26"></span><button class="icon copy-date" title="Copy to end date" type="button"></button></td></tr><tr><td class="section"><label for="id-period.end_date.year">End date</label></td><td class="fields end-date"><span class="partial-date"><input class="partial-date-year" id="id-period.end_date.year" maxlength="4" name="period.end_date.year" placeholder="YYYY" size="4" type="text" value="1981">-<input class="partial-date-month" id="id-period.end_date.month" maxlength="2" name="period.end_date.month" placeholder="MM" size="2" type="text" value="1">-<input class="partial-date-day" id="id-period.end_date.day" maxlength="2" name="period.end_date.day" placeholder="DD" size="2" type="text" value="26"></span><br><div class="row"><label class="inline"><input disabled="" id="id-period.ended" name="period.ended" type="checkbox" value="1" checked=""> This relationship has ended.</label></div></td></tr></tbody></table><h2><div class="heading-line"></div><span class="heading-text">Preview</span></h2><table class="preview details"><tbody><tr><th>Relationship:</th><td><a class="wrap-anywhere" target="_blank" href="/recording/96853f8b-da57-438a-b3b3-0eaf44f8597c"><bdi>Out in the Street</bdi></a> <span class="comment">(<bdi>live, 1981‚Äê01‚Äê26: Athletic &amp; Convocation Center, University of Notre Dame, South Bend, IN, USA</bdi>)</span> is a  live       recording of <a class="wrap-anywhere" target="_blank" href="/work/35fdc4a9-fd0a-3a68-a539-5b377464a3ac"><bdi>Out in the Street</bdi></a> on 1981-01-26 </td></tr></tbody></table><div class="buttons" style="margin-top: 1em;"><button class="negative" type="button">Cancel</button><div class="buttons-right"><button class="positive" type="button">Done</button></div></div></div><svg fill="currentColor" aria-hidden="true" width="26" height="24" viewBox="0 0 24 24" style="position: absolute; pointer-events: none; transform: rotate(90deg); top: 293px; right: calc(100% - 1px);"><path clip-path="url(#:rv8:)" fill="none" stroke="#AAA" stroke-width="3" d="M0,0 H24 L12,12 Q12,12 12,12 Z"></path><path stroke="currentColor" d="M0,0 H24 L12,12 Q12,12 12,12 Z"></path><clipPath id=":rv8:"><rect x="-1" y="1" width="26" height="24"></rect></clipPath></svg></div>
#+end_example

and the console log

#+begin_example
[MB-Debug] Relationship dialog detected in DOM
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:107 [MB-Debug] Header text: "Edit relationship"
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:117 [MB-Debug] Is Related type "Work"? true
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:60 [MB-Debug] Injecting custom buttons
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:89 Uncaught NotFoundError: Failed to execute 'insertBefore' on 'Node': The node before which the new node is to be inserted is not a child of this node.
    at injectButtons (userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:89:26)
    at MutationObserver.checkDialog (userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:120:29)
#+end_example

** 4

Now the buttons appear, but the checkbox state is actually NOT toggled.

#+begin_example
[MB-Debug] Script initialized
[MB-Debug] Observer attached to document.body
[MB-Debug] Relationship dialog detected in DOM
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:124 [MB-Debug] Is Related type "Work"? true
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:66 [MB-Debug] Injecting custom buttons
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:111 [MB-Debug] Relationship dialog detected in DOM
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:124 [MB-Debug] Is Related type "Work"? true
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:47 [MB-Debug] Buttons already exist, skipping injection
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:20 [MB-Debug] Applying attributes: (3)¬†['partial', 'live', 'cover']0: "partial"1: "live"2: "cover"length: 3[[Prototype]]: Array(0)
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:27 [MB-Debug] Toggled checkbox: partial
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:27 [MB-Debug] Toggled checkbox: live
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:27 [MB-Debug] Toggled checkbox: cover
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:37 [MB-Debug] Clicking Done button
userscript.html?name=VZ%253A-MusicBrainz-Work-Relationship-Fast-Attributes.user.js&id=5bd51035-6db2-4103-9618-cd009aa18a65:111 [MB-Debug] Relationship dialog detected in DOM
#+end_example

** 5

The toggling now works.

But I actually made an error during my description of the actions.

Pressing the generated buttons should make sure that the state of the checkboxes is actually "checked", so if for
example a specific work already has the "live" checkbox checked, the pressing of for example the

- button "partial/live/cover" should only additionally check the "partial" and "cover" checkboxes
- button "live" should actually do nothing with the checkboxes

Only the presing of the DONE button should always happen

** 6

Almost perfect. But when pressing one of the generated buttons, make sure that ONLY the checkboxes are checked that are actually mentioned on the button text.

** 7

The logic works now.  But please generate the new buttons one row below the "Done" button under the "Cancel" button

** 8

leave a little space between the "Cancel button and the new row of buttons, because the "Cancel" and "cover" button touch each other


* ShowAllReleases in ReleaseGroups
** initial

Create a Tampermonkey userscript for "// @match        https://musicbrainz.org/release-group/*"

that creates a button at the starting page with text "Show all releases" after the release group title between the
following tags "<bdi>Greetings From Asbury Park, N.J.</bdi>"

Complete HTML snippet:

#+begin_example
<div class="wrap-anywhere rgheader">
  <h1>
    <a href="/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c">
      <bdi>Greetings From Asbury Park, N.J.
      </bdi>
    </a>
  </h1>
  <p class="subheader">
    <span class="prefix">~
    </span>
    <!-- -->Release group by
    <bdi>
      <a href="/artist/70248960-cb53-4ea4-943a-edb18f7d336f" title="Springsteen, Bruce">Bruce Springsteen
      </a>
    </bdi>
  </p>
</div>
#+end_example

When pressed, the following action should be done:

Generate a final "release group page" which includes all information from all the sub release group pages by iterating through
all the links "https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c?page=<pagenumber>"
in the following pagination HTML snippet at the starting page

#+begin_example
<nav>
  <ul class="pagination">
    <li>
      <span>Previous
      </span>
    </li>
    <li class="separator">
    </li>
    <li>
      <a class="sel" href="https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c?page=1">
	<strong>1
	</strong>
      </a>
    </li>
    <li>
      <a href="https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c?page=2">2
      </a>
    </li>
    <li class="separator">
    </li>
    <li>
      <a href="https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c?page=2">Next
      </a>
    </li>
  </ul>
</nav>
#+end_example

accumulating all the tabular information and present the final accumulated page with the same headers found in the initial starting page at

#+begin_example
<table class="tbl mergeable-table">
<thead><tr><th class="checkbox-cell"><input type="checkbox"></th><th>Release</th><th>Relationships</th><th>Artist</th><th>Format</th><th>Tracks</th><th>Country/Date</th><th>Label</th><th>Catalog#</th><th>Barcode</th><th>Tagger</th></tr></thead>
#+end_example

** 1

Collect all the table entries after the different headings which look like the following

#+begin_example
<tr class="subh"><th></th><th colspan="9">Official</th></tr>
#+end_example

#+begin_example
<tr class="subh"><th></th><th colspan="9">Promotion</th></tr>
#+end_example

#+begin_example
<tr class="subh"><th></th><th colspan="9">(unknown)</th></tr>
#+end_example

#+begin_example
<tr class="subh"><th></th><th colspan="9">Bootleg</th></tr>
#+end_example

and create one final page where each subheader, like "Official", "Promotion, Bootleg", etc exist only one time.

** 2

Thx, it works.
Add two things:

 - Please add console logging to the code.
 - Make the final page sortable by the headers definde in

#+begin_example
<thead><tr><th class="checkbox-cell"><input type="checkbox"></th><th>Release</th><th>Relationships</th><th>Artist</th><th>Format</th><th>Tracks</th><th>Country/Date</th><th>Label</th><th>Catalog#</th><th>Barcode</th><th>Tagger</th></tr></thead>
#+end_example

** 3

- Ignore the "Relationships" and "Tagger" columns wenn accumulating the data. Also do not display this two headers in the final accumulated table.
- Place a up/down unicode trinagle symbol afer each column header to show the direction of sorting

** 4

Somehow the handling of the "Relationship" column is not right. See complete row example below

#+begin_example
<tr class="odd" id="9875993c-8cbe-42b3-a8ff-76d1148f6a5c">
  <td>
    <input name="add-to-merge" type="checkbox" value="2956217">
  </td>
  <td>
    <span style="cursor: pointer; margin-right: 4px; color: rgb(119, 119, 119);">‚ñ∂
    </span>
    <a href="/release/9875993c-8cbe-42b3-a8ff-76d1148f6a5c/cover-art">
      <span class="artwork-icon caa-icon" title="This release has artwork in the Cover Art Archive" style="background-size: contain; background-image: url(&quot;//coverartarchive.org/release/9875993c-8cbe-42b3-a8ff-76d1148f6a5c/front-250&quot;);">
      </span>
    </a>
    <a class="wrap-anywhere" href="/release/9875993c-8cbe-42b3-a8ff-76d1148f6a5c">
      <bdi>Greetings From Asbury Park, N.J.
      </bdi>
    </a>
    <span class="comment">(
      <bdi>‚ÄúNice Price‚Äù reissue
      </bdi>)
    </span>
  </td>
  <td class="relationships">
    <span style="cursor: pointer; color: rgb(119, 119, 119); float: right;">‚ûï
    </span>
    <a href="https://www.springsteenlyrics.com/collection.php?item=7992">
      <img src="https://www.springsteenlyrics.com/favicon.ico" class="favicon" style="width: 16px; height: 16px; vertical-align: middle; margin: 2px;">
    </a>
  </td>
  <td>
    <bdi>
      <a href="/artist/70248960-cb53-4ea4-943a-edb18f7d336f" title="Springsteen, Bruce">Bruce Springsteen
      </a>
    </bdi>
  </td>
  <td>Cassette
  </td>
  <td>9
  </td>
  <td>
    <script type="application/json">{"events":[{"country":{"entityType":"area","last_updated":"2013-08-28T11:55:13Z","iso_3166_3_codes":[],"iso_3166_1_codes":["XE"],"primaryAlias":"Europe","primary_code":"XE","iso_3166_2_codes":[],"id":241,"begin_date":null,"name":"Europe","typeID":null,"gid":"89a675c2-3e37-3518-b83c-418bad59a85a","end_date":null,"editsPending":false,"country_code":"XE","comment":"","ended":false},"date":{"year":null,"day":null,"month":null}}]}
    </script>
    <div class="release-events-container">
      <ul aria-label="Release events" class="release-events abbreviated">
	<li aria-label="Release event" class="release-event">
	  <span class="flag flag-XE release-country">
	    <a href="/area/89a675c2-3e37-3518-b83c-418bad59a85a">
	      <abbr title="Europe">XE
	      </abbr>
	    </a>
	  </span>
	  <span class="release-date no-date" title="Missing date">-
	  </span>
	</li>
      </ul>
    </div>
  </td>
  <td>
    <a href="/label/b8d33bec-92cc-40d9-bd92-4eb089b401a9">
      <bdi>CBS
      </bdi>
    </a>
    <span class="comment">(
      <bdi>CBS Records‚Äô international imprint from 1962‚Äì1990; renamed since 1991 as Columbia
      </bdi>)
    </span>
  </td>
  <td>
    <span class="catalog-number">40-32210
    </span>
  </td>
  <td class="barcode-cell">[none]
  </td>
  <td>
    <script type="application/json">{"entityType":"release","gid":"9875993c-8cbe-42b3-a8ff-76d1148f6a5c"}
    </script>
    <span class="tagger-icon">
      <a class="tagger-icon" href="http://127.0.0.1:8000/openalbum?id=9875993c-8cbe-42b3-a8ff-76d1148f6a5c" title="Open in tagger">
	<img alt="Tagger" src="https://static.metabrainz.org/MB/mblookup-tagger-5a66953.png">
      </a>
    </span>
  </td>
</tr>
#+end_example

Is it because of the 'class="relationships"' ?

#+begin_example
  <td class="relationships">
    <span style="cursor: pointer; color: rgb(119, 119, 119); float: right;">‚ûï
    </span>
    <a href="https://www.springsteenlyrics.com/collection.php?item=7992">
      <img src="https://www.springsteenlyrics.com/favicon.ico" class="favicon" style="width: 16px; height: 16px; vertical-align: middle; margin: 2px;">
    </a>
  </td>
#+end_example

When this colum is ignored, according to the current code, actually the "artist" column which normall should show the artist name, now shows the value of the "Format" column.

** 5

OK, the table data now looks ok, but in the header row there is still the "Relationships" column, which should be remove from the header.
Also the "Barcode" header is missing, but the "Tagger" header is there instead.
Please fix

** 6

In the uploaded user script add the following functionality:

1) add bigger unicode symbols for the sortable up/down icons
2) Change the button text "All releases loaded" to "All <total number of releases> releases" loaded
3) Add the text "Load only" after the "All <total number of releases> releases" button and after the text add buttons
   with text "<number of releases in subtype> <subtype>" for each subtype like "Official", "Promotion", "Bootleg" etc.
   
** 7

The sort up/down symbol gets rendered again and again per column and column header click. It should be replaced after
each click and onyl display on the column where the actual sorting takes place.

** pagination logic

Apply the same logic to find the maximum page number and logic for iteration always from pagnumber 1 up to the maximum
found from the uploaded userscript "ShowAllWorks.users.js" to the uploaded user script "ShowAllReleases.user.js"

** 1

In the uploaded userscript change the title of the "Show all releases" during loading to "Loading page <current> of <total>"

Also make the button text more visible during load. Right now because the button changes colour to show that it's not
clickable during load.

** 2

Create a button down effect when clicking the "Show all releases" button

** remove jesus images

Make the "<div class="jesus2099userjs154481bigbox"> container invisible when clicking the "Show all releases" button

** permit finger pointer

In the uploaded userscript "ShowAllReleasesInReleaseGroups.user.js" do not change the mouse pointer to a hand with pointing finger during page loding, leave as the default

Use the same Implementation logic like in the uploaded user script "ShowAllWorks.user.js"

** do not remove the tagger column

In the uploaded userscript "ShowAllReleasesInReleaseGroups.user.js" actually DO NOT remove the "Tagger" column, only the
"Relationships" column, like in the uploaded userscript "ShowAllReleases.user.js"

** console.log('[MB Show All] Starting accumulation and header cleanup...');

In the uploaded userscript refactor the console log statements to look like

console.log('[MB Show All Releases in ReleaseGroup] Starting accumulation and header cleanup...');

instead of

console.log('[MB Show All] Starting accumulation and header cleanup...');

but create a variable for the text "[MB Show All Releases in ReleaseGroup] " and concatenate this in the actual consol.log call


* ShowAllWorks
** initial

Create a new Tampermonkey userscript based on the uploaded one, but it should match

"// @match        https://musicbrainz.org/artist/*/works"

that creates a button at the starting page with text "Show all works" after the artist title between the
following tags "<bdi>Bruce Springsteen</bdi>" or in general "<bdi><artist name></bdi>"

Complete HTML snippet:

#+begin_example
<div class="wrap-anywhere artistheader person-icon">
  <h1>
    <a href="/artist/70248960-cb53-4ea4-943a-edb18f7d336f" title="Springsteen, Bruce">
      <bdi>Bruce Springsteen
      </bdi>
    </a>
  </h1>
  <p class="subheader">
    <span class="prefix">~
    </span>
    <!-- -->Person
  </p>
</div>
#+end_example

When pressed, the following action should be done:

Generate a final "works page" which includes all information from all the sub release work pages by iterating through
all the links "https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/works?page=<pagenumber>"
in the following pagination HTML snippet at the starting page

#+begin_example
<ul class="pagination">
  <li>
    <span>Previous
    </span>
  </li>
  <li class="separator">
  </li>
  <li>
    <a class="sel" href="https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/works?page=1">
      <strong>1
      </strong>
    </a>
  </li>
  <li>
    <a href="https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/works?page=2">2
    </a>
  </li>
  <li>
    <a href="https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/works?page=3">3
    </a>
  </li>
  <li>
    <a href="https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/works?page=4">4
    </a>
  </li>
  <li>
    <a href="https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/works?page=5">5
    </a>
  </li>
  <li>
    <span>‚Ä¶
    </span>
  </li>
  <li>
    <a href="https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/works?page=16">16
    </a>
  </li>
  <li class="separator">
  </li>
  <li>
    <a href="https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/works?page=2">Next
    </a>
  </li>
</ul>
#+end_example

accumulating all the tabular information and present the final accumulated page with the same headers found in the initial starting page at

#+begin_example
<table class="tbl mergeable-table">
<thead><tr><th colspan="1" class="checkbox-cell"><input type="checkbox"></th><th colspan="1">Work</th><th>Relationships</th><th colspan="1">Authors</th><th colspan="1">Recording artists</th><th colspan="1">Other artists</th><th colspan="1">ISWC</th><th colspan="1">Type</th><th colspan="1">Lyrics languages</th><th colspan="1">Attributes</th><th colspan="1" class="rating c">Rating</th></tr></thead>
#+end_example

But for this userscript please remove only the "Relationships" column, as the "Tagger" columns doesn't exist.
There are also NO subheaders (like "Official" or "Bootleg") on work pages. So that logic part doesn't apply here.

** 2

Actually we need to change how to look at the pagination

Always iterate by starting from pagenumber 1 up to the pagenumber which can be accessed by looking up the 
pagenumber from the href tag right before the one with the display text of "Next", for example in the following HTML pagination snippet, it's 16

#+begin_example
  <li>
    <a href="https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/works?page=16">16
    </a>
  </li>
  <li class="separator">
  </li>
  <li>
    <a href="https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/works?page=2">Next
    </a>
  </li>

#+end_example

** 3

In the uploaded userscript change the title of the "Show all works" during loading to "Loading page <current> of <total>"

** button text more visible

In the uploaded userscript "ShowAllWorks.user.js" make the button text more visible during load. Right now because the
button changes colour to show that it's not clickable during load.

Use the same Implementation logic like in the uploaded user script "ShowAllReleasesInReleaseGroups.user.js"

** 1

Do not change the mouse pointer to a hand with pointing finger during page loding, leave as the default 

** 2

NO, the mouse pointer ist still the ponting finger when hovering over the `Loading page ${p} of ${maxPage}...` button during load.


* ShowAllEvents
** initial

Create a new Tampermonkey userscript based on the uploaded one, but it should match

"// @match        https://musicbrainz.org/artist/*/events"

that creates a button at the starting page with text "Show all events" after the artist title between the
following tags "<bdi>Bruce Springsteen</bdi>" or in general "<bdi><artist name></bdi>"

Complete HTML snippet:

#+begin_example
<div class="wrap-anywhere artistheader person-icon">
  <h1>
    <a href="/artist/70248960-cb53-4ea4-943a-edb18f7d336f" title="Springsteen, Bruce">
      <bdi>Bruce Springsteen
      </bdi>
    </a>
  </h1>
  <p class="subheader">
    <span class="prefix">~
    </span>
    <!-- -->Person
  </p>
</div>
#+end_example

When pressed, the following action should be done:

Generate a final "events page" which includes all information from all the sub event pages by iterating through
all the links "https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/events?page=<pagenumber>"
in the following pagination HTML snippet at the starting page

** add fkt from ShowAllRecordings

In the uploaded userscripts add the functionality from the userscript "ShowAllRecordings.user.js" to
"ShowAllEvents.user.js";

- When the final page is rendered, add the generic sort icon "‚Üï" concatenated after the colums names and a popup hint "Click to sort" when hovering over
- Add a "Stop" button, to cancel iterating through all the pages
- Generate a popup warning and ask the user if he really want to proceed it the maximum pagenumber deduced from the pagination is greater than 100.
- Implement a time counter when pressing the "Show all events" button and display the total execution time, plus
  time for rendering the resulting table in the browser. The display should be next to the button on the right
  side. Please add timings for just the loading of pages AND the rendering of the resulting table separately
- add a search filter box next to the button that lets you filter the events by the different columns (for example Type, Role, Location, Date, etc) instantly after they've loaded?
 
** remove sanojjonas visualize stuff userscript

In the uploaded userscript, when pressing the "Show all events" button remove all container (if present) which look like

#+begin_example
<div id="load"><h1>deeper 3471</h1></div>
<div id="load2">
<div id="load3">
<div id="load4">
<div id="bottom1">
<div id="bottom2">
<div id="bottom3">
<div id="bottom4">
<div id="bottom6">
<div id="bottom6">
#+end_example

coming from sanojjonas visualize stuff userscript


* ShowAllReleases

Create a new Tampermonkey userscript based on the uploaded one, but it should match

"// @match        https://musicbrainz.org/artist/*/releases"

that creates a button at the starting page with text "Show all releases" after the artist title

When pressed, the following action should be done:

Generate a final "releases page" which includes all information from all the sub release pages by iterating through
all the links "https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/releases?page=<pagenumber>"

Also remove the "Relationships" column for the final page

Additionally make the "<div class="jesus2099userjs154481bigbox"> container invisible when clicking the "Show all releases" button


* ShowAllReleaseGroups

Create a new Tampermonkey userscript based on the uploaded one, but it should match

"// @match        https://musicbrainz.org/artist"

that creates a button at the starting page with text "Show all release groups" after the artist title

When pressed, the following action should be done:

Generate a final "release groups page" which includes all information from all the sub release groups pages by iterating through
all the links "https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f?page=<pagenumber>"

There is specific difference to the uploaded userscript. There actually multiple tables for release groups which all have
a specific heading '<h3><type></h3>', like the following ones

#+begin_example
<h3>Album</h3>
#+end_example

#+begin_example
table-structure for "Album"
#+end_example

#+begin_example
<h3>Album + Compilation</h3>
#+end_example

#+begin_example
table-structure for "Album + Compilation"
#+end_example

and so on, whereas in the uploaded script there is just ONE table.

Please leave these different structures intact for the finale "release groups" pages, only combine tabledata for a
specific heading if it extents over more than one iterated page.

Also remove the "Relationships" column for the final page for all tables

Additionally make ALL the "<div class="jesus2099userjs154481bigbox"> containers invisible when clicking the "Show all release groups" button.
They are located right after the '<h3><type></h3>'

All tables below each <type> (like for example "Album" or "Single") should also be sortable like in the before uploaded userscript

** remove sanojas stuff

In the uploaded user script, please remove the following container

#+begin_example
<div id="bottom1" style="overflow-x: auto; width: 804px;"><h2>Instrument Table</h2><br><table class="sanojjonas" border="1px solid black">
#+end_example

when pressing the "Show all release groups button"


* ShowAllRecordings

Create a new Tampermonkey userscript based on the uploaded one, but it should match

"// @match        https://musicbrainz.org/artist/*/recordings"

that creates a button at the starting page with text "Show all recordings" after the artist title

When pressed, the following action should be done:

Generate a final "recordings page" which includes all information from all the sub recording pages by iterating through
all the links "https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/recordings?page=<pagenumber>"

Generate a popup warning and ask the user if he really want to proceed it the maximum pagenumber deduced from the pagination is greater than 100.

** 2

Start 3:34

** 3

Implement a time counter when pressing the "Show all recordings" button and display the total execution time, plus time for rendering the resulting table in the browser.
The display should be next to the button on the right side.

Please add timings for just the loading of pages AND the rendering of the resulting table separately

** stop/cancel button

add a cancel button

** add sort icon

When the final page is rendered, 
add the generic sort icon "‚Üï" concatenated after the colums names and a popup hint "Click to sort" when hovering over
the column headers like in the following example for the "Date" header:

#+begin_example
<th title="Click to sort" style="cursor: pointer; white-space: nowrap;" class="sortable">Date<span>‚Üï</span></th>
#+end_example

** search filter

yes, please add a search filter box next to the button that lets you filter the recordings by title or year instantly after they've loaded?

** Hide table container

Hide the following table container if present when pressing the "Show all recordings" button

#+begin_example
<table style="margin: 0.5em 0.5em 2em; background: rgb(242, 242, 242); border: 1px solid rgb(153, 153, 153);">
  <tbody>
    <tr>
      <td style="padding: 0.5em; vertical-align: top;">
	<h3>Relate checked recordings to‚Ä¶
	</h3>
      </td>
      <td style="padding: 0.5em; vertical-align: top;">
	<h3>Cached works
	</h3>
	<span style="font-size: 0.9em;">(These are used to auto-suggest works.)
	</span>
      </td>
    </tr>
#+end_example

** remove the "Performance Attributes" column at the end of the table from the final table

Somehow the "Release Groups" colum is now empty

** answer

The "Release Groups" column is appearing empty because that specific column in MusicBrainz uses asynchronous loading (it
fetches the data via a separate internal API call after the initial page load). When the script grabs the HTML for
subsequent pages via fetchHtml, that data hasn't been populated yet.

To fix this, we need to modify the script to extract the recording MBID from each row and manually construct the
link/text for the Release Group column, or simply ensure we are capturing the content if it's already there (though for
background pages, it usually isn't).

However, a more robust way to ensure we don't lose data and to keep the "Performance Attributes" removal logic clean is
to specifically target the "Release Group" cell and preserve its internal structure.

Here is the corrected version. I have also refined the row-cleaning logic to ensure that if a Release Group link exists
in the source, it is preserved properly.

** wrong logic for     btn.textContent = `Show all recordings${totalRecordingsCount}`;

Somehow nothing (nor number of recordings) is shown in the following button

#+begin_example
    btn.textContent = `Show all recordings${totalRecordingsCount}`;
#+end_example

What I see is "Show all recording (Recordings)"


* ShowAllRecordings in Works
** initial try

"// @match        https://musicbrainz.org/work/*?direction=2&link_type_id=278"


Create a new Tampermonkey userscript based on the uploaded one, but it should match

"// @match        https://musicbrainz.org/work/*"

that creates a button at the starting page with text "Show all recordings" after the work title between the
following tags "<bdi>Born in the U.S.A.</bdi>" or in general "<bdi><work title></bdi>"

Complete HTML snippet:

#+begin_example
<h1><a href="/work/55d593ce-52cc-30ec-9494-eca1ab879f5c"><bdi>Born in the U.S.A.</bdi></a></h1>
#+end_example

When pressed, the following action should be done:

Call one time the link "https://musicbrainz.org/work/55d593ce-52cc-30ec-9494-eca1ab879f5c?direction=2&amp;link_type_id=278&amp;page=1" with explicit pagenumber 1
and parse the pagination part to get tha max pages

Generate a final "recordings page" which includes all information from all the sub recordings pages by iterating through
all the links "https://musicbrainz.org/work/55d593ce-52cc-30ec-9494-eca1ab879f5c?direction=2&amp;link_type_id=278&amp;page=<pagenumber>"

** 1

The first time the button is pressed, parse the resulting page for the text "See all <n> relationships" in the following HTML fragment

#+begin_example
<tr>
  <td>
  </td>
  <td colspan="4" style="padding: 1em; text-align: right;" class="treleases" title="SUPER&nbsp;MIND&nbsp;CONTROL&nbsp;‚Ö°&nbsp;X&nbsp;TURBO">
    <a href="https://musicbrainz.org/work/35fdc4a9-fd0a-3a68-a539-5b377464a3ac?direction=2&amp;link_type_id=278&amp;page=1">See all 851 relationships
    </a>
  </td>
</tr>
#+end_example

and emulate a click on that link to get another page which has the pagination buttons at the end as usual, so you can
get the max number of pages from there.

** next try

Create a new Tampermonkey userscript based on the uploaded one, but it should match

"// @match        https://musicbrainz.org/work/*"

that creates a button at the starting page with text "Show all recordings" after the work title between the
following tags "<bdi>Born in the U.S.A.</bdi>" or in general "<bdi><work title></bdi>"

Complete HTML snippet:

#+begin_example
<h1><a href="/work/55d593ce-52cc-30ec-9494-eca1ab879f5c"><bdi>Born in the U.S.A.</bdi></a></h1>
#+end_example

When pressed, the following action should be done:

Generate a final "recordings page" which includes all information from all the sub recordings pages by iterating through
all the links "https://musicbrainz.org/work/55d593ce-52cc-30ec-9494-eca1ab879f5c?direction=2&amp;link_type_id=278&amp;page=<pagenumber>"

Please also implement the sorting functionality + console logging.

** 1

It seems to work, the logging looks good, but somehow at the end a redirect occurs to the root of the page without the query parameters

https://musicbrainz.org/work/35fdc4a9-fd0a-3a68-a539-5b377464a3ac?direction=2&link_type_id=278&page=1

which should stay there, otherwise we start all over

** redirect

Can you make the userscript when entering a URL like "https://musicbrainz.org/work/35fdc4a9-fd0a-3a68-a539-5b377464a3ac"
automatically redirect to "https://musicbrainz.org/work/35fdc4a9-fd0a-3a68-a539-5b377464a3ac?direction=2&link_type_id=278&page=1"


* ShowAll
** initial

Please consolidate the uploaded userscripts in a common one which works on all @match URLs (also use the broader type
with '*://*.musicbrainz.org/' instead of 'https://musicbrainz.org/'

Specifically the consolidated script should have the following functionalities included in 'ShowAllEvents.user.js' for
all other types to (Recordings, Works, Releases, etc.):

- When the final page is rendered, add the generic sort icon "‚Üï" concatenated after the colums names and a popup hint "Click to sort" when hovering over
- Add a "Stop" button, to cancel iterating through all the pages
- Generate a popup warning and ask the user if he really want to proceed it the maximum pagenumber deduced from the pagination is greater than 100.
- Implement a time counter when pressing the "Show all events" button and display the total execution time, plus
  time for rendering the resulting table in the browser. The display should be next to the button on the right
  side. Please add timings for just the loading of pages AND the rendering of the resulting table separately
- add a search filter box next to the button that lets you filter the events by the different columns (for example Type, Role, Location, Date, etc) instantly after they've loaded?

** better button

The button text during loading is almost invisible. Please make it exactly like in the uploaded script "ShowAllEvents.user.js"

** add C

Add "C: " in front of the initial text in the Submit button, to distinguish it from the button of the non consolidated userscripts

So for example: "C: Show all events"

** missing

If existing, the "Relationship" and "Performance Attributes" columns should be filtered out.
See the uploaded userscripts for implentation.

** 1

Actually nothing changed, the "Relationship" and "Performance Attributes" columns are still there.  See the userscripts
"ShowAllWorks.user.js" for "Relationship" and "ShowAllRecordings.user.js" for "Performance Attributes" successfull
implementation.

** 2

The "Performance Attributes" column stuff is fixed now. But the the "Relationship" column is still present (actually just the header) for example
for the following URL:
- https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/works
- https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/releases

** 3

No, still not working. Please see the implementation for this in the userscript which was uploaded in the beginning "ShowAllWorks.user.js"

** 4

OK It's working now.

But, please hide the following table container if present when pressing the "Show all recordings" button

#+begin_example
<table style="margin: 0.5em 0.5em 2em; background: rgb(242, 242, 242); border: 1px solid rgb(153, 153, 153);">
  <tbody>
    <tr>
      <td style="padding: 0.5em; vertical-align: top;">
	<h3>Relate checked recordings to‚Ä¶
	</h3>
      </td>
      <td style="padding: 0.5em; vertical-align: top;">
	<h3>Cached works
	</h3>
	<span style="font-size: 0.9em;">(These are used to auto-suggest works.)
	</span>
      </td>
    </tr>
#+end_example

See also the implementation in the uploaded userscript "ShowAllRecordings.user.js"

** 5

Please make the "<div class="jesus2099userjs154481bigbox"> container invisible when clicking the "Show all releases" button.
It's still present for example in
 - https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/releases
   
See the successfull implementation in the uploaded userscript "ShowAllReleases.user.js" 

** 6

OK, the "<div class="jesus2099userjs154481bigbox"> container stuff works now.

But please, for the following type of URL https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c which shows all release in a release-group,
collect all the table entries after the different headings which look like the following

#+begin_example
<tr class="subh"><th></th><th colspan="9">Official</th></tr>
#+end_example

#+begin_example
<tr class="subh"><th></th><th colspan="9">Promotion</th></tr>
#+end_example

#+begin_example
<tr class="subh"><th></th><th colspan="9">(unknown)</th></tr>
#+end_example

#+begin_example
<tr class="subh"><th></th><th colspan="9">Bootleg</th></tr>
#+end_example

and create the final page where each subheader, like "Official", "Promotion, Bootleg", etc exist only one time.

See successfull implementation in uploaded userscript "ShowAllReleasesInReleaseGroups.user.js"

** 7

Thx, the subheader stuff now also works.

There is a problem with URLs of type https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f where all the
release groups are shown. Remember there actually multiple tables for release groups which all have a specific heading
'<h3><type></h3>', like the following ones

#+begin_example
<h3>Album</h3>
#+end_example

#+begin_example
table-structure for "Album"
#+end_example

#+begin_example
<h3>Album + Compilation</h3>
#+end_example

#+begin_example
table-structure for "Album + Compilation"
#+end_example

Let me refrase my last instructions, because I forget some important point.

Please leave these different structures intact for the finale "release groups" pages, only combine tabledata for a
specific heading if it extents over more than one iterated page.

Additionally make ALL the "<div class="jesus2099userjs154481bigbox"> containers invisible when clicking the "Show all release groups" button.
They are located right after the '<h3><type></h3>'

All tables below each <type> (like for example "Album" or "Single") should also be sortable like in the before uploaded userscript

For a successfull implementation see the uploaded userscript "ShowAllReleaseGroups.user.js"

** 8

It actually works, but there are three of the original tables still left in the resulting page. These are the types: "Album + Compilation", "Album + Compilation + Live" and "Album + Live"

Please also remove for these types of URLs, the following container (if present) in the resulting page, it starts with the header text '<h2>Instrument Table</h2>':

#+begin_example
<div id="bottom1" style="overflow-x: auto; width: 804px;"><h2>Instrument Table</h2><br><table class="sanojjonas" border="1px solid black"> .....
#+end_example

** 9

The '<h2>Instrument Table</h2>' worked, but the three original tables are still left in the resulting page. These are the types: "Album + Compilation", "Album + Compilation + Live" and "Album + Live"

** 10

No, three original tables are still left in the resulting page. These are the types: "Album + Compilation", "Album + Compilation + Live" and "Album + Live"

** 11

NO, still the same problem. Could you alos additionally implement debug logging for the whole script

** 12

Actually now the cleanup worked, but lots of other stuff which used to work is broken. The "Stop" button doesn't work anymore, the table headings are not there anymore, nothing is sortable.

** with better engine

In the uploaded userscript "ShowAllConsolidated.user.js" when calling with URLs of type https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f

three original tables are still left in the resulting page. These are the types: "Album + Compilation", "Album + Compilation + Live" and "Album + Live"

A working implementation can be found in the uploaded sript "ShowAllReleaseGroups.user.js"

** 1

Well the cleanup now works, but the sortable headers for the different tables are missing

** 2

Please also remove for these types of URLs, the following container (if present) in the resulting page, it starts with the header text '<h2>Instrument Table</h2>':

#+begin_example
<div id="bottom1" style="overflow-x: auto; width: 804px;"><h2>Instrument Table</h2><br><table class="sanojjonas" border="1px solid black"> .....
#+end_example

** 3

Implement comprehensive debug logging, but do not touch the code logic and the rest

** works

Please check the uploaded user script, specifically the code "Auto-redirect logic to ensure we are on the recording relationship view"
and the special fetching of data for these types of URLs, example https://musicbrainz.org/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db

#+begin_example
        try {
            for (let p = 1; p <= maxPage; p++) {
                btn.textContent = `Loading page ${p} of ${maxPage}...`;
                const targetUrl = `${baseUrl}?direction=${direction}&link_type_id=${linkTypeId}&page=${p}`;
                console.log(`[MB Show All Recordings] Fetching page ${p} of ${maxPage}...`);
#+end_example

and implement it in the current script, as right now it's not working

** 1

Please add debug statements. It looks like its fetching data, but in the end it seems there is a redirect to where we start off. The button has again the same initial text

** 2

Please use the implementation from the uploaded script, as that one works perfect

[MB-ShowAll-Debug] Script initialized. Checking environment... 
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Detection completed. {pageType: 'work-details', hasHeader: true}
react-dom.production.min.js:132 Uncaught Error: Minified React error #418; visit https://reactjs.org/docs/error-decoder.html?invariant=418 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
fo @ react-dom.production.min.js:132
Qs @ react-dom.production.min.js:225
ku @ react-dom.production.min.js:280
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
react-dom.production.min.js:292 Uncaught Error: Minified React error #423; visit https://reactjs.org/docs/error-decoder.html?invariant=423 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
Sl @ react-dom.production.min.js:292
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
ou @ react-dom.production.min.js:270
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
favicon-ico:1  GET https://brucebase.wikidot.com/favicon-ico net::ERR_TOO_MANY_REDIRECTS
Image
setFavicon @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1684
addExternalLink @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1333
xhr.onreadystatechange @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1376
(anonymous) @ xhr.js:88
XMLHttpRequest.send
(anonymous) @ trycatch.js:164
(anonymous) @ xhr.js:135
addHiddenLinks @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1392
main @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1227
(anonymous) @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1158
At @ VM4452:10
(anonymous) @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1
window.__f__mkqf4bnj.2q @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1
At @ VM4452:10
r.setMessageListener.r @ VM4452:90
(anonymous) @ VM4452:93
_ @ VM4452:22
$t @ content.js:9
h @ content.js:65
d @ content.js:68
(anonymous) @ content.js:68
Xn @ content.js:15
send @ content.js:68
w @ content.js:63
(anonymous) @ content.js:64
(anonymous) @ content.js:2
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Button clicked. Starting fetch process. 
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Pagination check done. Max page: 3 
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Fetching page 1... 
Navigated to https://musicbrainz.org/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db
userscript.html?name=MB%253A-Supercharged-Cover-Art-Edits.user.js&id=0c53d926-6032-49a1-9002-908a5d53bc1a:10503 Will not be able to get dimensions, script not installed?
userscript.html?name=sanojjonas-visualise-stuff.user.js&id=39cb5d25-a89a-401b-9c61-6d1089d68abe:1065 work & overview not allowed yet
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Script initialized. Checking environment... 
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Work page detected without params. Redirecting to recording relationship view... 
react-dom.production.min.js:132 Uncaught Error: Minified React error #418; visit https://reactjs.org/docs/error-decoder.html?invariant=418 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
fo @ react-dom.production.min.js:132
Qs @ react-dom.production.min.js:225
ku @ react-dom.production.min.js:280
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
react-dom.production.min.js:292 Uncaught Error: Minified React error #423; visit https://reactjs.org/docs/error-decoder.html?invariant=423 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
Sl @ react-dom.production.min.js:292
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
ou @ react-dom.production.min.js:270
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
Navigated to https://musicbrainz.org/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db?direction=2&link_type_id=278&page=1
userscript.html?name=MB%253A-Supercharged-Cover-Art-Edits.user.js&id=0c53d926-6032-49a1-9002-908a5d53bc1a:10503 Will not be able to get dimensions, script not installed?
userscript.html?name=sanojjonas-visualise-stuff.user.js&id=39cb5d25-a89a-401b-9c61-6d1089d68abe:1065 work & overview not allowed yet
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Script initialized. Checking environment... 
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Detection completed. {pageType: 'work-details', hasHeader: true}

** why

This is the debug from the woking script "ShowAllRecordingsInWorks.user.js"

#+begin_example
[MB Show All Recordings] Redirecting to recording relationship view...
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Script initialized. Checking environment... 
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Work page detected without params. Redirecting to recording relationship view... 
react-dom.production.min.js:132 Uncaught Error: Minified React error #418; visit https://reactjs.org/docs/error-decoder.html?invariant=418 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
fo @ react-dom.production.min.js:132
Qs @ react-dom.production.min.js:225
ku @ react-dom.production.min.js:280
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
react-dom.production.min.js:292 Uncaught Error: Minified React error #423; visit https://reactjs.org/docs/error-decoder.html?invariant=423 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
Sl @ react-dom.production.min.js:292
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
ou @ react-dom.production.min.js:270
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
Navigated to https://musicbrainz.org/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db?direction=2&link_type_id=278&page=1
userscript.html?name=MB%253A-Supercharged-Cover-Art-Edits.user.js&id=0c53d926-6032-49a1-9002-908a5d53bc1a:10503 Will not be able to get dimensions, script not installed?
userscript.html?name=sanojjonas-visualise-stuff.user.js&id=39cb5d25-a89a-401b-9c61-6d1089d68abe:1065 work & overview not allowed yet
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Script initialized. Checking environment... 
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Detection completed. {pageType: 'work-details', hasHeader: true}
react-dom.production.min.js:132 Uncaught Error: Minified React error #418; visit https://reactjs.org/docs/error-decoder.html?invariant=418 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
fo @ react-dom.production.min.js:132
Qs @ react-dom.production.min.js:225
ku @ react-dom.production.min.js:280
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
react-dom.production.min.js:292 Uncaught Error: Minified React error #423; visit https://reactjs.org/docs/error-decoder.html?invariant=423 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
Sl @ react-dom.production.min.js:292
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
ou @ react-dom.production.min.js:270
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
favicon-ico:1  GET https://brucebase.wikidot.com/favicon-ico net::ERR_TOO_MANY_REDIRECTS
Image
setFavicon @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1684
addExternalLink @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1333
xhr.onreadystatechange @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1376
(anonymous) @ xhr.js:88
XMLHttpRequest.send
(anonymous) @ trycatch.js:164
(anonymous) @ xhr.js:135
addHiddenLinks @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1392
main @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1227
(anonymous) @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1158
At @ VM4776:10
(anonymous) @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1
window.__f__mkqbl1r6.mlh @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1
At @ VM4776:10
r.setMessageListener.r @ VM4776:90
(anonymous) @ VM4776:93
_ @ VM4776:22
$t @ content.js:9
h @ content.js:65
d @ content.js:68
(anonymous) @ content.js:68
Xn @ content.js:15
send @ content.js:68
w @ content.js:63
(anonymous) @ content.js:64
(anonymous) @ content.js:2
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Recordings-In-Works.user.js&id=a472f993-2124-4a50-b4bf-c4b3f3873fdf:84 [MB Show All Recordings] Starting accumulation...
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Recordings-In-Works.user.js&id=a472f993-2124-4a50-b4bf-c4b3f3873fdf:110 [MB Show All Recordings] Fetching page 1 of 3...
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Recordings-In-Works.user.js&id=a472f993-2124-4a50-b4bf-c4b3f3873fdf:110 [MB Show All Recordings] Fetching page 2 of 3...
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Recordings-In-Works.user.js&id=a472f993-2124-4a50-b4bf-c4b3f3873fdf:110 [MB Show All Recordings] Fetching page 3 of 3...
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Recordings-In-Works.user.js&id=a472f993-2124-4a50-b4bf-c4b3f3873fdf:126 [MB Show All Recordings] Successfully loaded 674 rows.
#+end_example

everything is fine here. Why can*t we just include the saem logic ??

**

Please fix the functionality in the uploaded userscript for URLs of type https://musicbrainz.org/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db
with previous findings of you



see also the following snippet

#+begin_example
(function() {
    'use strict';

    const DEBUG = true;
    const log = (msg, data = '') => { if (DEBUG) console.log(`[MB-ShowAll-Debug] ${msg}`, data); };

    const currentUrl = new URL(window.location.href);
    const path = currentUrl.pathname;
    const params = currentUrl.searchParams;

    // --- EXACT LOGIC FROM ShowAllRecordingsInWorks.user.js ---
    if (path.includes('/work/') && !path.includes('/recordings') && !path.includes('/releases')) {
        if (!params.has('direction') || !params.has('link_type_id')) {
            console.log('[MB Show All Recordings] Redirecting to recording relationship view...');
            params.set('direction', '2');
            params.set('link_type_id', '278');
            if (!params.has('page')) params.set('page', '1');
            window.location.replace(currentUrl.toString());
            return;
        }
    }

    log('Script initialized. Checking environment...');

    let pageType = '';
    let headerContainer = document.querySelector('.artistheader h1') ||
                          document.querySelector('.rgheader h1') ||
                          document.querySelector('h1 a bdi')?.parentNode;

    if (path.includes('/events')) pageType = 'events';
    else if (path.includes('/recordings')) pageType = 'recordings';
    else if (path.includes('/releases')) pageType = 'releases';
    else if (path.includes('/works')) pageType = 'works';
    else if (path.includes('/release-group/')) pageType = 'rg-details';
    else if (path.includes('/work/')) pageType = 'work-details';
    else if (path.match(/\/artist\/[a-f0-9-]{36}$/)) pageType = 'artist-main';

    log('Detection completed.', { pageType, hasHeader: !!headerContainer });

    if (!pageType || !headerContainer) {
        log('Termination: pageType or headerContainer missing.');
        return;
    }

    // --- UI Setup ---
    const btn = document.createElement('button');
    btn.textContent = `C: Show all ${pageType.replace('-', ' ')}`;
    btn.style.cssText = 'margin-left:10px; font-size:0.5em; padding:2px 6px; vertical-align:middle; cursor:pointer;';
    btn.type = 'button';

    const stopBtn = document.createElement('button');
    stopBtn.textContent = 'Stop';
    stopBtn.style.cssText = 'display:none; margin-left:5px; font-size:0.5em; padding:2px 6px; vertical-align:middle; cursor:pointer; background-color:#f44336; color:white;';

    const filterInput = document.createElement('input');
    filterInput.placeholder = `Filter ${pageType}...`;
    filterInput.style.cssText = 'display:none; margin-left:10px; font-size:0.5em; padding:2px 6px; vertical-align:middle; border:1px solid #ccc; border-radius:3px;';

    const timerDisplay = document.createElement('span');
    timerDisplay.style.cssText = 'margin-left:10px; font-size:0.5em; color:#666; vertical-align:middle;';

    headerContainer.appendChild(btn);
    headerContainer.appendChild(stopBtn);
    headerContainer.appendChild(filterInput);
    headerContainer.appendChild(timerDisplay);

    let allRows = [];
    let isLoaded = false;
    let stopRequested = false;

    btn.addEventListener('click', async () => {
        const prefix = pageType === 'work-details' ? '[MB Show All Recordings]' : '[MB-ShowAll-Debug]';
        console.log(`${prefix} Starting accumulation...`);
        
        if (isLoaded) return;

        let maxPage = 1;
        const pagination = document.querySelector('ul.pagination');
        if (pagination) {
            const links = Array.from(pagination.querySelectorAll('li a'));
            links.forEach(link => {
                const p = new URL(link.href, window.location.origin).searchParams.get('page');
                if (p) maxPage = Math.max(maxPage, parseInt(p, 10));
            });
        }
        log(`Max page detected: ${maxPage}`);

        isLoaded = true;
        stopRequested = false;
        btn.disabled = true;
        stopBtn.style.display = 'inline-block';
        timerDisplay.textContent = 'Fetching...';

        const startTime = performance.now();
        const baseUrl = window.location.origin + path;

        try {
            for (let p = 1; p <= maxPage; p++) {
                if (stopRequested) {
                    console.log(`${prefix} Stop requested at page ${p}`);
                    break;
                }

                console.log(`${prefix} Fetching page ${p} of ${maxPage}...`);
                btn.textContent = `Loading ${p}/${maxPage}`;
                
                let fetchUrl = new URL(baseUrl);
                fetchUrl.searchParams.set('page', p);
                // Carry over work specific params if they exist
                if (params.has('direction')) fetchUrl.searchParams.set('direction', params.get('direction'));
                if (params.has('link_type_id')) fetchUrl.searchParams.set('link_type_id', params.get('link_type_id'));

                const html = await fetchHtml(fetchUrl.toString());
                const doc = new DOMParser().parseFromString(html, 'text/html');
                const tableBody = doc.querySelector('table.tbl tbody');

                if (tableBody) {
                    const rows = tableBody.querySelectorAll('tr:not(.explanation)');
                    rows.forEach(row => {
                        if (row.cells.length > 1) {
                            allRows.push(document.importNode(row, true));
                        }
                    });
                }
            }

            console.log(`${prefix} Successfully loaded ${allRows.length} rows.`);
            renderFinalTable(allRows);
            
            btn.textContent = 'All Loaded';
            stopBtn.style.display = 'none';
            filterInput.style.display = 'inline-block';
            
            const endTime = performance.now();
            timerDisplay.textContent = `(${((endTime - startTime) / 1000).toFixed(2)}s)`;
        } catch (err) {
            console.error(`${prefix} Error:`, err);
            btn.textContent = 'Error';
            btn.disabled = false;
        }
    });

    function renderFinalTable(rows) {
        const table = document.querySelector('table.tbl');
        const tbody = table?.querySelector('tbody');
        if (!tbody) return;

        document.querySelectorAll('ul.pagination, nav.pagination, .pageselector').forEach(el => el.remove());
        
        tbody.innerHTML = '';
        rows.forEach(r => tbody.appendChild(r));
    }

    function fetchHtml(url) {
        return new Promise((resolve, reject) => {
            GM_xmlhttpRequest({
                method: 'GET', url: url,
                onload: (res) => resolve(res.responseText),
                onerror: (err) => reject(err)
            });
        });
    }
})();
#+end_example

** finally

Adjust the code in the uploaded script "ShowAllConsolidated.user.js" for the case that URLs are of type
https://musicbrainz.org/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db

with the working implementation for the same case in the uploaded script "ShowAllConsolidatedWorking.user.js"

The relevant code seems to be

#+begin_example
    const currentUrl = new URL(location.href);
    const path = currentUrl.pathname;
    const params = currentUrl.searchParams;

    /* ---------------------------------------------------------
     * Redirect: Work ‚Üí Recording relationships
     * --------------------------------------------------------- */
    if (
        path.startsWith('/work/') &&
        (!params.has('direction') || !params.has('link_type_id'))
    ) {
        params.set('direction', '2');
        params.set('link_type_id', '278');
        params.set('page', '1');
        location.replace(currentUrl.toString());
        return;
    }

    /* ---------------------------------------------------------
     * Page type detection
     * --------------------------------------------------------- */
    const isWorkRecordings =
        path.startsWith('/work/') &&
        params.get('direction') === '2' &&
        params.get('link_type_id') === '278';

    let pageType = '';

    if (isWorkRecordings) pageType = 'work-recordings';
    else if (path.includes('/events')) pageType = 'events';
    else if (path.includes('/recordings')) pageType = 'recordings';
    else if (path.includes('/releases')) pageType = 'releases';
    else if (path.includes('/works')) pageType = 'works';
    else if (path.includes('/release-group/')) pageType = 'rg-details';
    else if (path.match(/\/artist\/[a-f0-9-]{36}$/)) pageType = 'artist-main';
#+end_example

and

#+begin_example
                const u = new URL(baseUrl);
                u.searchParams.set('page', page);
                if (params.has('direction')) u.searchParams.set('direction', params.get('direction'));
                if (params.has('link_type_id')) u.searchParams.set('link_type_id', params.get('link_type_id'));
#+end_example

don't touch other code and UI logic

** logging

It still doesn show the complete resulting page, but it seems to fetch everything. At the end we are again at the page https://musicbrainz.org/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db?direction=2&link_type_id=278&page=1

#+begin_example
Will not be able to get dimensions, script not installed?
console.js:36 work & overview not allowed yet
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Checking for Work -> Recording redirect Object
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Initializing script for path: /work/b1528b3f-0c0e-3977-ba98-5cb5b38108db
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Detected pageType: work-recordings
brucebase.wikidot.com/favicon-ico:1  Failed to load resource: net::ERR_TOO_MANY_REDIRECTS
userscript.html?name=sanojjonas-visualise-stuff.user.js&id=39cb5d25-a89a-401b-9c61-6d1089d68abe:1137 Uncaught TypeError: Cannot set properties of null (setting 'style')
    at window.onresize (userscript.html?name=sanojjonas-visualise-stuff.user.js&id=39cb5d25-a89a-401b-9c61-6d1089d68abe:1137:15)
Navigated to https://musicbrainz.org/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db
userscript.html?name=MB%253A-Supercharged-Cover-Art-Edits.user.js&id=0c53d926-6032-49a1-9002-908a5d53bc1a:10503 Will not be able to get dimensions, script not installed?
userscript.html?name=sanojjonas-visualise-stuff.user.js&id=39cb5d25-a89a-401b-9c61-6d1089d68abe:1065 work & overview not allowed yet
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Checking for Work -> Recording redirect {path: '/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db', params: ''}
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Redirect conditions met. Setting params and replacing location. 
react-dom.production.min.js:132 Uncaught Error: Minified React error #418; visit https://reactjs.org/docs/error-decoder.html?invariant=418 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
fo @ react-dom.production.min.js:132
Qs @ react-dom.production.min.js:225
ku @ react-dom.production.min.js:280
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
react-dom.production.min.js:292 Uncaught Error: Minified React error #423; visit https://reactjs.org/docs/error-decoder.html?invariant=423 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
Sl @ react-dom.production.min.js:292
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
ou @ react-dom.production.min.js:270
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
Navigated to https://musicbrainz.org/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db?direction=2&link_type_id=278&page=1
userscript.html?name=MB%253A-Supercharged-Cover-Art-Edits.user.js&id=0c53d926-6032-49a1-9002-908a5d53bc1a:10503 Will not be able to get dimensions, script not installed?
userscript.html?name=sanojjonas-visualise-stuff.user.js&id=39cb5d25-a89a-401b-9c61-6d1089d68abe:1065 work & overview not allowed yet
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Checking for Work -> Recording redirect {path: '/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db', params: 'direction=2&link_type_id=278&page=1'}
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Initializing script for path: /work/b1528b3f-0c0e-3977-ba98-5cb5b38108db
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Detected pageType: work-recordings
react-dom.production.min.js:132 Uncaught Error: Minified React error #418; visit https://reactjs.org/docs/error-decoder.html?invariant=418 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
fo @ react-dom.production.min.js:132
Qs @ react-dom.production.min.js:225
ku @ react-dom.production.min.js:280
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
react-dom.production.min.js:292 Uncaught Error: Minified React error #423; visit https://reactjs.org/docs/error-decoder.html?invariant=423 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
Sl @ react-dom.production.min.js:292
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
ou @ react-dom.production.min.js:270
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
favicon-ico:1  GET https://brucebase.wikidot.com/favicon-ico net::ERR_TOO_MANY_REDIRECTS
Image
setFavicon @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1684
addExternalLink @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1333
xhr.onreadystatechange @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1376
(anonymous) @ xhr.js:88
XMLHttpRequest.send
(anonymous) @ trycatch.js:164
(anonymous) @ xhr.js:135
addHiddenLinks @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1392
main @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1227
(anonymous) @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1158
At @ VM6847:10
(anonymous) @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1
window.__f__mkqftiwz.1m8 @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1
At @ VM6847:10
r.setMessageListener.r @ VM6847:90
(anonymous) @ VM6847:93
_ @ VM6847:22
$t @ content.js:9
h @ content.js:65
d @ content.js:68
(anonymous) @ content.js:68
Xn @ content.js:15
send @ content.js:68
w @ content.js:63
(anonymous) @ content.js:64
(anonymous) @ content.js:2
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Start button clicked. 
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Total pages to fetch: 3
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Hiding auxiliary UI elements. 
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Fetching page 1... 
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Target URL: https://musicbrainz.org/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db?page=1&direction=2&link_type_id=278
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Fetching page 2... 
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Target URL: https://musicbrainz.org/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db?page=2&direction=2&link_type_id=278
Navigated to https://musicbrainz.org/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db
userscript.html?name=MB%253A-Supercharged-Cover-Art-Edits.user.js&id=0c53d926-6032-49a1-9002-908a5d53bc1a:10503 Will not be able to get dimensions, script not installed?
userscript.html?name=sanojjonas-visualise-stuff.user.js&id=39cb5d25-a89a-401b-9c61-6d1089d68abe:1065 work & overview not allowed yet
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Checking for Work -> Recording redirect {path: '/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db', params: ''}
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Redirect conditions met. Setting params and replacing location. 
react-dom.production.min.js:132 Uncaught Error: Minified React error #418; visit https://reactjs.org/docs/error-decoder.html?invariant=418 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
fo @ react-dom.production.min.js:132
Qs @ react-dom.production.min.js:225
ku @ react-dom.production.min.js:280
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
react-dom.production.min.js:292 Uncaught Error: Minified React error #423; visit https://reactjs.org/docs/error-decoder.html?invariant=423 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
Sl @ react-dom.production.min.js:292
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
ou @ react-dom.production.min.js:270
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
favicon-ico:1  GET https://brucebase.wikidot.com/favicon-ico net::ERR_TOO_MANY_REDIRECTS
Image
setFavicon @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1684
addExternalLink @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1333
xhr.onreadystatechange @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1376
(anonymous) @ xhr.js:88
XMLHttpRequest.send
(anonymous) @ trycatch.js:164
(anonymous) @ xhr.js:135
addHiddenLinks @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1392
main @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1227
(anonymous) @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1158
At @ VM6950:10
(anonymous) @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1
window.__f__mkql9la2.kb8 @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1
At @ VM6950:10
r.setMessageListener.r @ VM6950:90
(anonymous) @ VM6950:93
_ @ VM6950:22
$t @ content.js:9
h @ content.js:65
d @ content.js:68
(anonymous) @ content.js:68
Xn @ content.js:15
send @ content.js:68
w @ content.js:63
(anonymous) @ content.js:64
(anonymous) @ content.js:2
Navigated to https://musicbrainz.org/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db?direction=2&link_type_id=278&page=1
userscript.html?name=MB%253A-Supercharged-Cover-Art-Edits.user.js&id=0c53d926-6032-49a1-9002-908a5d53bc1a:10503 Will not be able to get dimensions, script not installed?
userscript.html?name=sanojjonas-visualise-stuff.user.js&id=39cb5d25-a89a-401b-9c61-6d1089d68abe:1065 work & overview not allowed yet
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Checking for Work -> Recording redirect {path: '/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db', params: 'direction=2&link_type_id=278&page=1'}
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Initializing script for path: /work/b1528b3f-0c0e-3977-ba98-5cb5b38108db
userscript.html?name=VZ%253A-MusicBrainz-Show-All-Consolidated.user.js&id=42d0e630-9608-4996-a1a9-486fb6952bec:25 [MB-ShowAll-Debug] Detected pageType: work-recordings
react-dom.production.min.js:132 Uncaught Error: Minified React error #418; visit https://reactjs.org/docs/error-decoder.html?invariant=418 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
fo @ react-dom.production.min.js:132
Qs @ react-dom.production.min.js:225
ku @ react-dom.production.min.js:280
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
react-dom.production.min.js:292 Uncaught Error: Minified React error #423; visit https://reactjs.org/docs/error-decoder.html?invariant=423 for the full message or use the non-minified dev environment for full errors and additional helpful warnings.
Sl @ react-dom.production.min.js:292
bu @ react-dom.production.min.js:279
vu @ react-dom.production.min.js:279
gu @ react-dom.production.min.js:279
ou @ react-dom.production.min.js:270
lu @ react-dom.production.min.js:272
Va @ react-dom.production.min.js:127
cu @ react-dom.production.min.js:273
t.flushSync @ react-dom.production.min.js:319
(anonymous) @ hydrate.js:132
u @ jquery.js:3143
add @ jquery.js:3189
EVdnBjI.m.fn.ready @ jquery.js:3423
EVdnBjI.m.fn.init @ jquery.js:2863
m @ jquery.js:73
h @ hydrate.js:108
uGm1N2M @ TagEditor.js:649
i @ bootstrap:19
(anonymous) @ TagEditor-6ad26cd.js:1
i.O @ chunk loaded:23
(anonymous) @ TagEditor-6ad26cd.js:1
r @ jsonp chunk loading:34
(anonymous) @ TagEditor-6ad26cd.js:1
userscript.html?name=MusicBrainz-Nuclear-Tags.user.js&id=9f413413-b24c-40ae-9bdd-97f6d9c6f0c7:936 [ElephantTags] addTaggingUI: Injecting Custom UI...
favicon-ico:1  GET https://brucebase.wikidot.com/favicon-ico net::ERR_TOO_MANY_REDIRECTS
Image
setFavicon @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1684
addExternalLink @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1333
xhr.onreadystatechange @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1376
(anonymous) @ xhr.js:88
XMLHttpRequest.send
(anonymous) @ trycatch.js:164
(anonymous) @ xhr.js:135
addHiddenLinks @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1392
main @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1227
(anonymous) @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1158
At @ VM7005:10
(anonymous) @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1
window.__f__mkqcvzhs.pj @ userscript.html?name=mb.-ALL-LINKS.user.js&id=b0ab684b-0e44-42b6-9683-ed8b9b41ed33:1
At @ VM7005:10
r.setMessageListener.r @ VM7005:90
(anonymous) @ VM7005:93
_ @ VM7005:22
$t @ content.js:9
h @ content.js:65
d @ content.js:68
(anonymous) @ content.js:68
Xn @ content.js:15
send @ content.js:68
w @ content.js:63
(anonymous) @ content.js:64
(anonymous) @ content.js:2
Xn @ content.js:15
n @ content.js:1
c @ content.js:64
hs @ content.js:64
(anonymous) @ content.js:63
$t @ content.js:9
t @ content.js:10
e @ content.js:1
i @ content.js:1
(anonymous) @ content.js:1
n @ content.js:1
$t @ content.js:9
(anonymous) @ content.js:1
(anonymous) @ content.js:63
$t @ content.js:9
t @ content.js:10
fs @ content.js:58
Rs @ content.js:77
(anonymous) @ content.js:77
(anonymous) @ content.js:15
$t @ content.js:9
t @ content.js:10
(anonymous) @ content.js:15
(anonymous) @ content.js:72
#+end_example

** create function which gets maxnumber

In the uploaded userscript create a function which for URLs of type

https://musicbrainz.org/work/35fdc4a9-fd0a-3a68-a539-5b377464a3ac

makes a GM_xmlhttpRequest call to 

https://musicbrainz.org/work/35fdc4a9-fd0a-3a68-a539-5b377464a3ac?direction=2&link_type_id=278&page=1

and parses the maxPage from the resulting webpage with the following code

#+begin_example
        let maxPage = 1;
        const pagination = document.querySelector('ul.pagination');
        if (pagination) {
            const links = Array.from(pagination.querySelectorAll('li a'));
            const nextIdx = links.findIndex(a => a.textContent.trim() === 'Next');
            if (nextIdx > 0) {
                const urlObj = new URL(links[nextIdx - 1].href, window.location.origin);
                const p = urlObj.searchParams.get('page');
                if (p) maxPage = parseInt(p, 10);
            }
#+end_example

Add a debug stement and show the maxPage value in the console

** 1

Yes.

Remove the actual redirect for pages of type https://musicbrainz.org/work/35fdc4a9-fd0a-3a68-a539-5b377464a3ac and
adjust the logic for these URL types to get the maxPage with the "fetchWorkRecordingsMaxPage" function. Then use the standard fetching of data but adjusted for the

#+begin_example
        params.set('direction', '2');
        params.set('link_type_id', '278');
#+end_example

in case of https://musicbrainz.org/work/35fdc4a9-fd0a-3a68-a539-5b377464a3ac URLs

** 2

Log output:

#+begin_example
[MB-ShowAll-Debug] Detected pageType: work-recordings
[MB-ShowAll-Debug] Initializing script for path: /work/35fdc4a9-fd0a-3a68-a539-5b377464a3ac
[MB-ShowAll-Debug] Detected pageType: work-recordings
[MB-ShowAll-Debug] Start button clicked. 
[MB-ShowAll-Debug] Fetching maxPage for Work recordings from: https://musicbrainz.org/work/35fdc4a9-fd0a-3a68-a539-5b377464a3ac?direction=2&link_type_id=278&page=1
[MB-ShowAll-Debug] Detected maxPage for Work: 4
[MB-ShowAll-Debug] Total pages to fetch: 4
[MB-ShowAll-Debug] Hiding auxiliary UI elements. 
[MB-ShowAll-Debug] Fetching page 1... 
[MB-ShowAll-Debug] Target URL: https://musicbrainz.org/work/35fdc4a9-fd0a-3a68-a539-5b377464a3ac?page=1&direction=2&link_type_id=278
[MB-ShowAll-Debug] Initializing script for path: /work/35fdc4a9-fd0a-3a68-a539-5b377464a3ac
[MB-ShowAll-Debug] Detected pageType: work-recordings
#+end_example

It doesn't work right, after pressing the button, it does somehting, see log, but at the end it still stays on the same initial page and nothg happend

** TODO:
*** remove from events sanojjonas visualize stuff userscript

In the uploaded userscript, when pressing the "C: Show all artist main" button remove all container (if present) which look like

#+begin_example
<div id="load">
<div id="load2">
<div id="load3">
<div id="load4">
<div id="bottom1">
<div id="bottom2">
<div id="bottom3">
<div id="bottom4">
<div id="bottom5">
<div id="bottom6">
#+end_example

coming from sanojjonas visualize stuff userscript
for the pagetype: "artist-main"

*** debugging: info about read release types

Also add debug statements for URL types of https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f
and log a line when a new ReleaseGroup type like "Album", "Album + Compilation" etc. are detected, also log how many rows are being found for each type.

For URLs of type https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c also add a log line when 
during Collection all the table entries after the different headings which look like the following

#+begin_example
<tr class="subh"><th></th><th colspan="9">Official</th></tr>
#+end_example

#+begin_example
<tr class="subh"><th></th><th colspan="9">Promotion</th></tr>
#+end_example

#+begin_example
<tr class="subh"><th></th><th colspan="9">(unknown)</th></tr>
#+end_example

#+begin_example
<tr class="subh"><th></th><th colspan="9">Bootleg</th></tr>
#+end_example

change, and also log how many rows are under each heading

*** Submit button text: show number of rows, and number of rows all over the pages

Now that we have all kind of statistics about number of rows on different pages and types, please place them also on the
resulting pages ot the following places:

- for all pages: total number of rows after the h2 heading '<h2><type></h2>' (in bold and blue), for example '<h2>Events</h2>', '<h2>Releases</h2>', etc. The h2 heading '<h2><type></h2>' can generally be found right before the actual datatable
- for pages (e.g. https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f) which have h3 subtype headers like '<h3>Album</h3>', '<h3>Album + Compilation</h3>', etc, place the number of rows after that heading
- for pages (e.g. https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c) which have '<th colspan="8">Official</th>', '<th colspan="8">Promotion</th>' etc. subtypes inside a datatable, place the number of rows after that subtype (e.g. '<th colspan="8">Promotion (4)</th>' again in bold and blue

Also change the final button text from "All Loaded" to "Loaded <number of rows> from <number of pages>".

**** 1

If there are many h2 headings '<h2><type></h2>' before the datatable, place it on the last one right before the
datatable. For example, the web pahe https://musicbrainz.org/series/fab79f62-2fa5-4f85-9369-82c77811a290 has it on

#+begin_example
<h2 class="annotation">Annotation<span class="mb-row-count-stat">(354)</span></h2>
#+end_example

instead of

#+begin_example
<h2>Releases</h2>
#+end_example

*** On rg pages show debugging info about number per type and also number of types per type block

The logic of finding the h2 headers does not work on all pages. It for example works on https://musicbrainz.org/series/fab79f62-2fa5-4f85-9369-82c77811a290
but NOT on https://musicbrainz.org/label/8e6ab8cc-b190-482e-9975-cce113fba59c or https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f and the others

*** on RG page do not remove the bottom of the page

*** remove the everything between "Discography" and the first type "Album"

create a function which removes everything after the last h2 header and the actual datatable. Run that function after
rendering the datatable but do NOT remove the "main toggle above the subtype headers to hide/show all subtypes" in case
we are on pages of type https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f

*** switch the logging prefix

switch the logging prefix from "[MB-ShowAll-Debug] " to "[MB-ShowAll-Debug: <pageType>] " as soon as pageType is known

*** Implement hide/show functionality

Implement hide/show functionality for pages (e.g. https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f)
which have h3 subtype headers like '<h3>Album</h3>', '<h3>Album + Compilation</h3>' by clicking on the headername. Also
make adjust the UI so that it's obvious that these headername can toogle the display of the corresponding tabledata

**** 1

Include a main toggle above the subtype headers to hide/show all subtypes at once. Place the text "Show‚ñº/Hide‚ñ≤ all discography types or click the individual type"
The rendered page should havae all subtypes collapsed by default, except the "Album" one as long as the rpwcound for albums is less then 40

*** clean <br>

In the uploaded script, 
remove all <br> tags between the text "Showing official release groups by this artist" and "<div class="mb-master-toggle">Show‚ñº/Hide‚ñ≤ all discography types or click the individual type</div>"
after rendering the final page


Remove all <br> tags above "Showing official release groups by this artist" and "<div class="mb-master-toggle">Show‚ñº/Hide‚ñ≤ all discography types or click the individual type</div>"
after rendering the final page

*** debug logging

Also reintroduce comprehensive debug logging for all steps in the userscript, with timeing, number of rows processed etc.

*** add recording type

In the uploaded script add functionality to also
handle URLs of type https://musicbrainz.org/recording/8745510c-26c8-407c-bfaf-efa967ae4a63 the same as URLs of type https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c

So also collect all the table entries after the different headings which look like the following

#+begin_example
<tr class="subh"><th></th><th colspan="9">Official</th></tr>
#+end_example

#+begin_example
<tr class="subh"><th></th><th colspan="9">Promotion</th></tr>
#+end_example

#+begin_example
<tr class="subh"><th></th><th colspan="9">(unknown)</th></tr>
#+end_example

#+begin_example
<tr class="subh"><th></th><th colspan="9">Bootleg</th></tr>
#+end_example

and create one final page where each subheader, like "Official", "Promotion, Bootleg", etc exist only one time.

*** add x icon

In the "Filter" text box insert a unicode x icon on the right side of the text box , so tha when pressed, we can quickly delet the contents of the filter text box

*** render inline headers as external

For URLs of type https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c and https://musicbrainz.org/recording/8745510c-26c8-407c-bfaf-efa967ae4a63
in the final rendered page make an additional transformation:

Transfer the rows under each subheader, like "Official", "Promotion, Bootleg" to separate sortable datatables (each with
their own table headings) and put the subheader in a '<h3><subheader></h3>' right before the datatables, mimic the
structure of URLs of type https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f when they are finally
rendered.

*** button text

adjust the button text when Loading datapages to not be greyed out, but change the mousepointer to just a standard mousepointer instead of a finger
actually ist should still be diabled during load, but still make the visual changes

** add timing info for sorting and processsing

** for numerical columns adjust the sorting to be numeric and not character based

In the uploaded userscript, implement the following:

Please adjust the sorting for numerical columns to be numeric and not character based for the folowing URL types

https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f
numerical columns:
- year
- releases
  
https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c
- tracks

https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/releases
- tracks

https://musicbrainz.org/series/fab79f62-2fa5-4f85-9369-82c77811a290
- tracks

*** 1

For https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f

- year   - WORKS
- releases   - nothing happens at all

** "Relationships"  

In the uploaded userscript, after the introduction of the "‚Üï" symbol after the header columns names, the functionality of 

#+begin_example
                        if (txt === 'Relationship' || txt === 'Relationships' || txt === 'Performance Attributes') indicesToExclude.push(idx);
#+end_example

still works, so the data columns are deleted, but not the headers
Please remove the corresponding headers

The header column

#+begin_example
<th style="cursor: pointer;">Relationships<span class="sort-icon"> ‚Üï</span></th>
#+end_example

is still present

*** tackle relationships

In the uploaded userscript "ShowAllConsolidated.user.js" the functionality of removing the "Relationships" column works
for the column-data itself, but the column header for that column is still there, which is wrong. The column header
should also be removed. It probably is related to the introduction of the "‚Üï" symbol after the header columns names in
the final rendered table ?

Please compare this functionality with a working version in the uploaded userscript
"ShowAllConsolidated-without-relationships.user.js" and fix accordingly.

**** 1

not working. is it probably because of the introduction of the "‚Üï" symbol after the header columns names in the final rendered table ?

**** 2

NO, the "Relationships ‚Üï" header is still there

**** ChatGPT

** logging

In the uploaded userscript, implement the following:

Change the debug logging from

[MB-ShowAll-Debug: releasegroup-releases] Sorting category "Official" by column 2

to

[MB-ShowAll-Debug: releasegroup-releases] Sorting category "Official" by "<column name>" (column <index>)

** split column in two separate columns

In the uploaded userscript, implement the following:

In URLs of type https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c

split the column values of the "Country/Date" column in the "Country" and "Date" values and generate two more columns
for the latter two in the finale generated page. Leave the original "Country/Date" column in the table. The two new
colums should also be sortabel like the rest of the table

Example value for the "Country/Date" column:

#+begin_example
<li aria-label="Release event" class="release-event">
  <span class="flag flag-IT release-country">
    <a href="/area/c6500277-9a3d-349b-bf30-41afdbf42add">
      <abbr title="Italy">IT
      </abbr>
    </a>
  </span>
  <span class="release-date">2009-01-07
  </span>
</li>
#+end_example

*** 1

In the uploaded userscript, the following is implemented

In URLs of type https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c

split the column values of the "Country/Date" column in the "Country" and "Date" values and generate two more columns
for the latter two in the finale generated page. Leave the original "Country/Date" column in the table. The two new
colums should also be sortabel like the rest of the table

Example value for the "Country/Date" column:

#+begin_example
<li aria-label="Release event" class="release-event"><span class="flag flag-IT release-country"><a href="/area/c6500277-9a3d-349b-bf30-41afdbf42add"><abbr title="Italy">IT</abbr></a></span><span class="release-date">2009-01-07</span></li>
#+end_example

The problem is: The column headers for the two new columns "Country" and "Date" are missing, also the data cells are properly filled

*** add more pages

In the uploaded userscript, please also add the 'split the column values of the "Country/Date" column in separate
"Country" and "Date" columns' functionality also for the following URL types:

- https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/releases
- https://musicbrainz.org/label/762c208c-210d-4e59-b46c-6f3558ce3a22
- https://musicbrainz.org/series/fab79f62-2fa5-4f85-9369-82c77811a290

** Split location

In URLs of type https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/events

split the column value of the "Location" column in the "Place", "Area" and "Country" values and generate three more
columns for the latter three in the finale generated page. Leave the original "Location" column in the table. The three
new colums should also be sortable like the rest of the table

Example value for the "Location" column:

#+begin_example
<li>
  <a href="/place/1ff91c7e-447f-4991-94fb-0f508b1c5151">
    <bdi>Xfinity Mobile Arena
    </bdi>
  </a> in
  <a href="/area/0eeb01c2-6e31-46ad-96b8-319749f731d2">
    <bdi>Philadelphia
    </bdi>
  </a>,
  <a href="/area/75d8fdcf-03e9-43d9-9399-131b8e118b0b">
    <bdi>Pennsylvania
    </bdi>
  </a>,
  <span class="flag flag-US">
    <a href="/area/489ce91b-6658-3307-9877-795b68554c98">
      <bdi>United States
      </bdi>
    </a>
  </span>
</li>
#+end_example

So basically do the same as has already be done for the "Country/Date" column

*** href

Please extract also the hyperlinks 'a=href' from the "Location" column and include them in the "Place", "Area" and
"Country" columns. For the country column also include the flag see for example 'span class="flag flag-US"'

*** href in Country/Date

For URLs of type https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c

when splitting the column values of the "Country/Date" column in the "Country" and "Date" values please extract also the
hyperlinks 'a=href' from the "Country/Date" column and include them in the "Country" column. Also include the flag see
for example '<span class="flag flag-IT release-country">'

Complete example value for the "Country/Date" column:

#+begin_example
<li aria-label="Release event" class="release-event">
  <span class="flag flag-IT release-country">
    <a href="/area/c6500277-9a3d-349b-bf30-41afdbf42add">
      <abbr title="Italy">IT
      </abbr>
    </a>
  </span>
  <span class="release-date">2009-01-07
  </span>
</li>
#+end_example

*** color

For the extracted columns "Country", "Date", "Place" and "Area", make the backgound of the corresponding header cell
light grey, to distinguish them from standard columns

** DONE add predictiv timing how long it probably will take to load all the pages

add predictiv timing how long it probably will take to load all the pages, after the submit button (as soon as it's known how long it takes to load a single page, refine after page download)

** DONE split first column

For the following types of URLs, except: https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f

split the column values of the initial column in the "Name" and "Comment" values and generate two more columns
for the latter two in the finale generated page. Leave the original initial column in the table. The two new
colums should also be sortabel like the rest of the table (and the headers should have a dark grey background).

- The "Comment" column should be extracted from the '<span class="comment">' inside a <bdi> structure
- The "Name" column should be extracted from the <bdi> structure after the '<a href=' element. Also preserve the a=href in the new "Name" column
  
Here are examples for the initial column per URL type:

https://musicbrainz.org/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db?direction=2&link_type_id=278&page=1

<td>
  <span class="recordinglink">
  </span>
  <a href="/recording/44b947bb-01fc-4db1-ba41-b20b75f89c54">
    <bdi>4th of July, Asbury Park (Sandy) / Growin‚Äô Up
    </bdi>
  </a>
  <span class="comment">(
    <bdi>live, 1981‚Äê01‚Äê26: Athletic &amp; Convocation Center, University of Notre Dame, South Bend, IN, USA
    </bdi>)
  </span>
</td>

https://musicbrainz.org/place/6a59a67c-fcc5-491f-949c-bfc45bc97463/events

<td>
  <a href="/event/b0466931-607d-4033-aff3-022c3122ea2d/event-art">
    <span class="artwork-icon eaa-icon" title="This event has artwork in the Event Art Archive">
    </span>
  </a>
  <a class="wrap-anywhere" href="/event/b0466931-607d-4033-aff3-022c3122ea2d">
    <bdi>2025‚Äê12‚Äê14: The Stone Pony, Asbury Park, NJ, USA
    </bdi>
  </a>
  <span class="comment">(
    <bdi>Hungerthon Benefit
    </bdi>)
  </span>
</td>

https://musicbrainz.org/series/fab79f62-2fa5-4f85-9369-82c77811a290

<td>
  <a class="wrap-anywhere" href="/release/947e47b8-a771-4bb7-b672-8662cc2b396e">
    <bdi>1975‚Äê12‚Äê31: Tower Theater, Upper Darby, Philadelphia, PA, USA
    </bdi>
  </a>
  <span class="comment">(
    <bdi>50th anniversary edition
    </bdi>)
  </span>
</td>

https://musicbrainz.org/label/762c208c-210d-4e59-b46c-6f3558ce3a22

<td>
  <a href="/release/8deccee7-8300-440a-9df2-15e4f29a7b9a/cover-art">
    <span class="artwork-icon caa-icon" title="This release has artwork in the Cover Art Archive">
    </span>
  </a>
  <span class="mp">
    <a class="wrap-anywhere" href="/release/8deccee7-8300-440a-9df2-15e4f29a7b9a">
      <bdi>L‚ÄôOlympia
      </bdi>
    </a>
  </span>
  <span class="comment">(
    <bdi>1969‚Äê10‚Äê10: Musicorama, L‚ÄôOlympia, Paris, France
    </bdi>)
  </span>
</td>

https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/works

<td>
  <a class="wrap-anywhere" href="/work/6c0edf2e-3df6-31c2-855d-eb0cd62e184f">
    <bdi>Angel Eyes
    </bdi>
  </a>
  <span class="comment">(
    <bdi>1946 jazz standard
    </bdi>)
  </span>
</td>

https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/recordings

<td>
  <a class="wrap-anywhere" href="/recording/a2091b47-6721-408f-b8f3-f3d180337e6d">
    <bdi>‚ÄúVote for Change‚Äù Finale
    </bdi>
  </a>
  <span class="comment">(
    <bdi>live, 2004‚Äê10‚Äê02: Gund Arena, Cleveland, OH, USA
    </bdi>)
  </span>
</td>

https://musicbrainz.org/artist/70248960-cb53-4ea4-943a-edb18f7d336f/releases

<td>
  <a href="/release/2188d333-0486-4bb1-9472-c92b5ee2d402/cover-art">
    <span class="artwork-icon caa-icon" title="This release has artwork in the Cover Art Archive">
    </span>
  </a>
  <a class="wrap-anywhere" href="/release/2188d333-0486-4bb1-9472-c92b5ee2d402">
    <bdi>Bruce Springsteen in Atlanta, Georgia, 1975
    </bdi>
  </a>
  <span class="comment">(
    <bdi>standard cover, black vinyl
    </bdi>)
  </span>
</td>

https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c

<td>
  <a href="/release/7c995767-1517-4dc2-9f9d-41200458e92e/cover-art">
    <span class="artwork-icon caa-icon" title="This release has artwork in the Cover Art Archive">
    </span>
  </a>
  <a class="wrap-anywhere" href="/release/7c995767-1517-4dc2-9f9d-41200458e92e">
    <bdi>Greetings From Asbury Park, N.J.
    </bdi>
  </a>
  <span class="comment">(
    <bdi>CD 32210 on disc
    </bdi>)
  </span>
</td>

*** 1

NO, the two headers "Name" and "Comment" are there but the data cells are empty.
See for example the working logic to split the "Country/Date" and "Location" columns. 

** DONE fix releases per release group

On URLs of type https://musicbrainz.org/release-group/3c39a076-8e52-38f2-8076-260d0672fb23

Check for example the following three pages:

https://musicbrainz.org/release-group/3c39a076-8e52-38f2-8076-260d0672fb23?page=1
https://musicbrainz.org/release-group/3c39a076-8e52-38f2-8076-260d0672fb23?page=2
https://musicbrainz.org/release-group/3c39a076-8e52-38f2-8076-260d0672fb23?page=3

The collection all the table entries after the different headings which look like the following

#+begin_example
<tr class="subh"><th></th><th colspan="9">Official</th></tr>
#+end_example

#+begin_example
<tr class="subh"><th></th><th colspan="9">Promotion</th></tr>
#+end_example

#+begin_example
<tr class="subh"><th></th><th colspan="9">(unknown)</th></tr>
#+end_example

#+begin_example
<tr class="subh"><th></th><th colspan="9">Bootleg</th></tr>
#+end_example

only appears to happen on the page=1

The fact is on each of the pages there could be rows of type "Official", "Promotion", "Bootleg", etc

*** 1

Still not working.

I think the problem is that a specific subheader like for example "Promotion" and its rows can appear on different pages.
For example

on https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c?page=1

it starts with lots of entries for "Official", then there are 3 entries for "Promotion" and then 1 entry for "Bootleg"

on https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c?page=2

there are again lots of entries for "Official" and at the end there is again 1 entry for "Promotion"

*** 2

please don't touch existing code, only change the behaviour of the data accumulation of pages of type https://musicbrainz.org/release-group/c497fc44-ddaf-3cce-a9b4-bfec958a0f3c
** DONE global filter

In the uploaded script, there is already a filter input field which filters rows globally.

When filtering is active, change the row count statistics (displayed currently in blue) to (<filtered row count> of
<total row count>. Do this in the main H2 headers and the category-specific H3 headers (used in grouped views like
Artist release groups).

Also display the filter string in the data rows with a red color and a lighyellow background

In the uploaded script, there is already a filter input field which filters rows globally.

Please adjust for case sensitive filtering

*** 1

The unicode X for emptying the filter is misplaced now. It should be inside the filterbox

This is how it looks like now

#+begin_example
<span style="display: inline-block; position: relative; margin-left: 10px; vertical-align: middle;">
  <input placeholder="Filter events..." style="font-size: 0.5em; padding: 2px 20px 2px 6px; vertical-align: middle; border: 1px solid rgb(204, 204, 204); border-radius: 3px;">
  <span title="Clear filter" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 0.6em; color: rgb(153, 153, 153); user-select: none;">‚úï
  </span>
  <label title="Case Sensitive" style="font-size: 0.4em; margin-left: 5px; vertical-align: middle; cursor: pointer; font-weight: normal;">
    <input type="checkbox" style="vertical-align: middle; margin-right: 2px;">Cc
  </label>
</span>
#+end_example

** filter per column

In the uploaded script, there is already a filter input field which filters rows globally.

Include such a filter field above each column header (aligned with it), which ADDITIONALLY filters rows based on just
the column where a filter string has been entered (or if a global filter is NOT already activ, which filters just based
on this column). The matching of the filter string should only be done against data cells of the column where it is
entered.

Also include a unix X to quickly empty a filter field.

Also display the filter string in the data cells of the column where we enter a filter sting with a green color and a
lighyellow background

*** 1

The column level filtering is not working yet. The filter input fields are there. also include a unix X to quickly empty a filter field

** Popup tip for sorting + timing

** works

Why in the case of URLs of type https://musicbrainz.org/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db  the a=href goes up to the "(Fetch/Render:" string

#+begin_example
<h1>
  <a href="/work/b1528b3f-0c0e-3977-ba98-5cb5b38108db">
    <bdi>Growin‚Äô Up
    </bdi>
    <button type="button" style="margin-left: 10px; font-size: 0.5em; padding: 2px 6px; vertical-align: middle; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;" class="">Loaded 1348 rows from 3 pages
    </button>
    <button style="display: none; margin-left: 5px; font-size: 0.5em; padding: 2px 6px; vertical-align: middle; cursor: pointer; background-color: rgb(244, 67, 54); color: white; border: 1px solid rgb(211, 47, 47);">Stop
    </button>
    <span style="display: inline-block; margin-left: 10px; vertical-align: middle; white-space: nowrap;">
      <span style="position: relative; display: inline-block; vertical-align: middle;">
	<input placeholder="Filter work-recordings..." style="font-size: 0.5em; padding: 2px 20px 2px 6px; vertical-align: middle; border: 1px solid rgb(204, 204, 204); border-radius: 3px;">
	<span title="Clear filter" style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 0.6em; color: rgb(153, 153, 153); user-select: none;">‚úï
	</span>
      </span>
      <label title="Case Sensitive" style="font-size: 0.4em; margin-left: 5px; vertical-align: middle; cursor: pointer; font-weight: normal;">
	<input type="checkbox" style="vertical-align: middle; margin-right: 2px;">Cc
      </label>
    </span>
    <span style="margin-left: 10px; font-size: 0.5em; color: rgb(102, 102, 102); vertical-align: middle;">(Fetch/Render: 102.01s)
    </span>
  </a>
</h1>
#+end_example



